<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_small.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="RnN18ZogmZl_dLVpxZ6y8kjKL73Mu9VLVEkw9d3qrq0" />
  <meta name="msvalidate.01" content="DC3050AD55F30DDF75AAB78517714910" />
  <meta name="baidu-site-verification" content="codeva-PPofu3dNxe" />

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-loading-bar.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tangcuxiaojikuai.xyz","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="该文章主要记录一些特殊的趣题">
<meta property="og:type" content="article">
<meta property="og:title" content="Crypto趣题-其他">
<meta property="og:url" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9.html">
<meta property="og:site_name" content="糖醋小鸡块的blog">
<meta property="og:description" content="该文章主要记录一些特殊的趣题">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20230926104953693.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20230926105347447.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20230926105546460.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20230926105945860.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20230926110200084.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20240418114003579.png">
<meta property="article:published_time" content="2023-09-29T01:55:19.000Z">
<meta property="article:modified_time" content="2024-04-18T03:49:28.693Z">
<meta property="article:author" content="糖醋小鸡块">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tangcuxiaojikuai.xyz/post/97bbcbc9/image-20230926104953693.png">

<link rel="canonical" href="https://tangcuxiaojikuai.xyz/post/97bbcbc9.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Crypto趣题-其他 | 糖醋小鸡块的blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">糖醋小鸡块的blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tangcuxiaojikuai.xyz/post/97bbcbc9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/image.png">
      <meta itemprop="name" content="糖醋小鸡块">
      <meta itemprop="description" content=""追风赶月莫停留，平芜尽处是春山"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="糖醋小鸡块的blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Crypto趣题-其他
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-29 09:55:19" itemprop="dateCreated datePublished" datetime="2023-09-29T09:55:19+08:00">2023-09-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-18 11:49:28" itemprop="dateModified" datetime="2024-04-18T11:49:28+08:00">2024-04-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/crypto%E8%B6%A3%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">crypto趣题</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/97bbcbc9.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/97bbcbc9.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>该文章主要记录一些特殊的趣题</p>
<span id="more"></span>
<h3 id="Shamir门限"><a href="#Shamir门限" class="headerlink" title="Shamir门限"></a>Shamir门限</h3><p>题目来源：暂不明确</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">公司使用Shamir门限密钥设计了一个秘密保存方案，将fag保存了起来，最终的设计效果如下密钥总共有<span class="number">9</span>份，拿到任意<span class="number">5</span>个密钥即可解出保存的flag.现在我们知道公共的密钥:</span><br><span class="line">p=<span class="number">0x3b9f64aeadae9545d899102c8c1874e3d4f12caf6ded3eb8454c27fd7058ff31a5742aee60b2b7</span></span><br><span class="line">以及如下<span class="number">5</span>个密钥:</span><br><span class="line"><span class="number">0x13570e530aaa3639e622d02ca8a0f89089ad0ee3ba51edd95490653b684aaeedd3a762938d08b3</span></span><br><span class="line"><span class="number">0xb583b75e84190f9d081234088b23e6b634110bda167a21bdfb4b5608a65e7283e8531547623d8</span></span><br><span class="line"><span class="number">0x8d3bbbb28592b1a00885c11633369568fcb8bbfdec3cbf4d8cd5546728ca99f24cbe0ac214a39</span></span><br><span class="line"><span class="number">0x13816f03e972210516c17b13a008ee8fd9b888839d6e1ce203fd7723f5e8e0443c2c6279c8dab9</span></span><br><span class="line"><span class="number">0x1553e323763e4c3ba53f6f93e0feb01d6b168fdda30fd87e949664eb4c8f2fd8414e2c14df8f5e</span></span><br><span class="line">请恢复flag</span><br></pre></td></tr></table></figure>
<p>题目明确说了这是一个Shamir门限方案，先来简单梳理一下Shamir门限方案的基本实施方式，大概分为以下几步:</p>
<p>1、<strong>根据恢复秘密最小人数及秘密消息，生成秘密多项式</strong></p>
<ul>
<li>将秘密消息转化为整数，记为 secret</li>
<li>首先，设置一个需恢复秘密的最小人数 t ，而题目中说”拿到任意5个密钥即可解出保存的flag”，因此t=5</li>
<li>设置一个公钥 p ，作为之后生成的多项式所处的有限域</li>
<li>生成一个 t-1 次的多项式，满足：</li>
</ul>
<script type="math/tex; mode=display">
f(x) = a_{t-1}*x^{t-1}+a_{t-2}*x^{t-2}+...+a_{2}*x^{2}+a_{1}*x^{1}+a_0 \quad(mod\;p)</script><script type="math/tex; mode=display">
其中，a_1、a_2、...、a_{t-2}、a_{t-1}为随机数，a0=secret</script><ul>
<li>因此可以看出，当多项式取 x=0 时，对应的 f(x)=f(0)=a0=secret，即秘密消息</li>
</ul>
<p><br></p>
<p>2、<strong>根据秘密多项式，进行密钥分发</strong></p>
<ul>
<li>设实际参与密钥分发的人数为 n ，则将 1~n(有时也可能是n个不同的随机数)依次代入秘密多项式 f(x)，便得到n组密钥：</li>
</ul>
<script type="math/tex; mode=display">
(1，f(1))、(2,f(2))、...(n-1,f(n-1))、(n,f(n))</script><ul>
<li>将生成的 n 个密钥分发给 n 个人</li>
</ul>
<p><br></p>
<p>3、<strong>销毁秘密多项式</strong></p>
<p><br></p>
<p>至此，Shamir门限方案便实施完成了，这种分法方案涉及到两个数字，一个是需恢复秘密的最小人数 t ，一个是实际参与密钥分发的人数 n ，因此可以称为 (t,n) - 门限方案。</p>
<p>需要注意到的是，在完成密钥分发之后，秘密多项式便随之被销毁了。那么在拥有足够数量的密钥(&gt;=t)的情况下，怎么恢复秘密信息 secret呢？这就需要用到拉格朗日插值公式，我们不妨先把密钥记为:</p>
<script type="math/tex; mode=display">
(x_1，f(x_1))、(x_2,f(x_2))、...(x_{n-1},f(x_{n-1}))、(x_n,f(x_n))</script><p>则插值多项式如下：</p>
<script type="math/tex; mode=display">
f(x) = \sum_{i=1}^{t}[{f(x_i)}*\prod_{j=1,j\neq i}^{t}{\frac{x-x_j}{x_i-x_j}}]\quad(mod\;p)</script><p>直观一点可以展开写成下式：</p>
<script type="math/tex; mode=display">
f(x) = f(x_1)\frac{(x-x_2)(x-x_3)...(x-x_t)}{(x1-x_2)(x1-x_3)...(x1-x_t)} + f(x_2)\frac{(x-x_1)(x-x_3)...(x-x_t)}{(x2-x_1)(x2-x_3)...(x2-x_t)} + ... +
f(x_t)\frac{(x-x_1)(x-x_2)...(x-x_{t-1})}{(x_t-x_1)(x_t-x_2)...(x_t-x_{t-1})}
\quad(mod\;p)</script><p>观察一下这个多项式的性质：</p>
<ul>
<li>是一个 t-1 次多项式</li>
<li>分发的密钥均是多项式上的点：</li>
</ul>
<script type="math/tex; mode=display">
(x_1，f(x_1))、(x_2,f(x_2))、...(x_{n-1},f(x_{n-1}))、(x_n,f(x_n))</script><ul>
<li>这是因为，代入其中任意一个密钥的横坐标，则只有代入的那一项不为0，而其他全为0，拿 x1 举例：</li>
</ul>
<script type="math/tex; mode=display">
f(x_1) = f(x_1)\frac{(x_1-x_2)(x_1-x_3)...(x_1-x_t)}{(x1-x_2)(x1-x_3)...(x1-x_t)} + f(x_2)\frac{(x_1-x_1)(x_1-x_3)...(x_1-x_t)}{(x2-x_1)(x2-x_3)...(x2-x_t)} + ... +
f(x_t)\frac{(x_1-x_1)(x_1-x_2)...(x_1-x_{t-1})}{(x_t-x_1)(x_t-x_2)...(x_t-x_{t-1})}
\quad(mod\;p)</script><ul>
<li>即：</li>
</ul>
<script type="math/tex; mode=display">
f(x_1) = f(x_1)*1 + f(x_2)*0 + ... +
f(x_t)*0
\quad(mod\;p)</script><script type="math/tex; mode=display">
所以有 f(x_1) = f(x_1)
\quad(mod\;p)</script><p>所以当有足够多的点( t-1 次多项式需要 t 个点)进行插值时，就可以代入 0 进入插值多项式，解出的常数项即为秘密消息 secret</p>
<p><br></p>
<p>完全了解了Shamir门限方案后再来看这个题，就可以发现密钥数量是完全足够的，但是不清楚5个人具体分到的是9个密钥中的哪一个密钥，因此还需要全排列爆破处理。</p>
<p>exp.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = <span class="number">0x3b9f64aeadae9545d899102c8c1874e3d4f12caf6ded3eb8454c27fd7058ff31a5742aee60b2b7</span></span><br><span class="line">c = [<span class="number">0x13570e530aaa3639e622d02ca8a0f89089ad0ee3ba51edd95490653b684aaeedd3a762938d08b3</span>,<span class="number">0xb583b75e84190f9d081234088b23e6b634110bda167a21bdfb4b5608a65e7283e8531547623d8</span>,<span class="number">0x8d3bbbb28592b1a00885c11633369568fcb8bbfdec3cbf4d8cd5546728ca99f24cbe0ac214a39</span>,<span class="number">0x13816f03e972210516c17b13a008ee8fd9b888839d6e1ce203fd7723f5e8e0443c2c6279c8dab9</span>,<span class="number">0x1553e323763e4c3ba53f6f93e0feb01d6b168fdda30fd87e949664eb4c8f2fd8414e2c14df8f5e</span>]</span><br><span class="line"></span><br><span class="line">m = ([<span class="number">0</span>, c[<span class="number">0</span>]],[<span class="number">0</span>, c[<span class="number">1</span>]],[<span class="number">0</span>, c[<span class="number">2</span>]],[<span class="number">0</span>, c[<span class="number">3</span>]],[<span class="number">0</span>, c[<span class="number">4</span>]])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> permutations(<span class="built_in">range</span>(<span class="number">9</span>),<span class="number">5</span>):</span><br><span class="line">        m[<span class="number">0</span>][<span class="number">0</span>] = i[<span class="number">0</span>]</span><br><span class="line">        m[<span class="number">1</span>][<span class="number">0</span>] = i[<span class="number">1</span>]</span><br><span class="line">        m[<span class="number">2</span>][<span class="number">0</span>] = i[<span class="number">2</span>]</span><br><span class="line">        m[<span class="number">3</span>][<span class="number">0</span>] = i[<span class="number">3</span>]</span><br><span class="line">        m[<span class="number">4</span>][<span class="number">0</span>] = i[<span class="number">4</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (</span><br><span class="line">                m[<span class="number">0</span>][<span class="number">1</span>] * (<span class="number">0</span> - m[<span class="number">1</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">2</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">3</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">4</span>][<span class="number">0</span>]) * inverse((m[<span class="number">0</span>][<span class="number">0</span>] - m[<span class="number">1</span>][<span class="number">0</span>]) * (m[<span class="number">0</span>][<span class="number">0</span>] - m[<span class="number">2</span>][<span class="number">0</span>]) * (m[<span class="number">0</span>][<span class="number">0</span>] - m[<span class="number">3</span>][<span class="number">0</span>]) * (m[<span class="number">0</span>][<span class="number">0</span>] - m[<span class="number">4</span>][<span class="number">0</span>]), p) +</span><br><span class="line">                m[<span class="number">1</span>][<span class="number">1</span>] * (<span class="number">0</span> - m[<span class="number">0</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">2</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">3</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">4</span>][<span class="number">0</span>]) * inverse((m[<span class="number">1</span>][<span class="number">0</span>] - m[<span class="number">0</span>][<span class="number">0</span>]) * (m[<span class="number">1</span>][<span class="number">0</span>] - m[<span class="number">2</span>][<span class="number">0</span>]) * (m[<span class="number">1</span>][<span class="number">0</span>] - m[<span class="number">3</span>][<span class="number">0</span>]) * (m[<span class="number">1</span>][<span class="number">0</span>] - m[<span class="number">4</span>][<span class="number">0</span>]), p) +</span><br><span class="line">                m[<span class="number">2</span>][<span class="number">1</span>] * (<span class="number">0</span> - m[<span class="number">1</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">0</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">3</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">4</span>][<span class="number">0</span>]) * inverse((m[<span class="number">2</span>][<span class="number">0</span>] - m[<span class="number">1</span>][<span class="number">0</span>]) * (m[<span class="number">2</span>][<span class="number">0</span>] - m[<span class="number">0</span>][<span class="number">0</span>]) * (m[<span class="number">2</span>][<span class="number">0</span>] - m[<span class="number">3</span>][<span class="number">0</span>]) * (m[<span class="number">2</span>][<span class="number">0</span>] - m[<span class="number">4</span>][<span class="number">0</span>]), p) +</span><br><span class="line">                m[<span class="number">3</span>][<span class="number">1</span>] * (<span class="number">0</span> - m[<span class="number">1</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">2</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">0</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">4</span>][<span class="number">0</span>]) * inverse((m[<span class="number">3</span>][<span class="number">0</span>] - m[<span class="number">1</span>][<span class="number">0</span>]) * (m[<span class="number">3</span>][<span class="number">0</span>] - m[<span class="number">2</span>][<span class="number">0</span>]) * (m[<span class="number">3</span>][<span class="number">0</span>] - m[<span class="number">0</span>][<span class="number">0</span>]) * (m[<span class="number">3</span>][<span class="number">0</span>] - m[<span class="number">4</span>][<span class="number">0</span>]), p) +</span><br><span class="line">                m[<span class="number">4</span>][<span class="number">1</span>] * (<span class="number">0</span> - m[<span class="number">1</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">2</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">3</span>][<span class="number">0</span>]) * (<span class="number">0</span> - m[<span class="number">0</span>][<span class="number">0</span>]) * inverse((m[<span class="number">4</span>][<span class="number">0</span>] - m[<span class="number">1</span>][<span class="number">0</span>]) * (m[<span class="number">4</span>][<span class="number">0</span>] - m[<span class="number">2</span>][<span class="number">0</span>]) * (m[<span class="number">4</span>][<span class="number">0</span>] - m[<span class="number">3</span>][<span class="number">0</span>]) * (m[<span class="number">4</span>][<span class="number">0</span>] - m[<span class="number">0</span>][<span class="number">0</span>]), p)</span><br><span class="line">                ) % p</span><br><span class="line">            temp = <span class="built_in">str</span>(long_to_bytes(r))</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> temp):</span><br><span class="line">                <span class="built_in">print</span>(temp)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#flag&#123;b14f4963671a457cf22ec271356e0f78&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="sqrt"><a href="#sqrt" class="headerlink" title="sqrt"></a>sqrt</h3><p>题目来源：bricsctf-2023-Quals</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">P = Permutations(<span class="number">256</span>).random_element()</span><br><span class="line"><span class="built_in">print</span>(P**<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>([x^y <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(hashlib.sha512(<span class="built_in">str</span>(P).encode()).digest(), <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())])</span><br></pre></td></tr></table></figure>
<p>密文txt：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[41, 124, 256, 27, 201, 93, 40, 133, 47, 10, 69, 253, 13, 245, 165, 166, 118, 230, 197, 249, 115, 18, 71, 24, 100, 14, 160, 28, 251, 96, 106, 5, 244, 58, 67, 44, 150, 42, 255, 74, 168, 182, 153, 209, 227, 232, 159, 128, 125, 11, 135, 90, 76, 30, 84, 31, 1, 149, 48, 95, 216, 94, 157, 131, 196, 172, 105, 169, 202, 203, 121, 210, 53, 9, 147, 89, 39, 68, 59, 141, 87, 207, 51, 180, 19, 81, 57, 103, 228, 77, 12, 129, 185, 85, 45, 123, 50, 116, 65, 213, 104, 64, 54, 155, 222, 112, 3, 252, 21, 33, 138, 151, 211, 233, 204, 97, 239, 113, 82, 200, 23, 231, 177, 26, 72, 4, 78, 183, 199, 6, 49, 29, 250, 119, 32, 56, 110, 187, 35, 143, 83, 25, 70, 2, 66, 101, 217, 120, 224, 142, 191, 136, 189, 127, 132, 36, 174, 146, 152, 140, 193, 62, 178, 17, 148, 248, 167, 88, 73, 229, 134, 156, 158, 60, 63, 242, 221, 34, 214, 20, 171, 139, 226, 186, 164, 181, 236, 107, 111, 61, 99, 108, 179, 223, 137, 212, 237, 102, 161, 145, 184, 173, 247, 162, 205, 154, 55, 117, 254, 38, 75, 234, 7, 46, 109, 22, 175, 144, 219, 220, 195, 190, 98, 79, 15, 170, 80, 235, 52, 8, 37, 243, 198, 86, 43, 192, 241, 240, 208, 130, 188, 114, 218, 215, 206, 176, 238, 16, 246, 126, 122, 163, 225, 92, 91, 194]</span><br><span class="line">[18, 188, 48, 47, 100, 234, 225, 8, 187, 34, 124, 113, 118, 252, 137, 196, 125, 20, 251, 168, 167, 5, 225, 134, 66, 203, 26, 148, 63, 181, 213, 124, 170, 234, 35, 120, 47, 69, 157, 69, 194]</span><br></pre></td></tr></table></figure>
<p>题目非常简短，流程如下：</p>
<ul>
<li>将256个元素进行全排列，并随机抽取其中一个排列，记为 P</li>
<li>打印出该排列的平方</li>
<li>将该排列 P 的 sha512 值与flag明文相异或，打印出密文</li>
</ul>
<p>因此，任务就只有一个：根据排列的平方，还原出该排列，并与密文异或就能还原flag</p>
<p>有一个概念一定要先理解清楚，排列的平方是什么意思？用代码可以如下表示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C[i] = P[P[i]]</span><br></pre></td></tr></table></figure>
<p>也就是说，一组排列可以看作是一个置换，那么排列的平方就是进行二重置换。</p>
<p>那么怎么还原呢，我们用图的方式来理解，图上一个节点指向另一个节点，代表的就是经过一次置换后，该节点置换到指向节点的位置，比如下面这张图就可以表示一个置换：</p>
<p><strong>(偶数个点的情况)</strong></p>
<p><img src="/post/97bbcbc9/image-20230926104953693.png" alt="image-20230926104953693"></p>
<p>这张图代表：0置换到1、1置换到2、…5置换到0，这很好理解</p>
<p>那么这个置换平方后会是什么样子？很简单，只需要把一个节点指向节点所指向的节点作为新的置换即可，说起来有点绕，还是举个例子：0指向1，1指向2，所以平方后，0指向2，这就很容易明白了。</p>
<p>所以上面的置换平方后会变成如下形式：</p>
<p><img src="/post/97bbcbc9/image-20230926105347447.png" alt="image-20230926105347447"></p>
<p>那么还原的方式就是将两个环并排，然后挨个插入，如下：</p>
<p><img src="/post/97bbcbc9/image-20230926105546460.png" alt="image-20230926105546460"></p>
<p>但是显然，由于插入的相对位置不同，这样还原就可能会得到多个不同的初始置换，而他们平方后都是满足要求的。</p>
<p>上面的例子是偶数个点的情况，想一想奇数个点平方后会如何：</p>
<p><strong>(奇数个点的情况)</strong></p>
<p><img src="/post/97bbcbc9/image-20230926105945860.png" alt="image-20230926105945860"></p>
<p>继续利用<strong>把一个节点指向节点所指向的节点作为新的置换</strong>这一点，可以看出平方后，环并没有裂开，只是交换了位置：</p>
<p><img src="/post/97bbcbc9/image-20230926110200084.png" alt="image-20230926110200084"></p>
<p>仔细想想就能明白，这种形式的还原是唯一的，不会有多种情况。</p>
<p>想清楚置换与图的关系后，回到题目本身来，按如下步骤分析：</p>
<p>1、<strong>首先就要把平方后的排列先转化为若干个环：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#打印环</span></span><br><span class="line">n = [<span class="number">18</span>, <span class="number">188</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">100</span>, <span class="number">234</span>, <span class="number">225</span>, <span class="number">8</span>, <span class="number">187</span>, <span class="number">34</span>, <span class="number">124</span>, <span class="number">113</span>, <span class="number">118</span>, <span class="number">252</span>, <span class="number">137</span>, <span class="number">196</span>, <span class="number">125</span>, <span class="number">20</span>, <span class="number">251</span>, <span class="number">168</span>, <span class="number">167</span>, <span class="number">5</span>, <span class="number">225</span>, <span class="number">134</span>, <span class="number">66</span>, <span class="number">203</span>, <span class="number">26</span>, <span class="number">148</span>, <span class="number">63</span>, <span class="number">181</span>, <span class="number">213</span>, <span class="number">124</span>, <span class="number">170</span>, <span class="number">234</span>, <span class="number">35</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">157</span>, <span class="number">69</span>, <span class="number">194</span>]</span><br><span class="line"></span><br><span class="line">P2 = [<span class="number">41</span>, <span class="number">124</span>, <span class="number">256</span>, <span class="number">27</span>, <span class="number">201</span>, <span class="number">93</span>, <span class="number">40</span>, <span class="number">133</span>, <span class="number">47</span>, <span class="number">10</span>, <span class="number">69</span>, <span class="number">253</span>, <span class="number">13</span>, <span class="number">245</span>, <span class="number">165</span>, <span class="number">166</span>, <span class="number">118</span>, <span class="number">230</span>, <span class="number">197</span>, <span class="number">249</span>, <span class="number">115</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">24</span>, <span class="number">100</span>, <span class="number">14</span>, <span class="number">160</span>, <span class="number">28</span>, <span class="number">251</span>, <span class="number">96</span>, <span class="number">106</span>, <span class="number">5</span>, <span class="number">244</span>, <span class="number">58</span>, <span class="number">67</span>, <span class="number">44</span>, <span class="number">150</span>, <span class="number">42</span>, <span class="number">255</span>, <span class="number">74</span>, <span class="number">168</span>, <span class="number">182</span>, <span class="number">153</span>, <span class="number">209</span>, <span class="number">227</span>, <span class="number">232</span>, <span class="number">159</span>, <span class="number">128</span>, <span class="number">125</span>, <span class="number">11</span>, <span class="number">135</span>, <span class="number">90</span>, <span class="number">76</span>, <span class="number">30</span>, <span class="number">84</span>, <span class="number">31</span>, <span class="number">1</span>, <span class="number">149</span>, <span class="number">48</span>, <span class="number">95</span>, <span class="number">216</span>, <span class="number">94</span>, <span class="number">157</span>, <span class="number">131</span>, <span class="number">196</span>, <span class="number">172</span>, <span class="number">105</span>, <span class="number">169</span>, <span class="number">202</span>, <span class="number">203</span>, <span class="number">121</span>, <span class="number">210</span>, <span class="number">53</span>, <span class="number">9</span>, <span class="number">147</span>, <span class="number">89</span>, <span class="number">39</span>, <span class="number">68</span>, <span class="number">59</span>, <span class="number">141</span>, <span class="number">87</span>, <span class="number">207</span>, <span class="number">51</span>, <span class="number">180</span>, <span class="number">19</span>, <span class="number">81</span>, <span class="number">57</span>, <span class="number">103</span>, <span class="number">228</span>, <span class="number">77</span>, <span class="number">12</span>, <span class="number">129</span>, <span class="number">185</span>, <span class="number">85</span>, <span class="number">45</span>, <span class="number">123</span>, <span class="number">50</span>, <span class="number">116</span>, <span class="number">65</span>, <span class="number">213</span>, <span class="number">104</span>, <span class="number">64</span>, <span class="number">54</span>, <span class="number">155</span>, <span class="number">222</span>, <span class="number">112</span>, <span class="number">3</span>, <span class="number">252</span>, <span class="number">21</span>, <span class="number">33</span>, <span class="number">138</span>, <span class="number">151</span>, <span class="number">211</span>, <span class="number">233</span>, <span class="number">204</span>, <span class="number">97</span>, <span class="number">239</span>, <span class="number">113</span>, <span class="number">82</span>, <span class="number">200</span>, <span class="number">23</span>, <span class="number">231</span>, <span class="number">177</span>, <span class="number">26</span>, <span class="number">72</span>, <span class="number">4</span>, <span class="number">78</span>, <span class="number">183</span>, <span class="number">199</span>, <span class="number">6</span>, <span class="number">49</span>, <span class="number">29</span>, <span class="number">250</span>, <span class="number">119</span>, <span class="number">32</span>, <span class="number">56</span>, <span class="number">110</span>, <span class="number">187</span>, <span class="number">35</span>, <span class="number">143</span>, <span class="number">83</span>, <span class="number">25</span>, <span class="number">70</span>, <span class="number">2</span>, <span class="number">66</span>, <span class="number">101</span>, <span class="number">217</span>, <span class="number">120</span>, <span class="number">224</span>, <span class="number">142</span>, <span class="number">191</span>, <span class="number">136</span>, <span class="number">189</span>, <span class="number">127</span>, <span class="number">132</span>, <span class="number">36</span>, <span class="number">174</span>, <span class="number">146</span>, <span class="number">152</span>, <span class="number">140</span>, <span class="number">193</span>, <span class="number">62</span>, <span class="number">178</span>, <span class="number">17</span>, <span class="number">148</span>, <span class="number">248</span>, <span class="number">167</span>, <span class="number">88</span>, <span class="number">73</span>, <span class="number">229</span>, <span class="number">134</span>, <span class="number">156</span>, <span class="number">158</span>, <span class="number">60</span>, <span class="number">63</span>, <span class="number">242</span>, <span class="number">221</span>, <span class="number">34</span>, <span class="number">214</span>, <span class="number">20</span>, <span class="number">171</span>, <span class="number">139</span>, <span class="number">226</span>, <span class="number">186</span>, <span class="number">164</span>, <span class="number">181</span>, <span class="number">236</span>, <span class="number">107</span>, <span class="number">111</span>, <span class="number">61</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">179</span>, <span class="number">223</span>, <span class="number">137</span>, <span class="number">212</span>, <span class="number">237</span>, <span class="number">102</span>, <span class="number">161</span>, <span class="number">145</span>, <span class="number">184</span>, <span class="number">173</span>, <span class="number">247</span>, <span class="number">162</span>, <span class="number">205</span>, <span class="number">154</span>, <span class="number">55</span>, <span class="number">117</span>, <span class="number">254</span>, <span class="number">38</span>, <span class="number">75</span>, <span class="number">234</span>, <span class="number">7</span>, <span class="number">46</span>, <span class="number">109</span>, <span class="number">22</span>, <span class="number">175</span>, <span class="number">144</span>, <span class="number">219</span>, <span class="number">220</span>, <span class="number">195</span>, <span class="number">190</span>, <span class="number">98</span>, <span class="number">79</span>, <span class="number">15</span>, <span class="number">170</span>, <span class="number">80</span>, <span class="number">235</span>, <span class="number">52</span>, <span class="number">8</span>, <span class="number">37</span>, <span class="number">243</span>, <span class="number">198</span>, <span class="number">86</span>, <span class="number">43</span>, <span class="number">192</span>, <span class="number">241</span>, <span class="number">240</span>, <span class="number">208</span>, <span class="number">130</span>, <span class="number">188</span>, <span class="number">114</span>, <span class="number">218</span>, <span class="number">215</span>, <span class="number">206</span>, <span class="number">176</span>, <span class="number">238</span>, <span class="number">16</span>, <span class="number">246</span>, <span class="number">126</span>, <span class="number">122</span>, <span class="number">163</span>, <span class="number">225</span>, <span class="number">92</span>, <span class="number">91</span>, <span class="number">194</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P2)):</span><br><span class="line">    P2[i] -= <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(P2[<span class="number">204</span>])</span><br><span class="line">lenlist = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P2)):</span><br><span class="line">    <span class="built_in">len</span> = <span class="number">1</span></span><br><span class="line">    t = <span class="number">0</span></span><br><span class="line">    loc = P2[i]</span><br><span class="line">    chain = [loc]</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        t = P2[loc]</span><br><span class="line">        loc = t</span><br><span class="line">        chain.append(loc)</span><br><span class="line">        <span class="built_in">len</span> += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(t == i):</span><br><span class="line">            <span class="comment">#print(i,&quot;,&quot;,len)</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span> == <span class="number">2</span>):</span><br><span class="line">                <span class="built_in">print</span>(chain)</span><br><span class="line">                <span class="built_in">print</span>(i+<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#print(lenlist.count(2))</span></span><br><span class="line"><span class="comment">#2*82 + 75 + 3*3 + 1*8</span></span><br></pre></td></tr></table></figure>
<p>可以发现，平方后的置换可以拆分为 ：</p>
<ul>
<li>2个长为 82 的环</li>
<li>1个长为75的环</li>
<li>3个长为3的环</li>
<li>8个单元环</li>
</ul>
<p><br></p>
<p>2、<strong>接下来就是分析如何还原：</strong></p>
<ul>
<li>对于长为 82 的环，他一定是长为 164 的环拆分而成</li>
<li>长为 75 的环一定是本身长就为 75 的环</li>
<li>3个长为3的环，可能本身就是 3 个长为 3 的环；也可能本身是一个长为 3 的环加上一个长为 6 的环拆分而成</li>
<li>8个单元环，可能本身就是 8 个单元环，也可能是 1-4 个 2 元环加上剩下的单元环</li>
</ul>
<p>因此，要考虑上述的所有可能情况，求出所有符合要求的排列，并与密文异或做爆破。按理来说，一般爆破需要的是flag头，但是由于我并不知道flag头是什么(别的师傅问的)，所以采用全为可见字符来爆破。</p>
<p>复杂度经计算应该是 ：(对哪一部分复杂度不清楚可以问我) </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">82*1*4*C(8,2)*C(6,2)*C(4,2)*16</span><br></pre></td></tr></table></figure>
<p>约为一千多万，大概跑五分钟左右可以全部完成。</p>
<p>exp.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line"></span><br><span class="line"><span class="comment">#打印环</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">n = [18, 188, 48, 47, 100, 234, 225, 8, 187, 34, 124, 113, 118, 252, 137, 196, 125, 20, 251, 168, 167, 5, 225, 134, 66, 203, 26, 148, 63, 181, 213, 124, 170, 234, 35, 120, 47, 69, 157, 69, 194]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">P2 = [41, 124, 256, 27, 201, 93, 40, 133, 47, 10, 69, 253, 13, 245, 165, 166, 118, 230, 197, 249, 115, 18, 71, 24, 100, 14, 160, 28, 251, 96, 106, 5, 244, 58, 67, 44, 150, 42, 255, 74, 168, 182, 153, 209, 227, 232, 159, 128, 125, 11, 135, 90, 76, 30, 84, 31, 1, 149, 48, 95, 216, 94, 157, 131, 196, 172, 105, 169, 202, 203, 121, 210, 53, 9, 147, 89, 39, 68, 59, 141, 87, 207, 51, 180, 19, 81, 57, 103, 228, 77, 12, 129, 185, 85, 45, 123, 50, 116, 65, 213, 104, 64, 54, 155, 222, 112, 3, 252, 21, 33, 138, 151, 211, 233, 204, 97, 239, 113, 82, 200, 23, 231, 177, 26, 72, 4, 78, 183, 199, 6, 49, 29, 250, 119, 32, 56, 110, 187, 35, 143, 83, 25, 70, 2, 66, 101, 217, 120, 224, 142, 191, 136, 189, 127, 132, 36, 174, 146, 152, 140, 193, 62, 178, 17, 148, 248, 167, 88, 73, 229, 134, 156, 158, 60, 63, 242, 221, 34, 214, 20, 171, 139, 226, 186, 164, 181, 236, 107, 111, 61, 99, 108, 179, 223, 137, 212, 237, 102, 161, 145, 184, 173, 247, 162, 205, 154, 55, 117, 254, 38, 75, 234, 7, 46, 109, 22, 175, 144, 219, 220, 195, 190, 98, 79, 15, 170, 80, 235, 52, 8, 37, 243, 198, 86, 43, 192, 241, 240, 208, 130, 188, 114, 218, 215, 206, 176, 238, 16, 246, 126, 122, 163, 225, 92, 91, 194]</span></span><br><span class="line"><span class="string">for i in range(len(P2)):</span></span><br><span class="line"><span class="string">    P2[i] -= 1</span></span><br><span class="line"><span class="string">print(P2[204])</span></span><br><span class="line"><span class="string">lenlist = []</span></span><br><span class="line"><span class="string">for i in range(len(P2)):</span></span><br><span class="line"><span class="string">    len = 1</span></span><br><span class="line"><span class="string">    t = 0</span></span><br><span class="line"><span class="string">    loc = P2[i]</span></span><br><span class="line"><span class="string">    chain = [loc]</span></span><br><span class="line"><span class="string">    while(1):</span></span><br><span class="line"><span class="string">        t = P2[loc]</span></span><br><span class="line"><span class="string">        loc = t</span></span><br><span class="line"><span class="string">        chain.append(loc)</span></span><br><span class="line"><span class="string">        len += 1</span></span><br><span class="line"><span class="string">        if(t == i):</span></span><br><span class="line"><span class="string">            #print(i,&quot;,&quot;,len)</span></span><br><span class="line"><span class="string">            if(len == 2):</span></span><br><span class="line"><span class="string">                print(chain)</span></span><br><span class="line"><span class="string">                print(i+1)</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">#print(lenlist.count(2))</span></span><br><span class="line"><span class="string">#2*82 + 75 + 3*3 + 1*8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证函数</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        tt = [0 for k in range(256)]</span></span><br><span class="line"><span class="string">        for k in range(256):</span></span><br><span class="line"><span class="string">            tt[k] = P[P[k]] + 1</span></span><br><span class="line"><span class="string">        for k in range(256):</span></span><br><span class="line"><span class="string">            if(tt[k]!= c[k]):</span></span><br><span class="line"><span class="string">                print(k)</span></span><br><span class="line"><span class="string">        exit()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">chain1 = [<span class="number">9</span>,<span class="number">12</span>,<span class="number">23</span>,<span class="number">27</span>,<span class="number">166</span>,<span class="number">204</span>,<span class="number">218</span>,<span class="number">219</span>]</span><br><span class="line">group_size = <span class="number">2</span></span><br><span class="line">num_groups = <span class="number">4</span></span><br><span class="line">all_groupings = <span class="built_in">list</span>(combinations(chain1, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_groupings</span>(<span class="params">chain1, group_size, num_groups</span>):</span><br><span class="line">    <span class="keyword">if</span> num_groups == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">yield</span> [chain1]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> combo <span class="keyword">in</span> combinations(chain1, group_size):</span><br><span class="line">            remaining_chain1 = [e <span class="keyword">for</span> e <span class="keyword">in</span> chain1 <span class="keyword">if</span> e <span class="keyword">not</span> <span class="keyword">in</span> combo]</span><br><span class="line">            <span class="keyword">for</span> rest_grouping <span class="keyword">in</span> generate_groupings(remaining_chain1, group_size, num_groups - <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">yield</span> [<span class="built_in">list</span>(combo)] + rest_grouping</span><br><span class="line"></span><br><span class="line">chain1r = <span class="built_in">list</span>(generate_groupings(chain1, group_size, num_groups))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = [<span class="number">18</span>, <span class="number">188</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">100</span>, <span class="number">234</span>, <span class="number">225</span>, <span class="number">8</span>, <span class="number">187</span>, <span class="number">34</span>, <span class="number">124</span>, <span class="number">113</span>, <span class="number">118</span>, <span class="number">252</span>, <span class="number">137</span>, <span class="number">196</span>, <span class="number">125</span>, <span class="number">20</span>, <span class="number">251</span>, <span class="number">168</span>, <span class="number">167</span>, <span class="number">5</span>, <span class="number">225</span>, <span class="number">134</span>, <span class="number">66</span>, <span class="number">203</span>, <span class="number">26</span>, <span class="number">148</span>, <span class="number">63</span>, <span class="number">181</span>, <span class="number">213</span>, <span class="number">124</span>, <span class="number">170</span>, <span class="number">234</span>, <span class="number">35</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">157</span>, <span class="number">69</span>, <span class="number">194</span>]</span><br><span class="line">c = [<span class="number">41</span>, <span class="number">124</span>, <span class="number">256</span>, <span class="number">27</span>, <span class="number">201</span>, <span class="number">93</span>, <span class="number">40</span>, <span class="number">133</span>, <span class="number">47</span>, <span class="number">10</span>, <span class="number">69</span>, <span class="number">253</span>, <span class="number">13</span>, <span class="number">245</span>, <span class="number">165</span>, <span class="number">166</span>, <span class="number">118</span>, <span class="number">230</span>, <span class="number">197</span>, <span class="number">249</span>, <span class="number">115</span>, <span class="number">18</span>, <span class="number">71</span>, <span class="number">24</span>, <span class="number">100</span>, <span class="number">14</span>, <span class="number">160</span>, <span class="number">28</span>, <span class="number">251</span>, <span class="number">96</span>, <span class="number">106</span>, <span class="number">5</span>, <span class="number">244</span>, <span class="number">58</span>, <span class="number">67</span>, <span class="number">44</span>, <span class="number">150</span>, <span class="number">42</span>, <span class="number">255</span>, <span class="number">74</span>, <span class="number">168</span>, <span class="number">182</span>, <span class="number">153</span>, <span class="number">209</span>, <span class="number">227</span>, <span class="number">232</span>, <span class="number">159</span>, <span class="number">128</span>, <span class="number">125</span>, <span class="number">11</span>, <span class="number">135</span>, <span class="number">90</span>, <span class="number">76</span>, <span class="number">30</span>, <span class="number">84</span>, <span class="number">31</span>, <span class="number">1</span>, <span class="number">149</span>, <span class="number">48</span>, <span class="number">95</span>, <span class="number">216</span>, <span class="number">94</span>, <span class="number">157</span>, <span class="number">131</span>, <span class="number">196</span>, <span class="number">172</span>, <span class="number">105</span>, <span class="number">169</span>, <span class="number">202</span>, <span class="number">203</span>, <span class="number">121</span>, <span class="number">210</span>, <span class="number">53</span>, <span class="number">9</span>, <span class="number">147</span>, <span class="number">89</span>, <span class="number">39</span>, <span class="number">68</span>, <span class="number">59</span>, <span class="number">141</span>, <span class="number">87</span>, <span class="number">207</span>, <span class="number">51</span>, <span class="number">180</span>, <span class="number">19</span>, <span class="number">81</span>, <span class="number">57</span>, <span class="number">103</span>, <span class="number">228</span>, <span class="number">77</span>, <span class="number">12</span>, <span class="number">129</span>, <span class="number">185</span>, <span class="number">85</span>, <span class="number">45</span>, <span class="number">123</span>, <span class="number">50</span>, <span class="number">116</span>, <span class="number">65</span>, <span class="number">213</span>, <span class="number">104</span>, <span class="number">64</span>, <span class="number">54</span>, <span class="number">155</span>, <span class="number">222</span>, <span class="number">112</span>, <span class="number">3</span>, <span class="number">252</span>, <span class="number">21</span>, <span class="number">33</span>, <span class="number">138</span>, <span class="number">151</span>, <span class="number">211</span>, <span class="number">233</span>, <span class="number">204</span>, <span class="number">97</span>, <span class="number">239</span>, <span class="number">113</span>, <span class="number">82</span>, <span class="number">200</span>, <span class="number">23</span>, <span class="number">231</span>, <span class="number">177</span>, <span class="number">26</span>, <span class="number">72</span>, <span class="number">4</span>, <span class="number">78</span>, <span class="number">183</span>, <span class="number">199</span>, <span class="number">6</span>, <span class="number">49</span>, <span class="number">29</span>, <span class="number">250</span>, <span class="number">119</span>, <span class="number">32</span>, <span class="number">56</span>, <span class="number">110</span>, <span class="number">187</span>, <span class="number">35</span>, <span class="number">143</span>, <span class="number">83</span>, <span class="number">25</span>, <span class="number">70</span>, <span class="number">2</span>, <span class="number">66</span>, <span class="number">101</span>, <span class="number">217</span>, <span class="number">120</span>, <span class="number">224</span>, <span class="number">142</span>, <span class="number">191</span>, <span class="number">136</span>, <span class="number">189</span>, <span class="number">127</span>, <span class="number">132</span>, <span class="number">36</span>, <span class="number">174</span>, <span class="number">146</span>, <span class="number">152</span>, <span class="number">140</span>, <span class="number">193</span>, <span class="number">62</span>, <span class="number">178</span>, <span class="number">17</span>, <span class="number">148</span>, <span class="number">248</span>, <span class="number">167</span>, <span class="number">88</span>, <span class="number">73</span>, <span class="number">229</span>, <span class="number">134</span>, <span class="number">156</span>, <span class="number">158</span>, <span class="number">60</span>, <span class="number">63</span>, <span class="number">242</span>, <span class="number">221</span>, <span class="number">34</span>, <span class="number">214</span>, <span class="number">20</span>, <span class="number">171</span>, <span class="number">139</span>, <span class="number">226</span>, <span class="number">186</span>, <span class="number">164</span>, <span class="number">181</span>, <span class="number">236</span>, <span class="number">107</span>, <span class="number">111</span>, <span class="number">61</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">179</span>, <span class="number">223</span>, <span class="number">137</span>, <span class="number">212</span>, <span class="number">237</span>, <span class="number">102</span>, <span class="number">161</span>, <span class="number">145</span>, <span class="number">184</span>, <span class="number">173</span>, <span class="number">247</span>, <span class="number">162</span>, <span class="number">205</span>, <span class="number">154</span>, <span class="number">55</span>, <span class="number">117</span>, <span class="number">254</span>, <span class="number">38</span>, <span class="number">75</span>, <span class="number">234</span>, <span class="number">7</span>, <span class="number">46</span>, <span class="number">109</span>, <span class="number">22</span>, <span class="number">175</span>, <span class="number">144</span>, <span class="number">219</span>, <span class="number">220</span>, <span class="number">195</span>, <span class="number">190</span>, <span class="number">98</span>, <span class="number">79</span>, <span class="number">15</span>, <span class="number">170</span>, <span class="number">80</span>, <span class="number">235</span>, <span class="number">52</span>, <span class="number">8</span>, <span class="number">37</span>, <span class="number">243</span>, <span class="number">198</span>, <span class="number">86</span>, <span class="number">43</span>, <span class="number">192</span>, <span class="number">241</span>, <span class="number">240</span>, <span class="number">208</span>, <span class="number">130</span>, <span class="number">188</span>, <span class="number">114</span>, <span class="number">218</span>, <span class="number">215</span>, <span class="number">206</span>, <span class="number">176</span>, <span class="number">238</span>, <span class="number">16</span>, <span class="number">246</span>, <span class="number">126</span>, <span class="number">122</span>, <span class="number">163</span>, <span class="number">225</span>, <span class="number">92</span>, <span class="number">91</span>, <span class="number">194</span>]</span><br><span class="line"></span><br><span class="line">chain821 = [<span class="number">193</span>, <span class="number">222</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">96</span>, <span class="number">49</span>, <span class="number">10</span>, <span class="number">68</span>, <span class="number">201</span>, <span class="number">172</span>, <span class="number">157</span>, <span class="number">145</span>, <span class="number">100</span>, <span class="number">103</span>, <span class="number">154</span>, <span class="number">131</span>, <span class="number">28</span>, <span class="number">250</span>, <span class="number">121</span>, <span class="number">230</span>, <span class="number">36</span>, <span class="number">149</span>, <span class="number">141</span>, <span class="number">24</span>, <span class="number">99</span>, <span class="number">212</span>, <span class="number">6</span>, <span class="number">39</span>, <span class="number">73</span>, <span class="number">8</span>, <span class="number">46</span>, <span class="number">158</span>, <span class="number">151</span>, <span class="number">135</span>, <span class="number">55</span>, <span class="number">30</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">150</span>, <span class="number">190</span>, <span class="number">98</span>, <span class="number">64</span>, <span class="number">195</span>, <span class="number">211</span>, <span class="number">233</span>, <span class="number">85</span>, <span class="number">80</span>, <span class="number">86</span>, <span class="number">56</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">167</span>, <span class="number">87</span>, <span class="number">102</span>, <span class="number">53</span>, <span class="number">29</span>, <span class="number">95</span>, <span class="number">122</span>, <span class="number">176</span>, <span class="number">220</span>, <span class="number">194</span>, <span class="number">136</span>, <span class="number">109</span>, <span class="number">32</span>, <span class="number">243</span>, <span class="number">214</span>, <span class="number">108</span>, <span class="number">20</span>, <span class="number">114</span>, <span class="number">203</span>, <span class="number">161</span>, <span class="number">61</span>, <span class="number">93</span>, <span class="number">84</span>, <span class="number">18</span>, <span class="number">196</span>, <span class="number">236</span>, <span class="number">240</span>, <span class="number">187</span>, <span class="number">106</span>, <span class="number">2</span>, <span class="number">255</span>]</span><br><span class="line">chain822 = [<span class="number">125</span>, <span class="number">3</span>, <span class="number">26</span>, <span class="number">159</span>, <span class="number">139</span>, <span class="number">142</span>, <span class="number">69</span>, <span class="number">202</span>, <span class="number">246</span>, <span class="number">237</span>, <span class="number">239</span>, <span class="number">129</span>, <span class="number">5</span>, <span class="number">92</span>, <span class="number">184</span>, <span class="number">163</span>, <span class="number">16</span>, <span class="number">117</span>, <span class="number">112</span>, <span class="number">210</span>, <span class="number">74</span>, <span class="number">146</span>, <span class="number">216</span>, <span class="number">174</span>, <span class="number">62</span>, <span class="number">156</span>, <span class="number">173</span>, <span class="number">59</span>, <span class="number">94</span>, <span class="number">44</span>, <span class="number">226</span>, <span class="number">79</span>, <span class="number">140</span>, <span class="number">82</span>, <span class="number">50</span>, <span class="number">134</span>, <span class="number">31</span>, <span class="number">4</span>, <span class="number">200</span>, <span class="number">183</span>, <span class="number">185</span>, <span class="number">180</span>, <span class="number">170</span>, <span class="number">133</span>, <span class="number">118</span>, <span class="number">81</span>, <span class="number">206</span>, <span class="number">54</span>, <span class="number">83</span>, <span class="number">179</span>, <span class="number">19</span>, <span class="number">248</span>, <span class="number">245</span>, <span class="number">175</span>, <span class="number">241</span>, <span class="number">113</span>, <span class="number">232</span>, <span class="number">197</span>, <span class="number">101</span>, <span class="number">63</span>, <span class="number">130</span>, <span class="number">48</span>, <span class="number">124</span>, <span class="number">71</span>, <span class="number">209</span>, <span class="number">37</span>, <span class="number">41</span>, <span class="number">181</span>, <span class="number">138</span>, <span class="number">34</span>, <span class="number">66</span>, <span class="number">104</span>, <span class="number">221</span>, <span class="number">189</span>, <span class="number">60</span>, <span class="number">215</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">229</span>, <span class="number">7</span>, <span class="number">132</span>, <span class="number">249</span>]</span><br><span class="line">chain75 = [<span class="number">90</span>, <span class="number">11</span>, <span class="number">252</span>, <span class="number">224</span>, <span class="number">14</span>, <span class="number">164</span>, <span class="number">147</span>, <span class="number">119</span>, <span class="number">199</span>, <span class="number">144</span>, <span class="number">65</span>, <span class="number">171</span>, <span class="number">155</span>, <span class="number">35</span>, <span class="number">43</span>, <span class="number">208</span>, <span class="number">253</span>, <span class="number">91</span>, <span class="number">128</span>, <span class="number">198</span>, <span class="number">160</span>, <span class="number">192</span>, <span class="number">178</span>, <span class="number">213</span>, <span class="number">45</span>, <span class="number">231</span>, <span class="number">242</span>, <span class="number">217</span>, <span class="number">143</span>, <span class="number">1</span>, <span class="number">123</span>, <span class="number">25</span>, <span class="number">13</span>, <span class="number">244</span>, <span class="number">205</span>, <span class="number">153</span>, <span class="number">126</span>, <span class="number">77</span>, <span class="number">67</span>, <span class="number">168</span>, <span class="number">72</span>, <span class="number">52</span>, <span class="number">75</span>, <span class="number">88</span>, <span class="number">227</span>, <span class="number">234</span>, <span class="number">42</span>, <span class="number">152</span>, <span class="number">188</span>, <span class="number">110</span>, <span class="number">137</span>, <span class="number">186</span>, <span class="number">235</span>, <span class="number">191</span>, <span class="number">107</span>, <span class="number">251</span>, <span class="number">162</span>, <span class="number">177</span>, <span class="number">33</span>, <span class="number">57</span>, <span class="number">148</span>, <span class="number">223</span>, <span class="number">78</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">127</span>, <span class="number">182</span>, <span class="number">225</span>, <span class="number">169</span>, <span class="number">228</span>, <span class="number">51</span>, <span class="number">89</span>, <span class="number">76</span>, <span class="number">38</span>, <span class="number">254</span>]</span><br><span class="line">chain31 = [<span class="number">15</span>, <span class="number">165</span>, <span class="number">247</span>]</span><br><span class="line">chain32 = [<span class="number">207</span>, <span class="number">116</span>, <span class="number">238</span>]</span><br><span class="line">chain33 = [<span class="number">120</span>, <span class="number">22</span>, <span class="number">70</span>]</span><br><span class="line">chain1 = [<span class="number">9</span>,<span class="number">12</span>,<span class="number">23</span>,<span class="number">27</span>,<span class="number">166</span>,<span class="number">204</span>,<span class="number">218</span>,<span class="number">219</span>]</span><br><span class="line"></span><br><span class="line">locdic = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#处理chain3(四种情况)</span></span><br><span class="line"><span class="comment">#情况1：3个三环</span></span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>):</span><br><span class="line">    chain31r = [<span class="number">15</span>, <span class="number">247</span>, <span class="number">165</span>]</span><br><span class="line">    chain32r = [<span class="number">207</span>, <span class="number">238</span>, <span class="number">116</span>]</span><br><span class="line">    chain33r = [<span class="number">120</span>, <span class="number">70</span>, <span class="number">22</span>]</span><br><span class="line">    <span class="comment">#添加入位置字典</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        locdic[chain31r[i]] = chain31r[(i+<span class="number">1</span>)%<span class="number">3</span>]</span><br><span class="line">        locdic[chain32r[i]] = chain32r[(i+<span class="number">1</span>)%<span class="number">3</span>]</span><br><span class="line">        locdic[chain33r[i]] = chain33r[(i+<span class="number">1</span>)%<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#情况2:1个三环,1个六环</span></span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">    chain31r = [<span class="number">15</span>, <span class="number">247</span>, <span class="number">165</span>]</span><br><span class="line">    chain6r = [<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span>(j % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">            chain6r[j] = chain32[j//<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chain6r[j] = chain33[(j//<span class="number">2</span> + <span class="number">0</span>) % <span class="number">6</span>] </span><br><span class="line">    <span class="comment">#添加入位置字典</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        locdic[chain31r[i]] = chain31r[(i+<span class="number">1</span>)%<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        locdic[chain6r[i]] = chain6r[(i+<span class="number">1</span>)%<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>):</span><br><span class="line">    chain32r = [<span class="number">120</span>, <span class="number">70</span>, <span class="number">22</span>]</span><br><span class="line">    chain6r = [<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span>(j % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">            chain6r[j] = chain31[j//<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chain6r[j] = chain33[(j//<span class="number">2</span> + <span class="number">0</span>) % <span class="number">6</span>] </span><br><span class="line">    <span class="comment">#添加入位置字典</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        locdic[chain32r[i]] = chain32r[(i+<span class="number">1</span>)%<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        locdic[chain6r[i]] = chain6r[(i+<span class="number">1</span>)%<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>):</span><br><span class="line">    chain33r = [<span class="number">120</span>, <span class="number">70</span>, <span class="number">22</span>]</span><br><span class="line">    chain6r = [<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>)]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span>(j % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">            chain6r[j] = chain31[j//<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chain6r[j] = chain32[(j//<span class="number">2</span> + <span class="number">0</span>) % <span class="number">6</span>] </span><br><span class="line">    <span class="comment">#添加入位置字典</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        locdic[chain33r[i]] = chain33r[(i+<span class="number">1</span>)%<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        locdic[chain6r[i]] = chain6r[(i+<span class="number">1</span>)%<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#处理chain75(确定)</span></span><br><span class="line">chain75r = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">75</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">75</span>):</span><br><span class="line">    chain75r[<span class="number">2</span>*i%<span class="number">75</span>] = chain75[i]</span><br><span class="line"><span class="comment">#添加入位置字典</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">75</span>):</span><br><span class="line">    locdic[chain75r[i]] = chain75r[(i+<span class="number">1</span>)%<span class="number">75</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#嗯造剩下两种环的组合</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">82</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="comment">#造一个副本</span></span><br><span class="line">    locdic1 = locdic</span><br><span class="line">    chain164r = [<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">164</span>)]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">164</span>):</span><br><span class="line">        <span class="keyword">if</span>(j % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">            chain164r[j] = chain821[j//<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chain164r[j] = chain822[(j//<span class="number">2</span> + i) % <span class="number">82</span>] </span><br><span class="line">    <span class="comment">#添加入位置字典</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">164</span>):</span><br><span class="line">        locdic1[chain164r[i]] = chain164r[(i+<span class="number">1</span>)%<span class="number">164</span>]</span><br><span class="line">      </span><br><span class="line">    <span class="comment">#4个二元环（包含单环情况）</span></span><br><span class="line">    <span class="keyword">for</span> mm <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        ttt = <span class="built_in">bin</span>(mm)[<span class="number">2</span>:].zfill(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(chain1r)):</span><br><span class="line">            locdic2 = locdic1</span><br><span class="line">            <span class="keyword">if</span>(ttt[<span class="number">0</span>] == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">                locdic2[chain1r[j][<span class="number">0</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">0</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                locdic2[chain1r[j][<span class="number">0</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">0</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span>(ttt[<span class="number">1</span>] == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">                locdic2[chain1r[j][<span class="number">1</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">1</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                locdic2[chain1r[j][<span class="number">1</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">1</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span>(ttt[<span class="number">2</span>] == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">                locdic2[chain1r[j][<span class="number">2</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">2</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">2</span>][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                locdic2[chain1r[j][<span class="number">2</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">2</span>][<span class="number">0</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">2</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span>(ttt[<span class="number">3</span>] == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">                locdic2[chain1r[j][<span class="number">3</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">3</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">3</span>][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                locdic2[chain1r[j][<span class="number">3</span>][<span class="number">0</span>]] = chain1r[j][<span class="number">3</span>][<span class="number">0</span>]</span><br><span class="line">                locdic2[chain1r[j][<span class="number">3</span>][<span class="number">1</span>]] = chain1r[j][<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">            P = [locdic2[j]+<span class="number">1</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">            </span><br><span class="line">            t = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(hashlib.sha512(<span class="built_in">str</span>(P).encode()).digest(), n):</span><br><span class="line">                <span class="keyword">if</span>((x^y)&gt;=<span class="number">32</span> <span class="keyword">and</span> (x^y)&lt;=<span class="number">127</span>):</span><br><span class="line">                    t+=<span class="built_in">chr</span>(x^y)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(t) &gt; <span class="number">10</span>):</span><br><span class="line">                <span class="built_in">print</span>(t)</span><br><span class="line">                exit()</span><br><span class="line">                </span><br><span class="line"><span class="comment">#brics+&#123;ab99943f6dae4f20595c8645fcf8289e&#125;</span></span><br></pre></td></tr></table></figure>
<p>脚本比较丑，只能就题论题，不能作为该类求平方根置换的通解。</p>
<p><br></p>
<p><br></p>
<h3 id="prng-加强版"><a href="#prng-加强版" class="headerlink" title="prng(加强版)"></a>prng(加强版)</h3><p>(题目具体名称并不是这个，只是我还没有找到对应题目名，就先用着)</p>
<p>题目来源：江苏省领航杯</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">base</span>(<span class="params">n, l</span>):</span><br><span class="line">    bb = []</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        n, r = <span class="built_in">divmod</span>(n, l)</span><br><span class="line">        bb.append(r)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">str</span>(d) <span class="keyword">for</span> d <span class="keyword">in</span> bb[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prng</span>(<span class="params">secret</span>):</span><br><span class="line">	seed = base(secret, <span class="number">5</span>)</span><br><span class="line">	seed = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>(seed)]</span><br><span class="line">	length = <span class="built_in">len</span>(seed)</span><br><span class="line">	R = [[ random.randint(<span class="number">0</span>,<span class="number">4</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length**<span class="number">2</span>)]</span><br><span class="line">	S = []</span><br><span class="line">	<span class="keyword">for</span> r <span class="keyword">in</span> R:</span><br><span class="line">		s = <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">			s += (r[index] + seed[index]) % <span class="number">5</span></span><br><span class="line">		s %= <span class="number">2</span></span><br><span class="line">		S.append(s)</span><br><span class="line">	<span class="keyword">return</span> R, S</span><br><span class="line"></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">R, S = prng(m)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;output.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	f.write(<span class="string">f&#x27;R = <span class="subst">&#123;R&#125;</span>\nS = <span class="subst">&#123;S&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>梳理加密流程：</p>
<ul>
<li>将flag转为大整数后，将该整数转为五进制数，并转为列表，作为seed</li>
<li>记列表seed长度为n</li>
<li>生成一个 $ n^2*n$ 的矩阵R，其中每个元素为0-4的随机数</li>
<li>利用R矩阵，对seed矩阵做如下加密：(其中，$ i=1,2…n^2$)</li>
</ul>
<script type="math/tex; mode=display">
s_i=\sum_{j=1}^{n}{(({r_{ij}+seed_i})(mod\;5))} \quad(mod\;2)</script><ul>
<li>将 $ s_i$ 拼接为S向量后，提供R与S，求解明文</li>
</ul>
<p>自己做是一点思路都没有，最终找到了 ZM.J 师傅的一篇wp，发现题目是类似的：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/643573246">[CryptoCTF] CryptoCTF 2023 tough分类 团队解题writeup - 知乎 (zhihu.com)</a></p>
<p>于是就可以迁移到这道题目中来：</p>
<p>首先，由于seed中每个数字都是0-4之中的某个数m，我们可以先对其进行编码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0 : (1,0,0,0,0)</span><br><span class="line">1 : (0,1,0,0,0)</span><br><span class="line">2 : (0,0,1,0,0)</span><br><span class="line">3 : (0,0,0,1,0)</span><br><span class="line">4 : (0,0,0,0,1)</span><br></pre></td></tr></table></figure>
<p>此时，我们相当于把一个0-4的数转化为了五个变量组成的一个向量：</p>
<script type="math/tex; mode=display">
m = \left(
 \begin{matrix}
   x_{0} \\
   x_{1} \\
   x_{2} \\
   x_{3}  \\
   x_{4}  \\
  \end{matrix}
  \right)</script><p>其中，每个变量 $ x_i$ 只有0或1两种取值，并且对于任意一个0-4的数m， $ x_i$ 有且仅有一个变量为1，其他均为0</p>
<p>这么做的意义是什么？是让我们能够将这个先模5再模2的没有办法解的线性方程组，变化到一个可以解的形式。</p>
<p>为什么这样变换后就可以解？由加密流程知道，$ r_{ij},seed_i$ 均为0-4之间的数，因此相加后模5模2的结果完全可以用一张表加以表示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p>表的含义是，当 r 取 i ，seed 取 j 时，表中第 i 行第 j 列即为$ (r+seed)\;(mod\;5)\;(mod\;2)$ 的值</p>
<p>然后在这里举个简单的例子来看一下如何变换原题目的线性方程到这种形式下：</p>
<p>假设$ s = (2+m_0)+(3+m_1)+(4+m_2) \;(mod\;5)\;(mod\;2)$，</p>
<p>第一步，把每个 $ m_i$ 表示为五个变量的形式：</p>
<script type="math/tex; mode=display">
m_0 = \left(
 \begin{matrix}
   x_{00} \\
   x_{01} \\
   x_{02} \\
   x_{03}  \\
   x_{04}  \\
  \end{matrix}
  \right),
  m_1 = \left(
 \begin{matrix}
   x_{10} \\
   x_{11} \\
   x_{12} \\
   x_{13}  \\
   x_{14}  \\
  \end{matrix}
  \right),
  m_2 = \left(
 \begin{matrix}
   x_{20} \\
   x_{21} \\
   x_{22} \\
   x_{23}  \\
   x_{24}  \\
  \end{matrix}
  \right)</script><p>第二步，把每一个r转化成对应系数矩阵：</p>
<p>比如，r=2时，看上表的取2的行，需要变量1或4取1就能得到1，否则为0；r=3时，看上表的取3的行，需要变量0或3取1就能得到1，否则为0；r=4时，看上表的取4的行，需要变量2或4取1就能得到1，否则为0</p>
<p>这又是什么意思呢？比如 $ (2+1) \;(mod\;5)\;(mod\;2)$，由真值表可知，他就完全等价于下面的形式：</p>
<script type="math/tex; mode=display">
(0,1,0,0,1)*\left(
 \begin{matrix}
   0 \\
   1 \\
   0 \\
   0  \\
   0  \\
  \end{matrix}
  \right) \quad(mod\;2)</script><p>这么做的好处就是：</p>
<ul>
<li>去除了模5的影响</li>
<li>由加法转成了乘法，变成了矩阵可解的形式</li>
</ul>
<p>因此，刚才的等式$ s = (2+m_0)+(3+m_1)+(4+m_2) \;(mod\;5)\;(mod\;2)$就彻底去除了与模5的关系，而只剩下模2下的线性关系与变量，变成了下面这种形式：</p>
<script type="math/tex; mode=display">
s = (0,1,0,0,1)*\left(
 \begin{matrix}
   x_{00} \\
   x_{01} \\
   x_{02} \\
   x_{03}  \\
   x_{04}  \\
  \end{matrix}
  \right)
  + (1,0,0,1,0)*\left(
 \begin{matrix}
   x_{10} \\
   x_{11} \\
   x_{12} \\
   x_{13}  \\
   x_{14}  \\
  \end{matrix}
  \right)
  + (0,0,1,0,1) * \left(
 \begin{matrix}
   x_{20} \\
   x_{21} \\
   x_{22} \\
   x_{23}  \\
   x_{24}  \\
  \end{matrix}
  \right)
  \quad(mod\;2)</script><p>而把这种形式应用于我们需要求解的问题之中，就可以把seed中原本的n个变量转化成5n个变量，因此只需要从n^2个线性方程中拿出5n个线性线性方程即可解得所有的变量取值，再用刚才对m的编码还原即可。</p>
<p>你可能会发现求解后的向量并不全是刚才的编码形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0 : (1,0,0,0,0)</span><br><span class="line">1 : (0,1,0,0,0)</span><br><span class="line">2 : (0,0,1,0,0)</span><br><span class="line">3 : (0,0,0,1,0)</span><br><span class="line">4 : (0,0,0,0,1)</span><br></pre></td></tr></table></figure>
<p>而出现了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1,1,1,1,0)</span><br></pre></td></tr></table></figure>
<p>事实上，这是因为我们并没有把刚才说的这一点加入到线性方程组的约束中：</p>
<ul>
<li>对于任意一个0-4的数m， $ x_i$ 有且仅有一个变量为1，其他均为0</li>
</ul>
<p>但是影响不大了，因为你大概也能猜到(1,1,1,1,0)对应的就是不加该限制时4的编码，因此对应还原就好</p>
<p>exp.ipynb:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&#x27;E:\vscode\output4.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">exec</span>(f.read())</span><br><span class="line"></span><br><span class="line">n = <span class="built_in">len</span>(R[<span class="number">0</span>])</span><br><span class="line">A = []</span><br><span class="line">B = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span> * n):</span><br><span class="line">    a = []</span><br><span class="line">    B.append(S[i])</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="keyword">if</span> (R[i][j] == <span class="number">0</span>):</span><br><span class="line">            a.extend([<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span> ,<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">elif</span> (R[i][j] == <span class="number">1</span>):</span><br><span class="line">            a.extend([<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">        <span class="keyword">elif</span> (R[i][j] == <span class="number">2</span>):</span><br><span class="line">            a.extend([<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">elif</span> (R[i][j] == <span class="number">3</span>):</span><br><span class="line">            a.extend([<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>])</span><br><span class="line">        <span class="keyword">elif</span> (R[i][j] == <span class="number">4</span>):</span><br><span class="line">            a.extend([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">    A.append(a)</span><br><span class="line"></span><br><span class="line">A = matrix(GF(<span class="number">2</span>), A)</span><br><span class="line">B = vector(GF(<span class="number">2</span>), B)</span><br><span class="line">x = A.solve_right(B)</span><br><span class="line"><span class="comment">#print(x)</span></span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line">temp = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="keyword">if</span> (x[<span class="number">5</span>*i] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">1</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">2</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">3</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">4</span>] == <span class="number">0</span>):</span><br><span class="line">        flag.append(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (x[<span class="number">5</span>*i] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">1</span>] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">2</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">3</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">4</span>] == <span class="number">0</span>):</span><br><span class="line">        flag.append(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (x[<span class="number">5</span>*i] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">1</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">2</span>] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">3</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">4</span>] == <span class="number">0</span>):</span><br><span class="line">        flag.append(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (x[<span class="number">5</span>*i] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">1</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">2</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">3</span>] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">4</span>] == <span class="number">0</span>):</span><br><span class="line">        flag.append(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (x[<span class="number">5</span>*i] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">1</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">2</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">3</span>] == <span class="number">0</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">4</span>] == <span class="number">1</span>):</span><br><span class="line">        flag.append(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> (x[<span class="number">5</span>*i] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">1</span>] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">2</span>] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">3</span>] == <span class="number">1</span>) <span class="keyword">and</span> (x[<span class="number">5</span>*i+<span class="number">4</span>] == <span class="number">0</span>):</span><br><span class="line">        flag.append(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span>.join(flag)</span><br><span class="line">flag = long_to_bytes(<span class="built_in">int</span>(flag, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#CnHongKe&#123;179bdc38ea135c35f1f973c039a422a7&#125;</span></span><br></pre></td></tr></table></figure>
<p>(有不懂的地方欢迎与我交流！)</p>
<p><br></p>
<p><br></p>
<h3 id="ahead"><a href="#ahead" class="headerlink" title="ahead"></a>ahead</h3><p>题目来源：暂不明确</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>(<span class="params">S, B</span>):</span><br><span class="line">    L = S[<span class="number">0</span>] ^ S[<span class="number">7</span>] ^ S[<span class="number">38</span>] ^ S[<span class="number">70</span>] ^ S[<span class="number">81</span>] ^ S[<span class="number">96</span>]</span><br><span class="line">    N = S[<span class="number">0</span>] ^ B[<span class="number">0</span>] ^ B[<span class="number">26</span>] ^ B[<span class="number">56</span>] ^ B[<span class="number">91</span>] ^ B[<span class="number">96</span>] ^ (B[<span class="number">3</span>] &amp; B[<span class="number">67</span>]) ^ \</span><br><span class="line">        (B[<span class="number">11</span>] &amp; B[<span class="number">13</span>]) ^ (B[<span class="number">17</span>] &amp; B[<span class="number">18</span>]) ^ (B[<span class="number">27</span>] &amp; B[<span class="number">59</span>]) ^ (B[<span class="number">40</span>] &amp; B[<span class="number">48</span>]) ^ \</span><br><span class="line">        (B[<span class="number">61</span>] &amp; B[<span class="number">65</span>]) ^ (B[<span class="number">68</span>] &amp; B[<span class="number">84</span>]) ^ (B[<span class="number">22</span>] &amp; B[<span class="number">24</span>] &amp; B[<span class="number">25</span>]) ^ \</span><br><span class="line">        (B[<span class="number">70</span>] &amp; B[<span class="number">78</span>] &amp; B[<span class="number">82</span>]) ^ (B[<span class="number">88</span>] &amp; B[<span class="number">92</span>] &amp; B[<span class="number">93</span>] &amp; B[<span class="number">95</span>])</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> j &lt;= <span class="number">126</span>:</span><br><span class="line">            S[j] = S[j + <span class="number">1</span>]</span><br><span class="line">            B[j] = B[j + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            S[<span class="number">127</span>] = L</span><br><span class="line">            B[<span class="number">127</span>] = N</span><br><span class="line">    h = (B[<span class="number">12</span>] &amp; S[<span class="number">8</span>]) ^ (S[<span class="number">13</span>] &amp; S[<span class="number">20</span>]) ^ (B[<span class="number">95</span>] &amp; S[<span class="number">42</span>]) ^ (S[<span class="number">60</span>] &amp; S[<span class="number">79</span>]) ^ \</span><br><span class="line">        (B[<span class="number">12</span>] &amp; B[<span class="number">95</span>] &amp; S[<span class="number">94</span>])</span><br><span class="line">    z = h ^ S[<span class="number">93</span>] ^ B[<span class="number">2</span>] ^ B[<span class="number">15</span>] ^ B[<span class="number">36</span>] ^ B[<span class="number">45</span>] ^ B[<span class="number">64</span>] ^ B[<span class="number">73</span>] ^ B[<span class="number">89</span>]</span><br><span class="line">    <span class="keyword">return</span> z</span><br><span class="line"></span><br><span class="line">S1 = [randint(<span class="number">0</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line">B1 = [randint(<span class="number">0</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line">hint = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        tmp = randint(<span class="number">1</span>, <span class="number">120</span>)</span><br><span class="line">        <span class="keyword">if</span> tmp <span class="keyword">not</span> <span class="keyword">in</span> hint:</span><br><span class="line">            hint.append(tmp)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;S1&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;hint&#125;</span>&quot;</span>)</span><br><span class="line">hint2 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> hint:</span><br><span class="line">        hint2.append(B1[i])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;hint2&#125;</span>&quot;</span>)</span><br><span class="line">z = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    z.append(gen(S1, B1))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;z&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    key += <span class="built_in">str</span>(gen(S1, B1))</span><br><span class="line">key = long_to_bytes(<span class="built_in">int</span>(key, <span class="number">2</span>))</span><br><span class="line">iv = urandom(<span class="number">16</span>)</span><br><span class="line">secret = urandom(<span class="number">16</span>)</span><br><span class="line">aes = AES.new(<span class="built_in">bytes</span>(key), AES.MODE_CBC, iv)</span><br><span class="line">enc_secret = aes.encrypt(secret)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;iv.<span class="built_in">hex</span>()&#125;</span>||<span class="subst">&#123;enc_secret.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">input_secret = <span class="built_in">input</span>(<span class="string">&quot;my secret?&quot;</span>).strip().encode()</span><br><span class="line"><span class="keyword">if</span> unhexlify(input_secret) == secret:</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;wrong&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>仍然是一个师傅问我的没有靶机的交互题，因此也只说思路。题目看着很复杂，简单梳理一下流程：</p>
<ul>
<li>生成一个初始的S、B，均为长度为128的0、1数组</li>
<li>给出初始S的全部值，以及初始B的88个值</li>
<li>然后以S、B数组为初始值，经过gen函数连续生成128个值作为z数组，并给出z数组</li>
<li>然后继续生成128个值作为AES的key，并加密一个secret，给出密文与iv。如果我们能输入正确的secret就能得到flag</li>
</ul>
<p>那么显然，如果我们有完整的初始B，就可以直接用他的gen函数生成出key，就能解AES。而现在B被隐藏了40个值，但是却给出了包含了128个初始S、B经gen函数生成的值的数组z。而gen函数看着很麻烦，实际上就是一个复杂LFSR的更新过程，所以其实也可以看作是模2下的一些简单运算。</p>
<p>因此，我们把隐去的40个值视作40个变量，实际上就是40个变量、128个方程的解方程问题。</p>
<p>而这种位运算的多变量方程，z3往往是很有效的。我也直接丢给z3就得到了解，本地测试如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>(<span class="params">S, B</span>):</span><br><span class="line">    L = S[<span class="number">0</span>] ^ S[<span class="number">7</span>] ^ S[<span class="number">38</span>] ^ S[<span class="number">70</span>] ^ S[<span class="number">81</span>] ^ S[<span class="number">96</span>]</span><br><span class="line">    N = S[<span class="number">0</span>] ^ B[<span class="number">0</span>] ^ B[<span class="number">26</span>] ^ B[<span class="number">56</span>] ^ B[<span class="number">91</span>] ^ B[<span class="number">96</span>] ^ (B[<span class="number">3</span>] &amp; B[<span class="number">67</span>]) ^ \</span><br><span class="line">        (B[<span class="number">11</span>] &amp; B[<span class="number">13</span>]) ^ (B[<span class="number">17</span>] &amp; B[<span class="number">18</span>]) ^ (B[<span class="number">27</span>] &amp; B[<span class="number">59</span>]) ^ (B[<span class="number">40</span>] &amp; B[<span class="number">48</span>]) ^ \</span><br><span class="line">        (B[<span class="number">61</span>] &amp; B[<span class="number">65</span>]) ^ (B[<span class="number">68</span>] &amp; B[<span class="number">84</span>]) ^ (B[<span class="number">22</span>] &amp; B[<span class="number">24</span>] &amp; B[<span class="number">25</span>]) ^ \</span><br><span class="line">        (B[<span class="number">70</span>] &amp; B[<span class="number">78</span>] &amp; B[<span class="number">82</span>]) ^ (B[<span class="number">88</span>] &amp; B[<span class="number">92</span>] &amp; B[<span class="number">93</span>] &amp; B[<span class="number">95</span>])</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> j &lt;= <span class="number">126</span>:</span><br><span class="line">            S[j] = S[j + <span class="number">1</span>]</span><br><span class="line">            B[j] = B[j + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            S[<span class="number">127</span>] = L</span><br><span class="line">            B[<span class="number">127</span>] = N</span><br><span class="line">    h = (B[<span class="number">12</span>] &amp; S[<span class="number">8</span>]) ^ (S[<span class="number">13</span>] &amp; S[<span class="number">20</span>]) ^ (B[<span class="number">95</span>] &amp; S[<span class="number">42</span>]) ^ (S[<span class="number">60</span>] &amp; S[<span class="number">79</span>]) ^ \</span><br><span class="line">        (B[<span class="number">12</span>] &amp; B[<span class="number">95</span>] &amp; S[<span class="number">94</span>])</span><br><span class="line">    z = h ^ S[<span class="number">93</span>] ^ B[<span class="number">2</span>] ^ B[<span class="number">15</span>] ^ B[<span class="number">36</span>] ^ B[<span class="number">45</span>] ^ B[<span class="number">64</span>] ^ B[<span class="number">73</span>] ^ B[<span class="number">89</span>]</span><br><span class="line">    <span class="keyword">return</span> z</span><br><span class="line"></span><br><span class="line">S1 = [randint(<span class="number">0</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line">B1 = [randint(<span class="number">0</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line">S = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line">BB = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    S[i] = S1[i]</span><br><span class="line">    BB[i] = B1[i]</span><br><span class="line"></span><br><span class="line">hint = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        tmp = randint(<span class="number">1</span>, <span class="number">120</span>)</span><br><span class="line">        <span class="keyword">if</span> tmp <span class="keyword">not</span> <span class="keyword">in</span> hint:</span><br><span class="line">            hint.append(tmp)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">hint2 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> hint:</span><br><span class="line">        hint2.append(B1[i])</span><br><span class="line"></span><br><span class="line">z = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    z.append(gen(S1, B1))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#z3solve</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z3_solve</span>():</span><br><span class="line">    B = [BitVec(<span class="string">f&#x27;B_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line">    solver = Solver()</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> hint:</span><br><span class="line">            B[i] = hint2[j]</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">    <span class="comment">#print(B)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        solver.add(gen(S, B) == z[i])</span><br><span class="line">    <span class="keyword">if</span> solver.check()==sat:</span><br><span class="line">        <span class="built_in">print</span>(solver.model())</span><br><span class="line"></span><br><span class="line">z3_solve()</span><br><span class="line"><span class="built_in">print</span>(BB)</span><br></pre></td></tr></table></figure>
<p>那么还原出B后，用初始S、B先生成z，再生成key就能得到AES密钥，就能解密文了。</p>
<p><br></p>
<p><br></p>
<h3 id="e20k"><a href="#e20k" class="headerlink" title="e20k"></a>e20k</h3><p>题目来源：N1CTF 2023</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/sage</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">FLAG = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;n1ctf&#123;XXXXFAKE_FLAGXXXX&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ECPrng</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.N = self.keygen()</span><br><span class="line">        self.E = EllipticCurve(Zmod(self.N), [<span class="number">3</span>, <span class="number">7</span>])</span><br><span class="line">        self.bias = random.randint(<span class="number">1</span>, <span class="number">2</span>^<span class="number">128</span>)</span><br><span class="line">        self.state = <span class="literal">None</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;N = <span class="subst">&#123;self.N&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">keygen</span>(<span class="params">self</span>):</span><br><span class="line">        P = getPrime(<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            q = getPrime(<span class="number">256</span>)</span><br><span class="line">            <span class="keyword">if</span> is_prime(<span class="number">2</span>*q-<span class="number">1</span>):</span><br><span class="line">                Q = <span class="number">2</span>*q^<span class="number">2</span>-q</span><br><span class="line">                <span class="keyword">return</span> P*Q</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setState</span>(<span class="params">self, x0, y0</span>):</span><br><span class="line">        self.state = self.E(x0, y0)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next</span>(<span class="params">self</span>):</span><br><span class="line">        self.state = <span class="number">4</span>*self.state</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(self.state.xy()[<span class="number">0</span>])+self.bias</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">v2l</span>(<span class="params">v</span>):</span><br><span class="line">    tp = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> v:</span><br><span class="line">        tp.append(item.<span class="built_in">list</span>())</span><br><span class="line">    <span class="keyword">return</span> tp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Sample</span>(<span class="params">eta, num, signal=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> signal:</span><br><span class="line">        random.seed(prng.<span class="built_in">next</span>())</span><br><span class="line">    s = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; eta:</span><br><span class="line">            s.append(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            s.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> Rq(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">P</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, A, s, t</span>):</span><br><span class="line">        self.A = A</span><br><span class="line">        self.s = s</span><br><span class="line">        self.t = t</span><br><span class="line">        self.y = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generateCommit</span>(<span class="params">self, Verifier</span>):</span><br><span class="line">        self.y = vector(Rq, [Sample(<span class="number">0.3</span>, N, <span class="number">1</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(m)])</span><br><span class="line">        w = self.A * self.y</span><br><span class="line">        Verifier.w = w</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;w = <span class="subst">&#123;w.<span class="built_in">list</span>()&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generateProof</span>(<span class="params">self, Verifier, c</span>):</span><br><span class="line">        z = self.s*c + self.y</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;z = <span class="subst">&#123;v2l(z)&#125;</span>&quot;</span>)</span><br><span class="line">        Verifier.verifyProof(z)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">V</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, A, t</span>):</span><br><span class="line">        self.A = A</span><br><span class="line">        self.t = t</span><br><span class="line">        self.w = <span class="literal">None</span></span><br><span class="line">        self.c = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">challenge</span>(<span class="params">self, Prover</span>):</span><br><span class="line">        self.c = Sample(<span class="number">0.3</span>, N)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;c = <span class="subst">&#123;self.c.<span class="built_in">list</span>()&#125;</span>&quot;</span>)</span><br><span class="line">        Prover.generateProof(self, self.c)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verifyProof</span>(<span class="params">self, z</span>):</span><br><span class="line">        <span class="keyword">if</span> self.A*z == self.t*self.c + self.w:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Protocol</span>(<span class="params">A, secret, t</span>):</span><br><span class="line">    prover = P(A, secret, t)</span><br><span class="line">    verifier = V(A, t)</span><br><span class="line">    prover.generateCommit(verifier)</span><br><span class="line">    verifier.challenge(prover)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        signal.alarm(<span class="number">120</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ECPRNG init ...&quot;</span>)</span><br><span class="line">        prng = ECPrng()</span><br><span class="line">        x0, y0 = <span class="built_in">input</span>(<span class="string">&quot;PLZ SET PRNG SEED &gt; &quot;</span>).split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        prng.setState(<span class="built_in">int</span>(x0), <span class="built_in">int</span>(y0))</span><br><span class="line">        N, q, m = (<span class="number">256</span>, <span class="number">4197821</span>, <span class="number">15</span>)</span><br><span class="line">        PRq.&lt;a&gt; = PolynomialRing(Zmod(q))</span><br><span class="line">        Rq = PRq.quotient(a^N + <span class="number">1</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        A = vector(Rq, [Rq.random_element() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(m)])</span><br><span class="line">        secret = vector(Rq, [Sample(<span class="number">0.3</span>, N) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(m)])</span><br><span class="line">        t = A*secret</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;A = <span class="subst">&#123;v2l(A)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;t = <span class="subst">&#123;t.<span class="built_in">list</span>()&#125;</span>&quot;</span>)</span><br><span class="line">        Protocol(A, secret, t)</span><br><span class="line">        cipher = AES.new(md5(<span class="built_in">str</span>(secret).encode()).digest(), mode=AES.MODE_ECB)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ct = <span class="subst">&#123;cipher.encrypt(pad(FLAG.encode(), <span class="number">16</span>)).<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;error!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>e20k，0k代表零知识证明(Zero-Knowledge Proof)，简要一点说的话，零知识证明就是<strong>一方向另一方证明他知道某个问题的答案，但在证明过程中却不透露答案的任何信息。</strong>对于零知识证明，有一篇描述的很通俗的科普类的文章可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144847471">零知识证明Zero-Knowledge Proof介绍 - 知乎 (zhihu.com)</a></p>
<p>而本题就围绕着一个零知识证明的协议展开，接下来梳理一下题目流程。</p>
<p>连接上靶机后，题目首先会生成一个基于ECC的PRNG，其方程为：</p>
<script type="math/tex; mode=display">
y^2 = x^3 + 3ax + b \quad(mod\;N)</script><p>其中N由三个素数组成，并且满足：</p>
<script type="math/tex; mode=display">
N = pqr</script><script type="math/tex; mode=display">
r = 2q-1</script><p>然后需要我们提供曲线上的一个点P作为初始state，后续更新state的方式为：</p>
<script type="math/tex; mode=display">
P = 4P</script><p>然后用这个PRNG取伪随机数的方式，是取P点的横坐标并加上一个2^128以下的未知的固定偏差bias。</p>
<p>这个ECPRNG初始化完毕后，题目生成一个商环如下：</p>
<script type="math/tex; mode=display">
R_q = \frac{Z_q[x]}{x^N+1}</script><p>其中的参数是已知的，分别是(注意与ECPRNG里的q和N区分开)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N, q, m = (<span class="number">256</span>, <span class="number">4197821</span>, <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<p>其中m表示后面的向量长度。</p>
<p>然后题目会生成两个向量A和secret，这里写个例子应该更清晰一点，因为我自己做这个题目的时候就很昏。</p>
<p>具体来说，A是一个如下的长为15的向量：</p>
<script type="math/tex; mode=display">
A = (A_1,A_2,A_3,...,A_{15})</script><p>其中每个元素Ai是Rq中的随机多项式，长这个样子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">356602</span>*x^<span class="number">255</span> + <span class="number">4017611</span>*x^<span class="number">254</span> + <span class="number">3758030</span>*x^<span class="number">253</span> + ... + <span class="number">3299775</span>*x^<span class="number">2</span> + <span class="number">874450</span>*x + <span class="number">4059361</span></span><br></pre></td></tr></table></figure>
<p>而secret是一个用Sample生成的长为15的向量(signal=0)：</p>
<script type="math/tex; mode=display">
secret = (s_1,s_2,s_3,...,s_{15})</script><p>其中每个元素si是Rq中的系数仅有01，且1占比约为0.3的多项式，长这个样子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x^<span class="number">253</span> + x^<span class="number">252</span> + x^<span class="number">250</span> + ... + x^<span class="number">5</span> + x^<span class="number">3</span> + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>然后靶机计算向量A和secret的内积，记为t，也就是：</p>
<script type="math/tex; mode=display">
t = \mathbf{A} \cdot \mathbf{secret}</script><p>但secret靶机是不会给我们的，因为其md5值会作为后来AES加密flag的密钥，但是靶机会给到我们A和t。在这之后，题目就会进入到本题的零知识证明的协议中，具体来说如下：</p>
<p>首先，证明方(prover)生成一个同样用Sample生成的长为15的向量y(与secret区别在于signal=1)，计算出A和y的内积w，并同时给到我们和验证方：</p>
<script type="math/tex; mode=display">
w = \mathbf{A} \cdot \mathbf{y}</script><p>在此之后，验证方(verifier)进行一次challenge(也就是零知识证明中，验证方要求证明方证明他拥有正确答案而发起的挑战)，challenge的内容是，生成一个用Sample生成的多项式c(和secret中每个元素的生成方式相同，signal=0)，并给到我们和证明方。证明方接收到本次挑战中的c后，需要用如下方式计算出一个向量z：</p>
<script type="math/tex; mode=display">
\mathbf{z} = c*\mathbf{secret} + \mathbf{y}</script><p>z也就可以说是证明方的证明材料，证明方将z发送给我们和验证方，验证方通过验证：</p>
<script type="math/tex; mode=display">
\mathbf{A} \cdot \mathbf{z} = tc + w</script><p>来检验证明方是否真的知道secret的值。</p>
<p>简单说一下这个零知识证明的协议为什么正确，我们将上方的式子代入到最后一个表达式中，就有：</p>
<script type="math/tex; mode=display">
\mathbf{A} \cdot (c*\mathbf{secret} + \mathbf{y}) = (\mathbf{A} \cdot \mathbf{secret})c + (\mathbf{A} \cdot \mathbf{y})</script><p>所以其正确性是显然的，这说明证明方的确知道secret，否则z会是错误的。而证明方发送给验证方的消息有z和w。w很明显没有泄露secret的任何信息，而显然也没有办法通过向量z计算出secret，所以可以认为，证明方没有泄露任何有关secret的信息。这也就满足了我们刚才提到的零知识证明的目的：</p>
<blockquote>
<p>一方向另一方证明他知道某个问题的答案，但在证明过程中却不透露答案的任何信息。</p>
</blockquote>
<p>整个协议结束后，靶机将flag用secret的md5值作为AES密钥进行加密，并给出密文。因此，我们的任务就是在上述全部题目流程中，找到可利用点，从而计算出secret的值去进行AES解密。这大概可以分为以下几步：</p>
<h4 id="获取ECC上的点"><a href="#获取ECC上的点" class="headerlink" title="获取ECC上的点"></a>获取ECC上的点</h4><p>从上面的题目流程可以知道，我们需要提供一个ECC上的点用于初始化state。然而这个ECC是在模N下的，难以求解其上的二次剩余，所以也就很难得到其上某个点的坐标，因此我们第一步就是要分解N，而分解N的利用点就在于其三个素数的生成方式：</p>
<script type="math/tex; mode=display">
N = pqr</script><script type="math/tex; mode=display">
r = 2q-1</script><p>也就是：</p>
<script type="math/tex; mode=display">
N = pq(2q-1)</script><p>敏锐一点的话可以看出其实能构造出一个更合理的形式：</p>
<script type="math/tex; mode=display">
2N = p2q(2q-1)</script><p>而r也是个素数，所以式子用p、r来表示可以写作：</p>
<script type="math/tex; mode=display">
2N = p(r+1)r</script><p>到这里就和sus那个题目的分解方式一模一样了，只是：</p>
<script type="math/tex; mode=display">
r^2 + r + 1 \rightarrow r + 1</script><p>所以也就是从构造一个阶为r^3-1的乘法群，变到构造一个阶为r^2-1的乘法群而已。具体分解过程可以见：</p>
<p><a href="https://tangcuxiaojikuai.xyz/post/ea445335.html">Crypto趣题-RSA(一) | 糖醋小鸡块的blog (tangcuxiaojikuai.xyz)</a></p>
<p>得到N的分解后，我们就可以在以下三个曲线上分别找点，并crt起来就能得到题目里模N下的ECC上的点了。</p>
<h4 id="利用next"><a href="#利用next" class="headerlink" title="利用next"></a>利用next</h4><p>next的过程是：</p>
<script type="math/tex; mode=display">
P = 4P</script><p>而如果我们能找到一个阶为3的点的话，那么就有：</p>
<script type="math/tex; mode=display">
4P = 3P + P = O + P = P</script><p>就能达到一个目的：每次得到的随机数都相同，而如果每次生成的随机数均相同的话，对于Sample用signal=1生成的向量y来说，由于signal为1时会用next设置种子，因此y中的15个元素均是相同值。</p>
<p>而为了找到模N曲线下阶为3的点P，我们只需要在三条子曲线上分别找到阶为3的点，并crt起来就可以得到所需要的阶为3的P点。而在子曲线上找阶为3的点也很简单，以在模p的曲线上为例，我们只需要先找到其上的一个生成元Gp，并计算：</p>
<script type="math/tex; mode=display">
P_p = \frac{order_{Ep}}{3}G_p</script><p>就可以得到模p曲线上阶为3的点了，但这就要求Ep的阶有3这个因子。同理，Eq、Er的阶必须都要有3，我们才能找到需要的点P。因此我们成功的概率仅有1/27，不满足时就要刷掉重来。</p>
<p>得到这样的P点后，y向量虽然未知，但是我们能知道的一点是：y向量中的15个元素全是相同的。</p>
<h4 id="求y"><a href="#求y" class="headerlink" title="求y"></a>求y</h4><p>因为y中15个元素均相同，记为y0，这时候再回看刚才的w的计算过程：</p>
<script type="math/tex; mode=display">
w = \mathbf{A} \cdot \mathbf{y}</script><p>展开写这个向量内积，也就是：</p>
<script type="math/tex; mode=display">
w = A_1y_0 + A_2y_0 + A_3y_0 + ... + A_{15}y_0</script><p>也就是：</p>
<script type="math/tex; mode=display">
w = y_0(A_1+A_2+A_3+...+A_{15})</script><p>而我们又有w和A，因此就可以求出y0的值，也就得到了整个y向量。</p>
<h4 id="求secret"><a href="#求secret" class="headerlink" title="求secret"></a>求secret</h4><p>有y向量后，由于我们知道z向量的值以及其计算方式：</p>
<script type="math/tex; mode=display">
\mathbf{z} = c*\mathbf{secret} + \mathbf{y}</script><p>所以直接就能得到secret值了。得到secret后就能求md5得到AES密钥，进而解密得到flag。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Pwn4Sage.pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> crt</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    sh = remote(<span class="string">&quot;node4.anna.nssctf.cn&quot;</span>,<span class="number">28855</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">b&quot;N = &quot;</span>)</span><br><span class="line">    N = <span class="built_in">int</span>(sh.recvline().strip().decode())</span><br><span class="line"></span><br><span class="line">    <span class="comment">#part1 factor N</span></span><br><span class="line">    n = <span class="number">2</span>*N  <span class="comment"># n = r(r+1)p</span></span><br><span class="line">    R = Zmod(N)[<span class="string">&quot;x&quot;</span>]</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        Q = R.quo(R.random_element(<span class="number">2</span>))</span><br><span class="line">        r = GCD(ZZ(<span class="built_in">list</span>(Q.random_element() ^ n)[<span class="number">1</span>]), N)</span><br><span class="line">        <span class="keyword">if</span>(r != <span class="number">1</span>):</span><br><span class="line">            q = (r+<span class="number">1</span>) // <span class="number">2</span></span><br><span class="line">            p = N // q // r</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#part2 get a point whose order is 3</span></span><br><span class="line">    Ep = EllipticCurve(Zmod(p),[<span class="number">3</span>,<span class="number">7</span>])</span><br><span class="line">    Eq = EllipticCurve(Zmod(q),[<span class="number">3</span>,<span class="number">7</span>])</span><br><span class="line">    Er = EllipticCurve(Zmod(r),[<span class="number">3</span>,<span class="number">7</span>])</span><br><span class="line">    Ep_ord = Ep.order()</span><br><span class="line">    <span class="keyword">if</span>(Ep_ord % <span class="number">3</span> != <span class="number">0</span>):</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not this time&quot;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    Eq_ord = Eq.order()</span><br><span class="line">    <span class="keyword">if</span>(Eq_ord % <span class="number">3</span> != <span class="number">0</span>):</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not this time&quot;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    Er_ord = Er.order()</span><br><span class="line">    <span class="keyword">if</span>(Er_ord % <span class="number">3</span> != <span class="number">0</span>):</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not this time&quot;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    Ep_G = Ep.gens()[<span class="number">0</span>]*(Ep_ord//<span class="number">3</span>)</span><br><span class="line">    Eq_G = Eq.gens()[<span class="number">0</span>]*(Eq_ord//<span class="number">3</span>)</span><br><span class="line">    Er_G = Er.gens()[<span class="number">0</span>]*(Er_ord//<span class="number">3</span>)</span><br><span class="line">    xlist = [<span class="built_in">int</span>(Ep_G[<span class="number">0</span>]),<span class="built_in">int</span>(Eq_G[<span class="number">0</span>]),<span class="built_in">int</span>(Er_G[<span class="number">0</span>])]</span><br><span class="line">    ylist = [<span class="built_in">int</span>(Ep_G[<span class="number">1</span>]),<span class="built_in">int</span>(Eq_G[<span class="number">1</span>]),<span class="built_in">int</span>(Er_G[<span class="number">1</span>])]</span><br><span class="line">    modlist = [p,q,r]</span><br><span class="line">    E_x = crt(modlist,xlist)[<span class="number">0</span>]</span><br><span class="line">    E_y = crt(modlist,ylist)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">b&quot;PLZ SET PRNG SEED &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(E_x).encode()+<span class="string">b&quot;,&quot;</span>+<span class="built_in">str</span>(E_y).encode())</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part3 get data</span></span><br><span class="line">N, q, m = (<span class="number">256</span>, <span class="number">4197821</span>, <span class="number">15</span>)</span><br><span class="line">PRq.&lt;a&gt; = PolynomialRing(Zmod(q))</span><br><span class="line">Rq = PRq.quotient(a^N + <span class="number">1</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;A = &quot;</span>)</span><br><span class="line">A = ast.literal_eval(sh.recvline().strip().decode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;t = &quot;</span>)</span><br><span class="line">t = ast.literal_eval(sh.recvline().strip().decode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;w = &quot;</span>)</span><br><span class="line">w = ast.literal_eval(sh.recvline().strip().decode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;c = &quot;</span>)</span><br><span class="line">c = ast.literal_eval(sh.recvline().strip().decode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;z = &quot;</span>)</span><br><span class="line">z = ast.literal_eval(sh.recvline().strip().decode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;ct = &quot;</span>)</span><br><span class="line">ct = long_to_bytes(<span class="built_in">int</span>(sh.recvline().strip().decode(),<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">A = vector(Rq, [Rq(Ai) <span class="keyword">for</span> Ai <span class="keyword">in</span> A])</span><br><span class="line">t = Rq(t)</span><br><span class="line">w = Rq(w)</span><br><span class="line">c = Rq(c)</span><br><span class="line">z = vector(Rq, [Rq(zi) <span class="keyword">for</span> zi <span class="keyword">in</span> z])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part4 get y and then get secret</span></span><br><span class="line">sum_A = Rq(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> Ai <span class="keyword">in</span> A:</span><br><span class="line">    sum_A += Ai</span><br><span class="line">y = w*sum_A^(-<span class="number">1</span>)</span><br><span class="line">secret = vector(Rq,[(z[i]-y)*c^(-<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(z))])</span><br><span class="line">cipher = AES.new(md5(<span class="built_in">str</span>(secret).encode()).digest(), mode=AES.MODE_ECB)</span><br><span class="line">flag = cipher.decrypt(ct)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#NSSCTF&#123;0c4a79b9-545f-484b-9f99-e040c2bd0dc9&#125;</span></span><br></pre></td></tr></table></figure>
<p>看了maple的博客了解到，其实不需要这个w也能做。这是因为当y相同时，将z向量中的每个元素均与最后一个元素作差，就能消去y的影响。然后接下来就有很多做法，比如由于s是仅由01构成的向量，因此可以通过得到的差值向量的系数看出secret对应幂次的项的系数，然后通过多组统计就能得到secret的完整值；又或者再联立t的产生式子，直接求出差向量过后就可以求出A的和然后解出secret。后面这个方法也就是原题flag中提到的RSIS的解决思路了。</p>
<p>此外还看到几个比较有趣的点：</p>
<ul>
<li>在利用next那个步骤中，我们其实也可以求阶为5的P点，这是因为当阶为5时，有：</li>
</ul>
<script type="math/tex; mode=display">
4P = 5P - P = O - P = -P</script><ul>
<li><p>而P和-P的横坐标是相同的，所以ECPRNG产生的所有伪随机数仍然相同</p>
</li>
<li><p>商环下的多项式卷积运算应该是可以写成矩阵形式的，因此可能可以造格，然后用LLL直接规约出secret。但问题在于格的维度太大且q(4197821)不够大所以没有特别好的效果</p>
</li>
</ul>
<p><br></p>
<p><br></p>
<h3 id="shamir-for-dummies"><a href="#shamir-for-dummies" class="headerlink" title="shamir-for-dummies"></a>shamir-for-dummies</h3><p>题目来源：b01lersCTF 2024</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> getPrime, isPrime, bytes_to_long, long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">polynomial_evaluation</span>(<span class="params">coefficients, x</span>):</span><br><span class="line">	at_x = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(coefficients)):</span><br><span class="line">		at_x += coefficients[i] * (x ** i)</span><br><span class="line">		at_x = at_x % p</span><br><span class="line">	<span class="keyword">return</span> at_x</span><br><span class="line"></span><br><span class="line">flag = <span class="string">b&#x27;bctf&#123;REDACTED&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Thanks for coming in. I can really use your help.\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Like I said, my friend can only do additions. He technically can do division but he says he can only do it once a day.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;I need to share my secret using Shamir secret sharing. Can you craft the shares, in a way that my friend can recover it?\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Don&#x27;t worry, I have the polynomial and I will do all the math for you.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">s = bytes_to_long(flag)</span><br><span class="line"></span><br><span class="line">n = getPrime(<span class="number">4</span>)</span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> p % n != <span class="number">1</span>:</span><br><span class="line">    p = getPrime(<span class="number">512</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s use \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;n =&quot;</span>, n)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;k =&quot;</span>, n)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;p =&quot;</span>, p)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">coefficients = [s]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n):</span><br><span class="line">	coefficients.append(random.randint(<span class="number">2</span>, p-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Okay, I have my polynomial P(X) ready. Let me know when you are ready to generate shares with me.\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">evaluation_points = []</span><br><span class="line">shares = []</span><br><span class="line"></span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> count &lt; n+<span class="number">1</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Evaluate P(X) at X_&#123;0&#125; =&quot;</span>.<span class="built_in">format</span>(count))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&gt; &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">	eval_point = <span class="built_in">int</span>(<span class="built_in">input</span>())</span><br><span class="line">	<span class="keyword">if</span> eval_point % p == <span class="number">0</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Lol, nice try. Bye.&quot;</span>)</span><br><span class="line">		exit()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">elif</span> eval_point &lt; <span class="number">0</span> <span class="keyword">or</span> eval_point &gt; p:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s keep things in mod p. Please choose it again.&quot;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">if</span> eval_point <span class="keyword">not</span> <span class="keyword">in</span> evaluation_points:</span><br><span class="line">			evaluation_points.append(eval_point)</span><br><span class="line">			share = polynomial_evaluation(coefficients, eval_point)</span><br><span class="line">			shares.append(share)</span><br><span class="line">			count += <span class="number">1</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;You used that already. Let&#x27;s use something else!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Nice! Let&#x27;s make sure we have enough shares.\n&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(shares) == n</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(evaluation_points) == n</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;It looks like we do.\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;By the way, would he have to divide with anything? (Put 1 if he does not have to)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&gt; &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">some_factor = <span class="built_in">int</span>(<span class="built_in">input</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Good. Let&#x27;s send those over to him.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">	time.sleep(<span class="number">1</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">sum_of_shares = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s_i <span class="keyword">in</span> shares:</span><br><span class="line">	sum_of_shares += s_i</span><br><span class="line">	sum_of_shares = sum_of_shares % p</span><br><span class="line"></span><br><span class="line">sum_of_shares_processed = (sum_of_shares * <span class="built_in">pow</span>(some_factor, -<span class="number">1</span>, p)) % p</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sum_of_shares_processed == s:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Yep, he got my secret message!\n&quot;</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;The shares P(X_i)&#x27;s were&#x27;:&quot;</span>)</span><br><span class="line">	<span class="built_in">print</span>(shares)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;... Oh no. I think now you&#x27;d know the secret also... Thanks again though.&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Sorry, it looks like that didn&#x27;t work :(&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>题目流程有点长，简单说一说：</p>
<ul>
<li>连接上靶机后，题目随机生成512bit的素数p，以及4bit的素数n，保证p-1是n的倍数</li>
<li>以p为模数，生成一个度为n-1的多项式，其中常数项是secret的值，其余系数为未知随机值</li>
<li>可以与靶机交互，输入n个互不相同的横坐标，靶机会计算输入横坐标对应的多项式值(这里注意偷鸡是不可能的，限制死了只能输入互不相同的0-p的值，并且不能是0和p)</li>
<li>在n个点输入完毕后，靶机并不会返回给我们所有点对(否则就可以直接拉格朗日插值)，而是会计算所有纵坐标的和，记为sum of shares</li>
<li>允许我们输入一个数字some_factor，靶机计算如下值，如果该值与secret相等则会给我们所有点对，由于可以拉格朗日插值，所以满足这个条件也就等价于给了我们flag：</li>
</ul>
<script type="math/tex; mode=display">
(sum\;of\;shares)(some\;factor)^{-1} \quad(mod\;p)</script><p>那么现在问题就是：如何构造输入点的横坐标与最后的some_factor，去使得上述计算结果恰好为未知的常数项？</p>
<p>不妨回顾一下shamir密钥分享重建多项式的本质。对于一个度为n-1的多项式，如果能有n个互不相同的点对，那么可以通过解如下矩阵方程得到所有系数ai：</p>
<script type="math/tex; mode=display">
\left(\begin{matrix}
1 & x_1 & x_1^2 & \cdots & x_1^{n-1}\\
1 & x_2 & x_2^2 & \cdots & x_2^{n-1}\\
\vdots & \vdots &\vdots & \ddots &\vdots \\

1 & x_n & x_n^2 & \cdots & x_n^{n-1}\\
\end{matrix}\right)
\left(\begin{matrix}
s\\
a_1\\
\vdots \\

a_{n-1}\\
\end{matrix}\right)
=
\left(\begin{matrix}
f(x_1)\\
f(x_2)\\
\vdots \\

f(x_n)\\
\end{matrix}\right)</script><p>而对于题目来说，其计算的是所有纵坐标的和，也就等价于：</p>
<script type="math/tex; mode=display">
sum\;of\;shares
=
(1 , 1 , \cdots , 1)
\left(\begin{matrix}
f(x_1)\\
f(x_2)\\
\vdots \\

f(x_n)\\
\end{matrix}\right)
=
(1 , 1 , \cdots , 1)
\left(\begin{matrix}
1 & x_1 & x_1^2 & \cdots & x_1^{n-1}\\
1 & x_2 & x_2^2 & \cdots & x_2^{n-1}\\
\vdots & \vdots &\vdots & \ddots &\vdots \\

1 & x_n & x_n^2 & \cdots & x_n^{n-1}\\
\end{matrix}\right)
\left(\begin{matrix}
s\\
a_1\\
\vdots \\

a_{n-1}\\
\end{matrix}\right)</script><p>也就可以写成：</p>
<script type="math/tex; mode=display">
sum\;of\;shares
=
(1 , 1 , \cdots , 1)
\left(\begin{matrix}
1 & x_1 & x_1^2 & \cdots & x_1^{n-1}\\
1 & x_2 & x_2^2 & \cdots & x_2^{n-1}\\
\vdots & \vdots &\vdots & \ddots &\vdots \\

1 & x_n & x_n^2 & \cdots & x_n^{n-1}\\
\end{matrix}\right)
\left(\begin{matrix}
s\\
a_1\\
\vdots \\

a_{n-1}\\
\end{matrix}\right)
=
(n , \sum{x_i}, \sum{x_i^2} ,\cdots , \sum{x_i^{n-1}})
\left(\begin{matrix}
s\\
a_1\\
\vdots \\

a_{n-1}\\
\end{matrix}\right)</script><p>最终也就等于：</p>
<script type="math/tex; mode=display">
sum\;of\;shares
=
ns + a_1\sum{x_i} + a_2\sum{x_i^2} +  ... + a_{n-1}\sum{x_i^{n-1}}</script><p>可以看出，无论我们选的n个横坐标的值究竟是多少，ns这个值永远是存在的，这也侧面说明对于some factor应该选择n才能得到s项。而要使得最终结果是ns，就要使剩余的所有和加起来模p下为0，而显然如果能使每个幂次和加起来均为0的话显然能使这一点成立。</p>
<p>而由于费马小定理的存在，a^(p-1)在模p下总是为1，因此我考虑简单构造等比数列。比如我取：</p>
<script type="math/tex; mode=display">
x_i = (2^{\frac{p-1}{n}})^i</script><p>那么此时，对于所有幂次为1的和就有：</p>
<script type="math/tex; mode=display">
\sum{x_i} = 1 + 2^{\frac{p-1}{n}} + (2^{\frac{p-1}{n}})^2 + ... + (2^{\frac{p-1}{n}})^{n-1}</script><p>这是个公比为2^(p-1/n)的等比数列求和，其公式为：</p>
<script type="math/tex; mode=display">
\sum{x_i} = \frac{1(1 - (2^{\frac{p-1}{n}})^n)}{1 - 2^{\frac{p-1}{n}}} = 0</script><p>同理可以验证剩余所有幂次和也均为0，所以就达到了目的。并且返回点对后也不需要再插值了，计算其和并自己求n的逆元相乘就得到flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&quot;gold.b01le.rs&quot;</span>, <span class="number">5006</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">b&quot;n = &quot;</span>)</span><br><span class="line">n = <span class="built_in">int</span>(sh.recvline().strip().decode())</span><br><span class="line">sh.recvuntil(<span class="string">b&quot;p = &quot;</span>)</span><br><span class="line">p = <span class="built_in">int</span>(sh.recvline().strip().decode())</span><br><span class="line"></span><br><span class="line">ttt = (p - <span class="number">1</span>) // n</span><br><span class="line">tt = <span class="built_in">pow</span>(<span class="number">2</span>, ttt, p)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n): </span><br><span class="line">    sh.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">pow</span>(tt, i, p)).encode())</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">sh.sendline(<span class="built_in">str</span>(n).encode())</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">b&quot;The shares P(X_i)&#x27;s were&#x27;:\n&quot;</span>)</span><br><span class="line">datas = <span class="built_in">eval</span>(sh.recvline().decode())</span><br><span class="line">res = <span class="built_in">sum</span>(datas)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes((res * inverse(n, p)) % p))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#bctf&#123;P0LYN0m14l_1N_M0d_P_12_73H_P0W3Rh0u23_0F_73H_5h4M1r&#125;</span></span><br></pre></td></tr></table></figure>
<p>不过在看了休息师傅n次单位根的思路后：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_52640415/article/details/137886438?spm=1001.2014.3001.5502">b01lers CTF 2024] crypto/pwn 部分-CSDN博客</a></p>
<p>突然意识到这题还有更有趣的数学道理在里面，下面来阐述一下。</p>
<p>首先，对于模p下的n次单位根，sage可以用如下方式求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = GF(p)(<span class="number">1</span>).nth_root(n, <span class="built_in">all</span>=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>但是求解他的意义在哪里呢？这就是因为n次单位根的所有幂次和均为0，很容易就满足了我们刚才的要求，具体原因见下。</p>
<p>将n个n次单位根分别记为xi，那么利用这些单位根可以写出如下因式分解：</p>
<script type="math/tex; mode=display">
x^n - 1 = (x-x_1)(x-x_2)...(x-x_n) \quad(mod\;p)</script><p>而由于等式两侧相同，因此等式两侧对应的所有多项式幂次前的系数均相同。也就是说，左侧x^1,x^2,…x^(n-1)的系数均为0，那么右侧对应幂次也应该均为0。</p>
<p>所以把右侧展开，可以轻松得到第一个幂次和为0的事实：</p>
<script type="math/tex; mode=display">
\sum{x_i} = 0</script><p>但是似乎并不能直接推出其他次方的幂次和也为0：</p>
<script type="math/tex; mode=display">
\sum{x_i}^k = 0 \quad(2 \leq k \leq n-1)</script><p>但是可以利用牛顿恒等式间接推出这个事实。关于牛顿恒等式的相关知识我在之前TPCTF的wp中有简单讲到：</p>
<p><a href="https://tangcuxiaojikuai.xyz/post/df537e5d.html">2023-TPCTF-wp-crypto | 糖醋小鸡块的blog (tangcuxiaojikuai.xyz)</a></p>
<p>此处我们依然关注的是如下定理的应用：</p>
<p><img src="/post/97bbcbc9/image-20240418114003579.png" alt="image-20240418114003579"></p>
<p>将这些符号与本题对应起来，P(x)其实就是x^n-1，其n个根就是上面的所有n次单位根xi，而对这个式子的右侧多项式展开：</p>
<script type="math/tex; mode=display">
x^n - 1 = (x-x_1)(x-x_2)...(x-x_n) \quad(mod\;p)</script><p>可以发现其x^k的对应系数就是上图的ek，而由于等式两侧多项式对应幂次前系数需对应相等的缘故，所以ek(0&lt;k&lt;n)也均为0。同时由于P1我们已经知道其为0了，所以这样往上递推就可以得到n次单位根的所有幂次和都为0的事实。</p>
<p>但是还可以进一步延申，因为有限域中的n次单位根其实构成一个循环群，并且其实显然可以发现，对于任意如下形式的t：</p>
<script type="math/tex; mode=display">
t = a^{\frac{p-1}{n}}</script><p>t都是n次单位根(因为显然有t^n=1)。因此当t是该循环群的生成元时，两种做法本质上是完全相同的，可以用如下示例程序简单验证：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = getPrime(<span class="number">4</span>)</span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> p % n != <span class="number">1</span>:</span><br><span class="line">    p = getPrime(<span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(p))</span><br><span class="line">f = PR.random_element(degree=n)</span><br><span class="line"></span><br><span class="line">res = <span class="built_in">set</span>(GF(p)(<span class="number">1</span>).nth_root(n, <span class="built_in">all</span>=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">T = []</span><br><span class="line">tt = <span class="built_in">pow</span>(<span class="number">2</span>,(p-<span class="number">1</span>)//n,p)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    T.append(<span class="built_in">pow</span>(tt,i,p))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">set</span>(T) == res)</span><br></pre></td></tr></table></figure>
<p>有一定概率输出false，此时是因为tt恰好等于1的缘故。</p>
<p><br></p>
<p><br></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>糖醋小鸡块
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tangcuxiaojikuai.xyz/post/97bbcbc9.html" title="Crypto趣题-其他">https://tangcuxiaojikuai.xyz/post/97bbcbc9.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sacreative/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SACREATIVE</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/342113ee.html" rel="prev" title="Crypto趣题-剪枝">
      <i class="fa fa-chevron-left"></i> Crypto趣题-剪枝
    </a></div>
      <div class="post-nav-item">
    <a href="/post/601c0957.html" rel="next" title="Crypto趣题-Oracle">
      Crypto趣题-Oracle <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Shamir%E9%97%A8%E9%99%90"><span class="nav-number">1.</span> <span class="nav-text">Shamir门限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sqrt"><span class="nav-number">2.</span> <span class="nav-text">sqrt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prng-%E5%8A%A0%E5%BC%BA%E7%89%88"><span class="nav-number">3.</span> <span class="nav-text">prng(加强版)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ahead"><span class="nav-number">4.</span> <span class="nav-text">ahead</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#e20k"><span class="nav-number">5.</span> <span class="nav-text">e20k</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96ECC%E4%B8%8A%E7%9A%84%E7%82%B9"><span class="nav-number">5.1.</span> <span class="nav-text">获取ECC上的点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8next"><span class="nav-number">5.2.</span> <span class="nav-text">利用next</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%82y"><span class="nav-number">5.3.</span> <span class="nav-text">求y</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%82secret"><span class="nav-number">5.4.</span> <span class="nav-text">求secret</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shamir-for-dummies"><span class="nav-number">6.</span> <span class="nav-text">shamir-for-dummies</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="糖醋小鸡块"
      src="/images/image.png">
  <p class="site-author-name" itemprop="name">糖醋小鸡块</p>
  <div class="site-description" itemprop="description">"追风赶月莫停留，平芜尽处是春山"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/1142381085@qq.com" title="E-Mail → 1142381085@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6394335993" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6394335993" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">糖醋小鸡块</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'UPEMA7DyYbIIEyOW72ohgytU-gzGzoHsz',
      appKey     : 'M7rXAfeP3JOslroay2n0Jv2R',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
<!-- 引入jQuery -->
<script type="text/javascript" src="//libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<!-- 雪花特效2 -->
<script type="text/javascript" src="/js/snow2.js"></script>
