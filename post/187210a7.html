<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_small.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="RnN18ZogmZl_dLVpxZ6y8kjKL73Mu9VLVEkw9d3qrq0" />
  <meta name="msvalidate.01" content="DC3050AD55F30DDF75AAB78517714910" />
  <meta name="baidu-site-verification" content="codeva-PPofu3dNxe" />

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-loading-bar.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tangcuxiaojikuai.xyz","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="该文章主要记录一些曲线相关的趣题">
<meta property="og:type" content="article">
<meta property="og:title" content="Crypto趣题-曲线">
<meta property="og:url" content="https://tangcuxiaojikuai.xyz/post/187210a7.html">
<meta property="og:site_name" content="糖醋小鸡块的blog">
<meta property="og:description" content="该文章主要记录一些曲线相关的趣题">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/187210a7/image-20230930114139546.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/187210a7/image-20230930114719034.png">
<meta property="article:published_time" content="2023-09-29T01:54:01.000Z">
<meta property="article:modified_time" content="2024-02-23T02:20:35.826Z">
<meta property="article:author" content="糖醋小鸡块">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tangcuxiaojikuai.xyz/post/187210a7/image-20230930114139546.png">

<link rel="canonical" href="https://tangcuxiaojikuai.xyz/post/187210a7.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Crypto趣题-曲线 | 糖醋小鸡块的blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">糖醋小鸡块的blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tangcuxiaojikuai.xyz/post/187210a7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/image.png">
      <meta itemprop="name" content="糖醋小鸡块">
      <meta itemprop="description" content=""追风赶月莫停留，平芜尽处是春山"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="糖醋小鸡块的blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Crypto趣题-曲线
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-29 09:54:01" itemprop="dateCreated datePublished" datetime="2023-09-29T09:54:01+08:00">2023-09-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-23 10:20:35" itemprop="dateModified" datetime="2024-02-23T10:20:35+08:00">2024-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/crypto%E8%B6%A3%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">crypto趣题</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/187210a7.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/187210a7.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>该文章主要记录一些曲线相关的趣题</p>
<span id="more"></span>
<h3 id="EdRSA"><a href="#EdRSA" class="headerlink" title="EdRSA"></a>EdRSA</h3><p>题目来源：暂不明确</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sagemath</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secrets <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">P, Q</span>):</span><br><span class="line">    (x1, y1) = P</span><br><span class="line">    (x2, y2) = Q</span><br><span class="line"></span><br><span class="line">    x3 = (x1*y2 + y1*x2) * inverse(<span class="number">1</span> + d*x1*x2*y1*y2, p) % p</span><br><span class="line">    y3 = (y1*y2 - a*x1*x2) * inverse(<span class="number">1</span> - d*x1*x2*y1*y2, p) % p</span><br><span class="line">    <span class="keyword">return</span> (x3, y3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">x, P</span>):</span><br><span class="line">    Q = (<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> x &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            Q = add(Q, P)</span><br><span class="line">        P = add(P, P)</span><br><span class="line">        x = x &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> Q</span><br><span class="line"></span><br><span class="line">p = <span class="number">64141017538026690847507665744072764126523219720088055136531450296140542176327</span></span><br><span class="line">a = <span class="number">362</span></span><br><span class="line">d = <span class="number">7</span></span><br><span class="line">gx=bytes_to_long(flag)</span><br><span class="line">PR.&lt;y&gt;=PolynomialRing(Zmod(p))</span><br><span class="line">f=(d*gx^<span class="number">2</span>-<span class="number">1</span>)*y^<span class="number">2</span>+(<span class="number">1</span>-a*gx^<span class="number">2</span>)</span><br><span class="line">gy=<span class="built_in">int</span>(f.roots()[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> (a*gx^<span class="number">2</span>+gy^<span class="number">2</span>)%p==(<span class="number">1</span>+d*gx^<span class="number">2</span>*gy^<span class="number">2</span>)%p</span><br><span class="line"></span><br><span class="line">G=(gx,gy)</span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;eG = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(mul(e, G)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#eG = (602246821311345089174443402780402388933602410138142480089649941718527311147, 17625197557740535449294773567986004828160284887369041337984750097736030549853)</span></span><br></pre></td></tr></table></figure>
<p>简单看一下题目流程，题目定义了一个有限域上一条曲线的点加和点乘操作，其中曲线形式为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span> (a*gx^<span class="number">2</span>+gy^<span class="number">2</span>)%p==(<span class="number">1</span>+d*gx^<span class="number">2</span>*gy^<span class="number">2</span>)%p</span><br></pre></td></tr></table></figure>
<p>写出表达式如下：</p>
<script type="math/tex; mode=display">
ax^2+y^2 = 1+dx^2y^2\quad(mod\;p)</script><p>搜索一下，发现这是标准型的扭曲爱德华曲线：(Twisted Edwards Curves)</p>
<p><a target="_blank" rel="noopener" href="https://lazzzaro.github.io/2021/01/20/crypto-曲线/">曲线 | Lazzaro (lazzzaro.github.io)</a></p>
<p>而仔细核对一下点加与点乘，发现都是完全对的上的。因此问题就转化为，已知Edcurve上的一个e倍点，求解该e倍点对应的原点G的横坐标，即为flag。</p>
<p>想一想，如果这是一条常见形式的椭圆曲线，求解方式是什么？步骤如下：</p>
<ul>
<li>用sage中的order()函数求解出该椭圆曲线的阶n</li>
<li>求出e关于阶n的逆元，记为t</li>
<li>求倍点G=t*(eG)，横坐标即为所求</li>
</ul>
<p>那么再回头，这个求解过程对于Edcurve肯定也是类似的，不过问题就在于，sage中没有办法直接求出Edcurve这种形式的曲线的阶，因此确定思路：</p>
<ul>
<li>将Edcurve通过换元映射，变换为常见的椭圆曲线的形式</li>
<li>求解出对应椭圆曲线的阶，记为s</li>
<li>求倍点G’ = s*(eG’)</li>
<li>将求解出的G’再变换回Edcurve上得到G，其横坐标即为所求</li>
</ul>
<p>因此难点就在于如何通过换元进行曲线映射，这里陈述一下换元过程：<strong>(以下除法均为有限域上除法，即乘逆元)</strong></p>
<p><strong>第一步：</strong>转化为蒙哥马利曲线方程(Montgomery)：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://christianepeters.files.wordpress.com/2012/10/20080620-rennes.pdf">Edwards Curves (wordpress.com)</a></p>
<script type="math/tex; mode=display">
x' = \frac{1+y}{1-y}</script><script type="math/tex; mode=display">
y'=\frac{1+y}{x(1-y)}</script><script type="math/tex; mode=display">
B=\frac{4}{a-d}</script><script type="math/tex; mode=display">
A=\frac{2(a+d)}{a-d}</script><p>代入到Edcurve的曲线方程之后，曲线会转化为蒙哥马利曲线，其方程形式如下：</p>
<script type="math/tex; mode=display">
B(y')^2 = (x')^3+A(x')^2+(x')\quad(mod\;p)</script><p><strong>第二步：</strong>转化为椭圆曲线方程(Weierstrass)：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Montgomery_curve">Montgomery curve - Wikipedia</a></p>
<script type="math/tex; mode=display">
x'' = \frac{3x'+A}{3B}</script><script type="math/tex; mode=display">
y''=\frac{y'}{B}</script><script type="math/tex; mode=display">
a=\frac{3-A^2}{3B^2}</script><script type="math/tex; mode=display">
b=\frac{2A^3-9A}{27B^3}</script><p>此时蒙哥马利曲线就变成了椭圆曲线方程形式：</p>
<script type="math/tex; mode=display">
(y'')^2 = (x'')^3+a(x'')+b\quad(mod\;p)</script><p>然后求该曲线的阶，从而求解出远原点G，并且重新逆变换回Edcurve，得到的横坐标即为flag。</p>
<p>exp.ipynb：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">p = <span class="number">64141017538026690847507665744072764126523219720088055136531450296140542176327</span></span><br><span class="line">a = <span class="number">362</span></span><br><span class="line">d = <span class="number">7</span></span><br><span class="line">c = <span class="number">1</span></span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">eG = (<span class="number">602246821311345089174443402780402388933602410138142480089649941718527311147</span>, <span class="number">17625197557740535449294773567986004828160284887369041337984750097736030549853</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part2 map to ECC</span></span><br><span class="line">F = GF(p)</span><br><span class="line">dd = F(d*c^<span class="number">4</span>)</span><br><span class="line">A = F(<span class="number">2</span>) * F(a+dd) / F(a-dd)</span><br><span class="line">B = F(<span class="number">4</span>) / F(a-dd)</span><br><span class="line">a = F(<span class="number">3</span>-A^<span class="number">2</span>) / F(<span class="number">3</span>*B^<span class="number">2</span>)</span><br><span class="line">b = F(<span class="number">2</span>*A^<span class="number">3</span>-<span class="number">9</span>*A) / F(<span class="number">27</span>*B^<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edwards_to_ECC</span>(<span class="params">x,y</span>):</span><br><span class="line">    x1 = F(x) / F(c)</span><br><span class="line">    y1 = F(y) / F(c)</span><br><span class="line">    <span class="comment">#now curve is a*x^2+y^2 = 1+dd*x^2*y^2</span></span><br><span class="line"></span><br><span class="line">    x2 = F(<span class="number">1</span>+y1) / F(<span class="number">1</span>-y1)</span><br><span class="line">    y2 = F(x2) / F(x1)</span><br><span class="line">    <span class="comment">#now curve is By^2 = x^3 + Ax^2 + x</span></span><br><span class="line"></span><br><span class="line">    x3 = (F(<span class="number">3</span>*x2) + F(A)) / F(<span class="number">3</span>*B)</span><br><span class="line">    y3 = F(y2) / F(B)</span><br><span class="line">    <span class="comment">#now curve is y^2 = x^3 + ax + b</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (x3,y3)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ECC_to_edwards</span>(<span class="params">x,y</span>):</span><br><span class="line">    x2 = (F(x) * F(<span class="number">3</span>*B) - F(A)) / F(<span class="number">3</span>)</span><br><span class="line">    y2 = F(y) * F(B)</span><br><span class="line">    <span class="comment">#now curve is By^2 = x^3 + Ax^2 + x</span></span><br><span class="line"></span><br><span class="line">    x1 = F(x2) / F(y2)</span><br><span class="line">    y1 = F(<span class="number">1</span>) - (F(<span class="number">2</span>) / F(x2+<span class="number">1</span>))</span><br><span class="line">    <span class="comment">#now curve is a*x^2+y^2 = 1+dd*x^2*y^2</span></span><br><span class="line"></span><br><span class="line">    x_ = F(x1) * F(c)</span><br><span class="line">    y_ = F(y1) * F(c)</span><br><span class="line">    <span class="comment">#now curve is a*x^2+y^2 = c^2(1+d*x^2*y^2)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (x_,y_)</span><br><span class="line"> </span><br><span class="line">E = EllipticCurve(GF(p), [a, b])</span><br><span class="line">order = E.order()</span><br><span class="line">eG = E(edwards_to_ECC(eG[<span class="number">0</span>],eG[<span class="number">1</span>]))</span><br><span class="line">t = inverse(e,order)</span><br><span class="line">G = t*eG</span><br><span class="line">G = ECC_to_edwards(G[<span class="number">0</span>],G[<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(G[<span class="number">0</span>])))</span><br></pre></td></tr></table></figure>
<p>flag：</p>
<p><strong>DASCTF{y0u_kn0w_edcurv3_w3LL!!}</strong></p>
<p><br></p>
<p><br></p>
<h3 id="EC-Party-I"><a href="#EC-Party-I" class="headerlink" title="EC_Party-I"></a>EC_Party-I</h3><p>题目来源：“华为杯”第二届中国研究生网络安全创新大赛</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> flag[:<span class="number">5</span>]==<span class="string">b&#x27;flag&#123;&#x27;</span> <span class="keyword">and</span> flag[-<span class="number">1</span>:]==<span class="string">b&#x27;&#125;&#x27;</span></span><br><span class="line">flag = flag[<span class="number">5</span>:-<span class="number">1</span>]</span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rabin</span>(<span class="params">m</span>):</span><br><span class="line">    m = m+os.urandom(<span class="number">32</span>)</span><br><span class="line">    p = getPrime(<span class="number">384</span>)</span><br><span class="line">    q = getPrime(<span class="number">384</span>)</span><br><span class="line">    Fp = GF(p)</span><br><span class="line">    Fq = GF(q)</span><br><span class="line">    n = p*q</span><br><span class="line">    e = <span class="number">2</span></span><br><span class="line">    a = random.randint(<span class="number">0</span>, p-<span class="number">1</span>)</span><br><span class="line">    b = random.randint(<span class="number">0</span>, p-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    Ep = EllipticCurve(Zmod(p), [a, b])</span><br><span class="line">    Eq = EllipticCurve(Zmod(q), [a, b])</span><br><span class="line">    En = EllipticCurve(Zmod(n), [a, b])</span><br><span class="line">    ord_p = Ep.order()</span><br><span class="line">    ord_q = Eq.order()</span><br><span class="line"></span><br><span class="line">    xm = bytes_to_long(m)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            Gp = Ep.lift_x(Fp(xm))</span><br><span class="line">            Gq = Eq.lift_x(Fq(xm))</span><br><span class="line">            ym = crt([<span class="built_in">int</span>(Gp.xy()[<span class="number">1</span>]),<span class="built_in">int</span>(Gq.xy()[<span class="number">1</span>])],[p,q])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            xm += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    M = En((xm,ym))</span><br><span class="line">    C = e*M</span><br><span class="line">    pk = [a, b, n, C]</span><br><span class="line">    leak = ord_p*ord_q</span><br><span class="line">    <span class="keyword">return</span> pk, leak</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rabin(flag))</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[138681122158674534796479818810828100269024674330030901179877002756402543027343312824423418859769980312713625658733, 4989541340743108588577899263469059346332852532421276369038720203527706762720292559751463880310075002363945271507040, 762981334990685089884160169295988791471426441106522959345412318178660817286272606245181160960267776171409174142433857335352402619564485470678152764621235882232914864951345067231483720755544188962798600739631026707678945887174897543, (19591102741441427006422487362547101973286873135330241799412389205281057650306427438686318050682578531286702107543065985988634367524715153650482199099194389191525898366546842016339136884277515665890331906261550080128989942048438965, 728465071542637655949094554469510039681717865811604984652385614821789556549826602178972137405550902004858456181137844771163710123158955524137202319902378503104952106036911634918189377295743976966073577013775200078470659428344462772), 762981334990685089884160169295988791471426441106522959345445792076415993922016249232021560266153453470937452118572318136597282436269660557904217923887981072203978473274822142705255987334355747997513083011853917049784914749699536828]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>梳理题目加密流程：</p>
<ul>
<li>题目将flag转化成大整数后，转化为基点M的横坐标</li>
<li>生成两个大素数p、q，n=p*q</li>
<li>生成随机数a、b，并以此生成三条椭圆曲线Ep、Eq、En</li>
<li>求出基点M在Ep、Eq上的倍点，并用中国剩余定理求出组合后的纵坐标</li>
<li>给出泄露信息leak=order(Ep)*order(Eq)</li>
</ul>
<p>那么显然如果能获得n的分解，题目就没有难度了，而泄漏的leak就是n的分解的重要依据。其具体原理可以参考：(因为我其实也并没有理解清楚)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/maple3142/My-CTF-Challenges/blob/master/HITCON CTF 2022/Chimera/README.md">My-CTF-Challenges/HITCON CTF 2022/Chimera/README.md at master · maple3142/My-CTF-Challenges (github.com)</a></p>
<p>简单来说，就是先获得leak的因式分解：</p>
<p><img src="/post/187210a7/image-20230930114139546.png" alt="image-20230930114139546"></p>
<p>由于leak=order(Ep)*order(Eq)，因此leak乘任何点都应该是En、Ep、Eq的共同O点(无穷远点)，但是将leak挨个除以其因子，再与C点相乘，就可能会产生倍点在Ep上，而不在Eq上的情况，这会使求解关于n的逆元不存在，sage便会在这时抛出一个报错，而在报错信息中就能看到kp以及n的分解：(这是我的理解，如果有不对的地方欢迎师傅指出)</p>
<p><img src="/post/187210a7/image-20230930114719034.png" alt="image-20230930114719034"></p>
<p>这个数字就是kp，与n求gcd即可得到p，也可以在最后一行报错信息中直接看到n的分解。</p>
<p>其实这种分解方式就是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Lenstra_elliptic-curve_factorization">Lenstra elliptic-curve factorization</a>.的核心原理，但我没有完全理解。</p>
<p>求解出p、q后，就顺势获得了两条曲线，接下来就是如何由曲线上的倍点(2M)求解出原点的问题，一般有两类解法：</p>
<p>1、如果2与曲线阶互素，则可以直接求解2的逆元，将倍点乘上逆元即得原点</p>
<p>2、如果不互素，则可以联立椭圆曲线本身方程及倍点方程，在有限域下求根</p>
<p>而在本题中，2与Eq的阶互素，因此采用第一种解法；与Ep的阶不互素，因此采用第二种解法，第二种解法联立方程过程如下：(记M为(x1,y1),2M为(x2,y2))</p>
<script type="math/tex; mode=display">
y^2=x^3+ax+b\quad(mod\;p)</script><script type="math/tex; mode=display">
x_2=k^2−2x_1\quad(mod\;p)</script><script type="math/tex; mode=display">
k = \frac{3x_1^2 + a}{2y_1}\quad(mod\;p)</script><p>联立上述三式可得方程：</p>
<script type="math/tex; mode=display">
\frac{(3x_1^2+a)^2}{(2y_1)^2} - 2x_1 - x_2 = 0\quad(mod\;p)</script><p>即：</p>
<script type="math/tex; mode=display">
(3x_1^2+a)^2 - 2x_1*4(x_1^3+ax_1+b) - x_2*4(x_1^3+ax_1+b) = 0\quad(mod\;p)</script><p>此时方程中仅有x1一个未知数，在模p下解方程即可，解完后用中国剩余定理将模p与模q下的解组合即得flag。</p>
<p>exp.ipynb：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = <span class="number">2</span></span><br><span class="line">a,b,n,C,leak = [<span class="number">138681122158674534796479818810828100269024674330030901179877002756402543027343312824423418859769980312713625658733</span>, <span class="number">4989541340743108588577899263469059346332852532421276369038720203527706762720292559751463880310075002363945271507040</span>, <span class="number">762981334990685089884160169295988791471426441106522959345412318178660817286272606245181160960267776171409174142433857335352402619564485470678152764621235882232914864951345067231483720755544188962798600739631026707678945887174897543</span>, (<span class="number">19591102741441427006422487362547101973286873135330241799412389205281057650306427438686318050682578531286702107543065985988634367524715153650482199099194389191525898366546842016339136884277515665890331906261550080128989942048438965</span>, <span class="number">728465071542637655949094554469510039681717865811604984652385614821789556549826602178972137405550902004858456181137844771163710123158955524137202319902378503104952106036911634918189377295743976966073577013775200078470659428344462772</span>), <span class="number">762981334990685089884160169295988791471426441106522959345445792076415993922016249232021560266153453470937452118572318136597282436269660557904217923887981072203978473274822142705255987334355747997513083011853917049784914749699536828</span>]</span><br><span class="line">E = EllipticCurve(Zmod(n),[a,b])</span><br><span class="line">C = E(C)</span><br><span class="line"></span><br><span class="line"><span class="comment">#factordb</span></span><br><span class="line"><span class="comment">#2^2,3^4,13,199,307,647,157259,297617,8452217,411927661365999433,1157516701716180046249,1338688620929080207819,31226697952255326809332037614333,581208663471376553417319728009366348095695079579751839149645355600351572890241761173016580183555305805091712621</span></span><br><span class="line">leak_fac = [<span class="number">2</span>,<span class="number">3</span>,<span class="number">13</span>,<span class="number">199</span>,<span class="number">307</span>,<span class="number">647</span>,<span class="number">157259</span>,<span class="number">297617</span>,<span class="number">8452217</span>,<span class="number">411927661365999433</span>,<span class="number">1157516701716180046249</span>,<span class="number">1338688620929080207819</span>,<span class="number">31226697952255326809332037614333</span>,<span class="number">581208663471376553417319728009366348095695079579751839149645355600351572890241761173016580183555305805091712621</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">for i in leak_fac:</span></span><br><span class="line"><span class="string">    temp = leak // i * C</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">kp = <span class="number">422522588482185975632147929645103216180089543839772868484032620301855259044079430236142637458472152787337779544279109415705783248825091269039840404202119229567311048216047356951966653331710686649176005328509793328313264251738045723</span></span><br><span class="line">p = GCD(kp,n)</span><br><span class="line">q = n//p</span><br><span class="line"></span><br><span class="line">Ep = EllipticCurve(Zmod(p), [a, b])</span><br><span class="line">Eq = EllipticCurve(Zmod(q), [a, b])</span><br><span class="line">ord_p = Ep.order()</span><br><span class="line">ord_q = Eq.order()</span><br><span class="line"><span class="comment">#print(ord_p)</span></span><br><span class="line"><span class="comment">#print(ord_q)</span></span><br><span class="line"></span><br><span class="line">dq = inverse(e,ord_q)</span><br><span class="line">Q = dq*Eq(C)</span><br><span class="line">mq = <span class="built_in">int</span>(Q[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(Ep(C))</span></span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(GF(p))</span><br><span class="line">f = (<span class="number">3</span>*(x**<span class="number">2</span>)+a)**<span class="number">2</span> - <span class="number">2</span>*x*(<span class="number">4</span>*(x**<span class="number">3</span>+a*x+b)) - <span class="built_in">int</span>(C[<span class="number">0</span>])*<span class="number">4</span>*(x**<span class="number">3</span>+a*x+b)</span><br><span class="line">res = f.roots()</span><br><span class="line"><span class="comment">#print(res)</span></span><br><span class="line"></span><br><span class="line">n = [p,q]</span><br><span class="line"><span class="keyword">if</span>(res):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">        c = [<span class="built_in">int</span>(i[<span class="number">0</span>]),mq]</span><br><span class="line">        m = crt(c,n)</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(m))</span><br></pre></td></tr></table></figure>
<p>flag：</p>
<p><strong>flag{3crab1n_s0unds_go0d}</strong></p>
<p><br></p>
<p><br></p>
<h3 id="strange-curve"><a href="#strange-curve" class="headerlink" title="strange curve"></a>strange curve</h3><p>题目来源：巅峰极客 2022</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secrets <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">P,Q</span>):</span><br><span class="line">    (x1,y1)=P</span><br><span class="line">    (x2,y2)=Q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    x3=(x1+x2)*(<span class="number">1</span>+y1*y2)*invert((<span class="number">1</span>+x1*x2)*(<span class="number">1</span>-y1*y2),p)%p</span><br><span class="line">    y3=(y1+y2)*(<span class="number">1</span>+x1*x2)*invert((<span class="number">1</span>-x1*x2)*(<span class="number">1</span>+y1*y2),p)%p</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (x3,y3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">e,P</span>):</span><br><span class="line">    Q=(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    e=e%p</span><br><span class="line">    <span class="keyword">while</span> e:</span><br><span class="line">        <span class="keyword">if</span> e&amp;<span class="number">1</span>:</span><br><span class="line">            Q=add(Q,P)</span><br><span class="line">        P=add(P,P)</span><br><span class="line">        e&gt;&gt;=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> Q</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Legendre</span>(<span class="params">a,p</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">pow</span>((a%p+p)%p,(p-<span class="number">1</span>)//<span class="number">2</span>,p))%p</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ts</span>(<span class="params">p</span>):</span><br><span class="line">    p=p-<span class="number">1</span></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> p%<span class="number">2</span>==<span class="number">0</span>:</span><br><span class="line">        count+=<span class="number">1</span></span><br><span class="line">        p=p//<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> count,p</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_nonre</span>(<span class="params">p</span>):</span><br><span class="line">    a=random.randint(<span class="number">1</span>,p)</span><br><span class="line">    <span class="keyword">while</span> Legendre(a,p)==<span class="number">1</span>:</span><br><span class="line">        a=random.randint(<span class="number">1</span>,p)</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">amm2</span>(<span class="params">a,p</span>):</span><br><span class="line">    t,s=get_ts(p)</span><br><span class="line">    ta=<span class="built_in">pow</span>(get_nonre(p),s,p)</span><br><span class="line">    tb=<span class="built_in">pow</span>(a,s,p)</span><br><span class="line">    h=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,t):</span><br><span class="line">        d=<span class="built_in">pow</span>(tb,<span class="number">2</span>**t-<span class="number">1</span>-i,p)</span><br><span class="line">        <span class="keyword">if</span> d==<span class="number">1</span>:</span><br><span class="line">            k=<span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            k=<span class="number">1</span></span><br><span class="line">        tb=(tb*<span class="built_in">pow</span>(ta,<span class="number">2</span>*k,p))%p</span><br><span class="line">        h=(h*<span class="built_in">pow</span>(ta,k,p))%p</span><br><span class="line">        ta=<span class="built_in">pow</span>(ta,<span class="number">2</span>,p)</span><br><span class="line">    <span class="keyword">return</span> h*<span class="built_in">pow</span>(a,(s+<span class="number">1</span>)//<span class="number">2</span>,p)%p  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">a,b,c,p</span>):</span><br><span class="line">    tmpa=<span class="number">1</span></span><br><span class="line">    tmpb=b*inverse(a,p)%p</span><br><span class="line">    tmpc=c*inverse(a,p)%p</span><br><span class="line">    <span class="keyword">assert</span> Legendre(tmpb**<span class="number">2</span>*inverse(<span class="number">4</span>,p)-tmpc,p)==<span class="number">1</span></span><br><span class="line">    res1=(amm2(tmpb**<span class="number">2</span>*inverse(<span class="number">4</span>,p)-tmpc,p)-tmpb*inverse(<span class="number">2</span>,p))%p</span><br><span class="line">    res2=(-amm2(tmpb**<span class="number">2</span>*inverse(<span class="number">4</span>,p)-tmpc,p)-tmpb*inverse(<span class="number">2</span>,p))%p</span><br><span class="line">    <span class="keyword">return</span> (res1,res2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift</span>(<span class="params">x,a,b,p</span>):</span><br><span class="line">    tmp=b*(x**<span class="number">2</span>-<span class="number">1</span>)*inverse(a*x,p)%p</span><br><span class="line">    <span class="keyword">return</span> solve(<span class="number">1</span>,-tmp,-<span class="number">1</span>,p)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">p=<span class="number">9410547699903726871336507117271550134683191140146415131394654141737636910570480327296351841515571767317596027931492843621727002889086193529096531342265353</span></span><br><span class="line">a=<span class="number">54733430689690725746438325219044741824500093621550218736194675295708808435509</span></span><br><span class="line">b=<span class="number">75237024593957256761258687646797952793573177095902495908321724558796076392871</span></span><br><span class="line">x=bytes_to_long(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        y=lift(x,a,b,p)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        x+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> a*x*(y**<span class="number">2</span>-<span class="number">1</span>)%p==b*y*(x**<span class="number">2</span>-<span class="number">1</span>)%p</span><br><span class="line"></span><br><span class="line">P=(x,y)</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line"></span><br><span class="line">eP=mul(e,P)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;P = <span class="subst">&#123;P&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;eP = <span class="subst">&#123;eP&#125;</span>&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">P = (56006392793427940134514899557008545913996191831278248640996846111183757392968770895731003245209281149, 5533217632352976155681815016236825302418119286774481415122941272968513081846849158651480192550482691343283818244963282636939305751909505213138032238524899)</span></span><br><span class="line"><span class="string">eP = (mpz(8694229840573103722999959579565187489450818138005222030156495740841851804943200684116883831426548909867463656993852596745698999492932194245562062558787005), mpz(9279986963919197374405152604360936066932975197577643570458423456304679111057526702737279809805694360981565554506626018364382736924914907001214909905449002))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>非预期解很容易，flag就是P的横坐标，最多再需要爆破一下就行，这里主要讲一下预期解。</p>
<p>我认为题目预期应该是不给P，而只给eP的，因此我就以只有eP这个条件开始解题，分析过程如下：</p>
<p>首先，前面的很多函数先不看，先关注题目给的曲线方程：</p>
<script type="math/tex; mode=display">
ax(y^2-1) \equiv by(x^2-1) \quad(mod\;p)</script><p>而就在前几天的2023 DASCTF CBCTF中，出了一道huff曲线题，而huff曲线的一般形式为：</p>
<script type="math/tex; mode=display">
x(ay^2-1) \equiv y(bx^2-1) \quad(mod\;p)</script><p>可以发现其实很像，我们只需要做以下映射就可以把题目曲线变成一个标准huff曲线：</p>
<script type="math/tex; mode=display">
x' = ax</script><script type="math/tex; mode=display">
y' = by</script><p>那么题目曲线就变成了：</p>
<script type="math/tex; mode=display">
x(\frac{y^2}{b^2}-1) \equiv y(\frac{x^2}{a^2}-1) \quad(mod\;p)</script><p>可以发现这就是个标准huff曲线：</p>
<script type="math/tex; mode=display">
x(a'y^2-1) \equiv y(b'x^2-1) \quad(mod\;p)</script><p>其中：</p>
<script type="math/tex; mode=display">
a' = (b^2)^{-1} \quad(mod\;p)</script><script type="math/tex; mode=display">
b' = (a^2)^{-1} \quad(mod\;p)</script><p>而huff曲线又可以通过如下方式映射为一条Weiestrass Curve，也就是常见的椭圆曲线：</p>
<script type="math/tex; mode=display">
(x,y)→(\frac{b'x-a'y}{y-x},\frac{b'-a'}{y-x})</script><p>该Weiestrass Curve方程如下：</p>
<script type="math/tex; mode=display">
y^2≡x^3+(a'+b')x^2+a'b'x \quad mod \quad p</script><p>映射为这样的曲线后，sage就可以直接求出阶。而映射由于是双射所以不会改变曲线阶，所以我们其实也就求得了原huff曲线的阶，然后就可以求e关于阶的逆元d，就有：</p>
<script type="math/tex; mode=display">
d*eP' = P'</script><p>然后再将第一次映射逆回去就能得到原P点坐标了。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=<span class="number">9410547699903726871336507117271550134683191140146415131394654141737636910570480327296351841515571767317596027931492843621727002889086193529096531342265353</span></span><br><span class="line">a=<span class="number">54733430689690725746438325219044741824500093621550218736194675295708808435509</span></span><br><span class="line">b=<span class="number">75237024593957256761258687646797952793573177095902495908321724558796076392871</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">eP = (<span class="number">8694229840573103722999959579565187489450818138005222030156495740841851804943200684116883831426548909867463656993852596745698999492932194245562062558787005</span>,<span class="number">9279986963919197374405152604360936066932975197577643570458423456304679111057526702737279809805694360981565554506626018364382736924914907001214909905449002</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mapping</span>(<span class="params">point</span>):</span><br><span class="line">    x = point[<span class="number">0</span>]</span><br><span class="line">    y = point[<span class="number">1</span>]</span><br><span class="line">    Ex = (b_*x-a_*y) * inverse(y-x,p) % p</span><br><span class="line">    Ey = (b_-a_) * inverse(y-x,p) % p</span><br><span class="line">    <span class="keyword">return</span> (Ex,Ey)</span><br><span class="line"></span><br><span class="line">a_ = inverse(b**<span class="number">2</span>,p)</span><br><span class="line">b_ = inverse(a**<span class="number">2</span>,p)</span><br><span class="line">E = EllipticCurve(GF(p),[<span class="number">0</span>,a_+b_,<span class="number">0</span>,a_*b_,<span class="number">0</span>])</span><br><span class="line"><span class="comment">#print(E.order())</span></span><br><span class="line"></span><br><span class="line">eP_ = (eP[<span class="number">0</span>]*a%p,eP[<span class="number">1</span>]*b%p)</span><br><span class="line">order = <span class="number">9410547699903726871336507117271550134683191140146415131394654141737636910570514004897728229958723858012338384995335419723570802793276851855535834618146832</span></span><br><span class="line">d = inverse(e,order)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CB_curve</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.p = p</span><br><span class="line">        self.a = a_</span><br><span class="line">        self.b = b_</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, P, Q</span>):</span><br><span class="line">        <span class="keyword">if</span> P == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> Q</span><br><span class="line">        (x1, y1) = P</span><br><span class="line">        (x2, y2) = Q</span><br><span class="line">        x3 =  (x1+x2)*(<span class="number">1</span>+self.a*y1*y2)*inverse((<span class="number">1</span>+self.b*x1*x2)*(<span class="number">1</span>-self.a*y1*y2),self.p)% self.p</span><br><span class="line">        y3 =  (y1+y2)*(<span class="number">1</span>+self.b*x1*x2)*inverse((<span class="number">1</span>-self.b*x1*x2)*(<span class="number">1</span>+self.a*y1*y2),self.p)% self.p</span><br><span class="line">        <span class="keyword">return</span> (x3, y3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">self, x, P</span>):</span><br><span class="line">        Q = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> x &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> x &amp; <span class="number">1</span>:</span><br><span class="line">                Q = self.add(Q, P)</span><br><span class="line">            P = self.add(P, P)</span><br><span class="line">            x = x &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> Q</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">negG</span>(<span class="params">self,G</span>):</span><br><span class="line">        <span class="keyword">return</span> self.mul(order-<span class="number">1</span>,G)</span><br><span class="line"></span><br><span class="line">curve = CB_curve()</span><br><span class="line">P_ = curve.mul(d,eP_)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(inverse(a,p)*P_[<span class="number">0</span>] % p)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;b7f209df-1284-4bdf-b030-28197483c47b&#125;</span></span><br></pre></td></tr></table></figure>
<p>CB_curve其实就是huff曲线的实现，偷懒用了出题师傅的(ᕑᗢᓫ∗)˒</p>
<p><br></p>
<p><br></p>
<h3 id="SMM"><a href="#SMM" class="headerlink" title="SMM"></a>SMM</h3><p>题目来源：2023福建省数据安全竞赛</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, bytes_to_long</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> getrandbits</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">msg = pad(flag, <span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">ecc_table1 = &#123;</span><br><span class="line">    <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;p&#x27;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;g&#x27;</span>: <span class="string">&#x27;32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7&#x27;</span></span><br><span class="line">         <span class="string">&#x27;bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ecc_table2 = &#123;</span><br><span class="line">    <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af4b7eece0cec3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;p&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af4b7eece0cec3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;g&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000001333d7197c5da65ad36ebbb3589634ad6&#x27;</span></span><br><span class="line">         <span class="string">&#x27;00000000000000000000000000000007b81a5934e5b39c8d36f449527767209b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af4b7e22c0cec3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af04915ce0cec3&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TSM2</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, sk, ecc_table</span>):</span><br><span class="line">        self.ecc_table = ecc_table</span><br><span class="line">        self.n = <span class="built_in">int</span>(ecc_table[<span class="string">&#x27;n&#x27;</span>], <span class="number">16</span>)</span><br><span class="line">        self.para_len = <span class="built_in">len</span>(ecc_table[<span class="string">&#x27;n&#x27;</span>])</span><br><span class="line">        self.ecc_a3 = (<span class="built_in">int</span>(ecc_table[<span class="string">&#x27;a&#x27;</span>], base=<span class="number">16</span>) +</span><br><span class="line">                       <span class="number">3</span>) % <span class="built_in">int</span>(ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">        self.sk = sk</span><br><span class="line">        self.pk = self._kg(self.sk, ecc_table[<span class="string">&#x27;g&#x27;</span>])</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">self, data, K</span>):</span><br><span class="line">        e = data</span><br><span class="line">        d = self.sk</span><br><span class="line">        k = K</span><br><span class="line"> </span><br><span class="line">        P1 = self._kg(k, self.ecc_table[<span class="string">&#x27;g&#x27;</span>])</span><br><span class="line">        x = <span class="built_in">int</span>(P1[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">        R = ((e + x) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;n&#x27;</span>], base=<span class="number">16</span>))</span><br><span class="line">        <span class="keyword">if</span> R == <span class="number">0</span> <span class="keyword">or</span> R + k == <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;n&#x27;</span>], base=<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        d_1 = <span class="built_in">pow</span>(</span><br><span class="line">            d+<span class="number">1</span>, <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;n&#x27;</span>], base=<span class="number">16</span>) - <span class="number">2</span>, <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;n&#x27;</span>], base=<span class="number">16</span>))</span><br><span class="line">        S = (d_1*(k + R) - R) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;n&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> S == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;%064x%064x&#x27;</span> % (R, S)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">self, Sign, data</span>):</span><br><span class="line">        r = <span class="built_in">int</span>(Sign[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">        s = <span class="built_in">int</span>(Sign[self.para_len:<span class="number">2</span> * self.para_len], <span class="number">16</span>)</span><br><span class="line">        e = <span class="built_in">int</span>(data.<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">        t = (r + s) % self.n</span><br><span class="line">        <span class="keyword">if</span> t == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">        P1 = self._kg(s, self.ecc_table[<span class="string">&#x27;g&#x27;</span>])</span><br><span class="line">        P2 = self._kg(t, self.pk)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> P1 == P2:</span><br><span class="line">            P1 = <span class="string">&#x27;%s%s&#x27;</span> % (P1, <span class="number">1</span>)</span><br><span class="line">            P1 = self._double_point(P1)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            P1 = <span class="string">&#x27;%s%s&#x27;</span> % (P1, <span class="number">1</span>)</span><br><span class="line">            P1 = self._add_point(P1, P2)</span><br><span class="line">            P1 = self._convert_jacb_to_nor(P1)</span><br><span class="line"> </span><br><span class="line">        x = <span class="built_in">int</span>(P1[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> r == ((e + x) % self.n)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_kg</span>(<span class="params">self, k, Point</span>):</span><br><span class="line">        <span class="keyword">if</span> (k % self.n) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;0&#x27;</span> * <span class="number">128</span></span><br><span class="line">        Point = <span class="string">&#x27;%s%s&#x27;</span> % (Point, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        mask_str = <span class="string">&#x27;8&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.para_len - <span class="number">1</span>):</span><br><span class="line">            mask_str += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        mask = <span class="built_in">int</span>(mask_str, <span class="number">16</span>)</span><br><span class="line">        Temp = Point</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(self.para_len * <span class="number">4</span>):</span><br><span class="line">            <span class="keyword">if</span> flag:</span><br><span class="line">                Temp = self._double_point(Temp)</span><br><span class="line">            <span class="keyword">if</span> (k &amp; mask) != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> flag:</span><br><span class="line">                    Temp = self._add_point(Temp, Point)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    flag = <span class="literal">True</span></span><br><span class="line">                    Temp = Point</span><br><span class="line">            k = k &lt;&lt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self._convert_jacb_to_nor(Temp)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_double_point</span>(<span class="params">self, Point</span>):</span><br><span class="line">        l = <span class="built_in">len</span>(Point)</span><br><span class="line">        len_2 = <span class="number">2</span> * self.para_len</span><br><span class="line">        <span class="keyword">if</span> l &lt; self.para_len * <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x1 = <span class="built_in">int</span>(Point[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">            y1 = <span class="built_in">int</span>(Point[self.para_len:len_2], <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> l == len_2:</span><br><span class="line">                z1 = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                z1 = <span class="built_in">int</span>(Point[len_2:], <span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">            T6 = (z1 * z1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (y1 * y1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (x1 + T6) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (x1 - T6) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T3 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (y1 * z1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (T2 * <span class="number">8</span>) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T5 = (x1 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 * <span class="number">3</span>) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T6 = (T6 * T6) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T6 = (self.ecc_a3 * T6) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 + T6) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            z3 = (T3 + T3) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T1 * T1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (T2 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            x3 = (T3 - T5) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (T5 % <span class="number">2</span>) == <span class="number">1</span>:</span><br><span class="line">                T4 = (T5 + ((T5 + <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)) &gt;&gt; <span class="number">1</span>) - T3) % <span class="built_in">int</span>(</span><br><span class="line">                    self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                T4 = (T5 + (T5 &gt;&gt; <span class="number">1</span>) - T3) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">            T1 = (T1 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            y3 = (T1 - T2) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">            form = <span class="string">&#x27;%%0%dx&#x27;</span> % self.para_len</span><br><span class="line">            form = form * <span class="number">3</span></span><br><span class="line">            <span class="keyword">return</span> form % (x3, y3, z3)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_add_point</span>(<span class="params">self, P1, P2</span>):</span><br><span class="line">        <span class="keyword">if</span> P1 == <span class="string">&#x27;0&#x27;</span> * <span class="number">128</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;%s%s&#x27;</span> % (P2, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> P2 == <span class="string">&#x27;0&#x27;</span> * <span class="number">128</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;%s%s&#x27;</span> % (P1, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        len_2 = <span class="number">2</span> * self.para_len</span><br><span class="line">        l1 = <span class="built_in">len</span>(P1)</span><br><span class="line">        l2 = <span class="built_in">len</span>(P2)</span><br><span class="line">        <span class="keyword">if</span> (l1 &lt; len_2) <span class="keyword">or</span> (l2 &lt; len_2):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            X1 = <span class="built_in">int</span>(P1[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">            Y1 = <span class="built_in">int</span>(P1[self.para_len:len_2], <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> l1 == len_2:</span><br><span class="line">                Z1 = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                Z1 = <span class="built_in">int</span>(P1[len_2:], <span class="number">16</span>)</span><br><span class="line">            x2 = <span class="built_in">int</span>(P2[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">            y2 = <span class="built_in">int</span>(P2[self.para_len:len_2], <span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">            T1 = (Z1 * Z1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (y2 * Z1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (x2 * T1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 * T2) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (T3 - X1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T3 + X1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (T2 * T2) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 - Y1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            Z3 = (Z1 * T2) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (T2 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T3 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T5 = (T1 * T1) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T4 = (X1 * T4) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            X3 = (T5 - T3) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T2 = (Y1 * T2) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T3 = (T4 - X3) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            T1 = (T1 * T3) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">            Y3 = (T1 - T2) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">            form = <span class="string">&#x27;%%0%dx&#x27;</span> % self.para_len</span><br><span class="line">            form = form * <span class="number">3</span></span><br><span class="line">            <span class="keyword">return</span> form % (X3, Y3, Z3)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_convert_jacb_to_nor</span>(<span class="params">self, Point</span>):</span><br><span class="line">        len_2 = <span class="number">2</span> * self.para_len</span><br><span class="line">        x = <span class="built_in">int</span>(Point[<span class="number">0</span>:self.para_len], <span class="number">16</span>)</span><br><span class="line">        y = <span class="built_in">int</span>(Point[self.para_len:len_2], <span class="number">16</span>)</span><br><span class="line">        z = <span class="built_in">int</span>(Point[len_2:], <span class="number">16</span>)</span><br><span class="line">        z_inv = <span class="built_in">pow</span>(</span><br><span class="line">            z, <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>) - <span class="number">2</span>, <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>))</span><br><span class="line">        z_invSquar = (z_inv * z_inv) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">        z_invQube = (z_invSquar * z_inv) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">        x_new = (x * z_invSquar) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">        y_new = (y * z_invQube) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">        z_new = (z * z_inv) % <span class="built_in">int</span>(self.ecc_table[<span class="string">&#x27;p&#x27;</span>], base=<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> z_new == <span class="number">1</span>:</span><br><span class="line">            form = <span class="string">&#x27;%%0%dx&#x27;</span> % self.para_len</span><br><span class="line">            form = form * <span class="number">2</span></span><br><span class="line">            <span class="keyword">return</span> form % (x_new, y_new)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">bits = [<span class="number">40</span>, <span class="number">140</span>]</span><br><span class="line">ecc_table = [ecc_table1, ecc_table2]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sk = getrandbits(bits[_])</span><br><span class="line">    key = hashlib.md5(<span class="built_in">str</span>(sk).encode()).digest()</span><br><span class="line">    aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    msg = aes.encrypt(msg)</span><br><span class="line">    sk = sk % <span class="built_in">int</span>(ecc_table[_][<span class="string">&#x27;n&#x27;</span>], <span class="number">16</span>)</span><br><span class="line">    sm2 = TSM2(sk, ecc_table[_])</span><br><span class="line">    pk = sm2.pk</span><br><span class="line">    <span class="built_in">print</span>(pk)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(msg)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">749180747cd167402449aa2ffdfacd87a3d8ff9a3e00670e9501cefc96c712f16ddca6ba23ed4c9bbbd23bb5d4f16627cd30a82f64a75195c4c3337c17041e89</span></span><br><span class="line"><span class="string">0000000000000000000000000000002030737f5765b0ca638572035d1143a2210000000000000000000000000000001c69be4b4c104fe2c888be4b659620d933</span></span><br><span class="line"><span class="string">b&#x27;\xb6\xe2\xd0\x00\xdb=3\xf2\xc3\x10\x9b\xb7\x04\xb2\t\x92\xed$Z\xf6.\xd8\xdd/\xad\x03M\xaec\xce\xa9Z\x00&#125;\xfd\xe2T\x859\x0b\x1f\xd3\xd4H^\xfa8\xb7&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>特别长的题目，不过其实注意到函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_convert_jacb_to_nor</span>(<span class="params">self, Point</span>)</span><br></pre></td></tr></table></figure>
<p>看名字，这个函数的作用应该是把雅可比坐标转换成普通坐标，那么前面的很长的点加、倍乘的实现，估计也就是雅可比坐标下的ECC点运算。</p>
<p>所以其实很长一段代码都可以忽略，其实这个题就是定义了两个ECC，每张ecc_table中，p、a、b就是椭圆曲线方程中的各参数，n是曲线的阶，g是曲线上的一个生成元。</p>
<p>明白了这一点后再看题目主要任务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bits = [<span class="number">40</span>, <span class="number">140</span>]</span><br><span class="line">ecc_table = [ecc_table1, ecc_table2]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sk = getrandbits(bits[_])</span><br><span class="line">    key = hashlib.md5(<span class="built_in">str</span>(sk).encode()).digest()</span><br><span class="line">    aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    msg = aes.encrypt(msg)</span><br><span class="line">    sk = sk % <span class="built_in">int</span>(ecc_table[_][<span class="string">&#x27;n&#x27;</span>], <span class="number">16</span>)</span><br><span class="line">    sm2 = TSM2(sk, ecc_table[_])</span><br><span class="line">    pk = sm2.pk</span><br><span class="line">    <span class="built_in">print</span>(pk)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(msg)</span><br></pre></td></tr></table></figure>
<p>可以看到，他其实给了两个曲线上各自生成元的sk倍点坐标，sk分别为40bit和140bit，然后他将sk分别作为AES密钥，连续对flag进行两次加密，最后给出密文。那么我们想要得到flag，也就要解出两个sk然后AES解密。</p>
<p>也就是说，我们实际上是要完成两个不同曲线上的DLP问题。而略作测试就会发现：</p>
<ul>
<li>对于曲线一，由于私钥sk仅有40bit，因此可以考虑bsgs</li>
<li>对于曲线二，order=p，因此smart attack解决问题</li>
</ul>
<p>而实际上bsgs也需要一定的时间，耐心一点就好了。</p>
<p>而最后还有一个小细节需要注意：每一次加密中，sk模了曲线阶n，而第二个曲线阶略小于140比特，因此求出DLP后还需要爆破几位才能得到正确sk。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">ecc_table1 = &#123;</span><br><span class="line">    <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;p&#x27;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;gx&#x27;</span>: <span class="string">&#x27;32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;gy&#x27;</span>: <span class="string">&#x27;bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ecc_table2 = &#123;</span><br><span class="line">    <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af4b7eece0cec3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;p&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af4b7eece0cec3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;gx&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000001333d7197c5da65ad36ebbb3589634ad6&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;gy&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000007b81a5934e5b39c8d36f449527767209b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af4b7e22c0cec3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;00000000000000000000000000000024c0a1eef669c78f5a60af04915ce0cec3&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ecc1 = EllipticCurve(GF(<span class="built_in">int</span>(ecc_table1[<span class="string">&#x27;p&#x27;</span>],<span class="number">16</span>)),[<span class="built_in">int</span>(ecc_table1[<span class="string">&#x27;a&#x27;</span>],<span class="number">16</span>),<span class="built_in">int</span>(ecc_table1[<span class="string">&#x27;b&#x27;</span>],<span class="number">16</span>)])</span><br><span class="line">ecc2 = EllipticCurve(GF(<span class="built_in">int</span>(ecc_table2[<span class="string">&#x27;p&#x27;</span>],<span class="number">16</span>)),[<span class="built_in">int</span>(ecc_table2[<span class="string">&#x27;a&#x27;</span>],<span class="number">16</span>),<span class="built_in">int</span>(ecc_table2[<span class="string">&#x27;b&#x27;</span>],<span class="number">16</span>)])</span><br><span class="line">g1 = ecc1((<span class="built_in">int</span>(ecc_table1[<span class="string">&#x27;gx&#x27;</span>],<span class="number">16</span>),<span class="built_in">int</span>(ecc_table1[<span class="string">&#x27;gy&#x27;</span>],<span class="number">16</span>)))</span><br><span class="line">g2 = ecc2((<span class="built_in">int</span>(ecc_table2[<span class="string">&#x27;gx&#x27;</span>],<span class="number">16</span>),<span class="built_in">int</span>(ecc_table2[<span class="string">&#x27;gy&#x27;</span>],<span class="number">16</span>)))</span><br><span class="line"></span><br><span class="line">k1g1 = ecc1(<span class="built_in">int</span>(<span class="string">&quot;749180747cd167402449aa2ffdfacd87a3d8ff9a3e00670e9501cefc96c712f1&quot;</span>,<span class="number">16</span>),<span class="built_in">int</span>(<span class="string">&quot;6ddca6ba23ed4c9bbbd23bb5d4f16627cd30a82f64a75195c4c3337c17041e89&quot;</span>,<span class="number">16</span>))</span><br><span class="line">k2g2 = ecc2(<span class="built_in">int</span>(<span class="string">&quot;2030737f5765b0ca638572035d1143a221&quot;</span>,<span class="number">16</span>),<span class="built_in">int</span>(<span class="string">&quot;1c69be4b4c104fe2c888be4b659620d933&quot;</span>,<span class="number">16</span>))</span><br><span class="line">enc = <span class="string">b&#x27;\xb6\xe2\xd0\x00\xdb=3\xf2\xc3\x10\x9b\xb7\x04\xb2\t\x92\xed$Z\xf6.\xd8\xdd/\xad\x03M\xaec\xce\xa9Z\x00&#125;\xfd\xe2T\x859\x0b\x1f\xd3\xd4H^\xfa8\xb7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part1 bsgs</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">dic = &#123;&#125;</span></span><br><span class="line"><span class="string">for b in trange(2**20):</span></span><br><span class="line"><span class="string">    dic[b*g1] = b</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cc = dic.keys()</span></span><br><span class="line"><span class="string">for a in trange(464193,2**20):</span></span><br><span class="line"><span class="string">    temp = k1g1 - a*2^20*g1</span></span><br><span class="line"><span class="string">    if(temp in cc):</span></span><br><span class="line"><span class="string">        print(a)</span></span><br><span class="line"><span class="string">        print(dic[temp])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#d = a*2^20+b</span></span><br><span class="line">a = <span class="number">464193</span></span><br><span class="line">b = <span class="number">319430</span></span><br><span class="line">k1 = a*<span class="number">2</span>^<span class="number">20</span>+b</span><br><span class="line"><span class="comment">#print(k1*g1 == k1g1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part2 smart_attack</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SmartAttack</span>(<span class="params">P,Q,p</span>):</span><br><span class="line">    E = P.curve()</span><br><span class="line">    Eqp = EllipticCurve(Qp(p, <span class="number">2</span>), [ ZZ(t) + randint(<span class="number">0</span>,p)*p <span class="keyword">for</span> t <span class="keyword">in</span> E.a_invariants() ])</span><br><span class="line"></span><br><span class="line">    P_Qps = Eqp.lift_x(ZZ(P.xy()[<span class="number">0</span>]), <span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> P_Qp <span class="keyword">in</span> P_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(P_Qp.xy()[<span class="number">1</span>]) == P.xy()[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    Q_Qps = Eqp.lift_x(ZZ(Q.xy()[<span class="number">0</span>]), <span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> Q_Qp <span class="keyword">in</span> Q_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(Q_Qp.xy()[<span class="number">1</span>]) == Q.xy()[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    p_times_P = p*P_Qp</span><br><span class="line">    p_times_Q = p*Q_Qp</span><br><span class="line"></span><br><span class="line">    x_P,y_P = p_times_P.xy()</span><br><span class="line">    x_Q,y_Q = p_times_Q.xy()</span><br><span class="line"></span><br><span class="line">    phi_P = -(x_P/y_P)</span><br><span class="line">    phi_Q = -(x_Q/y_Q)</span><br><span class="line">    k = phi_Q/phi_P</span><br><span class="line">    <span class="keyword">return</span> ZZ(k)</span><br><span class="line"></span><br><span class="line">k2 = <span class="built_in">int</span>(SmartAttack(g2, k2g2, ecc2.order()))</span><br><span class="line"><span class="comment">#print(k2*g2 == k2g2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part3 AES</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">7</span>):</span><br><span class="line">    temp = k2 + i*g2.order()</span><br><span class="line">    <span class="comment">#print(temp*g2 == k2g2)</span></span><br><span class="line">    key2 = hashlib.md5(<span class="built_in">str</span>(temp).encode()).digest()</span><br><span class="line">    aes2 = AES.new(key2, AES.MODE_ECB)</span><br><span class="line">    dec2 = aes2.decrypt(enc)</span><br><span class="line"></span><br><span class="line">    key1 = hashlib.md5(<span class="built_in">str</span>(k1).encode()).digest()</span><br><span class="line">    aes1 = AES.new(key1, AES.MODE_ECB)</span><br><span class="line">    dec1 = aes1.decrypt(dec2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">b&quot;flag&quot;</span> <span class="keyword">in</span> dec1):</span><br><span class="line">        <span class="built_in">print</span>(dec1)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;609a091e-6666-b7c9-edc2-c721958409e2&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="Rosita"><a href="#Rosita" class="headerlink" title="Rosita"></a>Rosita</h3><p>题目来源：巅峰极客 2023</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Problem by rec, without any sleep at all.</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long <span class="keyword">as</span> b2l</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> p, a, b, flag</span><br><span class="line"></span><br><span class="line">ECC = EllipticCurve(GF(p), [a, b])</span><br><span class="line">R, E, C = [ECC.random_point() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line">pad = <span class="keyword">lambda</span> m: urandom(<span class="number">8</span>) + m + <span class="string">b&#x27;\x00&#x27;</span> * (ZZ(p).nbits() // <span class="number">8</span> - <span class="built_in">len</span>(m) - <span class="number">8</span> - <span class="number">1</span>)</span><br><span class="line">out = <span class="built_in">list</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)):</span><br><span class="line">    m = pad(<span class="built_in">chr</span>(flag[i]).encode())</span><br><span class="line">    nonce = urandom(<span class="number">16</span>)</span><br><span class="line">    sh = sha256(nonce + m).digest()</span><br><span class="line">    </span><br><span class="line">    Q = b2l(m)*R + b2l(nonce)*E + b2l(sh)*C</span><br><span class="line">    out.append(Q.xy())</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;out.tuo&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="built_in">str</span>(out))</span><br></pre></td></tr></table></figure>
<p>题目内容很简短，流程如下：</p>
<ul>
<li>用自定义参数a、b、p生成一条曲线ECC，并在上面随机取了三点R、E、C。曲线参数与REC三点坐标均未知</li>
<li>对flag的每一个字节填充，填充方式为：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad = <span class="keyword">lambda</span> m: urandom(<span class="number">8</span>) + m + <span class="string">b&#x27;\x00&#x27;</span> * (ZZ(p).nbits() // <span class="number">8</span> - <span class="built_in">len</span>(m) - <span class="number">8</span> - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>每一次加密生成一个临时密钥nonce，并依据nonce与填充后的m计算sh</li>
<li>计算：</li>
</ul>
<script type="math/tex; mode=display">
Q_i = m_i*R + nonce_i*E + sh_i*C</script><ul>
<li>给出所有Qi坐标，要求还原m</li>
</ul>
<h4 id="还原ecc参数"><a href="#还原ecc参数" class="headerlink" title="还原ecc参数"></a>还原ecc参数</h4><p>第一步肯定是要先找到原曲线的a、b、p参数的，这里我采用消元办法，思路如下：</p>
<p>我们知道椭圆曲线的点满足方程：</p>
<script type="math/tex; mode=display">
y^2 = x^3+ax+b \quad(mod\;p)</script><p>而Qi均为曲线上的点，所以我们取其中前四个点的坐标，就有四组方程：</p>
<script type="math/tex; mode=display">
y_1^2 = x_1^3+ax_1+b \quad(mod\;p)</script><script type="math/tex; mode=display">
y_2^2 = x_2^3+ax_2+b \quad(mod\;p)</script><script type="math/tex; mode=display">
y_3^2 = x_3^3+ax_3+b \quad(mod\;p)</script><script type="math/tex; mode=display">
y_4^2 = x_4^3+ax_4+b \quad(mod\;p)</script><p>要求从四组方程中还原a、b、p，其实跟无参数的LCG很像，主要目的就是消元，求gcd得到p，然后再回到模方程中求解a、b。</p>
<p>消元过程如下，我们取前两组方程：</p>
<script type="math/tex; mode=display">
y_1^2 -  x_1^3 =ax_1+b \quad(mod\;p)</script><script type="math/tex; mode=display">
y_2^2 - x_2^3= ax_2+b \quad(mod\;p)</script><p>作差消掉b：</p>
<script type="math/tex; mode=display">
y_1^2 -  x_1^3 - y_2^2 + x_2^3=ax_1 - ax_2 \quad(mod\;p)</script><p>把a单独提出来：</p>
<script type="math/tex; mode=display">
(y_1^2 -  x_1^3 - y_2^2 + x_2^3)(x_1-x_2)^{-1} = a \quad(mod\;p)</script><p>同理，我们取第二三组方程也能得到：</p>
<script type="math/tex; mode=display">
(y_2^2 -  x_2^3 - y_3^2 + x_3^3)(x_2-x_3)^{-1} = a \quad(mod\;p)</script><p>那么作差就有：</p>
<script type="math/tex; mode=display">
(y_1^2 -  x_1^3 - y_2^2 + x_2^3)(x_1-x_2)^{-1} - (y_2^2 -  x_2^3 - y_3^2 + x_3^3)(x_2-x_3)^{-1} = 0 \quad(mod\;p)</script><p>那么同样再取一组求gcd，并消去小因子就能得到p，得到p过后还原ab就很轻松。</p>
<p>当然，有更直接的梭哈办法就是直接定义在ZZ域上，用四个点的方程求Groebner就可以轻松还原a、b、p参数。</p>
<h4 id="Smart-Attack"><a href="#Smart-Attack" class="headerlink" title="Smart Attack"></a>Smart Attack</h4><p>有了参数后我们就有了原曲线，经过观察与测试可以知道这个曲线有一个很特殊的性质：</p>
<script type="math/tex; mode=display">
E.order() = p</script><p>有这个性质的曲线可以用Smart attack轻松解决离散对数问题，那么接下来的思路就是如何利用DLP来转化问题。</p>
<p>那么首先，我们期望还原的是明文的每个字符mi，想要解决这一点就要从Qi的生成方式入手：</p>
<script type="math/tex; mode=display">
Q_i = m_i*R + nonce_i*E + sh_i*C</script><p>给了多组Qi相关的线性等式，可以想到应该是要造格，但是造格之前我们需要想办法把ECC相关的计算式转到数域上，而由于DLP在这个曲线上能用Smart Attack轻松求解，因此我们可以考虑如下方式，将所以Qi的计算式转化到数域上：</p>
<p>令G为曲线E的生成元，则G的阶等于曲线的阶，在这条曲线上也就等于p。然后我们就可以把Q、R、E、C等点均用生成元的倍点表示如下：</p>
<script type="math/tex; mode=display">
Q_i = d_iG</script><script type="math/tex; mode=display">
R = rG,E=eG,C=cG</script><p>代回到Qi的计算式中，就有：</p>
<script type="math/tex; mode=display">
d_iG = m_i*rG + nonce_i*eG + sh_i*cG</script><p>即：</p>
<script type="math/tex; mode=display">
d_iG = (m_i*r + nonce_i*e + sh_i*c)G</script><p>而由于G的阶就是曲线的阶，因此有：</p>
<script type="math/tex; mode=display">
d_i \equiv m_i*r + nonce_i*e + sh_i*c \quad(mod\;order)</script><p>又因为曲线阶就等于p，所以有：</p>
<script type="math/tex; mode=display">
d_i \equiv m_i*r + nonce_i*e + sh_i*c \quad(mod\;p)</script><p>到这里，我们就完全脱离了曲线，而转化为了一个数域上的问题，也就是知道多组上述等式，如何求解mi。</p>
<h4 id="格"><a href="#格" class="headerlink" title="格"></a>格</h4><p>现在我们有多组如下等式：</p>
<script type="math/tex; mode=display">
d_i \equiv m_i*r + nonce_i*e + sh_i*c \quad(mod\;p)</script><p>而注意到m_i的填充方式很奇怪：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad = <span class="keyword">lambda</span> m: urandom(<span class="number">8</span>) + m + <span class="string">b&#x27;\x00&#x27;</span> * (ZZ(p).nbits() // <span class="number">8</span> - <span class="built_in">len</span>(m) - <span class="number">8</span> - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>他对flag逐个字节加密，因此len(m)是1，代入我们计算出的p可以得到，这种方式相当于是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad(m) = urandom(<span class="number">8</span>) + m + <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">54</span></span><br></pre></td></tr></table></figure>
<p>而尾缀这些b’\x00’，其实也就相当于把(urandom(8) + m)左移54x8位，其实也就是乘2^432，所以上述等式可以进一步写成：</p>
<script type="math/tex; mode=display">
d_i \equiv m_i*2^{432}r + nonce_i*e + sh_i*c \quad(mod\;p)</script><p>我们把这些等式写成模p下的矩阵乘法的形式，便于我们发现格构造的方法：</p>
<script type="math/tex; mode=display">
\left(
 \begin{matrix}
   m_1 & nonce_1 &sh_1\\
   m_2 & nonce_2 &sh_2\\
   & ...&\\
   m_{72} & nonce_{72} &sh_{72}\\
   m_{73} & nonce_{73} &sh_{73}\\
  \end{matrix}
  \right)_{73*3}
\left(
 \begin{matrix}
   2^{432}r\\
   e\\
   c\\
  \end{matrix}
  \right)_{3*1}
  =
  \left(
 \begin{matrix}
   d_1\\
   d_1\\
   ...\\
   d_{72}\\
   d_{73}\\
  \end{matrix}
  \right)_{73*1}</script><p>而观察到mi均为9字节的短向量，因此应该可以利用格规约。</p>
<p>做到这里就没思路了，这能怎么造格呢？想了好一会儿也没想到。</p>
<p>然后就去找别的师傅的wp，学习到了一种基于正交格的很妙的解法：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41626232/article/details/131861414">巅峰极客2023 Crypto Rosita-CSDN博客</a></p>
<p>这个思路就是，我们首先把上述矩阵方程写作：</p>
<script type="math/tex; mode=display">
M_{73*3}
\left(
 \begin{matrix}
   2^{432}r\\
   e\\
   c\\
  \end{matrix}
  \right)_{3*1}
  =
  D_{73*1}
  \quad(mod\;p)</script><p>然后，我们假设有一个kx73的矩阵R满足下式：</p>
<script type="math/tex; mode=display">
R_{k*73}M_{73*3} = 
\left(
 \begin{matrix}
   0&0&0\\
   &...&\\
   0&0&0\\
  \end{matrix}
  \right)_{k*3}
   \quad(mod\;p)</script><p>这也就是说R与M正交，然后把这个R矩阵同时乘在矩阵方程的两侧：</p>
<script type="math/tex; mode=display">
R_{k*73}M_{73*3}
\left(
 \begin{matrix}
   2^{432}r\\
   e\\
   c\\
  \end{matrix}
  \right)_{3*1}
  =
  R_{k*73}D_{73*1}
   \quad(mod\;p)</script><p>显然就有：</p>
<script type="math/tex; mode=display">
R_{k*73}D_{73*1} =
  \left(
 \begin{matrix}
   0\\
   ...\\
   0\\
  \end{matrix}
  \right)_{k*1}
   \quad(mod\;p)</script><p>也就是说，如果R与M正交，那么R一定满足以下几点：</p>
<ul>
<li><p>R与D也正交</p>
</li>
<li><p>M的三列均在R的右核空间中</p>
</li>
<li>M的第一列是R的右核空间中的一个短向量</li>
</ul>
<p>所以我们就要完成以下的对应目标：</p>
<ul>
<li>找到与M正交的矩阵R</li>
<li>对R的右核空间进行规约得到M的第一列</li>
</ul>
<h5 id="找到R"><a href="#找到R" class="headerlink" title="找到R"></a>找到R</h5><p>由于我们没有M，所以要找到与M正交的矩阵的话，只能通过R与D也正交这一关系来找。为此我们构造如下的格来找到R：</p>
<script type="math/tex; mode=display">
\left(
 \begin{matrix}
   E&D\\
   0&p\\
  \end{matrix}
  \right)</script><p>其中，E是单位矩阵，D是DLP得到的列向量，p是曲线的阶，这里也正好是曲线的模数。</p>
<p>构造这个格是基于：</p>
<script type="math/tex; mode=display">
R_{k*73}D_{73*1} =
  \left(
 \begin{matrix}
   0\\
   ...\\
   0\\
  \end{matrix}
  \right)_{k*1}
   \quad(mod\;p)</script><p>那么我们对R中的任意一行：</p>
<script type="math/tex; mode=display">
(r_1,r_2,...,r_{73})</script><p>都有：</p>
<script type="math/tex; mode=display">
(r_1,r_2,...,r_{73},t)
\left(
 \begin{matrix}
   E&D\\
   0&p\\
  \end{matrix}
  \right)
  =
  (r_1,r_2,...,r_{73},0)</script><p>因此我们就能用LLL规约出若干短向量，只要规约出的最后一个数字为0，就可以作为R的其中一行加入到R中。所以我们可以对格的最后一列配上一个大系数，从而保证规约出0，这样我们就能从中取70行，得到一个70x73的矩阵R。</p>
<h5 id="求解右核"><a href="#求解右核" class="headerlink" title="求解右核"></a>求解右核</h5><p>我们通过刚才的步骤，找到了一个符合要求的70x73的矩阵R，他满足：</p>
<script type="math/tex; mode=display">
R_{70*73}
\left(
 \begin{matrix}
   m_1 & nonce_1 &sh_1\\
   m_2 & nonce_2 &sh_2\\
   & ...&\\
   m_{72} & nonce_{72} &sh_{72}\\
   m_{73} & nonce_{73} &sh_{73}\\
  \end{matrix}
  \right)_{73*3}
= 
\left(
 \begin{matrix}
   0&0&0\\
   &...&\\
   0&0&0\\
  \end{matrix}
  \right)_{70*3}
   \quad(mod\;p)</script><p>而R的右核空间，指的就是满足Rv=0的所有向量v张成的空间，那么显然，<strong>M的三列均在R的右核空间中，并且M的第一列是R的右核空间中的一个短向量。</strong></p>
<p>那么我们就可以按如下方式找到M的第一列：</p>
<ul>
<li>求解R的右核空间</li>
<li>对R的右核空间进行规约</li>
</ul>
<p>找到M的第一列后，依次取最低字节就可以还原flag。</p>
<p>这里可能会有以下几个问题：</p>
<ul>
<li>为什么不取73行？</li>
</ul>
<p>这是因为，取73行后的R矩阵是满秩的，右核空间是0维，而我们需要一个至少一维的右核进行规约。</p>
<ul>
<li>为什么不取更少的比如60、50行？</li>
</ul>
<p>这是因为，少取若干行之后，右核空间维数也会对应增大，高斯启发式期望的短向量长度会显著减小，从而导致我们的目标向量规约不出。经测试取67以下的就规约不出了。</p>
<ul>
<li>为什么不取71、72行？</li>
</ul>
<p>这一点我也暂时不理解，因为既然规约出最后一列为0，就说明该行与D模p下正交，就应该可以作为R的一行才对。但事实上，只有前70行可以作规约，这也就是说，必须是不配大系数也能规约出的正交行，才能作为R中的一行，这我就暂时没有理解到，如果有明白的师傅欢迎与我交流！</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#part1 recover a,b,p</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">points</span>):</span><br><span class="line">    (x1,y1),(x2,y2),(x3,y3),(x4,y4) = points</span><br><span class="line">    t1 = (y2**<span class="number">2</span>-y1**<span class="number">2</span>-x2**<span class="number">3</span>+x1**<span class="number">3</span>)</span><br><span class="line">    t2 = (y3**<span class="number">2</span>-y2**<span class="number">2</span>-x3**<span class="number">3</span>+x2**<span class="number">3</span>)</span><br><span class="line">    t3 = (y4**<span class="number">2</span>-y3**<span class="number">2</span>-x4**<span class="number">3</span>+x3**<span class="number">3</span>)</span><br><span class="line">    k1p = t1*(x3-x2) - t2*(x2-x1)</span><br><span class="line">    k2p = t2*(x4-x3) - t3*(x3-x2)</span><br><span class="line">    k3p = t1*(x4-x3) - t3*(x2-x1)</span><br><span class="line">    p = GCD(k1p,k2p)</span><br><span class="line">    p = GCD(p,k3p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">1000</span>):</span><br><span class="line">        <span class="keyword">while</span>(p % i == <span class="number">0</span>):</span><br><span class="line">            p //= i</span><br><span class="line">    a = inverse(x2-x1,p)*t1 % p</span><br><span class="line">    b = (y1**<span class="number">2</span>-x1**<span class="number">3</span>-a*x1) % p</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a,b,p</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&#x27;E:\题\历届赛题\巅峰极客 2023\Rosita\out.tuo&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    points = <span class="built_in">eval</span>(f.read())</span><br><span class="line">a,b,p = calc(points[:<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Smart&#x27;s attack</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SmartAttack</span>(<span class="params">P,Q,p</span>):</span><br><span class="line">    E = P.curve()</span><br><span class="line">    Eqp = EllipticCurve(Qp(p, <span class="number">2</span>), [ ZZ(t) + randint(<span class="number">0</span>,p)*p <span class="keyword">for</span> t <span class="keyword">in</span> E.a_invariants() ])</span><br><span class="line"></span><br><span class="line">    P_Qps = Eqp.lift_x(ZZ(P.xy()[<span class="number">0</span>]), <span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> P_Qp <span class="keyword">in</span> P_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(P_Qp.xy()[<span class="number">1</span>]) == P.xy()[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    Q_Qps = Eqp.lift_x(ZZ(Q.xy()[<span class="number">0</span>]), <span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> Q_Qp <span class="keyword">in</span> Q_Qps:</span><br><span class="line">        <span class="keyword">if</span> GF(p)(Q_Qp.xy()[<span class="number">1</span>]) == Q.xy()[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    p_times_P = p*P_Qp</span><br><span class="line">    p_times_Q = p*Q_Qp</span><br><span class="line"></span><br><span class="line">    x_P,y_P = p_times_P.xy()</span><br><span class="line">    x_Q,y_Q = p_times_Q.xy()</span><br><span class="line"></span><br><span class="line">    phi_P = -(x_P/y_P)</span><br><span class="line">    phi_Q = -(x_Q/y_Q)</span><br><span class="line">    k = phi_Q/phi_P</span><br><span class="line">    <span class="keyword">return</span> ZZ(k)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(Zmod(p),[a,b])</span><br><span class="line">G = E.gens()[<span class="number">0</span>]</span><br><span class="line">d = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="built_in">len</span>(points)):</span><br><span class="line">    d.append(SmartAttack(G,E(points[i]),p))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part3 LLL</span></span><br><span class="line">L = Matrix(ZZ,<span class="number">74</span>,<span class="number">74</span>)</span><br><span class="line">K = <span class="number">2</span>^<span class="number">100</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">73</span>):</span><br><span class="line">    L[i,i] = <span class="number">1</span></span><br><span class="line">    L[i,-<span class="number">1</span>] = d[i]*K</span><br><span class="line">L[-<span class="number">1</span>,-<span class="number">1</span>] = p*K</span><br><span class="line">res = L.LLL()</span><br><span class="line"></span><br><span class="line">R = Matrix(ZZ,<span class="number">70</span>,<span class="number">73</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">70</span>):</span><br><span class="line">    R[i] = res[i][:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">bas = R.right_kernel().basis()</span><br><span class="line">bas = Matrix(ZZ,bas)</span><br><span class="line">res = bas.LLL()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">b&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    flag += long_to_bytes(<span class="built_in">int</span>(i&amp;<span class="number">0xff</span>))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Congratulations! Your flag is: flag&#123;893d041e-c0a2-3145-5320-cdee7d3c87fb&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="ecdh"><a href="#ecdh" class="headerlink" title="ecdh"></a>ecdh</h3><p>题目来源：强网拟态 2022</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3.9</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> invert</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line">p = <span class="number">0xc483230557557e3d94b7407f3355b8a5b26bda29119babcb8d72b5a19e10e113</span></span><br><span class="line">a = <span class="number">0xb5ecbb93d4e49fe3c93ad770343ec5ab70131151151fcc830f6c658223c92e1d</span></span><br><span class="line">b = <span class="number">0xb0d9363d1828cfa7c2aba27b0d483fe808637adf6e3a0a5bbc6cb53fdd1e4d85</span></span><br><span class="line"></span><br><span class="line">Px = <span class="number">0xe9592b5211516c197f0fd31cf0e28201ea0bcc67f7356d8732ded234045259e3</span></span><br><span class="line">Py = <span class="number">0xe825e2821cc58e97816ca9877b7604b05a9a4bbc03110bc2124be49eb2718c23</span></span><br><span class="line">P = (Px, Py)</span><br><span class="line">zero = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">           </span><br><span class="line">MENU = <span class="string">rb&#x27;&#x27;&#x27;1.sign</span></span><br><span class="line"><span class="string">2.get flag</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">p1, p2</span>):</span><br><span class="line">    <span class="keyword">if</span> p1 == zero:</span><br><span class="line">        <span class="keyword">return</span> p2</span><br><span class="line">    <span class="keyword">if</span> p2 == zero:</span><br><span class="line">        <span class="keyword">return</span> p1</span><br><span class="line">    p1x, p1y = p1</span><br><span class="line">    p2x, p2y = p2</span><br><span class="line">    <span class="keyword">if</span> p1x == p2x <span class="keyword">and</span> (p1y != p2y <span class="keyword">or</span> p1y == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> zero</span><br><span class="line">    <span class="keyword">if</span> p1x == p2x:</span><br><span class="line">        tmp = (<span class="number">3</span> * p1x * p1x + a) * invert(<span class="number">2</span> * p1y, p) % p</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp = (p2y - p1y) * invert(p2x - p1x, p) % p</span><br><span class="line">    x = (tmp * tmp - p1x - p2x) % p</span><br><span class="line">    y = (tmp * (p1x - x) - p1y) % p</span><br><span class="line">    <span class="keyword">return</span> x, y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">p, n</span>):</span><br><span class="line">    r = zero</span><br><span class="line">    tmp = p</span><br><span class="line">    <span class="keyword">while</span> <span class="number">0</span> &lt; n:</span><br><span class="line">        <span class="keyword">if</span> n &amp; <span class="number">1</span> == <span class="number">1</span>:</span><br><span class="line">            r = add(r, tmp)</span><br><span class="line">        n, tmp = n &gt;&gt; <span class="number">1</span>, add(tmp, tmp)</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>(socketserver.BaseRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_recvall</span>(<span class="params">self</span>):</span><br><span class="line">        BUFF_SIZE = <span class="number">1024</span></span><br><span class="line">        data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            part = self.request.recv(BUFF_SIZE)</span><br><span class="line">            data += part</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(part) &lt; BUFF_SIZE:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> data.strip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, msg, newline=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> newline:</span><br><span class="line">                msg += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">            self.request.sendall(msg)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self, prompt=<span class="string">b&#x27;&gt; &#x27;</span></span>):</span><br><span class="line">        self.send(prompt, newline=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> self._recvall()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">timeout_handler</span>(<span class="params">self, signum, frame</span>):</span><br><span class="line">        <span class="keyword">raise</span> TimeoutError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">proof_of_work</span>(<span class="params">self</span>):</span><br><span class="line">        random.seed(urandom(<span class="number">32</span>))</span><br><span class="line">        alphabet = string.ascii_letters + string.digits</span><br><span class="line">        proof = <span class="string">&#x27;&#x27;</span>.join(random.choices(alphabet, k=<span class="number">32</span>))</span><br><span class="line">        hash_value = sha256(proof.encode()).hexdigest()</span><br><span class="line">        self.send(<span class="string">f&#x27;sha256(XXXX+<span class="subst">&#123;proof[<span class="number">4</span>:]&#125;</span>) == <span class="subst">&#123;hash_value&#125;</span>&#x27;</span>.encode())</span><br><span class="line">        nonce = self.recv(prompt=<span class="string">b&#x27;Give me XXXX &gt; &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(nonce) != <span class="number">4</span> <span class="keyword">or</span> sha256(nonce + proof[<span class="number">4</span>:].encode()).hexdigest() != hash_value:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            signal.signal(signal.SIGALRM, self.timeout_handler)</span><br><span class="line">            signal.alarm(<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.proof_of_work():</span><br><span class="line">                self.send(<span class="string">b&#x27;\nWrong!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            self.secret = random.randint(<span class="number">0</span>, p)</span><br><span class="line">            Q = mul(P, self.secret)</span><br><span class="line"></span><br><span class="line">            self.send(<span class="string">b&#x27;p: &#x27;</span> + <span class="built_in">str</span>(p).encode())</span><br><span class="line">            self.send(<span class="string">b&#x27;a: &#x27;</span> + <span class="built_in">str</span>(a).encode())</span><br><span class="line">            self.send(<span class="string">b&#x27;P: &#x27;</span> + self.point_to_string(P).encode())</span><br><span class="line">            self.send(<span class="string">b&#x27;Q: &#x27;</span> + self.point_to_string(Q).encode())</span><br><span class="line"></span><br><span class="line">            signal.alarm(<span class="number">300</span>)</span><br><span class="line">		</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">45</span>):</span><br><span class="line">                self.send(MENU, newline=<span class="literal">False</span>)</span><br><span class="line">                choice = <span class="built_in">int</span>(self.recv(prompt=<span class="string">b&#x27;&gt; &#x27;</span>))</span><br><span class="line">                <span class="keyword">if</span> choice == <span class="number">1</span>:</span><br><span class="line">                    self.sign()</span><br><span class="line">                <span class="keyword">elif</span> choice == <span class="number">2</span>:</span><br><span class="line">                    self.get_flag()</span><br><span class="line">                <span class="keyword">else</span>:                </span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            self.send(<span class="string">b&#x27;Bye!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> TimeoutError:</span><br><span class="line">            self.send(<span class="string">b&#x27;\nTimeout!&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            self.send(<span class="string">b&#x27;Something Wrong!&#x27;</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.request.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">point_to_string</span>(<span class="params">p</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;(<span class="subst">&#123;p[<span class="number">0</span>]&#125;</span>, <span class="subst">&#123;p[<span class="number">1</span>]&#125;</span>)&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">self</span>):</span><br><span class="line">        self.send(<span class="string">b&#x27;Give me your key:&#x27;</span>)</span><br><span class="line">        x = <span class="built_in">int</span>(self.recv(prompt=<span class="string">b&#x27;X &gt; &#x27;</span>))</span><br><span class="line">        y = <span class="built_in">int</span>(self.recv(prompt=<span class="string">b&#x27;Y &gt; &#x27;</span>))</span><br><span class="line">        point = (x, y)</span><br><span class="line">        result = mul(point, self.secret)</span><br><span class="line">        self.send(<span class="string">b&#x27;result: &#x27;</span> + self.point_to_string(result).encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">self</span>):</span><br><span class="line">        s = <span class="built_in">int</span>(self.recv(prompt=<span class="string">b&#x27;Give me the secret &gt; &#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> s == self.secret:</span><br><span class="line">            self.send(<span class="string">b&#x27;Here is your flag:&#x27;</span>)</span><br><span class="line">            self.send(FLAG)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.send(<span class="string">b&#x27;wrong.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForkedServer</span>(socketserver.ForkingMixIn, socketserver.TCPServer):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    HOST, PORT = <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10002</span></span><br><span class="line">    <span class="built_in">print</span>(HOST, PORT)</span><br><span class="line">    server = ForkedServer((HOST, PORT), Task)</span><br><span class="line">    server.allow_reuse_address = <span class="literal">True</span></span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>题目代码比较长，但其实主要任务很容易描述：</p>
<ul>
<li>生成一条给定参数的椭圆曲线</li>
<li>生成一个(0,p)之间的随机数当作私钥secret</li>
<li>通过proof后，有45次交互机会。输入1，可以输入一个点的坐标，并获得他的secret倍点坐标；输入2，可以核验secret值，如果输入的值等于secret则得到flag</li>
</ul>
<p>因此目标明确：想办法构造一些点，并利用输入1的交互返回的倍点来求解secret的有关信息。</p>
<p>首先检查题目椭圆曲线的几个参数，可以发现这个曲线并不是易受攻击的椭圆曲线(比如阶光滑、阶为p之类)，那么直接求解DLP肯定是不行的。</p>
<p>然后注意到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self.send(<span class="string">b&#x27;p: &#x27;</span> + <span class="built_in">str</span>(p).encode())</span><br><span class="line">self.send(<span class="string">b&#x27;a: &#x27;</span> + <span class="built_in">str</span>(a).encode())</span><br><span class="line">self.send(<span class="string">b&#x27;P: &#x27;</span> + self.point_to_string(P).encode())</span><br><span class="line">self.send(<span class="string">b&#x27;Q: &#x27;</span> + self.point_to_string(Q).encode())</span><br></pre></td></tr></table></figure>
<p>这是通过proof后靶机会发送给我们的信息，可以注意到一个隐晦的提示：为什么不发送参数b给我们？</p>
<p>要知道，参数b其实是题目上面有的。结合题目任务：我们可以输入1，得到自定义的一个点的倍点坐标。紧接着就会注意到：<strong>这里根本没有对输入的点在不在曲线上进行检查。</strong></p>
<p>也就是说，我们完全可以输入一个不在题目曲线上的点，靶机端仍然会照常进行倍点运算并返回给我们倍点坐标。那么如何利用这一点呢？</p>
<p>熟悉倍点计算过程的话应该会知道，倍点的计算其实和参数b没有一点关系，也就是说，我们可以自选一个合适的b’，然后构造一条新的曲线：</p>
<script type="math/tex; mode=display">
E': \quad y^2 = x^3 + ax + b' \quad(mod\;p)</script><p>也就是说，由于倍点与b无关，我们输入给靶机这条曲线上的点的话，靶机计算出来的其实也是这条曲线上的倍点。因此我们现在就可以想办法改变b’，从而找到一条合适的曲线。</p>
<h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>什么样的参数b’才算合适呢，首先能想到的肯定是找到的b’应该使曲线的DLP易求。就比如说，假如我们可以找到b’使得曲线E’的阶是光滑的，那么就可以输入一个E’的生成元，并很轻松地由倍点求解DLP得到secret；又或者我们能找到b’使得E’是anomalous curve，也就是E’.order()=p，那么就可以用Smart Attack攻击等等。</p>
<p>大致思路如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">p = <span class="number">0xc483230557557e3d94b7407f3355b8a5b26bda29119babcb8d72b5a19e10e113</span></span><br><span class="line">a = <span class="number">0xb5ecbb93d4e49fe3c93ad770343ec5ab70131151151fcc830f6c658223c92e1d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line">    b = i</span><br><span class="line">    temp = factor(EllipticCurve(GF(p), [a, b]).order())</span><br><span class="line">    <span class="built_in">print</span>(temp)</span><br><span class="line">    maxp = [<span class="built_in">int</span>(p) <span class="keyword">for</span> p, e <span class="keyword">in</span> temp][-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span>(maxp &lt; <span class="number">2</span> ^ <span class="number">40</span>):</span><br><span class="line">        <span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure>
<p>但是实际这样做的话，会发现由于order比较大，所以factor执行的很慢，因此很难在短时间内找到一个符合条件的b’。所以要想别的更通用一点的办法，毕竟我们其实有多次交互机会可以用。</p>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>可以想到用CRT来解题，我们假设取了某个b’，得到的E’的阶order是：</p>
<script type="math/tex; mode=display">
order = p_1^{k_1}p_2^{k_2}...p_n^{k_n}</script><p>其中，因子分解按从小到大的递增顺序排列，那么假设我们用factordb获取到其中的一个小素因子a1。(较小但是又不那么小，比如3347、3517这种)</p>
<p>然后，我们取E’的一个生成元G，G的阶就等于曲线的阶order，然后我们获取以下点：</p>
<script type="math/tex; mode=display">
G_1 = \frac{order}{a_1}*G</script><p>那么G1是a1阶元素，这是因为：</p>
<script type="math/tex; mode=display">
a_1G_1 = a_1*\frac{order}{a_1}*G = order*G = O</script><p>而a1是我们分解order后得到的一个小素因子，那么我们发送G1给靶机得到Q1，然后就可以在(0,a1)内爆破出对应的倍数d1，d1满足：</p>
<script type="math/tex; mode=display">
d_1 = secret \quad(mod\;a_1)</script><p>然后我们改变b，并如此重复多次，就可以CRT得到secret在更大模数下的值。也就是说，我们不断调整b，并选取order的一些小因子去求secret模这些小因子下的结果，只要能使得最后的模数乘积大于p，我们就能得到secret的原本值了。</p>
<p>然后还有一个问题就是限时300s且只有44次输入1的交互，所以选的素因子最佳的就是大小为几千的数，选太大会加长爆破时间，选太小可能会注意不到模数重复，并且可能凑不够256比特。同时proof过的太慢的话可以掐掉重来(不过选的数字恰当的话不会这么紧)。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Pwn4Sage.pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> crt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proof_of_work</span>():</span><br><span class="line">	table = string.digits + string.ascii_letters</span><br><span class="line">	temp = r.recvuntil(<span class="string">b&quot;sha256(XXXX+&quot;</span>)</span><br><span class="line">	temp = r.recvline()</span><br><span class="line">	suffix = temp[:<span class="number">28</span>].decode()</span><br><span class="line">	hex1 = temp[<span class="number">33</span>:].strip().decode()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> tqdm(table):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> table:</span><br><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> table:</span><br><span class="line">				<span class="keyword">for</span> m <span class="keyword">in</span> table:</span><br><span class="line">					temp1 = i+j+k+m</span><br><span class="line">					<span class="keyword">if</span>(sha256((temp1+suffix).encode()).hexdigest() == hex1):</span><br><span class="line">						r.sendline(temp1.encode())</span><br><span class="line">						<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part1 Get parameters</span></span><br><span class="line">r = remote(<span class="string">&quot;node5.anna.nssctf.cn&quot;</span>,<span class="number">28809</span>)</span><br><span class="line">proof_of_work()</span><br><span class="line">r.recvuntil(<span class="string">b&quot;XXXX &gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line">p = <span class="built_in">int</span>(r.recvline().strip().decode()[<span class="number">3</span>:])</span><br><span class="line">a = <span class="built_in">int</span>(r.recvline().strip().decode()[<span class="number">3</span>:])</span><br><span class="line">P = <span class="built_in">eval</span>(r.recvline().strip().decode()[<span class="number">3</span>:])</span><br><span class="line">Q = <span class="built_in">eval</span>(r.recvline().strip().decode()[<span class="number">3</span>:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part2 Get secret % num_i</span></span><br><span class="line">B = [(<span class="number">5</span>,<span class="number">12841</span>),(<span class="number">9</span>,<span class="number">9463</span>),(<span class="number">12</span>,<span class="number">1567</span>,<span class="number">2371</span>,<span class="number">5981</span>),(<span class="number">14</span>,<span class="number">7417</span>),(<span class="number">16</span>,<span class="number">3413</span>),(<span class="number">27</span>,<span class="number">4127</span>),(<span class="number">28</span>,<span class="number">9901</span>),(<span class="number">36</span>,<span class="number">8581</span>),(<span class="number">41</span>,<span class="number">5659</span>),(<span class="number">45</span>, <span class="number">5477</span>,<span class="number">7057</span>),(<span class="number">54</span>,<span class="number">1109</span>),(<span class="number">61</span>,<span class="number">409</span>),(<span class="number">64</span>,<span class="number">7243</span>),(<span class="number">66</span>,<span class="number">1049</span>),(<span class="number">67</span>,<span class="number">3469</span>),(<span class="number">68</span>,<span class="number">1979</span>),(<span class="number">69</span>,<span class="number">1987</span>,<span class="number">6967</span>),(<span class="number">73</span>,<span class="number">1873</span>),(<span class="number">77</span>,<span class="number">1153</span>)]</span><br><span class="line">modnum = []</span><br><span class="line">secret = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="built_in">len</span>(B)):</span><br><span class="line">	b = B[i][<span class="number">0</span>]</span><br><span class="line">	E = EllipticCurve(Zmod(p),[a,b])</span><br><span class="line">	order = E.order()</span><br><span class="line">	G = E.gens()[<span class="number">0</span>]</span><br><span class="line">	factors = B[i][<span class="number">1</span>:]</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> factors:</span><br><span class="line">		r.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">		r.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">		sendG = (order//j)*G</span><br><span class="line">		modnum.append(j)</span><br><span class="line">		sendGx = <span class="built_in">int</span>(sendG[<span class="number">0</span>])</span><br><span class="line">		sendGy = <span class="built_in">int</span>(sendG[<span class="number">1</span>])</span><br><span class="line">		r.sendline(<span class="built_in">str</span>(sendGx).encode())</span><br><span class="line">		r.sendline(<span class="built_in">str</span>(sendGy).encode())</span><br><span class="line"></span><br><span class="line">		r.recvuntil(<span class="string">b&#x27;result: &#x27;</span>)</span><br><span class="line">		temp = <span class="built_in">eval</span>(r.recvline().strip().decode())</span><br><span class="line">		Qx = <span class="built_in">int</span>(temp[<span class="number">0</span>])</span><br><span class="line">		Qy = <span class="built_in">int</span>(temp[<span class="number">1</span>])</span><br><span class="line">		Q = E(Qx,Qy)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(j):</span><br><span class="line">			<span class="keyword">if</span>(k*sendG == Q):</span><br><span class="line">				secret.append(k)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part3 Get flag using CRT</span></span><br><span class="line">secret1 = crt(modnum,secret)[<span class="number">0</span>]	</span><br><span class="line">r.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&quot;the secret &gt; &quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(secret1).encode())</span><br><span class="line">r.recvline()</span><br><span class="line"><span class="built_in">print</span>(r.recvline())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#NSSCTF&#123;dabf6daf-d95d-4764-8af0-b5fa9b8dc442&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="Tiny-ECC"><a href="#Tiny-ECC" class="headerlink" title="Tiny ECC"></a>Tiny ECC</h3><p>题目来源：CryptoCTF 2021</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># In the name of Allah</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mini_ecdsa <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tonelli_shanks</span>(<span class="params">n, p</span>):</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">pow</span>(n, <span class="built_in">int</span>((p-<span class="number">1</span>)//<span class="number">2</span>), p) == <span class="number">1</span>:</span><br><span class="line">			s = <span class="number">1</span></span><br><span class="line">			q = <span class="built_in">int</span>((p-<span class="number">1</span>)//<span class="number">2</span>)</span><br><span class="line">			<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">				<span class="keyword">if</span> q % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">					q = q // <span class="number">2</span></span><br><span class="line">					s += <span class="number">1</span></span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">if</span> s == <span class="number">1</span>:</span><br><span class="line">				r1 = <span class="built_in">pow</span>(n, <span class="built_in">int</span>((p+<span class="number">1</span>)//<span class="number">4</span>), p)</span><br><span class="line">				r2 = p - r1</span><br><span class="line">				<span class="keyword">return</span> r1, r2</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				z = <span class="number">2</span></span><br><span class="line">				<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">					<span class="keyword">if</span> <span class="built_in">pow</span>(z, <span class="built_in">int</span>((p-<span class="number">1</span>)//<span class="number">2</span>), p) == p - <span class="number">1</span>:</span><br><span class="line">						c = <span class="built_in">pow</span>(z, q, p)</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						z += <span class="number">1</span></span><br><span class="line">				r = <span class="built_in">pow</span>(n, <span class="built_in">int</span>((q+<span class="number">1</span>)//<span class="number">2</span>), p)</span><br><span class="line">				t = <span class="built_in">pow</span>(n, q, p)</span><br><span class="line">				m = s</span><br><span class="line">				<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">					<span class="keyword">if</span> t == <span class="number">1</span>:</span><br><span class="line">						r1 = r</span><br><span class="line">						r2 = p - r1</span><br><span class="line">						<span class="keyword">return</span> r1, r2</span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						i = <span class="number">1</span></span><br><span class="line">						<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">							<span class="keyword">if</span> <span class="built_in">pow</span>(t, <span class="number">2</span>**i, p) == <span class="number">1</span>:</span><br><span class="line">								<span class="keyword">break</span></span><br><span class="line">							<span class="keyword">else</span>:</span><br><span class="line">								i += <span class="number">1</span></span><br><span class="line">						b = <span class="built_in">pow</span>(c, <span class="number">2</span>**(m-i-<span class="number">1</span>), p)</span><br><span class="line">						r = r * b % p</span><br><span class="line">						t = t * b ** <span class="number">2</span> % p</span><br><span class="line">						c = b ** <span class="number">2</span> % p</span><br><span class="line">						m = i</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_point</span>(<span class="params">p, a, b</span>):</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		gx = getRandomRange(<span class="number">1</span>, p-<span class="number">1</span>)</span><br><span class="line">		n = (gx**<span class="number">3</span> + a*gx + b) % p</span><br><span class="line">		gy = tonelli_shanks(n, p)</span><br><span class="line">		<span class="keyword">if</span> gy == <span class="literal">False</span>:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> (gx, gy[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">die</span>(<span class="params">*args</span>):</span><br><span class="line">	pr(*args)</span><br><span class="line">	quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>(<span class="params">*args</span>):</span><br><span class="line">	s = <span class="string">&quot; &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, args))</span><br><span class="line">	sys.stdout.write(s + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sc</span>():</span><br><span class="line">	<span class="keyword">return</span> sys.stdin.readline().strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">	border = <span class="string">&quot;+&quot;</span></span><br><span class="line">	pr(border*<span class="number">72</span>)</span><br><span class="line">	pr(border, <span class="string">&quot;  Dual ECC means two elliptic curve with same coefficients over the &quot;</span>, border)</span><br><span class="line">	pr(border, <span class="string">&quot;  different fields or ring! You should calculate the discrete log   &quot;</span>, border)</span><br><span class="line">	pr(border, <span class="string">&quot;  in dual ECCs. So be smart in choosing the first parameters! Enjoy!&quot;</span>, border)</span><br><span class="line">	pr(border*<span class="number">72</span>)</span><br><span class="line"></span><br><span class="line">	bool_coef, bool_prime, nbit = <span class="literal">False</span>, <span class="literal">False</span>, <span class="number">128</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		pr(<span class="string">f&quot;| Options: \n|\t[C]hoose the <span class="subst">&#123;nbit&#125;</span>-bit prime p \n|\t[A]ssign the coefficients \n|\t[S]olve DLP \n|\t[Q]uit&quot;</span>)</span><br><span class="line">		ans = sc().lower()</span><br><span class="line">		<span class="keyword">if</span> ans == <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">			pr(<span class="string">&#x27;| send the coefficients a and b separated by comma: &#x27;</span>)</span><br><span class="line">			COEFS = sc()</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				a, b = [<span class="built_in">int</span>(_) <span class="keyword">for</span> _ <span class="keyword">in</span> COEFS.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				die(<span class="string">&#x27;| your coefficients are not valid, Bye!!&#x27;</span>)</span><br><span class="line">			<span class="keyword">if</span> a*b == <span class="number">0</span>:</span><br><span class="line">				die(<span class="string">&#x27;| Kidding me?!! a*b should not be zero!!&#x27;</span>)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				bool_coef = <span class="literal">True</span></span><br><span class="line">		<span class="keyword">elif</span> ans == <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">			pr(<span class="string">&#x27;| send your prime: &#x27;</span>)</span><br><span class="line">			p = sc()</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				p = <span class="built_in">int</span>(p)</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				die(<span class="string">&#x27;| your input is not valid :(&#x27;</span>)</span><br><span class="line">			<span class="keyword">if</span> isPrime(p) <span class="keyword">and</span> p.bit_length() == nbit <span class="keyword">and</span> isPrime(<span class="number">2</span>*p + <span class="number">1</span>):</span><br><span class="line">				q = <span class="number">2</span>*p + <span class="number">1</span></span><br><span class="line">				bool_prime = <span class="literal">True</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				die(<span class="string">f&#x27;| your integer p is not <span class="subst">&#123;nbit&#125;</span>-bit prime or 2p + 1 is not prime, bye!!&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> ans == <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> bool_coef == <span class="literal">False</span>:</span><br><span class="line">				pr(<span class="string">&#x27;| please assign the coefficients.&#x27;</span>)</span><br><span class="line">			<span class="keyword">if</span> bool_prime == <span class="literal">False</span>:</span><br><span class="line">				pr(<span class="string">&#x27;| please choose your prime first.&#x27;</span>)</span><br><span class="line">			<span class="keyword">if</span> bool_prime <span class="keyword">and</span> bool_coef:</span><br><span class="line">				Ep = CurveOverFp(<span class="number">0</span>, a, b, p)</span><br><span class="line">				Eq = CurveOverFp(<span class="number">0</span>, a, b, q)</span><br><span class="line"></span><br><span class="line">				xp, yp = random_point(p, a, b)</span><br><span class="line">				P = Point(xp, yp)</span><br><span class="line"></span><br><span class="line">				xq, yq = random_point(q, a, b)</span><br><span class="line">				Q = Point(xq, yq)</span><br><span class="line"></span><br><span class="line">				k = getRandomRange(<span class="number">1</span>, p &gt;&gt; <span class="number">1</span>)</span><br><span class="line">				kP = Ep.mult(P, k)</span><br><span class="line"></span><br><span class="line">				l = getRandomRange(<span class="number">1</span>, q &gt;&gt; <span class="number">1</span>)</span><br><span class="line">				lQ = Eq.mult(Q, l)</span><br><span class="line">				pr(<span class="string">&#x27;| We know that: &#x27;</span>)</span><br><span class="line">				pr(<span class="string">f&#x27;| P = <span class="subst">&#123;P&#125;</span>&#x27;</span>)</span><br><span class="line">				pr(<span class="string">f&#x27;| k*P = <span class="subst">&#123;kP&#125;</span>&#x27;</span>)</span><br><span class="line">				pr(<span class="string">f&#x27;| Q = <span class="subst">&#123;Q&#125;</span>&#x27;</span>)</span><br><span class="line">				pr(<span class="string">f&#x27;| l*Q = <span class="subst">&#123;lQ&#125;</span>&#x27;</span>)</span><br><span class="line">				pr(<span class="string">&#x27;| send the k and l separated by comma: &#x27;</span>)</span><br><span class="line">				PRIVS = sc()</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					priv, qriv = [<span class="built_in">int</span>(s) <span class="keyword">for</span> s <span class="keyword">in</span> PRIVS.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">				<span class="keyword">except</span>:</span><br><span class="line">					die(<span class="string">&#x27;| your input is not valid, Bye!!&#x27;</span>)</span><br><span class="line">				<span class="keyword">if</span> priv == k <span class="keyword">and</span> qriv == l:</span><br><span class="line">					die(<span class="string">f&#x27;| Congrats, you got the flag: <span class="subst">&#123;flag&#125;</span>&#x27;</span>)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					die(<span class="string">&#x27;| sorry, your keys are not correct! Bye!!!&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> ans == <span class="string">&#x27;q&#x27;</span>:</span><br><span class="line">			die(<span class="string">&quot;Quitting ...&quot;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			die(<span class="string">&quot;Bye ...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>题目比较长，但是其实提取出来的任务还是很清楚，靶机提供给了我们三个有用选项：</p>
<ul>
<li>输入a，可以提供ECC的a、b参数，这里要求a、b均不为0</li>
<li>输入c，可以提供ECC的模数p，这里要求p是一个128比特的素数且q=2p+1也是一个素数</li>
<li>在参数均给定后，输入s，题目会用输入的参数生成以下两条曲线：</li>
</ul>
<script type="math/tex; mode=display">
y^2 = x^3 + ax + b \quad(mod\; p)</script><script type="math/tex; mode=display">
y^2 = x^3 + ax + b \quad(mod\; q)</script><ul>
<li>并且，题目会分别取这两条曲线上的随机点P、Q，并生成两个随机数k、l，计算倍点kP、lQ，并给出四个点的坐标。如果能够计算出正确的k、l并提交，我们就能获取flag</li>
</ul>
<p>那么其实也就是解一个离散对数问题，而ECC的所有参数都是我们可以自定义的，那么可操作性非常大。这里我阐述两种思路。</p>
<h4 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h4><p>最直接的思路就是：直接爆破p、q、a、b，使得两条曲线均光滑，这样我们就可以pohlig-hellman轻松解决DLP。这一部分实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">genprime</span>(<span class="params">nbits</span>):</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        a = getPrime(<span class="number">16</span>)</span><br><span class="line">        b = getPrime(<span class="number">16</span>)</span><br><span class="line">        p = <span class="built_in">int</span>(getPrime(<span class="number">128</span>))</span><br><span class="line">        q = <span class="built_in">int</span>(<span class="number">2</span>*p + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span>(isPrime(q)):</span><br><span class="line">            Ep = EllipticCurve(GF(p),[a,b])</span><br><span class="line">            Eq = EllipticCurve(GF(q),[a,b])</span><br><span class="line">            factorsEp = <span class="built_in">list</span>(factor(Ep.order()))</span><br><span class="line">            factorsEq = <span class="built_in">list</span>(factor(Eq.order()))</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">int</span>(factorsEp[-<span class="number">1</span>][<span class="number">0</span>]).bit_length(),<span class="built_in">int</span>(factorsEq[-<span class="number">1</span>][<span class="number">0</span>]).bit_length())</span><br><span class="line">            <span class="keyword">if</span>(factorsEp[-<span class="number">1</span>][<span class="number">0</span>] &lt; <span class="number">2</span>^<span class="number">35</span> <span class="keyword">and</span> factorsEq[-<span class="number">1</span>][<span class="number">0</span>] &lt; <span class="number">2</span>^<span class="number">35</span>):</span><br><span class="line">                <span class="built_in">print</span>(factorsEp)</span><br><span class="line">                <span class="built_in">print</span>(factorsEq)</span><br><span class="line">                <span class="keyword">return</span> a,b,p,q</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>这个方法确实用一小段时间就能找到一组合理值。</p>
<h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h4><p>这个方法我是看maple的博客看到的，原wp指路：</p>
<p><a target="_blank" rel="noopener" href="https://blog.maple3142.net/2021/08/01/cryptoctf-2021-writeups/?highlight=crypto#tiny-ecc">Crypto CTF 2021 WriteUps | 廢文集中區 (maple3142.net)</a></p>
<p>也就是说，在输入a、b时，他只检查a、b均不为0.并且他的椭圆曲线实现中不会检查曲线是singular curve(4a^3+27b^2=0)的情况(而sage中会)，所以我们可以令a，b均等于pq，这样两条曲线就分别是：</p>
<script type="math/tex; mode=display">
y^2 = x^3 \quad(mod\;p)</script><script type="math/tex; mode=display">
y^2 = x^3 \quad(mod\;q)</script><p>而这样的singular curve可以作椭圆曲线加法群中的点到有限域中的数的映射：</p>
<script type="math/tex; mode=display">
(x,y) \rightarrow \frac{y}{x}</script><p>因此可以直接求解逆元求解离散对数问题。而其实取其他singular curve的参数，我们同样可以找到映射，但是肯定没有这个这么简单。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Pwn4Sage.pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genprime</span>(<span class="params">nbits</span>):</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        a = getPrime(<span class="number">16</span>)</span><br><span class="line">        b = getPrime(<span class="number">16</span>)</span><br><span class="line">        p = <span class="built_in">int</span>(getPrime(<span class="number">128</span>))</span><br><span class="line">        q = <span class="built_in">int</span>(<span class="number">2</span>*p + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span>(isPrime(q)):</span><br><span class="line">            Ep = EllipticCurve(GF(p),[a,b])</span><br><span class="line">            Eq = EllipticCurve(GF(q),[a,b])</span><br><span class="line">            factorsEp = <span class="built_in">list</span>(factor(Ep.order()))</span><br><span class="line">            factorsEq = <span class="built_in">list</span>(factor(Eq.order()))</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">int</span>(factorsEp[-<span class="number">1</span>][<span class="number">0</span>]).bit_length(),<span class="built_in">int</span>(factorsEq[-<span class="number">1</span>][<span class="number">0</span>]).bit_length())</span><br><span class="line">            <span class="keyword">if</span>(factorsEp[-<span class="number">1</span>][<span class="number">0</span>] &lt; <span class="number">2</span>^<span class="number">35</span> <span class="keyword">and</span> factorsEq[-<span class="number">1</span>][<span class="number">0</span>] &lt; <span class="number">2</span>^<span class="number">35</span>):</span><br><span class="line">                <span class="built_in">print</span>(factorsEp)</span><br><span class="line">                <span class="built_in">print</span>(factorsEq)</span><br><span class="line">                <span class="keyword">return</span> a,b,p,q</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;node4.anna.nssctf.cn&quot;</span>,<span class="number">28697</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part1 send p</span></span><br><span class="line">r.recvuntil(<span class="string">b&quot;[Q]uit&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&quot;prime:&quot;</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    p = <span class="built_in">int</span>(getPrime(<span class="number">128</span>))</span><br><span class="line">    q = <span class="built_in">int</span>(<span class="number">2</span>*p+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(isPrime(q)):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">r.sendline(<span class="built_in">str</span>(p).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#part2 send a,b</span></span><br><span class="line">r.recvuntil(<span class="string">b&quot;[Q]uit&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&quot;by comma:&quot;</span>)</span><br><span class="line">a = p*q</span><br><span class="line">b = p*q</span><br><span class="line">r.sendline(<span class="built_in">str</span>(a).encode() + <span class="string">b&quot;,&quot;</span> + <span class="built_in">str</span>(b).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#part3 get point</span></span><br><span class="line">r.recvuntil(<span class="string">b&quot;[Q]uit&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">b&quot;s&quot;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&quot; = (&quot;</span>)</span><br><span class="line">P = <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span> + r.recvline().strip().decode())</span><br><span class="line">r.recvuntil(<span class="string">b&quot; = (&quot;</span>)</span><br><span class="line">kP = <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span> + r.recvline().strip().decode())</span><br><span class="line">r.recvuntil(<span class="string">b&quot; = (&quot;</span>)</span><br><span class="line">Q = <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span> + r.recvline().strip().decode())</span><br><span class="line">r.recvuntil(<span class="string">b&quot; = (&quot;</span>)</span><br><span class="line">lQ = <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span> + r.recvline().strip().decode())</span><br><span class="line">r.recvuntil(<span class="string">b&quot;comma: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part4 solveDLP Getflag</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mapping</span>(<span class="params">point,prime</span>):</span><br><span class="line">    x = point[<span class="number">0</span>]</span><br><span class="line">    y = point[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> y*inverse(x,prime) % prime</span><br><span class="line">map_P = mapping(P,p)</span><br><span class="line">map_kP = mapping(kP,p)</span><br><span class="line">map_Q = mapping(Q,q)</span><br><span class="line">map_lQ = mapping(lQ,q)</span><br><span class="line"></span><br><span class="line">k = inverse(map_kP,p)*map_P % p</span><br><span class="line">l = inverse(map_lQ,q)*map_Q % q</span><br><span class="line">r.sendline(<span class="built_in">str</span>(k).encode() + <span class="string">b&quot;,&quot;</span> + <span class="built_in">str</span>(l).encode())</span><br><span class="line">r.recvline()</span><br><span class="line"><span class="built_in">print</span>(r.recvline())</span><br><span class="line"></span><br><span class="line"><span class="comment">#NSSCTF&#123;c375f851-5f15-438d-9726-fd20b8903ebe&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>糖醋小鸡块
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tangcuxiaojikuai.xyz/post/187210a7.html" title="Crypto趣题-曲线">https://tangcuxiaojikuai.xyz/post/187210a7.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sacreative/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SACREATIVE</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/ea445335.html" rel="prev" title="Crypto趣题-RSA(一)">
      <i class="fa fa-chevron-left"></i> Crypto趣题-RSA(一)
    </a></div>
      <div class="post-nav-item">
    <a href="/post/9b40da15.html" rel="next" title="Crypto趣题-Lattice">
      Crypto趣题-Lattice <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#EdRSA"><span class="nav-number">1.</span> <span class="nav-text">EdRSA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EC-Party-I"><span class="nav-number">2.</span> <span class="nav-text">EC_Party-I</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strange-curve"><span class="nav-number">3.</span> <span class="nav-text">strange curve</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SMM"><span class="nav-number">4.</span> <span class="nav-text">SMM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rosita"><span class="nav-number">5.</span> <span class="nav-text">Rosita</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%98%E5%8E%9Fecc%E5%8F%82%E6%95%B0"><span class="nav-number">5.1.</span> <span class="nav-text">还原ecc参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Smart-Attack"><span class="nav-number">5.2.</span> <span class="nav-text">Smart Attack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%BC"><span class="nav-number">5.3.</span> <span class="nav-text">格</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%BE%E5%88%B0R"><span class="nav-number">5.3.1.</span> <span class="nav-text">找到R</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B1%82%E8%A7%A3%E5%8F%B3%E6%A0%B8"><span class="nav-number">5.3.2.</span> <span class="nav-text">求解右核</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ecdh"><span class="nav-number">6.</span> <span class="nav-text">ecdh</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="nav-number">6.1.</span> <span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="nav-number">6.2.</span> <span class="nav-text">方法二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tiny-ECC"><span class="nav-number">7.</span> <span class="nav-text">Tiny ECC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%88%86%E7%A0%B4"><span class="nav-number">7.1.</span> <span class="nav-text">爆破</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%A0%E5%B0%84"><span class="nav-number">7.2.</span> <span class="nav-text">映射</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="糖醋小鸡块"
      src="/images/image.png">
  <p class="site-author-name" itemprop="name">糖醋小鸡块</p>
  <div class="site-description" itemprop="description">"追风赶月莫停留，平芜尽处是春山"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">72</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/1142381085@qq.com" title="E-Mail → 1142381085@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6394335993" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6394335993" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">糖醋小鸡块</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'UPEMA7DyYbIIEyOW72ohgytU-gzGzoHsz',
      appKey     : 'M7rXAfeP3JOslroay2n0Jv2R',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
<!-- 引入jQuery -->
<script type="text/javascript" src="//libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<!-- 雪花特效2 -->
<script type="text/javascript" src="/js/snow2.js"></script>
