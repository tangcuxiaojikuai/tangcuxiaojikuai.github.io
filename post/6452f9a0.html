<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_small.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="RnN18ZogmZl_dLVpxZ6y8kjKL73Mu9VLVEkw9d3qrq0" />
  <meta name="msvalidate.01" content="DC3050AD55F30DDF75AAB78517714910" />
  <meta name="baidu-site-verification" content="codeva-PPofu3dNxe" />

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-loading-bar.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tangcuxiaojikuai.xyz","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="和学长学弟一起组成CaTForce参加了这次熵密杯，最后做出了除最终挑战以外的所有赛题拿到了第九名。  由于这次真的算是超大型面基现场，所以和上次密码挑战赛的wp一样，不仅包含题解也包含一些游记。">
<meta property="og:type" content="article">
<meta property="og:title" content="2024-熵密杯-wp-crypto">
<meta property="og:url" content="https://tangcuxiaojikuai.xyz/post/6452f9a0.html">
<meta property="og:site_name" content="糖醋小鸡块的blog">
<meta property="og:description" content="和学长学弟一起组成CaTForce参加了这次熵密杯，最后做出了除最终挑战以外的所有赛题拿到了第九名。  由于这次真的算是超大型面基现场，所以和上次密码挑战赛的wp一样，不仅包含题解也包含一些游记。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/image-20240906134812155.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/image-20240906160617551.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/image-20240906162944644.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/a2baae1dbad9c793f325597bc62f6ddd.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/fbdd13f0b84d64ab230b65c3b3d12580.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/image-20240906221715709.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/e30d63b57974059d2e4dbbc01080ea8c.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/a24cbbade1997a5118f4145480f52f44.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/2b9b84515fdabece93d5fab2ef46e897-1725634979776.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/e90398f9e18ee521f83babd3fd748ac5.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/519b699be3f243dffa48619ae57b876e.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/c36118133cc65bc19853af34f64e876c.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/1554e9f73d54e9b1dd358e59efab202e-1725635079503.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/8dd4f367ba15a45703eb2a87c53fe30e.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/df15f79aa2e0f45d0da0945723d31fd6.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/0f95989624687f52424fd829ac2cd38c.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/db2a5567863700299734daffa714a893.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/67ff89742b93a0769e4fc2be6f516384.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/2ad7bbfcf0d5d5119812141b1cfb8682.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/7f4b5021fa35673a075f4a2f612e18d1.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/784fbe3a12b5250f27b2029e530f47da.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/5c3007d103847a1f3b44987ba30deef4.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/19630656b752181f5fdb409716505c7f.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/7aea2ba94b58422550873e7707a57b00.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/af5ae90c009514359a231e01cf4ac720.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/9e5e38b1d5d1bc43f7af44ce7b99259e.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/fb286c68275730e5c6b3e82a0ff8963c.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/430461feb6fc2a2f71d282c30940827b.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/2c1ba1e940f518ada9115ad4b8ec2f8e.jpg">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/38fa428b6cd68e11b27c6695fc7691b1.jpg">
<meta property="article:published_time" content="2024-09-06T05:43:53.000Z">
<meta property="article:modified_time" content="2024-09-06T16:04:35.111Z">
<meta property="article:author" content="糖醋小鸡块">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tangcuxiaojikuai.xyz/post/6452f9a0/image-20240906134812155.png">

<link rel="canonical" href="https://tangcuxiaojikuai.xyz/post/6452f9a0.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>2024-熵密杯-wp-crypto | 糖醋小鸡块的blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">糖醋小鸡块的blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tangcuxiaojikuai.xyz/post/6452f9a0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/image.png">
      <meta itemprop="name" content="糖醋小鸡块">
      <meta itemprop="description" content=""追风赶月莫停留，平芜尽处是春山"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="糖醋小鸡块的blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2024-熵密杯-wp-crypto
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-06 13:43:53" itemprop="dateCreated datePublished" datetime="2024-09-06T13:43:53+08:00">2024-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-07 00:04:35" itemprop="dateModified" datetime="2024-09-07T00:04:35+08:00">2024-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/wp-crypto/" itemprop="url" rel="index"><span itemprop="name">wp-crypto</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/6452f9a0.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/6452f9a0.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>和学长学弟一起组成CaTForce参加了这次熵密杯，最后做出了除最终挑战以外的所有赛题拿到了第九名。</p>
<p><img src="/post/6452f9a0/image-20240906134812155.png" alt="image-20240906134812155"></p>
<p>由于这次真的算是超大型面基现场，所以和上次密码挑战赛的wp一样，不仅包含题解也包含一些游记。</p>
<span id="more"></span>
<h2 id="第一部分：初始谜题"><a href="#第一部分：初始谜题" class="headerlink" title="第一部分：初始谜题"></a>第一部分：初始谜题</h2><p>这一部分算是开胃菜，形式也更像平时见到的CTF题目，三个题目都是python加密的，做出其中任意一个就可以进入第二部分，也就是一个更类似真实情境的大型密码渗透系统。</p>
<p>但每个初始谜题都是有分数的，所以就算开了第二部分也当然要接着做TT。</p>
<blockquote>
<p>每个题目也都有前三血的加成，一血5%，二血3%，三血1%，在最后排名的时候会先根据分数再根据解题时间，所以血量分其实很重要，但是手速实在不太够</p>
</blockquote>
<p>然后就是他每个初始谜题下发的附件不仅包含加密用的.py文件，还有一个.exe文件，开启实例并输入ip和端口，之后题目就会下发加密数据，与他进行正确交互后就能拿到flag了。</p>
<p><br></p>
<h3 id="初始谜题一-300-pts"><a href="#初始谜题一-300-pts" class="headerlink" title="初始谜题一(300 pts)"></a>初始谜题一(300 pts)</h3><p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> Mod, Integer</span><br><span class="line"><span class="keyword">from</span> sympy.core.numbers <span class="keyword">import</span> mod_inverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模数</span></span><br><span class="line">N_HEX = <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span></span><br><span class="line">MODULUS = Integer(<span class="built_in">int</span>(N_HEX, <span class="number">16</span>))</span><br><span class="line">MSG_PREFIX = <span class="string">&quot;CryptoCup message:&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_message</span>(<span class="params">message, key</span>):</span><br><span class="line">    <span class="comment"># 添加前缀</span></span><br><span class="line">    message_with_prefix = MSG_PREFIX + message</span><br><span class="line">    message_bytes = message_with_prefix.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    message_len = <span class="built_in">len</span>(message_bytes)</span><br><span class="line">    num_blocks = (message_len + <span class="number">15</span>) // <span class="number">16</span></span><br><span class="line">    blocks = [message_bytes[i * <span class="number">16</span>:(i + <span class="number">1</span>) * <span class="number">16</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行0填充</span></span><br><span class="line">    blocks[-<span class="number">1</span>] = blocks[-<span class="number">1</span>].ljust(<span class="number">16</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    encrypted_blocks = []</span><br><span class="line"></span><br><span class="line">    k = key</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加密每个分组</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">        block_int = <span class="built_in">int</span>.from_bytes(block, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        encrypted_block_int = Mod(block_int * k, MODULUS)</span><br><span class="line">        encrypted_blocks.append(encrypted_block_int)</span><br><span class="line">        k += <span class="number">1</span>  <span class="comment"># 密钥自增1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将加密后的分组连接成最终的密文</span></span><br><span class="line">    encrypted_message = <span class="string">b&#x27;&#x27;</span>.join(</span><br><span class="line">        <span class="built_in">int</span>(block_int).to_bytes(<span class="number">32</span>, byteorder=<span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> block_int <span class="keyword">in</span> encrypted_blocks</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> encrypted_message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_message</span>(<span class="params">encrypted_message, key</span>):</span><br><span class="line">    num_blocks = <span class="built_in">len</span>(encrypted_message) // <span class="number">32</span></span><br><span class="line">    blocks = [encrypted_message[i * <span class="number">32</span>:(i + <span class="number">1</span>) * <span class="number">32</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks)]</span><br><span class="line"></span><br><span class="line">    decrypted_blocks = []</span><br><span class="line"></span><br><span class="line">    k = key</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解密每个分组</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blocks:</span><br><span class="line">        block_int = <span class="built_in">int</span>.from_bytes(block, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        key_inv = mod_inverse(k, MODULUS)</span><br><span class="line">        decrypted_block_int = Mod(block_int * key_inv, MODULUS)</span><br><span class="line">        decrypted_blocks.append(decrypted_block_int)</span><br><span class="line">        k += <span class="number">1</span>  <span class="comment"># 密钥自增1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将解密后的分组连接成最终的明文</span></span><br><span class="line">    decrypted_message = <span class="string">b&#x27;&#x27;</span>.join(</span><br><span class="line">        <span class="built_in">int</span>(block_int).to_bytes(<span class="number">16</span>, byteorder=<span class="string">&#x27;big&#x27;</span>) <span class="keyword">for</span> block_int <span class="keyword">in</span> decrypted_blocks</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 去除前缀</span></span><br><span class="line">    <span class="keyword">if</span> decrypted_message.startswith(MSG_PREFIX.encode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">        decrypted_message = decrypted_message[<span class="built_in">len</span>(MSG_PREFIX):]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decrypted_message.rstrip(<span class="string">b&#x27;\x00&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">initial_key = Integer(<span class="number">0x123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0</span>)</span><br><span class="line">message = <span class="string">&quot;Hello, this is a test message.&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Original Message:&quot;</span>, message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密</span></span><br><span class="line">encrypted_message = encrypt_message(message, initial_key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Encrypted Message (hex):&quot;</span>, encrypted_message.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密</span></span><br><span class="line">decrypted_message = decrypt_message(encrypted_message, initial_key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Decrypted Message:&quot;</span>, decrypted_message)</span><br></pre></td></tr></table></figure>
<p>题目加密流程大概如下：</p>
<ul>
<li><p>有一个未知的initial_key，与一个未知的message</p>
</li>
<li><p>对于这个message，题目会在他前面填上一个固定的前缀”CryptoCup message:”，并在最后补充上”\x00”使得整个消息长为16的倍数</p>
</li>
<li><p>将填充了前后缀的消息按16字节为一组分组</p>
</li>
<li><p>从第一个分组开始，将该分组消息转化为整数，记为mi，并计算：</p>
<script type="math/tex; mode=display">
c_i = m_ik_i \quad(mod\;n)</script><p>其中ki是key在对应分组的值(key每个分组之后会自增一)</p>
</li>
<li><p>将所有ci转成32字节，并连接在一起得到密文</p>
</li>
</ul>
<p>靶机只会发送encrypted_message，要发送给他message来拿到flag。这个可以说是相当轻松了，由于有一个已知的前缀，并且他超过了16字节，因此就有第一个分组对应的明文和密文，所以就可以直接求出key来。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">N_HEX = <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span></span><br><span class="line">MODULUS = <span class="built_in">int</span>(N_HEX, <span class="number">16</span>)</span><br><span class="line">MSG_PREFIX = <span class="string">b&quot;CryptoCup message:&quot;</span></span><br><span class="line"></span><br><span class="line">c = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;a7ea042608ffce5be79a19ee45533506819e85f8d9250fccef5a89731151fd7a76d83aa85c47ba1357a86d0e9763470fb608cd54d0927125f500353e156a01da759fa814e96fa41a888eea3a9cf9b062923ed70774add490c7ed7f83d6b47e711e7b3c8a960dcc2838e577459bb6f2769d0917e1fd57db0829633b77652c2180&quot;</span>)</span><br><span class="line">C = [c[<span class="number">32</span>*i:<span class="number">32</span>*i+<span class="number">32</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c)//<span class="number">32</span>)]</span><br><span class="line"></span><br><span class="line">msg = <span class="string">b&quot;&quot;</span></span><br><span class="line">key = bytes_to_long(C[<span class="number">0</span>]) * inverse(bytes_to_long(MSG_PREFIX[:<span class="number">16</span>]), MODULUS) % MODULUS</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(C)):</span><br><span class="line">    msg += long_to_bytes(bytes_to_long(C[i]) * inverse(key,MODULUS) % MODULUS)</span><br><span class="line">    key += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CryptoCup message:dHyNBCgxEq4prNBbxjDOiOgmvviuAgfx\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span></span><br></pre></td></tr></table></figure>
<p>发送message回去之后就会拿到flag，以及一个登录Gitea的帐号密码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">验证通过</span><br><span class="line">flag&#123;OYLXbASQsEc5SVkhBj7kTiSBc4AM5ZkR&#125;</span><br><span class="line">gitea账号：giteauser2024</span><br><span class="line">gitea口令：S(*HD^WY63y89TY71</span><br><span class="line">提示：gitea账号和口令用于登录第二环节的gitea服务器，请注意保存！</span><br></pre></td></tr></table></figure>
<blockquote>
<p>后面两个初始谜题也都是给一个拿分的flag，以及一个账号密码作为开第二部分的钥匙，所以后面两个初始谜题就不写这个了</p>
</blockquote>
<p><br></p>
<p><br></p>
<h3 id="初始谜题二-300-pts"><a href="#初始谜题二-300-pts" class="headerlink" title="初始谜题二(300 pts)"></a>初始谜题二(300 pts)</h3><p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取HMAC key文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_hmac_key</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        hmac_key = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> hmac_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成token</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_token</span>(<span class="params">hmac_key, counter</span>):</span><br><span class="line">    <span class="comment"># 如果HMAC_KEY长度不足32字节，则在末尾补0，超过64字节则截断</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hmac_key) &lt; <span class="number">32</span>:</span><br><span class="line">        hmac_key = hmac_key.ljust(<span class="number">32</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(hmac_key) &gt; <span class="number">32</span>:</span><br><span class="line">        hmac_key = hmac_key[:<span class="number">32</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将计数器转换为字节表示</span></span><br><span class="line">    counter_bytes = counter.to_bytes((counter.bit_length() + <span class="number">7</span>) // <span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="comment"># print(&quot;counter_bytes:&quot;, binascii.hexlify(counter_bytes))</span></span><br><span class="line"></span><br><span class="line">    tobe_hashed = <span class="built_in">bytearray</span>(hmac_key + counter_bytes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(&quot;tobe_hashed:&quot;, binascii.hexlify(tobe_hashed))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用SM3算法计算哈希值</span></span><br><span class="line">    sm3_hash = sm3.sm3_hash(tobe_hashed)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将SM3的哈希值转换为十六进制字符串作为token</span></span><br><span class="line">    token = sm3_hash</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">current_counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_token</span>(<span class="params">hmac_key, counter, token</span>):</span><br><span class="line">    <span class="comment"># 生成token</span></span><br><span class="line">    generated_token = generate_token(hmac_key, counter)</span><br><span class="line">    <span class="keyword">global</span> current_counter</span><br><span class="line">    <span class="comment"># 比较生成的token和输入的token是否相同</span></span><br><span class="line">    <span class="keyword">if</span> generated_token == token:</span><br><span class="line">        <span class="keyword">if</span> counter &amp; <span class="number">0xFFFFFFFF</span> &gt; current_counter:</span><br><span class="line">            current_counter = counter &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;current_counter: &quot;</span>, <span class="built_in">hex</span>(current_counter))</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error: counter must be increasing&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Error: token not match&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设HMAC key文件路径</span></span><br><span class="line">hmac_key_file = <span class="string">&#x27;hmac_key.txt&#x27;</span></span><br><span class="line"><span class="comment"># 假设计数器值</span></span><br><span class="line">counter = <span class="number">0x12345678</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取HMAC key</span></span><br><span class="line">hmac_key = read_hmac_key(hmac_key_file)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成token</span></span><br><span class="line">token = generate_token(hmac_key, counter)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Generated token:&quot;</span>, token)</span><br><span class="line"><span class="built_in">print</span>(verify_token(hmac_key, counter, token))</span><br></pre></td></tr></table></figure>
<p>题目内容很简单：</p>
<ul>
<li>读取一个未知的hmac_key，并生成一个随机的counter</li>
<li>将hmac_key控制在32字节(不足则填充”\x00”，超出则截断)</li>
<li>将hmac_key与counter拼接起来进行SM3哈希</li>
</ul>
<p>然后下发的数据有：</p>
<ul>
<li>SM3得到的哈希值</li>
<li>counter值</li>
</ul>
<p>我们需要完成的事情是：</p>
<ul>
<li>找到一个新的counter，使得新counter的低32位比原来的counter大</li>
<li>计算出hmac_key与新counter拼接后的SM3哈希值</li>
<li>发送新counter和这个哈希值就能拿到flag</li>
</ul>
<p>看明白题意就会知道这是一个基于SM3的哈希长度扩展攻击，由于控制了hmac_key为32字节，并且counter只有4字节，而SM3的分组长度是64字节，所以说我们拿到的哈希值是只有一个分组的。而按照SM3的填充规则，这个分组哈希的完整分组其实是下面这部分内容的part1 + part2：(单引号代表字节串，双引号代表比特串)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#448 bits</span></span><br><span class="line">part1 = <span class="string">&#x27;hmac_key&#x27;</span>(<span class="number">32</span> <span class="built_in">bytes</span>) + <span class="string">&#x27;counter&#x27;</span>(<span class="number">4</span> <span class="built_in">bytes</span>) + <span class="string">&quot;1&quot;</span> + <span class="string">&quot;00...0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#64 bits</span></span><br><span class="line">part2 = <span class="built_in">bin</span>(<span class="number">8</span>*(<span class="built_in">len</span>(hmac_key + counter)))[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br></pre></td></tr></table></figure>
<p>这两部分拼起来就得到了完整的第一个分组。</p>
<p>SM3的哈希长度扩展攻击基于其Merkle Damgard结构，我们可以用一个已知分组的哈希值，去继续迭代计算更长的含有该分组消息的哈希值，而不需要知道这个分组对应的明文是什么。所以我们完全可以构造下面这样的counter：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New_counter = <span class="string">&#x27;counter&#x27;</span>(<span class="number">4</span> <span class="built_in">bytes</span>) + <span class="string">&quot;1&quot;</span> + <span class="string">&quot;00...0&quot;</span> + <span class="built_in">bin</span>(<span class="number">8</span>*(<span class="built_in">len</span>(hmac_key + counter)))[<span class="number">2</span>:].zfill(<span class="number">64</span>) + <span class="string">&#x27;\xff\xff\xff\xff&#x27;</span></span><br></pre></td></tr></table></figure>
<p>那么hmac_key拼接上这个counter后，其用于SM3哈希的消息就会按64字节分为两组，而第一组是和靶机发送的消息完全一样的，因此我们就可以利用哈希长度扩展攻击迭代计算整个消息的哈希值了，具体实现代码是赛前那天晚上在github上随便找的：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/KKrias/length-extension-attack-for-SM3/tree/main">KKrias/length-extension-attack-for-SM3 (github.com)</a></p>
<p>稍微对着题意改一改就好。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">zero_fill</span>(<span class="params">a,n</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(a)&lt;n:</span><br><span class="line">        a=<span class="string">&quot;0&quot;</span>*(n-<span class="built_in">len</span>(a))+a</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cycle_shift_left</span>(<span class="params"> B, n</span>):</span><br><span class="line">    n=n%<span class="number">32</span></span><br><span class="line">    <span class="keyword">return</span> ((B &lt;&lt; n) ^ (B &gt;&gt; (<span class="number">32</span> - n)))%(<span class="number">2</span>**<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T</span>(<span class="params">j</span>):</span><br><span class="line">    <span class="keyword">if</span> j&gt;=<span class="number">0</span> <span class="keyword">and</span> j&lt;=<span class="number">15</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(<span class="string">&quot;79cc4519&quot;</span>,<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">elif</span> j&gt;=<span class="number">16</span> <span class="keyword">and</span> j&lt;=<span class="number">63</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(<span class="string">&quot;7a879d8a&quot;</span>,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FF</span>(<span class="params">X,Y,Z,j</span>):</span><br><span class="line">    <span class="keyword">if</span> j&gt;=<span class="number">0</span> <span class="keyword">and</span> j&lt;=<span class="number">15</span>:</span><br><span class="line">        <span class="keyword">return</span> X^Y^Z</span><br><span class="line">    <span class="keyword">elif</span> j&gt;=<span class="number">16</span> <span class="keyword">and</span> j&lt;=<span class="number">63</span>:</span><br><span class="line">        <span class="keyword">return</span> (X&amp;Y)|(X&amp;Z)|(Y&amp;Z)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GG</span>(<span class="params">X,Y,Z,j</span>):</span><br><span class="line">    <span class="keyword">if</span> j &gt;= <span class="number">0</span> <span class="keyword">and</span> j &lt;= <span class="number">15</span>:</span><br><span class="line">        <span class="keyword">return</span> X ^ Y ^ Z</span><br><span class="line">    <span class="keyword">elif</span> j &gt;= <span class="number">16</span> <span class="keyword">and</span> j &lt;= <span class="number">63</span>:</span><br><span class="line">        <span class="keyword">return</span> (X &amp; Y) | (~X &amp; Z)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">P0</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x^(cycle_shift_left(x,<span class="number">9</span>))^cycle_shift_left(x,<span class="number">17</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">P1</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x^(cycle_shift_left(x,<span class="number">15</span>))^cycle_shift_left(x,<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Message_extension</span>(<span class="params">a</span>):  <span class="comment">#a的数一定要满足512bit,不够要补零!!  ,承接的是字符串</span></span><br><span class="line">    W1 = []            <span class="comment">#  W0-15</span></span><br><span class="line">    W2=[]             <span class="comment">#  W&#x27; 0-63</span></span><br><span class="line">    <span class="comment">#print(&quot;a消息扩展的a:&quot;,a)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="built_in">len</span>(a) / <span class="number">8</span>)):</span><br><span class="line">        W1.append(<span class="built_in">int</span>(a[<span class="number">8</span> * i:<span class="number">8</span> * i + <span class="number">8</span>],<span class="number">16</span>))</span><br><span class="line">        <span class="comment">#print(&quot;W1的前16个&quot;,a[8 * i:8 * i + 8])</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>,<span class="number">68</span>):</span><br><span class="line">        temp=P1(W1[j-<span class="number">16</span>] ^ W1[j-<span class="number">9</span>] ^ cycle_shift_left(W1[j-<span class="number">3</span>],<span class="number">15</span>)) ^cycle_shift_left(W1[j-<span class="number">13</span>],<span class="number">7</span>)^W1[j-<span class="number">6</span>]</span><br><span class="line">        <span class="comment">#print(&quot;消息扩展：&quot;,hex(temp))</span></span><br><span class="line">        W1.append(temp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        W2.append(W1[j]^W1[j+<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    W1.append(W2)</span><br><span class="line">    <span class="keyword">return</span> W1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CF</span>(<span class="params">V,Bi</span>):  <span class="comment">#V是字符串</span></span><br><span class="line">    Bi=zero_fill(Bi,<span class="number">128</span>)</span><br><span class="line">    W=[]</span><br><span class="line">    W=Message_extension(Bi)   <span class="comment">#消息扩展完的消息字</span></span><br><span class="line">    <span class="comment">#print(&quot;W:&quot;,W)</span></span><br><span class="line">    A=<span class="built_in">int</span>(V[<span class="number">0</span>:<span class="number">8</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#print(&quot;A:&quot;, hex(A))</span></span><br><span class="line">    B = <span class="built_in">int</span>(V[<span class="number">8</span>:<span class="number">16</span>], <span class="number">16</span>)</span><br><span class="line">    C = <span class="built_in">int</span>(V[<span class="number">16</span>:<span class="number">24</span>], <span class="number">16</span>)</span><br><span class="line">    D = <span class="built_in">int</span>(V[<span class="number">24</span>:<span class="number">32</span>], <span class="number">16</span>)</span><br><span class="line">    E = <span class="built_in">int</span>(V[<span class="number">32</span>:<span class="number">40</span>], <span class="number">16</span>)</span><br><span class="line">    F = <span class="built_in">int</span>(V[<span class="number">40</span>:<span class="number">48</span>], <span class="number">16</span>)</span><br><span class="line">    G = <span class="built_in">int</span>(V[<span class="number">48</span>:<span class="number">56</span>], <span class="number">16</span>)</span><br><span class="line">    H = <span class="built_in">int</span>(V[<span class="number">56</span>:<span class="number">64</span>], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        temp=(cycle_shift_left(A,<span class="number">12</span>) + E +cycle_shift_left(T(j),j)) %(<span class="number">2</span>**<span class="number">32</span>)</span><br><span class="line">        SS1=cycle_shift_left(temp,<span class="number">7</span>)</span><br><span class="line">        SS2=SS1 ^ cycle_shift_left(A,<span class="number">12</span>)</span><br><span class="line">        TT1=(FF(A,B,C,j) +D +SS2 +W[-<span class="number">1</span>][j] ) %(<span class="number">2</span>**<span class="number">32</span>)</span><br><span class="line">        TT2=(GG(E,F,G,j)+H+SS1+W[j])%(<span class="number">2</span>**<span class="number">32</span>)</span><br><span class="line">        D=C</span><br><span class="line">        C=cycle_shift_left(B,<span class="number">9</span>)</span><br><span class="line">        B=A</span><br><span class="line">        A=TT1</span><br><span class="line">        H=G</span><br><span class="line">        G=cycle_shift_left(F,<span class="number">19</span>)</span><br><span class="line">        F=E</span><br><span class="line">        E=P0(TT2)</span><br><span class="line">        <span class="comment">#print(&quot;B:&quot;, hex(B))</span></span><br><span class="line">    t1=zero_fill(<span class="built_in">hex</span>(A^<span class="built_in">int</span>(V[<span class="number">0</span>:<span class="number">8</span>],<span class="number">16</span>))[<span class="number">2</span>:],<span class="number">8</span>)</span><br><span class="line">    t2 = zero_fill(<span class="built_in">hex</span>(B ^ <span class="built_in">int</span>(V[<span class="number">8</span>:<span class="number">16</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t3 = zero_fill(<span class="built_in">hex</span>(C ^ <span class="built_in">int</span>(V[<span class="number">16</span>:<span class="number">24</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t4 = zero_fill(<span class="built_in">hex</span>(D ^ <span class="built_in">int</span>(V[<span class="number">24</span>:<span class="number">32</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t5 = zero_fill(<span class="built_in">hex</span>(E ^ <span class="built_in">int</span>(V[<span class="number">32</span>:<span class="number">40</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t6 = zero_fill(<span class="built_in">hex</span>(F ^ <span class="built_in">int</span>(V[<span class="number">40</span>:<span class="number">48</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t7 = zero_fill(<span class="built_in">hex</span>(G ^ <span class="built_in">int</span>(V[<span class="number">48</span>:<span class="number">56</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t8 = zero_fill(<span class="built_in">hex</span>(H ^ <span class="built_in">int</span>(V[<span class="number">56</span>:<span class="number">64</span>], <span class="number">16</span>))[<span class="number">2</span>:], <span class="number">8</span>)</span><br><span class="line">    t=t1+t2+t3+t4+t5+t6+t7+t8</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM3</span>(<span class="params">plaintext</span>):</span><br><span class="line">    Vtemp=IV</span><br><span class="line">    a=(<span class="built_in">len</span>(plaintext)*<span class="number">4</span>+<span class="number">1</span> ) % <span class="number">512</span></span><br><span class="line">    <span class="comment">#print(a)</span></span><br><span class="line">    k=<span class="number">0</span></span><br><span class="line">    B=[]</span><br><span class="line">    <span class="keyword">if</span> a&lt;=<span class="number">448</span>:</span><br><span class="line">        k=<span class="number">448</span>-a</span><br><span class="line">    <span class="keyword">elif</span> a&gt;<span class="number">448</span>:</span><br><span class="line">        k=<span class="number">512</span>-a+<span class="number">448</span></span><br><span class="line">    <span class="comment">#print(k)</span></span><br><span class="line">    m=plaintext+<span class="string">&quot;8&quot;</span>+<span class="string">&quot;0&quot;</span>*<span class="built_in">int</span>((k+<span class="number">1</span>)/<span class="number">4</span>-<span class="number">1</span>)+zero_fill(<span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(plaintext)*<span class="number">4</span>))[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#print(m)</span></span><br><span class="line">    block_len=<span class="built_in">int</span>((<span class="built_in">len</span>(plaintext)*<span class="number">4</span> + k + <span class="number">65</span>) / <span class="number">512</span>)</span><br><span class="line">    <span class="comment">#print(block_len)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,block_len):</span><br><span class="line">        B.append(m[<span class="number">128</span>*i:<span class="number">128</span>*i+<span class="number">128</span>])     <span class="comment">#分组</span></span><br><span class="line">    <span class="comment">#print(&quot;B:&quot;,B)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,block_len):</span><br><span class="line">        Vtemp=CF(Vtemp,B[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Vtemp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM3_len_ex_ak</span>(<span class="params">num_block,IV,plaintext</span>):</span><br><span class="line">    Vtemp=IV</span><br><span class="line">    a=(<span class="built_in">len</span>(plaintext)*<span class="number">4</span>+<span class="number">1</span> ) % <span class="number">512</span></span><br><span class="line">    <span class="comment">#print(a)</span></span><br><span class="line">    k=<span class="number">0</span></span><br><span class="line">    B=[]</span><br><span class="line">    <span class="keyword">if</span> a&lt;=<span class="number">448</span>:</span><br><span class="line">        k=<span class="number">448</span>-a</span><br><span class="line">    <span class="keyword">elif</span> a&gt;<span class="number">448</span>:</span><br><span class="line">        k=<span class="number">512</span>-a+<span class="number">448</span></span><br><span class="line">    <span class="comment">#print(k)</span></span><br><span class="line">    m=plaintext+<span class="string">&quot;8&quot;</span>+<span class="string">&quot;0&quot;</span>*<span class="built_in">int</span>((k+<span class="number">1</span>)/<span class="number">4</span>-<span class="number">1</span>)+zero_fill(<span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(plaintext)*<span class="number">4</span>+num_block*<span class="number">512</span>))[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#print(m)</span></span><br><span class="line">    block_len=<span class="built_in">int</span>((<span class="built_in">len</span>(plaintext)*<span class="number">4</span> + k + <span class="number">65</span>) / <span class="number">512</span>)</span><br><span class="line">    <span class="comment">#print(block_len)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,block_len):</span><br><span class="line">        B.append(m[<span class="number">128</span>*i:<span class="number">128</span>*i+<span class="number">128</span>])     <span class="comment">#分组</span></span><br><span class="line">    <span class="comment">#print(&quot;B:&quot;,B)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,block_len):</span><br><span class="line">        Vtemp=CF(Vtemp,B[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Vtemp</span><br><span class="line"></span><br><span class="line">IV=<span class="string">&quot;7380166f4914b2b9172442d7da8a0600a96f30bc163138aae38dee4db0fb0e4e&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################################</span></span><br><span class="line">IV2=<span class="string">&quot;c2427b818b1fb3b9e72e0ec8c60d101a17865842506e6b0052278a0c156d9e7a&quot;</span></span><br><span class="line">num_block=<span class="number">1</span></span><br><span class="line">counter = <span class="string">&quot;51f18456&quot;</span></span><br><span class="line">New_Counter = <span class="built_in">hex</span>(<span class="built_in">int</span>((<span class="built_in">bin</span>(<span class="built_in">int</span>(counter,<span class="number">16</span>))[<span class="number">2</span>:].zfill(<span class="number">32</span>) + <span class="string">&quot;1&quot;</span>) + <span class="string">&quot;0&quot;</span>*(<span class="number">448</span> - <span class="number">32</span>*<span class="number">8</span> - <span class="number">1</span> - <span class="number">4</span>*<span class="number">8</span>) + <span class="built_in">bin</span>(<span class="number">36</span>*<span class="number">8</span>)[<span class="number">2</span>:].zfill(<span class="number">64</span>) , <span class="number">2</span>))[<span class="number">2</span>:] + <span class="string">&quot;ffffffff&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(New_Counter)</span><br><span class="line"><span class="built_in">print</span>(SM3_len_ex_ak(<span class="number">1</span>,IV2,<span class="string">&quot;FFFFFFFF&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag&#123;3WhlSlIw4tSOhbY52j6CMrUCAYSLfrS9&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="初始谜题三-300-pts"><a href="#初始谜题三-300-pts" class="headerlink" title="初始谜题三(300 pts)"></a>初始谜题三(300 pts)</h3><p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sympy <span class="keyword">as</span> sp</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置参数</span></span><br><span class="line">n = <span class="number">16</span>  <span class="comment"># 向量长度</span></span><br><span class="line">q = <span class="number">251</span>  <span class="comment"># 模数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机噪声向量e</span></span><br><span class="line">e = sp.Matrix(sp.randMatrix(n, <span class="number">1</span>, <span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=<span class="number">1</span>))  <span class="comment"># 噪声向量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机n维私钥向量s和n*n矩阵A</span></span><br><span class="line">s = sp.Matrix(sp.randMatrix(n, <span class="number">1</span>, <span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=q - <span class="number">1</span>))  <span class="comment"># 私钥向量</span></span><br><span class="line">Temp = sp.Matrix(sp.randMatrix(n, n, <span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=q - <span class="number">1</span>))  <span class="comment"># 中间变量矩阵Temp</span></span><br><span class="line">A = Temp.inv_mod(q)  <span class="comment"># 计算矩阵Temp在模 q 下的逆矩阵作为A</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算n维公钥向量b</span></span><br><span class="line">b = (A * s + e) % q  <span class="comment"># 公钥向量b = A * s + e</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">message, A, b</span>):</span><br><span class="line">    m_bin = <span class="built_in">bin</span>(message)[<span class="number">2</span>:].zfill(n)  <span class="comment"># 将消息转换为16比特的二进制字符串</span></span><br><span class="line">    m = sp.Matrix([<span class="built_in">int</span>(bit) <span class="keyword">for</span> bit <span class="keyword">in</span> m_bin])  <span class="comment"># 转换为SymPy矩阵</span></span><br><span class="line">    x = sp.Matrix(sp.randMatrix(n, n, <span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=q // (n * <span class="number">4</span>)))  <span class="comment"># 随机产生一个n*n的矩阵x</span></span><br><span class="line">    e1 = sp.Matrix(sp.randMatrix(n, <span class="number">1</span>, <span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=<span class="number">1</span>))  <span class="comment"># 随机产生一个n维噪声向量e</span></span><br><span class="line">    c1 = (x * A) % q  <span class="comment"># 密文部分c1 =   x * A</span></span><br><span class="line">    c2 = (x * b + e1 + m * (q // <span class="number">2</span>)) % q  <span class="comment"># 密文部分c2 = x * b + e1 + m * q/2</span></span><br><span class="line">    <span class="keyword">return</span> c1, c2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">c1, c2, s</span>):</span><br><span class="line">    m_dec = (c2 - c1 * s) % q</span><br><span class="line">    m_rec = m_dec.applyfunc(<span class="keyword">lambda</span> x: <span class="built_in">round</span>(<span class="number">2</span> * x / q) % <span class="number">2</span>)  <span class="comment"># 还原消息</span></span><br><span class="line">    m_bin = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(bit) <span class="keyword">for</span> bit <span class="keyword">in</span> m_rec])  <span class="comment"># 将SymPy矩阵转换为二进制字符串</span></span><br><span class="line">    m_rec_int = <span class="built_in">int</span>(m_bin, <span class="number">2</span>)  <span class="comment"># 将二进制字符串转换为整数</span></span><br><span class="line">    <span class="keyword">return</span> m_rec_int</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试加解密</span></span><br><span class="line">message = random.randint(<span class="number">0</span>, <span class="number">2</span> ** n - <span class="number">1</span>)  <span class="comment"># 要加密的消息，随机生成一个16比特整数</span></span><br><span class="line">c1, c2 = encrypt(message, A, b)  <span class="comment"># 加密</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;原始消息: &quot;</span>, message)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;公钥A=sp.&quot;</span>, A)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;公钥b=sp.&quot;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;密文c1=sp.&quot;</span>, c1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;密文c2=sp.&quot;</span>, c2)</span><br><span class="line"></span><br><span class="line">decrypted_message = decrypt(c1, c2, s)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解密后的消息: &quot;</span>, decrypted_message)  <span class="comment"># 输出解密后的消息</span></span><br></pre></td></tr></table></figure>
<p>题目名字叫lwe，具体来说给了一些如下数据：</p>
<ul>
<li><p>随机生成16维的01向量e</p>
</li>
<li><p>随机生成16维的向量s以及16x16的可逆矩阵A，并计算：</p>
<script type="math/tex; mode=display">
b = As + e</script></li>
<li><p>将m转化为比特串，并进一步变为长度为16的01向量(也就是说m本身也只有2字节)</p>
</li>
<li><p>随机生成16x16的矩阵x以及另一个16维的01向量e1，并计算：</p>
<script type="math/tex; mode=display">
c_1 = xA</script><script type="math/tex; mode=display">
c_2 = xb + e_1 + \frac{q}{2}m</script></li>
<li><p>给出A、b、c1、c2，要求还原message并发送给他</p>
</li>
</ul>
<p>虽然说题目叫lwe，似乎也可以通过lwe的方法求出s来，但是很显眼的一点是维数仅仅为16，实在太小了，只需要琼剧2^16其中就一定有正确的e、e1了。</p>
<p>然而再仔细看发现有更离谱的一点，既然A、c1都给好了并且A可逆，那么x直接求就好了，然后就可以轻松得到：</p>
<script type="math/tex; mode=display">
t = e_1 + \frac{q}{2}m</script><p>而由于e1也是01向量，他对向量t的大小影响可以忽略不计，所以t中大于等于q/2的位置就是m中为1的位置，否则就是0。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">A = Matrix(ZZ,[[<span class="number">139</span>, <span class="number">63</span>, <span class="number">18</span>, <span class="number">202</span>, <span class="number">166</span>, <span class="number">185</span>, <span class="number">85</span>, <span class="number">108</span>, <span class="number">58</span>, <span class="number">90</span>, <span class="number">211</span>, <span class="number">248</span>, <span class="number">240</span>, <span class="number">44</span>, <span class="number">137</span>, <span class="number">39</span>], [<span class="number">5</span>, <span class="number">230</span>, <span class="number">89</span>, <span class="number">226</span>, <span class="number">139</span>, <span class="number">24</span>, <span class="number">233</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">108</span>, <span class="number">127</span>, <span class="number">11</span>, <span class="number">52</span>, <span class="number">64</span>, <span class="number">188</span>, <span class="number">156</span>], [<span class="number">80</span>, <span class="number">61</span>, <span class="number">105</span>, <span class="number">3</span>, <span class="number">165</span>, <span class="number">96</span>, <span class="number">154</span>, <span class="number">40</span>, <span class="number">62</span>, <span class="number">103</span>, <span class="number">157</span>, <span class="number">75</span>, <span class="number">190</span>, <span class="number">101</span>, <span class="number">31</span>, <span class="number">239</span>], [<span class="number">193</span>, <span class="number">100</span>, <span class="number">124</span>, <span class="number">216</span>, <span class="number">248</span>, <span class="number">95</span>, <span class="number">241</span>, <span class="number">196</span>, <span class="number">67</span>, <span class="number">192</span>, <span class="number">217</span>, <span class="number">114</span>, <span class="number">171</span>, <span class="number">248</span>, <span class="number">219</span>, <span class="number">169</span>], [<span class="number">116</span>, <span class="number">71</span>, <span class="number">221</span>, <span class="number">105</span>, <span class="number">167</span>, <span class="number">153</span>, <span class="number">22</span>, <span class="number">124</span>, <span class="number">178</span>, <span class="number">45</span>, <span class="number">7</span>, <span class="number">183</span>, <span class="number">125</span>, <span class="number">8</span>, <span class="number">127</span>, <span class="number">123</span>], [<span class="number">182</span>, <span class="number">162</span>, <span class="number">164</span>, <span class="number">184</span>, <span class="number">27</span>, <span class="number">148</span>, <span class="number">206</span>, <span class="number">73</span>, <span class="number">217</span>, <span class="number">86</span>, <span class="number">187</span>, <span class="number">137</span>, <span class="number">82</span>, <span class="number">150</span>, <span class="number">99</span>, <span class="number">65</span>], [<span class="number">106</span>, <span class="number">60</span>, <span class="number">153</span>, <span class="number">91</span>, <span class="number">213</span>, <span class="number">41</span>, <span class="number">188</span>, <span class="number">92</span>, <span class="number">121</span>, <span class="number">246</span>, <span class="number">164</span>, <span class="number">223</span>, <span class="number">199</span>, <span class="number">85</span>, <span class="number">161</span>, <span class="number">25</span>], [<span class="number">93</span>, <span class="number">97</span>, <span class="number">145</span>, <span class="number">31</span>, <span class="number">48</span>, <span class="number">36</span>, <span class="number">7</span>, <span class="number">110</span>, <span class="number">56</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">79</span>, <span class="number">233</span>, <span class="number">186</span>, <span class="number">93</span>, <span class="number">181</span>], [<span class="number">195</span>, <span class="number">98</span>, <span class="number">47</span>, <span class="number">147</span>, <span class="number">49</span>, <span class="number">40</span>, <span class="number">158</span>, <span class="number">89</span>, <span class="number">218</span>, <span class="number">8</span>, <span class="number">23</span>, <span class="number">118</span>, <span class="number">170</span>, <span class="number">19</span>, <span class="number">50</span>, <span class="number">17</span>], [<span class="number">127</span>, <span class="number">95</span>, <span class="number">37</span>, <span class="number">48</span>, <span class="number">230</span>, <span class="number">244</span>, <span class="number">130</span>, <span class="number">37</span>, <span class="number">75</span>, <span class="number">125</span>, <span class="number">103</span>, <span class="number">154</span>, <span class="number">148</span>, <span class="number">218</span>, <span class="number">227</span>, <span class="number">178</span>], [<span class="number">162</span>, <span class="number">235</span>, <span class="number">129</span>, <span class="number">44</span>, <span class="number">204</span>, <span class="number">228</span>, <span class="number">221</span>, <span class="number">130</span>, <span class="number">239</span>, <span class="number">36</span>, <span class="number">57</span>, <span class="number">38</span>, <span class="number">41</span>, <span class="number">74</span>, <span class="number">61</span>, <span class="number">155</span>], [<span class="number">246</span>, <span class="number">11</span>, <span class="number">11</span>, <span class="number">97</span>, <span class="number">218</span>, <span class="number">57</span>, <span class="number">209</span>, <span class="number">72</span>, <span class="number">229</span>, <span class="number">27</span>, <span class="number">250</span>, <span class="number">73</span>, <span class="number">19</span>, <span class="number">64</span>, <span class="number">25</span>, <span class="number">62</span>], [<span class="number">60</span>, <span class="number">162</span>, <span class="number">1</span>, <span class="number">110</span>, <span class="number">191</span>, <span class="number">130</span>, <span class="number">120</span>, <span class="number">227</span>, <span class="number">214</span>, <span class="number">98</span>, <span class="number">165</span>, <span class="number">245</span>, <span class="number">28</span>, <span class="number">55</span>, <span class="number">94</span>, <span class="number">190</span>], [<span class="number">129</span>, <span class="number">212</span>, <span class="number">185</span>, <span class="number">156</span>, <span class="number">119</span>, <span class="number">239</span>, <span class="number">83</span>, <span class="number">221</span>, <span class="number">4</span>, <span class="number">174</span>, <span class="number">65</span>, <span class="number">218</span>, <span class="number">32</span>, <span class="number">211</span>, <span class="number">213</span>, <span class="number">223</span>], [<span class="number">80</span>, <span class="number">218</span>, <span class="number">135</span>, <span class="number">245</span>, <span class="number">238</span>, <span class="number">127</span>, <span class="number">55</span>, <span class="number">68</span>, <span class="number">113</span>, <span class="number">145</span>, <span class="number">110</span>, <span class="number">59</span>, <span class="number">50</span>, <span class="number">177</span>, <span class="number">159</span>, <span class="number">146</span>], [<span class="number">68</span>, <span class="number">239</span>, <span class="number">36</span>, <span class="number">166</span>, <span class="number">206</span>, <span class="number">23</span>, <span class="number">59</span>, <span class="number">126</span>, <span class="number">67</span>, <span class="number">152</span>, <span class="number">99</span>, <span class="number">189</span>, <span class="number">133</span>, <span class="number">113</span>, <span class="number">243</span>, <span class="number">198</span>]])</span><br><span class="line">b = Matrix(ZZ,[[<span class="number">88</span>], [<span class="number">74</span>], [<span class="number">219</span>], [<span class="number">244</span>], [<span class="number">81</span>], [<span class="number">109</span>], [<span class="number">81</span>], [<span class="number">216</span>], [<span class="number">125</span>], [<span class="number">218</span>], [<span class="number">170</span>], [<span class="number">56</span>], [<span class="number">152</span>], [<span class="number">229</span>], [<span class="number">204</span>], [<span class="number">45</span>]])</span><br><span class="line">c1 = Matrix(ZZ,[[<span class="number">173</span>, <span class="number">2</span>, <span class="number">67</span>, <span class="number">11</span>, <span class="number">40</span>, <span class="number">80</span>, <span class="number">187</span>, <span class="number">38</span>, <span class="number">16</span>, <span class="number">226</span>, <span class="number">243</span>, <span class="number">79</span>, <span class="number">117</span>, <span class="number">127</span>, <span class="number">100</span>, <span class="number">113</span>], [<span class="number">208</span>, <span class="number">231</span>, <span class="number">211</span>, <span class="number">196</span>, <span class="number">2</span>, <span class="number">146</span>, <span class="number">35</span>, <span class="number">2</span>, <span class="number">221</span>, <span class="number">119</span>, <span class="number">12</span>, <span class="number">25</span>, <span class="number">208</span>, <span class="number">152</span>, <span class="number">83</span>, <span class="number">201</span>], [<span class="number">154</span>, <span class="number">43</span>, <span class="number">180</span>, <span class="number">76</span>, <span class="number">235</span>, <span class="number">5</span>, <span class="number">179</span>, <span class="number">196</span>, <span class="number">206</span>, <span class="number">171</span>, <span class="number">98</span>, <span class="number">145</span>, <span class="number">92</span>, <span class="number">144</span>, <span class="number">247</span>, <span class="number">98</span>], [<span class="number">121</span>, <span class="number">145</span>, <span class="number">123</span>, <span class="number">232</span>, <span class="number">87</span>, <span class="number">78</span>, <span class="number">181</span>, <span class="number">145</span>, <span class="number">79</span>, <span class="number">166</span>, <span class="number">112</span>, <span class="number">169</span>, <span class="number">208</span>, <span class="number">102</span>, <span class="number">201</span>, <span class="number">63</span>], [<span class="number">204</span>, <span class="number">141</span>, <span class="number">165</span>, <span class="number">225</span>, <span class="number">213</span>, <span class="number">137</span>, <span class="number">40</span>, <span class="number">43</span>, <span class="number">229</span>, <span class="number">151</span>, <span class="number">72</span>, <span class="number">237</span>, <span class="number">58</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">31</span>], [<span class="number">35</span>, <span class="number">114</span>, <span class="number">241</span>, <span class="number">31</span>, <span class="number">122</span>, <span class="number">123</span>, <span class="number">164</span>, <span class="number">231</span>, <span class="number">197</span>, <span class="number">89</span>, <span class="number">41</span>, <span class="number">236</span>, <span class="number">128</span>, <span class="number">22</span>, <span class="number">152</span>, <span class="number">82</span>], [<span class="number">141</span>, <span class="number">133</span>, <span class="number">235</span>, <span class="number">79</span>, <span class="number">43</span>, <span class="number">120</span>, <span class="number">209</span>, <span class="number">231</span>, <span class="number">58</span>, <span class="number">85</span>, <span class="number">3</span>, <span class="number">44</span>, <span class="number">73</span>, <span class="number">245</span>, <span class="number">227</span>, <span class="number">62</span>], [<span class="number">28</span>, <span class="number">158</span>, <span class="number">71</span>, <span class="number">41</span>, <span class="number">152</span>, <span class="number">32</span>, <span class="number">91</span>, <span class="number">200</span>, <span class="number">163</span>, <span class="number">46</span>, <span class="number">19</span>, <span class="number">121</span>, <span class="number">23</span>, <span class="number">209</span>, <span class="number">25</span>, <span class="number">55</span>], [<span class="number">156</span>, <span class="number">17</span>, <span class="number">218</span>, <span class="number">146</span>, <span class="number">231</span>, <span class="number">242</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">217</span>, <span class="number">57</span>, <span class="number">100</span>, <span class="number">212</span>, <span class="number">243</span>, <span class="number">87</span>, <span class="number">62</span>, <span class="number">159</span>], [<span class="number">100</span>, <span class="number">111</span>, <span class="number">107</span>, <span class="number">62</span>, <span class="number">106</span>, <span class="number">72</span>, <span class="number">51</span>, <span class="number">79</span>, <span class="number">223</span>, <span class="number">93</span>, <span class="number">86</span>, <span class="number">145</span>, <span class="number">192</span>, <span class="number">21</span>, <span class="number">218</span>, <span class="number">243</span>], [<span class="number">196</span>, <span class="number">250</span>, <span class="number">248</span>, <span class="number">166</span>, <span class="number">155</span>, <span class="number">39</span>, <span class="number">7</span>, <span class="number">93</span>, <span class="number">103</span>, <span class="number">54</span>, <span class="number">168</span>, <span class="number">188</span>, <span class="number">190</span>, <span class="number">104</span>, <span class="number">183</span>, <span class="number">64</span>], [<span class="number">16</span>, <span class="number">131</span>, <span class="number">148</span>, <span class="number">193</span>, <span class="number">19</span>, <span class="number">149</span>, <span class="number">179</span>, <span class="number">212</span>, <span class="number">109</span>, <span class="number">170</span>, <span class="number">201</span>, <span class="number">168</span>, <span class="number">165</span>, <span class="number">167</span>, <span class="number">68</span>, <span class="number">25</span>], [<span class="number">30</span>, <span class="number">222</span>, <span class="number">171</span>, <span class="number">32</span>, <span class="number">141</span>, <span class="number">105</span>, <span class="number">232</span>, <span class="number">104</span>, <span class="number">198</span>, <span class="number">53</span>, <span class="number">50</span>, <span class="number">157</span>, <span class="number">206</span>, <span class="number">165</span>, <span class="number">200</span>, <span class="number">42</span>], [<span class="number">90</span>, <span class="number">149</span>, <span class="number">148</span>, <span class="number">112</span>, <span class="number">142</span>, <span class="number">228</span>, <span class="number">231</span>, <span class="number">119</span>, <span class="number">235</span>, <span class="number">248</span>, <span class="number">233</span>, <span class="number">9</span>, <span class="number">242</span>, <span class="number">102</span>, <span class="number">241</span>, <span class="number">93</span>], [<span class="number">150</span>, <span class="number">32</span>, <span class="number">78</span>, <span class="number">183</span>, <span class="number">68</span>, <span class="number">249</span>, <span class="number">80</span>, <span class="number">165</span>, <span class="number">95</span>, <span class="number">229</span>, <span class="number">211</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">14</span>, <span class="number">172</span>, <span class="number">139</span>], [<span class="number">175</span>, <span class="number">69</span>, <span class="number">15</span>, <span class="number">100</span>, <span class="number">113</span>, <span class="number">63</span>, <span class="number">123</span>, <span class="number">71</span>, <span class="number">24</span>, <span class="number">250</span>, <span class="number">135</span>, <span class="number">232</span>, <span class="number">53</span>, <span class="number">32</span>, <span class="number">81</span>, <span class="number">117</span>]])</span><br><span class="line">c2 = Matrix(ZZ,[[<span class="number">18</span>], [<span class="number">67</span>], [<span class="number">187</span>], [<span class="number">237</span>], [<span class="number">99</span>], [<span class="number">127</span>], [<span class="number">128</span>], [<span class="number">23</span>], [<span class="number">83</span>], [<span class="number">66</span>], [<span class="number">64</span>], [<span class="number">69</span>], [<span class="number">7</span>], [<span class="number">214</span>], [<span class="number">43</span>], [<span class="number">156</span>]])</span><br><span class="line"></span><br><span class="line">p = <span class="number">251</span></span><br><span class="line">A = Matrix(Zmod(p), A)</span><br><span class="line">c1 = Matrix(Zmod(p), c1)</span><br><span class="line">b = vector(b.T)</span><br><span class="line">c2 = vector(c2.T)</span><br><span class="line">x = c1*A^(-<span class="number">1</span>)</span><br><span class="line">t = c2 - x*b</span><br><span class="line">m = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> t:</span><br><span class="line">    <span class="keyword">if</span>(i &gt;= p // <span class="number">2</span>):</span><br><span class="line">        m += <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m += <span class="string">&quot;0&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">int</span>(m,<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#21c4</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h2 id="第二部分：大型密码系统"><a href="#第二部分：大型密码系统" class="headerlink" title="第二部分：大型密码系统"></a>第二部分：大型密码系统</h2><p>这一部分共有4个题目和一个最终挑战，题目之间是有顺序关系的，也就是要先做出某些题目，才能得到后续题目的附件、数据、登录密码之类的相关信息，具体来说这次挑战的先后顺序是：</p>
<ul>
<li>flag1和flag3可以同时挑战</li>
<li>做出flag1可以开启flag2</li>
<li>做出flag3可以开启flag4</li>
<li>全部完成后可以开启最终挑战</li>
</ul>
<p><br></p>
<h3 id="flag1-600-pts"><a href="#flag1-600-pts" class="headerlink" title="flag1(600 pts)"></a>flag1(600 pts)</h3><p>题目：</p>
<p>passwordEncryptorV2.c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROUND 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//S-Box 16x16</span></span><br><span class="line"><span class="type">int</span> sBox[<span class="number">16</span>] =</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="number">2</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">12</span>,</span><br><span class="line">                <span class="number">1</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">14</span>,</span><br><span class="line">                <span class="number">7</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">                <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">13</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将十六进制字符串转换为 unsigned char 数组</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hex_to_bytes</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* hex_str, <span class="type">unsigned</span> <span class="type">char</span>* bytes, <span class="type">size_t</span> bytes_len)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> hex_len = <span class="built_in">strlen</span>(hex_str);</span><br><span class="line">    <span class="keyword">if</span> (hex_len % <span class="number">2</span> != <span class="number">0</span> || hex_len / <span class="number">2</span> &gt; bytes_len) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid hex string length.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hex_len / <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">sscanf</span>(hex_str + <span class="number">2</span> * i, <span class="string">&quot;%2hhx&quot;</span>, &amp;bytes[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 派生轮密钥</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">derive_round_key</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> key, <span class="type">unsigned</span> <span class="type">char</span> *round_key, <span class="type">int</span> length)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tmp = key;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; length / <span class="number">16</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(round_key + i * <span class="number">16</span>,      &amp;tmp, <span class="number">4</span>);   tmp++;</span><br><span class="line">        <span class="built_in">memcpy</span>(round_key + i * <span class="number">16</span> + <span class="number">4</span>,  &amp;tmp, <span class="number">4</span>);   tmp++;</span><br><span class="line">        <span class="built_in">memcpy</span>(round_key + i * <span class="number">16</span> + <span class="number">8</span>,  &amp;tmp, <span class="number">4</span>);   tmp++;</span><br><span class="line">        <span class="built_in">memcpy</span>(round_key + i * <span class="number">16</span> + <span class="number">12</span>, &amp;tmp, <span class="number">4</span>);   tmp++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 比特逆序</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">reverseBits</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* state)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> byte = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            byte |= ((state[i] &gt;&gt; j) &amp; <span class="number">1</span>) &lt;&lt; (<span class="number">7</span> - j);</span><br><span class="line">        &#125;</span><br><span class="line">        temp[<span class="number">15</span> - i] = byte;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        state[i] = temp[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sBoxTransform</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* state)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> lo = sBox[state[i] &amp; <span class="number">0xF</span>];</span><br><span class="line">        <span class="type">int</span> hi = sBox[state[i] &gt;&gt; <span class="number">4</span>];</span><br><span class="line">        state[i] = (hi &lt;&lt; <span class="number">4</span>) | lo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leftShiftBytes</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* state)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        temp[i + <span class="number">0</span>] = state[i + <span class="number">2</span>] &gt;&gt; <span class="number">5</span> | (state[i + <span class="number">1</span>] &lt;&lt; <span class="number">3</span>);</span><br><span class="line">        temp[i + <span class="number">1</span>] = state[i + <span class="number">3</span>] &gt;&gt; <span class="number">5</span> | (state[i + <span class="number">2</span>] &lt;&lt; <span class="number">3</span>);</span><br><span class="line">        temp[i + <span class="number">2</span>] = state[i + <span class="number">0</span>] &gt;&gt; <span class="number">5</span> | (state[i + <span class="number">3</span>] &lt;&lt; <span class="number">3</span>);</span><br><span class="line">        temp[i + <span class="number">3</span>] = state[i + <span class="number">1</span>] &gt;&gt; <span class="number">5</span> | (state[i + <span class="number">0</span>] &lt;&lt; <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        state[i] = temp[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 轮密钥加</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">addRoundKey</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* state, <span class="type">unsigned</span> <span class="type">char</span>* roundKey, <span class="type">unsigned</span> <span class="type">int</span> round)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            state[i] ^= ((roundKey[i + round * <span class="number">16</span>] &gt;&gt; j) &amp; <span class="number">1</span>) &lt;&lt; j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">encrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* password, <span class="type">unsigned</span> <span class="type">int</span> key, <span class="type">unsigned</span> <span class="type">char</span>* ciphertext)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> roundKeys[<span class="number">16</span> * ROUND] = &#123;&#125;; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成轮密钥</span></span><br><span class="line">    derive_round_key(key, roundKeys, <span class="number">16</span> * ROUND);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始状态为16字节的口令</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> state[<span class="number">16</span>]; <span class="comment">// 初始状态为16字节的密码</span></span><br><span class="line">    <span class="built_in">memcpy</span>(state, password, <span class="number">16</span>); <span class="comment">// 初始状态为密码的初始值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 迭代加密过程</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> round = <span class="number">0</span>; round &lt; ROUND; round++)</span><br><span class="line">    &#123;</span><br><span class="line">        reverseBits(state);</span><br><span class="line">        sBoxTransform(state);</span><br><span class="line">        leftShiftBytes(state);</span><br><span class="line">        addRoundKey(state, roundKeys, round);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(ciphertext, state, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> password[] = <span class="string">&quot;pwd:xxxxxxxxxxxx&quot;</span>; <span class="comment">// 口令明文固定以pwd:开头，16字节的口令</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key = <span class="number">0xF0FFFFFF</span>; <span class="comment">// 4字节的密钥</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ciphertext[<span class="number">16</span>]; <span class="comment">// 16字节的状态</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password: \n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, password);</span><br><span class="line"></span><br><span class="line">    encrypt(password, key, ciphertext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出加密后的结果</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Encrypted password:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X&quot;</span>, ciphertext[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目基于一个对称加密，给出了其具体实现步骤。连接靶机之后会给出密文，要求求出password，来解压带密码的协同签名源码文件压缩包，压缩包内含有本题的flag值以及flag2的源码。</p>
<p>可以看出在有key的情况下，解密就是把整个加密过程逆一下，这一部分交给学长很快就写好了。</p>
<p>然而学长发现对于靶机给出的密文，用题目给定的0xF0FFFFFF当作key是解不出他要求的”pwd:”开头的password的，所以我猜测这个key只是个示例，实际上要用这个已知的开头来爆破4字节的key。4字节对于c来说似乎也不算很大，因此简单修改下解密部分就开爆了。但是，实际效果并不是很理想，如果要爆破完所有解空间的话，差不多需要2^16秒，这对于仅仅6h的比赛来说太长了，所以要考虑一些优化。而比起仔细查看代码来说，最简单的优化当然是直接用多进程来做。</p>
<p>可是我只用过python的多进程，并且考虑到python本身的速度，为了用个多进程把整个求解代码转成python实在是不太划算。可是比赛不出网，要查询资料不仅需要申请，时间也只限10min，还会对整个队伍的成绩产生影响，更不划算。所以想来想去也只能三个人都多开点窗口，然后从不同的位置开爆。</p>
<blockquote>
<p>也算是一种多进程了。</p>
</blockquote>
<p>然而这样做有意想不到的效果——我让学弟倒着爆破的那个窗口过了一段时间真的跑出了结果，这个题也就顺利解掉了。</p>
<blockquote>
<p>实际上最后一轮提示中有提到，因为某些原因，key首字节一定是F，所以倒着爆才更加快；此外还有一些其他地方可以减少耗时。</p>
<p>这里就不仔细研究产生这些优化的原因了，多进程肯定是最有力的XD，做出来就行。</p>
</blockquote>
<p>exp：(header.h就是题目加密源码里的函数)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;header.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* m)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X&quot;</span>, m[i]); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sBox_inv[<span class="number">16</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">13</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">14</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rightShiftBytes</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* state)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp[<span class="number">16</span>]; </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        temp[i + <span class="number">0</span>] = state[i + <span class="number">2</span>] &lt;&lt; <span class="number">5</span> | (state[i + <span class="number">3</span>] &gt;&gt; <span class="number">3</span>); </span><br><span class="line">        temp[i + <span class="number">1</span>] = state[i + <span class="number">3</span>] &lt;&lt; <span class="number">5</span> | (state[i + <span class="number">0</span>] &gt;&gt; <span class="number">3</span>); </span><br><span class="line">        temp[i + <span class="number">2</span>] = state[i + <span class="number">0</span>] &lt;&lt; <span class="number">5</span> | (state[i + <span class="number">1</span>] &gt;&gt; <span class="number">3</span>); </span><br><span class="line">        temp[i + <span class="number">3</span>] = state[i + <span class="number">1</span>] &lt;&lt; <span class="number">5</span> | (state[i + <span class="number">2</span>] &gt;&gt; <span class="number">3</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">        state[i] = temp[i]; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* password, <span class="type">unsigned</span> <span class="type">int</span> key, <span class="type">unsigned</span> <span class="type">char</span>* ciphertext)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> roundKeys[<span class="number">16</span> * ROUND] = &#123;&#125;; </span><br><span class="line">    derive_round_key(key, roundKeys, <span class="number">16</span> * ROUND); </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> state[<span class="number">16</span>]; </span><br><span class="line">    <span class="built_in">memcpy</span>(state, ciphertext, <span class="number">16</span>); </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> round = ROUND - <span class="number">1</span>; round &gt;= <span class="number">0</span>; round--) &#123;</span><br><span class="line">        addRoundKey(state, roundKeys, round);</span><br><span class="line">        rightShiftBytes(state);</span><br><span class="line">        sBoxTransform(state, sBox_inv);</span><br><span class="line">        reverseBits(state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(password, state, <span class="number">16</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// cipher = &quot;B17164A27E035012107D6F7B0454D51D&quot;</span></span><br><span class="line">    <span class="comment">// cipher = &quot;99F2980AAB4BE8640D8F322147CBA409&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> password[] = <span class="string">&quot;pwd:xxxxxxxxxxxx&quot;</span>; <span class="comment">// 口令明文固定以pwd:开头，16字节的口令</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ciphertext[<span class="number">16</span>]; <span class="comment">// 16字节的状态</span></span><br><span class="line">    hex_to_bytes(<span class="string">&quot;99F2980AAB4BE8640D8F322147CBA409&quot;</span>, ciphertext, <span class="number">16</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> key = <span class="number">0</span>; key &lt; <span class="number">0xFFFFFFFF</span>; key++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((key &amp; <span class="number">0xFFFF</span>) == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, key); </span><br><span class="line">        decrypt(password, key, ciphertext); </span><br><span class="line">        <span class="keyword">if</span> (password[<span class="number">0</span>] == <span class="number">112</span> &amp;&amp; password[<span class="number">1</span>] == <span class="number">119</span> &amp;&amp; password[<span class="number">2</span>] == <span class="number">100</span> &amp;&amp; password[<span class="number">3</span>] == <span class="number">58</span>) &#123;</span><br><span class="line">            print(password); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="flag2-900-pts"><a href="#flag2-900-pts" class="headerlink" title="flag2(900 pts)"></a>flag2(900 pts)</h3><p>题目：</p>
<p>co-signing_client.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> form = <span class="title function_">ref</span>(&#123;</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">msgdigest</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">k1</span>: any = <span class="title function_">ref</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">submit</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    isform.<span class="property">value</span>.<span class="title function_">validate</span>(<span class="function">(<span class="params">valid: boolean</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">            </span><br><span class="line">            loading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">let</span> smPassword = <span class="title function_">ref</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            smPassword.<span class="property">value</span> = <span class="title function_">sm3</span>(form.<span class="property">value</span>.<span class="property">password</span>);</span><br><span class="line">            <span class="comment">// 客户端通过用户口令、消息摘要和用户私钥d1，计算客户端协同签名值 p1x, p1y, q1x, q1y, r1, s1</span></span><br><span class="line">            <span class="keyword">var</span> &#123; str_e, str_p1x, str_p1y, str_q1x, str_q1y, str_r1, str_s1, errMessage &#125; = <span class="title function_">clientSign1</span>(smPassword.<span class="property">value</span>, form.<span class="property">value</span>.<span class="property">msgdigest</span>);</span><br><span class="line">            <span class="keyword">if</span> (errMessage) &#123;</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(errMessage)</span><br><span class="line">                loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> data = &#123;</span><br><span class="line">                <span class="attr">q1x</span>: str_q1x,</span><br><span class="line">                <span class="attr">q1y</span>: str_q1y,</span><br><span class="line">                <span class="attr">e</span>: str_e,</span><br><span class="line">                <span class="attr">r1</span>: str_r1,</span><br><span class="line">                <span class="attr">s1</span>: str_s1,</span><br><span class="line">                <span class="attr">p1x</span>: str_p1x,</span><br><span class="line">                <span class="attr">p1y</span>: str_p1y</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 客户端将 e, p1x, p1y, q1x, q1y, r1, s1发送给服务端</span></span><br><span class="line">            <span class="comment">// 服务端用服务端私钥d2计算服务端协同签名值 s2, s3, r 发送给客户端</span></span><br><span class="line">            <span class="title function_">sign_param_send</span>(data).<span class="title function_">then</span>(<span class="function">(<span class="params">res: any</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 客户端通过s2, s3, r，计算协同签名值 s</span></span><br><span class="line">                <span class="keyword">let</span> <span class="attr">str_s</span>: any = <span class="title function_">clientSign2</span>(smPassword.<span class="property">value</span>, res.<span class="property">s2</span>, res.<span class="property">s3</span>, res.<span class="property">r</span>);</span><br><span class="line">                <span class="keyword">if</span> (str_s.<span class="property">errMessage</span>) &#123;</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(errMessage)</span><br><span class="line">                    loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">&quot;协同签名成功&quot;</span>);</span><br><span class="line">                <span class="title function_">signature_send</span>(&#123; <span class="attr">client_sign</span>: str_s &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res: any</span>) =&gt;</span> &#123;</span><br><span class="line">                    qmz.<span class="property">value</span> = str_s;</span><br><span class="line">                    loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">                &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">err: any</span>) =&gt;</span> &#123;</span><br><span class="line">                    loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err: any</span>) =&gt;</span> &#123;</span><br><span class="line">                loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">clientSign1</span>: any = <span class="function">(<span class="params">str_d1: any, str_e: any</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> d1 = <span class="keyword">new</span> <span class="title function_">BN</span>(str_d1, <span class="number">16</span>);</span><br><span class="line">    <span class="comment">// console.log(&quot;e&quot;,str_e)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> e = <span class="keyword">new</span> <span class="title function_">BN</span>(str_e, <span class="number">16</span>);</span><br><span class="line">    <span class="comment">// console.log(&quot;e&quot;,e)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">sm2</span>: any = <span class="keyword">new</span> elliptic.<span class="property">curve</span>.<span class="title function_">short</span>(&#123;</span><br><span class="line">        <span class="attr">p</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#x27;</span>,</span><br><span class="line">        <span class="attr">a</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#x27;</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="string">&#x27;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#x27;</span>,</span><br><span class="line">        <span class="attr">n</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#x27;</span>,</span><br><span class="line">        <span class="attr">g</span>: [</span><br><span class="line">            <span class="string">&#x27;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125; <span class="keyword">as</span> any);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> n = <span class="keyword">new</span> <span class="title function_">BN</span>(sm2.<span class="property">n</span>.<span class="title function_">toString</span>(<span class="number">16</span>), <span class="number">16</span>);    </span><br><span class="line">    <span class="keyword">let</span> G = sm2.<span class="property">g</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// generate random k1</span></span><br><span class="line">    <span class="keyword">const</span> randomBytes = <span class="title function_">cryptoRandomStringAsync</span>(&#123; <span class="attr">length</span>: <span class="number">64</span> &#125;);</span><br><span class="line">    k1.<span class="property">value</span> = <span class="keyword">new</span> <span class="title function_">BN</span>(randomBytes <span class="keyword">as</span> any, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">while</span>(k1.<span class="property">value</span>.<span class="title function_">mod</span>(n).<span class="title function_">isZero</span>())&#123;</span><br><span class="line">        <span class="keyword">const</span> randomBytes = <span class="title function_">cryptoRandomStringAsync</span>(&#123; <span class="attr">length</span>: <span class="number">64</span> &#125;);</span><br><span class="line">        k1.<span class="property">value</span> = <span class="keyword">new</span> <span class="title function_">BN</span>(randomBytes <span class="keyword">as</span> any, <span class="number">16</span>);     </span><br><span class="line">    &#125;</span><br><span class="line">    k1.<span class="property">value</span> = k1.<span class="property">value</span>.<span class="title function_">mod</span>(n);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// d1 = d1 mod n</span></span><br><span class="line">    d1 = d1.<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">if</span> (d1.<span class="title function_">isZero</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> errMessage = <span class="string">&quot;d1=0，签名失败&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123; errMessage &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//P1 = ((d1)^(-1)) * G</span></span><br><span class="line">    <span class="keyword">let</span> tmp1 = d1.<span class="title function_">invm</span>(n);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable constant_">P1</span> = G.<span class="title function_">mul</span>(tmp1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Q1 = k1*G = (x, y)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable constant_">Q1</span> = G.<span class="title function_">mul</span>(k1.<span class="property">value</span>);</span><br><span class="line">    <span class="keyword">let</span> x = <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="variable constant_">Q1</span>.<span class="title function_">getX</span>().<span class="title function_">toString</span>(<span class="number">16</span>), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//r1 = x mod n</span></span><br><span class="line">    <span class="keyword">let</span> r1 = x.<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">if</span> (r1.<span class="title function_">isZero</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> errMessage = <span class="string">&quot;r1=0，签名失败&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123; errMessage &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//s1 = k1^(-1) * (e + d1^(-1) * r1) mod n</span></span><br><span class="line">    tmp1 = d1.<span class="title function_">invm</span>(n);</span><br><span class="line">    <span class="keyword">let</span> tmp2 = tmp1.<span class="title function_">mul</span>(r1).<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">let</span> tmp3 = tmp2.<span class="title function_">add</span>(e).<span class="title function_">mod</span>(n);</span><br><span class="line">    tmp1 = k1.<span class="property">value</span>.<span class="title function_">invm</span>(n);</span><br><span class="line">    <span class="keyword">let</span> s1 = tmp1.<span class="title function_">mul</span>(tmp3).<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">if</span> (s1.<span class="title function_">isZero</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> errMessage = <span class="string">&quot;s1=0，签名失败&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123; errMessage &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    str_e = e.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="comment">// console.log(&quot;str_e&quot;,str_e)</span></span><br><span class="line">    <span class="keyword">let</span> str_p1x = <span class="variable constant_">P1</span>.<span class="title function_">getX</span>().<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> str_p1y = <span class="variable constant_">P1</span>.<span class="title function_">getY</span>().<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> str_q1x = <span class="variable constant_">Q1</span>.<span class="title function_">getX</span>().<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> str_q1y = <span class="variable constant_">Q1</span>.<span class="title function_">getY</span>().<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> str_r1 = r1.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> str_s1 = s1.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; str_e, str_p1x, str_p1y, str_q1x, str_q1y, str_r1, str_s1 &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clientSign2</span> = (<span class="params">str_d1: any, str_s2: any, str_s3: any, str_r: any</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> sm2 = <span class="keyword">new</span> elliptic.<span class="property">curve</span>.<span class="title function_">short</span>(&#123;</span><br><span class="line">        <span class="attr">p</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#x27;</span>,</span><br><span class="line">        <span class="attr">a</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#x27;</span>,</span><br><span class="line">        <span class="attr">b</span>: <span class="string">&#x27;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#x27;</span>,</span><br><span class="line">        <span class="attr">n</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#x27;</span>,</span><br><span class="line">        <span class="attr">g</span>: [</span><br><span class="line">            <span class="string">&#x27;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125; <span class="keyword">as</span> any);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> d1 = <span class="keyword">new</span> <span class="title function_">BN</span>(str_d1, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> n = <span class="keyword">new</span> <span class="title function_">BN</span>(sm2.<span class="property">n</span>.<span class="title function_">toString</span>(<span class="number">16</span>), <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> s2 = <span class="keyword">new</span> <span class="title function_">BN</span>(str_s2, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> s3 = <span class="keyword">new</span> <span class="title function_">BN</span>(str_s3, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">let</span> r = <span class="keyword">new</span> <span class="title function_">BN</span>(str_r, <span class="number">16</span>);</span><br><span class="line">    <span class="comment">//s = d1*k1*s2 + d1*s3 -r mod n</span></span><br><span class="line">    <span class="keyword">let</span> tmp1 = d1.<span class="title function_">mul</span>(k1.<span class="property">value</span>).<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">let</span> tmp2 = tmp1.<span class="title function_">mul</span>(s2).<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">let</span> tmp3 = d1.<span class="title function_">mul</span>(s3).<span class="title function_">mod</span>(n);</span><br><span class="line">    tmp1 = tmp2.<span class="title function_">add</span>(tmp3).<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">let</span> s = tmp1.<span class="title function_">sub</span>(r).<span class="title function_">mod</span>(n);</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="title function_">isZero</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> errMessage = <span class="string">&quot;s=0，签名失败&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123; errMessage &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="title function_">add</span>(r).<span class="title function_">mod</span>(n).<span class="title function_">isZero</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> errMessage = <span class="string">&quot;s=n-r，签名失败&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123; errMessage &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> str_s = s.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (str_s[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">        s = s.<span class="title function_">add</span>(n).<span class="title function_">mod</span>(n);</span><br><span class="line">        str_s = s.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>co-signing_client.c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/ec.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/rand.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SM2LEN 32</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">error</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">error_partial_verify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error partial verify.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_flag2</span><span class="params">(<span class="type">const</span> BIGNUM *d2)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *hex_str = BN_bn2hex(d2);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; hex_str[i] != <span class="string">&#x27;\0&#x27;</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hex_str[i] &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; hex_str[i] &lt;= <span class="string">&#x27;F&#x27;</span>) &#123;</span><br><span class="line">            hex_str[i] += <span class="number">32</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag2&#123;%s&#125;\n&quot;</span>, hex_str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> s2[SM2LEN * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span> s3[SM2LEN * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span> r[SM2LEN * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> success;</span><br><span class="line">&#125; Result;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协同签名服务端签名算法</span></span><br><span class="line">Result <span class="title function_">server</span><span class="params">(<span class="type">char</span>* str_e,<span class="type">char</span>* str_p1x,<span class="type">char</span>* str_p1y,<span class="type">char</span>* str_q1x,<span class="type">char</span>* str_q1y,<span class="type">char</span>* str_r1,<span class="type">char</span>* str_s1)</span>&#123;</span><br><span class="line">    Result res = &#123;<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> rv = <span class="number">1</span>;</span><br><span class="line">	BIGNUM *e,*a,*b,*p,*n,*x,*y;</span><br><span class="line">	BIGNUM *d2,*r1,*s1,*p1x,*p1y,*q1x,*q1y;</span><br><span class="line">	BIGNUM *u1,*u2,*xprime,*yprime,*k2,*k3,*x1,*y1,*r,*s2,*s3,*s,*tmp1,*tmp2,*tmp3;</span><br><span class="line">	EC_GROUP* group;</span><br><span class="line">	EC_POINT *generator,*G,*P,*P1,*Q1,*TMP;</span><br><span class="line"></span><br><span class="line">	BN_CTX* bn_ctx = BN_CTX_new();</span><br><span class="line">	BN_CTX_start(bn_ctx);</span><br><span class="line">	<span class="keyword">if</span> (!bn_ctx)</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line">	e = BN_CTX_get(bn_ctx);</span><br><span class="line">	a = BN_CTX_get(bn_ctx);</span><br><span class="line">	b = BN_CTX_get(bn_ctx);</span><br><span class="line">	p = BN_CTX_get(bn_ctx);</span><br><span class="line">	n = BN_CTX_get(bn_ctx);</span><br><span class="line">	d2 = BN_CTX_get(bn_ctx);</span><br><span class="line">	x = BN_CTX_get(bn_ctx);</span><br><span class="line">	y = BN_CTX_get(bn_ctx);</span><br><span class="line">	p1x = BN_CTX_get(bn_ctx);</span><br><span class="line">	p1y = BN_CTX_get(bn_ctx);</span><br><span class="line">	q1x = BN_CTX_get(bn_ctx);</span><br><span class="line">	q1y = BN_CTX_get(bn_ctx);</span><br><span class="line">	r1 = BN_CTX_get(bn_ctx);</span><br><span class="line">	s1 = BN_CTX_get(bn_ctx);</span><br><span class="line">	u1 = BN_CTX_get(bn_ctx);</span><br><span class="line">	u2 = BN_CTX_get(bn_ctx);</span><br><span class="line">	xprime = BN_CTX_get(bn_ctx);</span><br><span class="line">	yprime = BN_CTX_get(bn_ctx);</span><br><span class="line">	k2 = BN_CTX_get(bn_ctx);</span><br><span class="line">	k3 = BN_CTX_get(bn_ctx);</span><br><span class="line">	x1 = BN_CTX_get(bn_ctx);</span><br><span class="line">	y1 = BN_CTX_get(bn_ctx);</span><br><span class="line">	r = BN_CTX_get(bn_ctx);</span><br><span class="line">	s2 = BN_CTX_get(bn_ctx);</span><br><span class="line">	s3 = BN_CTX_get(bn_ctx);</span><br><span class="line">	s = BN_CTX_get(bn_ctx);</span><br><span class="line">	tmp1 = BN_CTX_get(bn_ctx);</span><br><span class="line">	tmp2 = BN_CTX_get(bn_ctx);</span><br><span class="line">	tmp3 = BN_CTX_get(bn_ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (</span><br><span class="line">		!BN_hex2bn(&amp;e, str_e) ||</span><br><span class="line">		!BN_hex2bn(&amp;p1x, str_p1x) ||</span><br><span class="line">		!BN_hex2bn(&amp;p1y, str_p1y) ||</span><br><span class="line">		!BN_hex2bn(&amp;q1x, str_q1x) ||</span><br><span class="line">		!BN_hex2bn(&amp;q1y, str_q1y) ||</span><br><span class="line">		!BN_hex2bn(&amp;r1, str_r1) ||</span><br><span class="line">		!BN_hex2bn(&amp;s1, str_s1) ||</span><br><span class="line">		!BN_hex2bn(&amp;a, <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>) ||</span><br><span class="line">		!BN_hex2bn(&amp;b, <span class="string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>) ||</span><br><span class="line">		!BN_hex2bn(&amp;p, <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>) ||</span><br><span class="line">		!BN_hex2bn(&amp;n, <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>) ||</span><br><span class="line">		<span class="comment">// d2 = ds (server key)</span></span><br><span class="line">		!BN_hex2bn(&amp;d2, <span class="string">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>) ||</span><br><span class="line">		!BN_hex2bn(&amp;x, <span class="string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>) ||</span><br><span class="line">		!BN_hex2bn(&amp;y, <span class="string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>) ||</span><br><span class="line">		!BN_rand_range(k2,n) ||</span><br><span class="line">		!BN_copy(k3, k2)</span><br><span class="line">		)</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// generate k2 in [1, n-1]</span></span><br><span class="line">	<span class="keyword">while</span>(BN_is_zero(k2))&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !BN_rand_range(k2,n) ||</span><br><span class="line">            !BN_copy(k3, k2)</span><br><span class="line">            )</span><br><span class="line">            &#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	group = EC_GROUP_new_curve_GFp(p, a, b, bn_ctx);</span><br><span class="line">	generator = EC_POINT_new(group);</span><br><span class="line">	<span class="keyword">if</span> (!generator)</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, generator, x, y, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> != EC_GROUP_set_generator(group, generator, n, <span class="literal">NULL</span>))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	G = EC_POINT_new(group);</span><br><span class="line">	P = EC_POINT_new(group);</span><br><span class="line">	P1 = EC_POINT_new(group);</span><br><span class="line">	Q1 = EC_POINT_new(group);</span><br><span class="line">	TMP = EC_POINT_new(group);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if r1=0 or s1=0, error</span></span><br><span class="line">	<span class="keyword">if</span> (BN_is_zero(r1) || BN_is_zero(s1))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set P1 = (p1x, p1y)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, P1, p1x, p1y, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set Q1 = (q1x, q1y)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, Q1, q1x, q1y, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//u1 = e * (s1^(-1)) mod n, u2 = r1 * (s1^(-1)) mod n</span></span><br><span class="line">	<span class="keyword">if</span> (!BN_mod_inverse(tmp1, s1, n, bn_ctx) ||</span><br><span class="line">		!BN_mod_mul(u1, e, tmp1, n, bn_ctx) ||</span><br><span class="line">		!BN_mod_mul(u2, r1, tmp1, n, bn_ctx) ||</span><br><span class="line">		!BN_mod(u1, u1, n, bn_ctx) ||</span><br><span class="line">		!BN_mod(u2, u2, n, bn_ctx)</span><br><span class="line">		)</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//u1*G + u2*P1 = (x&#x27;, y&#x27;)</span></span><br><span class="line">	<span class="keyword">if</span> (!EC_POINT_mul(group, TMP, u1, P1, u2, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!EC_POINT_get_affine_coordinates_GFp(group, TMP, xprime, yprime, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//verify r1 = x&#x27; mod n</span></span><br><span class="line">	<span class="keyword">if</span> (!BN_mod(xprime, xprime, n, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(BN_cmp(r1,xprime))</span><br><span class="line">		&#123; error_partial_verify(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//k2*G + k3*Q1 = (x1, y1)</span></span><br><span class="line">	<span class="keyword">if</span> (!EC_POINT_mul(group, TMP, k2, Q1, k3, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!EC_POINT_get_affine_coordinates_GFp(group, TMP, x1, y1, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//r=(e+x1) mod n</span></span><br><span class="line">	<span class="keyword">if</span> (!BN_mod_add(r, e, x1, n, bn_ctx))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (BN_is_zero(r))</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line">	<span class="built_in">strncpy</span>(res.r, BN_bn2hex(r), <span class="number">2</span>*SM2LEN+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//s2 = d2 * k3 mod n, s3 = d2 * (r+k2) mod n</span></span><br><span class="line">	<span class="keyword">if</span> (!BN_mod_mul(s2, d2, k3, n, bn_ctx) ||</span><br><span class="line">		!BN_mod_add(tmp1, r, k2, n, bn_ctx) ||</span><br><span class="line">		!BN_mod_mul(s3, d2, tmp1, n, bn_ctx) ||</span><br><span class="line">		!BN_mod(s2, s2, n, bn_ctx) ||</span><br><span class="line">		!BN_mod(s3, s3, n, bn_ctx)</span><br><span class="line">		)</span><br><span class="line">		&#123; error(); <span class="keyword">return</span> res; &#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;s2: %s\n&quot;</span>,BN_bn2hex(s2));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;s3: %s\n&quot;</span>,BN_bn2hex(s3));</span><br><span class="line">	<span class="built_in">strncpy</span>(res.s2, BN_bn2hex(s2), <span class="number">2</span>*SM2LEN+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">strncpy</span>(res.s3, BN_bn2hex(s3), <span class="number">2</span>*SM2LEN+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// flag2 的格式如下：flag2&#123;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#125;，大括号中的内容为 16 进制格式（字母小写）的 d2。</span></span><br><span class="line">    print_flag2(d2);</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">0</span>;</span><br><span class="line">    BN_CTX_free(bn_ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算公钥P</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getPublicKey</span><span class="params">(<span class="type">char</span> *str_d2, <span class="type">char</span> *str_p1x, <span class="type">char</span> *str_p1y)</span> &#123;</span><br><span class="line">    <span class="type">int</span> rv = <span class="number">1</span>;</span><br><span class="line">    BIGNUM *negone, *a, *b, *p, *n, *x, *y;</span><br><span class="line">    BIGNUM *d2, *p1x, *p1y, *px, *py;</span><br><span class="line">    BIGNUM *tmp1, *tmp2;</span><br><span class="line">    EC_GROUP *group;</span><br><span class="line">    EC_POINT *generator, *G, *P, *P1;</span><br><span class="line"></span><br><span class="line">    BN_CTX *bn_ctx = BN_CTX_new();</span><br><span class="line">    BN_CTX_start(bn_ctx);</span><br><span class="line">    <span class="keyword">if</span> (!bn_ctx) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    negone = BN_CTX_get(bn_ctx);</span><br><span class="line">    a = BN_CTX_get(bn_ctx);</span><br><span class="line">    b = BN_CTX_get(bn_ctx);</span><br><span class="line">    p = BN_CTX_get(bn_ctx);</span><br><span class="line">    n = BN_CTX_get(bn_ctx);</span><br><span class="line">    d2 = BN_CTX_get(bn_ctx);</span><br><span class="line">    x = BN_CTX_get(bn_ctx);</span><br><span class="line">    y = BN_CTX_get(bn_ctx);</span><br><span class="line">    p1x = BN_CTX_get(bn_ctx);</span><br><span class="line">    p1y = BN_CTX_get(bn_ctx);</span><br><span class="line">    px = BN_CTX_get(bn_ctx);</span><br><span class="line">    py = BN_CTX_get(bn_ctx);</span><br><span class="line">    tmp1 = BN_CTX_get(bn_ctx);</span><br><span class="line">    tmp2 = BN_CTX_get(bn_ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        !BN_hex2bn(&amp;d2, str_d2) ||</span><br><span class="line">        !BN_hex2bn(&amp;p1x, str_p1x) ||</span><br><span class="line">        !BN_hex2bn(&amp;p1y, str_p1y) ||</span><br><span class="line">        !BN_hex2bn(&amp;a, <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>) ||</span><br><span class="line">        !BN_hex2bn(&amp;b, <span class="string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>) ||</span><br><span class="line">        !BN_hex2bn(&amp;p, <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>) ||</span><br><span class="line">        !BN_hex2bn(&amp;n, <span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>) ||</span><br><span class="line">        !BN_hex2bn(&amp;x, <span class="string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>) ||</span><br><span class="line">        !BN_hex2bn(&amp;y, <span class="string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    group = EC_GROUP_new_curve_GFp(p, a, b, bn_ctx);</span><br><span class="line">    generator = EC_POINT_new(group);</span><br><span class="line">    <span class="keyword">if</span> (!generator) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, generator, x, y, bn_ctx)) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> != EC_GROUP_set_generator(group, generator, n, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    G = EC_POINT_new(group);</span><br><span class="line">    P = EC_POINT_new(group);</span><br><span class="line">    P1 = EC_POINT_new(group);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set P1 = (p1x, p1y)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, P1, p1x, p1y, bn_ctx)) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//P = ((d2)^(-1)) * P1 - G</span></span><br><span class="line">    <span class="keyword">if</span> (!BN_zero(tmp1) ||</span><br><span class="line">        !BN_one(tmp2) ||</span><br><span class="line">        !BN_mod_sub(negone, tmp1, tmp2, n, bn_ctx)</span><br><span class="line">    ) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!BN_mod_inverse(tmp1, d2, n, bn_ctx) || !EC_POINT_mul(group, P, negone, P1, tmp1, bn_ctx)) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!EC_POINT_get_affine_coordinates_GFp(group, P, px, py, bn_ctx)) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Px: %s\n&quot;</span>, BN_bn2hex(px));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Py: %s\n&quot;</span>, BN_bn2hex(py));</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">0</span>;</span><br><span class="line">    BN_CTX_free(bn_ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> rv = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (server(argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>], argv[<span class="number">4</span>], argv[<span class="number">5</span>], argv[<span class="number">6</span>], argv[<span class="number">7</span>])) &#123;</span><br><span class="line">        error();</span><br><span class="line">        <span class="keyword">return</span> rv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个题目代码特别特别的长，具体细节可以慢慢读。</p>
<p>.js文件是交互部分，梳理一下主要交互流程是：</p>
<ul>
<li><p>用户输入口令和消息摘要，并发送给服务器</p>
</li>
<li><p>用户本地计算出如下数据，这些数据可以在发送包的负载里找到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e, p1x, p1y, q1x, q1y, r1, s1</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器接收到数据后，进行协同签名，并发送以下数据返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s2, s3, r</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们需要计算出服务器的私钥d2，d2就是flag2的值</p>
</li>
</ul>
<p>而.c文件则是告诉我们协同签名流程，这些数据主要有以下一些关系(运算均在模n下，n是曲线阶)：</p>
<ul>
<li><p>使用SM2的标准曲线，参数及生成元G均已知，服务器私钥为d2，并有以下P点坐标：</p>
<script type="math/tex; mode=display">
P = d_2G</script></li>
<li><p>使用用户发送来的p1x, p1y, q1x, q1y这几个数据设置点P1、Q1</p>
</li>
<li><p>使用用户发送来的e、r1、s1计算u1、u2：</p>
<script type="math/tex; mode=display">
u_1 = es_1^{-1}</script><script type="math/tex; mode=display">
u_2 = r_1s_1^{-1}</script></li>
<li><p>计算中间点T(x’,y’)，验证r1=x’：</p>
<script type="math/tex; mode=display">
T = u_1G + u_2P_1</script></li>
<li><p>生成随机数k2、k3，并计算：</p>
<script type="math/tex; mode=display">
(x_1,y_1) = k_2G + k_3Q_1</script></li>
<li><p>计算r：</p>
<script type="math/tex; mode=display">
r = e + x_1</script></li>
<li><p>计算s2、s3：</p>
<script type="math/tex; mode=display">
s_2 = d_2k_3</script><script type="math/tex; mode=display">
s_3 = d_2(r + k_2)</script></li>
<li><p>返回r、s2、s3</p>
</li>
</ul>
<p>整个步骤就是看注释一步步梳理出来的，我们的目的是算出d2来，而s2、s3中一共有三个变量d2、k2、k3，并不足以求出所有未知数，所以可能需要利用r再构造一个等式才行。</p>
<p>然而这个题藏了个相当阴的地方，仔细观察可以发现一行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BN_copy(k3, k2)</span><br></pre></td></tr></table></figure>
<p>这也就是说k3=k2，因此未知数实际上就只有两个，所以很轻松就可以拿到d2了XD。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">a = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>, <span class="number">16</span>)</span><br><span class="line">b = <span class="built_in">int</span>(<span class="string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>, <span class="number">16</span>)</span><br><span class="line">p = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>, <span class="number">16</span>)</span><br><span class="line">n = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>, <span class="number">16</span>)</span><br><span class="line">x = <span class="built_in">int</span>(<span class="string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>, <span class="number">16</span>)</span><br><span class="line">y = <span class="built_in">int</span>(<span class="string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(Zmod(p),[a,b])</span><br><span class="line">G = E(x,y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################# res</span></span><br><span class="line">e = <span class="string">&quot;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot;</span></span><br><span class="line">p1x = <span class="string">&quot;3e8eda67c5f1b70ac1950f615c2c4e0b0fe2544823ac96cb127ba318d96b4f5&quot;</span></span><br><span class="line">p1y = <span class="string">&quot;ab1bbde72e7d1ef42e0c9d18d44a10e7250a0dfea98194f2d8d591b355fc636&quot;</span></span><br><span class="line">q1x = <span class="string">&quot;bc44ec67a42c1613d9cf99f7bd2d1d859ab94823ba6cfb1836e8083e23bbd41e&quot;</span></span><br><span class="line">q1y = <span class="string">&quot;faef1f853c095d6de79ba9ad9a2026d742042116b38b1c672ae67c7c7e9e762d&quot;</span></span><br><span class="line">r1 = <span class="string">&quot;bc44ec67a42c1613d9cf99f7bd2d1d859ab94823ba6cfb1836e8083e23bbd41e&quot;</span></span><br><span class="line">s1 = <span class="string">&quot;6c1bfef8bacf4f9c8bc4703c66458715475e50d17ba84f666372b4f4c364e16f&quot;</span></span><br><span class="line">r = <span class="string">&quot;C987C22813DD2D0537433FF583C84B047E0313DCA072E187ACBB5A638D4E2BC0&quot;</span></span><br><span class="line">s2 = <span class="string">&quot;E1E08110628EEB528DC26AA117AFEF8613B1D22EBFD77A9F42524CEFEB57F676&quot;</span></span><br><span class="line">s3 = <span class="string">&quot;758CBCCFADFB5078DB26DF382A179C9AFDE1D0617D92EC5496F67380162235B6&quot;</span></span><br><span class="line"></span><br><span class="line">tt = [e,p1x,p1y,q1x,q1y,r1,s1,r,s2,s3]</span><br><span class="line">e,p1x,p1y,q1x,q1y,r1,s1,r,s2,s3 = [<span class="built_in">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> tt]</span><br><span class="line">P1 = E(p1x,p1y)</span><br><span class="line">Q1 = E(q1x,q1y)</span><br><span class="line">u1 = e * inverse(s1, n) % n</span><br><span class="line">u2 = r1 * inverse(s1, n) % n</span><br><span class="line">T = u1*G + u2*P1</span><br><span class="line">x_, y_ = T.xy()</span><br><span class="line"><span class="keyword">assert</span> r1 == x_</span><br><span class="line">x1 = r - e</span><br><span class="line"></span><br><span class="line">d2 = (s3-s2)*inverse(r,n) % n</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(d2))</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag2&#123;a61bdbacbad62b141284a6955b14a27df01c09984e23785ec75b5e5c79e18f62&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="flag3-500-pts"><a href="#flag3-500-pts" class="headerlink" title="flag3(500 pts)"></a>flag3(500 pts)</h3><p>题目：</p>
<p>login.go：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controllers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/pem&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	jwtgo <span class="string">&quot;github.com/dgrijalva/jwt-go&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm2&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/x509&quot;</span></span><br><span class="line">	<span class="string">&quot;http_svr/config&quot;</span></span><br><span class="line">	<span class="string">&quot;http_svr/models&quot;</span></span><br><span class="line">	<span class="string">&quot;http_svr/utils&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载证书</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadCertificate</span><span class="params">(certPEM <span class="type">string</span>)</span></span> (*x509.Certificate, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">//certPEM := &quot;-----BEGIN CERTIFICATE-----\nMIIBQDCB6KADAgECAgECMAoGCCqBHM9VAYN1MBIxEDAOBgNVBAoTB1Jvb3QgQ0Ew\nHhcNMjQwNzI0MDkyMTI5WhcNMjUwNzI0MDkyMTI5WjAaMRgwFgYDVQQKEw9NeSBP\ncmdhbml6YXRpb24wWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAASlPepwTvt5c4rF\nEsg1Mqs+Tyx/BwRkwyWqDyZd/gBFKp7veuoZnGK11c24xPOqR/eQZNW7ugsZW6eb\nLyXSsE9ooycwJTAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEw\nCgYIKoEcz1UBg3UDRwAwRAIgG4/snkgUCW819OotUWUfMOo0BzHX8KeTTUSLpIjy\nEO4CIEq6X7h3nVNeFzdtLWdy5+1MeNwsWawHU5YzITsNtqOe\n-----END CERTIFICATE-----\n&quot;</span></span><br><span class="line">	block, _ := pem.Decode([]<span class="type">byte</span>(certPEM))</span><br><span class="line">	<span class="keyword">if</span> block == <span class="literal">nil</span> || block.Type != <span class="string">&quot;CERTIFICATE&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;无效的证书格式&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> x509.ParseCertificate(block.Bytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证证书</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validateCertificate</span><span class="params">(cert *x509.Certificate, rootCert *x509.Certificate)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 检查颁发者</span></span><br><span class="line">	<span class="keyword">if</span> cert.Issuer.CommonName != rootCert.Subject.CommonName &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 检查颁发者组织</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cert.Issuer.Organization) != <span class="number">1</span> || cert.Issuer.Organization[<span class="number">0</span>] != rootCert.Subject.Organization[<span class="number">0</span>] &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 检查颁发者国家</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cert.Issuer.Country) != <span class="number">1</span> || cert.Issuer.Country[<span class="number">0</span>] != rootCert.Subject.Country[<span class="number">0</span>] &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查有效日期</span></span><br><span class="line">	<span class="keyword">if</span> time.Now().Before(cert.NotBefore) || time.Now().After(cert.NotAfter) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查组织</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cert.Subject.Organization) != <span class="number">1</span> || cert.Subject.Organization[<span class="number">0</span>] != <span class="string">&quot;ShangMiBei&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查组织单元</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cert.Subject.OrganizationalUnit) != <span class="number">1</span> || cert.Subject.OrganizationalUnit[<span class="number">0</span>] != <span class="string">&quot;ShangMiBei2024&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查国家</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cert.Subject.Country) != <span class="number">1</span> || cert.Subject.Country[<span class="number">0</span>] != <span class="string">&quot;CN&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书校验失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建证书链</span></span><br><span class="line">	roots := x509.NewCertPool()</span><br><span class="line">	roots.AddCert(rootCert)</span><br><span class="line"></span><br><span class="line">	opts := x509.VerifyOptions&#123;</span><br><span class="line">		Roots:       roots,</span><br><span class="line">		CurrentTime: time.Now(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 验证证书链</span></span><br><span class="line">	<span class="keyword">if</span> _, err := cert.Verify(opts); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;证书链校验失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SM2Signature <span class="keyword">struct</span> &#123;</span><br><span class="line">	R, S *big.Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证签名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validateSignature</span><span class="params">(message, signature <span class="type">string</span>, publicKey *sm2.PublicKey)</span></span> (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">//rawSignatureHex, err := base64.StdEncoding.DecodeString(base64EncodedSignature)</span></span><br><span class="line">	hexSignature, err := hex.DecodeString(signature)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;invalid signature format&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	isValid := publicKey.Verify([]<span class="type">byte</span>(message), hexSignature)</span><br><span class="line">	<span class="keyword">if</span> isValid &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;signature is invalid&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Login 登录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Login</span><span class="params">(c *gin.Context, conf config.Config)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析请求参数</span></span><br><span class="line">	<span class="keyword">var</span> req models.LoginReq</span><br><span class="line">	<span class="keyword">if</span> err := c.ShouldBind(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验用户名是否已注册过</span></span><br><span class="line">	<span class="keyword">if</span> _, exists := models.Users[req.Username]; !exists &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;username not exists&quot;</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验随机字符串是否过期</span></span><br><span class="line">	randomStr, exists := conf.Cache.Get(req.Username)</span><br><span class="line">	<span class="keyword">if</span> !exists &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;random string has expired&quot;</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验证书</span></span><br><span class="line">	cert, err := loadCertificate(req.Cert)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := validateCertificate(cert, models.RootCert); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断是否挑战成功（随机字符串的签名能否用证书中的公钥验签过）</span></span><br><span class="line">	ecdsaPubKey, ok := cert.PublicKey.(*ecdsa.PublicKey)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;public key in cert is not sm2&quot;</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	sm2PubKey := sm2.PublicKey&#123;</span><br><span class="line">		Curve: ecdsaPubKey.Curve,</span><br><span class="line">		X:     ecdsaPubKey.X,</span><br><span class="line">		Y:     ecdsaPubKey.Y,</span><br><span class="line">	&#125;</span><br><span class="line">	isValid, err := validateSignature(randomStr.(<span class="type">string</span>), req.Signature, &amp;sm2PubKey)</span><br><span class="line">	<span class="keyword">if</span> isValid &#123;</span><br><span class="line">		<span class="comment">//c.JSON(http.StatusOK, gin.H&#123;&quot;msg&quot;: &quot;success&quot;, &quot;flag3&quot;: config.Flag3, &quot;download_url&quot;: config.DownloadUrl&#125;)</span></span><br><span class="line">		generateToken2(c, req.Username, conf)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成令牌</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateToken2</span><span class="params">(c *gin.Context, username <span class="type">string</span>, conf config.Config)</span></span> &#123;</span><br><span class="line">	j := &amp;utils.JWT&#123;</span><br><span class="line">		SigningKey: []<span class="type">byte</span>(conf.SignKey),</span><br><span class="line">	&#125;</span><br><span class="line">	claims := utils.CustomClaims&#123;</span><br><span class="line">		Name: username,</span><br><span class="line">		StandardClaims: jwtgo.StandardClaims&#123;</span><br><span class="line">			NotBefore: time.Now().Unix() - conf.NotBeforeTime, <span class="comment">// 签名生效时间</span></span><br><span class="line">			ExpiresAt: time.Now().Unix() + conf.ExpiresTime,   <span class="comment">// 过期时间</span></span><br><span class="line">			Issuer:    conf.Issuer,                            <span class="comment">// 签名的发行者</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	token, err := j.CreateToken(claims)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;code&quot;</span>: <span class="number">5091</span>,</span><br><span class="line">			<span class="string">&quot;msg&quot;</span>:  <span class="string">&quot;登录失败，系统有误&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将当前用户对应的缓存中的随机字符串删除</span></span><br><span class="line">	conf.Cache.Delete(username)</span><br><span class="line"></span><br><span class="line">	isAdmin := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">if</span> username == <span class="string">&quot;shangmibeiadmin&quot;</span> &#123;</span><br><span class="line">		isAdmin = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">		<span class="string">&quot;code&quot;</span>:     <span class="number">0</span>,</span><br><span class="line">		<span class="string">&quot;msg&quot;</span>:      <span class="string">&quot;登录成功&quot;</span>,</span><br><span class="line">		<span class="string">&quot;token&quot;</span>:    token,</span><br><span class="line">		<span class="string">&quot;is_admin&quot;</span>: isAdmin,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库管理系统管理员证书.cer：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIICXjCCAgWgAwIBAgIIatKGfgnOvYYwCgYIKoEcz1UBg3UwNjELMAkGA1UEBhMC</span><br><span class="line">Q04xEzARBgNVBAoTClNoYW5nTWlCZWkxEjAQBgNVBAMTCVNoYW5nTWlDQTAeFw0y</span><br><span class="line">NDA4MDUwNzUyMTdaFw0yNTEwMTAxMjAxMDFaMFUxEzARBgNVBAoTClNoYW5nTWlC</span><br><span class="line">ZWkxFzAVBgNVBAsTDlNoYW5nTWlCZWkyMDI0MRgwFgYDVQQDEw9zaGFuZ21pYmVp</span><br><span class="line">YWRtaW4xCzAJBgNVBAYTAkNOMFkwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQgAEiHG2</span><br><span class="line">LM9gsuJXiyo+0yDDZEVP1+3Qh+47g65eMeoUXoi0eUiGPvhehh4RaWacpVrQKJXQ</span><br><span class="line">qzCqkR4n1B+7ZymwXqOB3TCB2jAOBgNVHQ8BAf8EBAMCA4gwHQYDVR0lBBYwFAYI</span><br><span class="line">KwYBBQUHAwIGCCsGAQUFBwMBMA8GA1UdDgQIBAYBAgMEBQYwDwYDVR0jBAgwBoAE</span><br><span class="line">AQIDBDAuBgNVHREEJzAlgQtnaXRAZ2l0LmNvbYcEfwAAAYcQIAFIYAAAIAEAAAAA</span><br><span class="line">AAAAaDBXBgNVHR8EUDBOMCWgI6Ahhh9odHRwOi8vY3JsMS5leGFtcGxlLmNvbS9j</span><br><span class="line">YTEuY3JsMCWgI6Ahhh9odHRwOi8vY3JsMi5leGFtcGxlLmNvbS9jYTEuY3JsMAoG</span><br><span class="line">CCqBHM9VAYN1A0cAMEQCIEU8qEYGqgRTJPGI8YLRrpR7x3M2HzZOt377PwsnivGW</span><br><span class="line">AiA67pgq6qfrhKsWc/B2VUqi2t+ZlK+iAM6D+Ai7NoqYSw==</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>
<p>题目连接上之后有一个简易的网站，由于复现不了所以只能大致描述一下它的功能：</p>
<ul>
<li>有一个登录界面，可以输入用户名、私钥以及公钥文件，如果能通过login.go中的所有check就能成功登录</li>
<li>还有一个注册界面，可以输入用户名和裸公钥，如果裸公钥格式正确，服务器就会用根证书发放一个完整公钥文件给你</li>
</ul>
<p>我们的目标是用“shangmibeiadmin”成功登录，就可以拿到flag3的值以及flag4的源码。</p>
<p>已知的这个证书文件是个公钥文件，查看一下发现这个证书的用户就是“shangmibeiadmin”，所以如果我们能知道他的私钥的话就可以直接登录了。结合这个题只有500分这个事实，我第一反应是私钥相当小，可以直接爆出来，但是用mitm爆了2^50无果，所以只能从其他部分入手。</p>
<p>用gmssl这个工具可以比较轻松的生成一对公私钥证书，我们只需要把公钥里的裸公钥拆出来，然后自己随便生成个用户名就可以注册一个用户，并得到服务器颁发的公钥证书。</p>
<blockquote>
<p>这里需要注意一下不能直接注册“shangmibeiadmin”，它会显示已注册</p>
</blockquote>
<p>然后查看login.go可以发现他似乎根本没检验证书持有者是不是和用户名一样，所以按理来说接下来的步骤很简单，我们只需要在用户名一栏输入“shangmibeiadmin”，然后输入刚才我们生成的公私钥证书中的私钥，再输入刚才服务器下发的证书就可以成功登录。</p>
<p>然而我们实在是不熟悉gmssl乃至openssl这些工具，并且不出网，不能自由查找怎么使用，所以只能一直用help来看有什么参数可以用。我们遇到的最大问题是：gmssl必须要一个密码，才能生成sm2私钥文件，而这个私钥文件是用这个密码加密过的，但是我们怎么找都找不到怎么解密这个私钥文件并解析他。</p>
<p>这里花了很长很长时间，最后离比赛结束不到一小时的时候想了一个笨办法出来——直接去源码c文件里面加几行打印私钥d的文件，并重新编译一下再用这个工具：</p>
<p><img src="/post/6452f9a0/image-20240906160617551.png" alt="image-20240906160617551"></p>
<p>这个方法很笨但是确实有效，由于脑子有点混乱，也想不太清楚d具体该怎么拼，就用从前往后和从后往前两种顺序得到两个d，并用是否满足P=dG这个式子来进行核验，最后好歹是把自己生成的私钥d搞出来了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">a = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>, <span class="number">16</span>)</span><br><span class="line">b = <span class="built_in">int</span>(<span class="string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>, <span class="number">16</span>)</span><br><span class="line">p = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>, <span class="number">16</span>)</span><br><span class="line">n = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>, <span class="number">16</span>)</span><br><span class="line">x = <span class="built_in">int</span>(<span class="string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>, <span class="number">16</span>)</span><br><span class="line">y = <span class="built_in">int</span>(<span class="string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(Zmod(p),[a,b])</span><br><span class="line">G = E(x,y)</span><br><span class="line"></span><br><span class="line">t = <span class="string">&quot;3059301306072a8648ce3d020106082a811ccf5501822d03420004ed7a7dce0e4e2e4b779f76b4ec407b8987ba5c3beba5cd454604e587fce0a17160b29510b2beb36e36470fba3ed6bd436049a0b588e931c71df6cf0b0d0e6407&quot;</span></span><br><span class="line">x1 = <span class="built_in">int</span>(t[-<span class="number">128</span>:-<span class="number">64</span>], <span class="number">16</span>)</span><br><span class="line">y1 = <span class="built_in">int</span>(t[-<span class="number">64</span>:], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">P = E(x1,y1)</span><br><span class="line"></span><br><span class="line">dd = [<span class="number">12437958772606967559</span>,<span class="number">9879664919779981675</span>,<span class="number">172814172046494727</span>,<span class="number">15816591967453487196</span>]</span><br><span class="line"></span><br><span class="line">d = (dd[<span class="number">3</span>] &lt;&lt; (<span class="number">64</span>*<span class="number">3</span>)) + (dd[<span class="number">2</span>] &lt;&lt; (<span class="number">64</span>*<span class="number">2</span>)) + (dd[<span class="number">1</span>] &lt;&lt; (<span class="number">64</span>*<span class="number">1</span>)) + (dd[<span class="number">0</span>] &lt;&lt; (<span class="number">64</span>*<span class="number">0</span>))</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(d))</span><br><span class="line"><span class="built_in">print</span>(d*G == P)</span><br></pre></td></tr></table></figure>
<p>之后按刚才的方式就可以登录上网站拿到flag3以及flag4的源码。</p>
<p><br></p>
<p><br></p>
<h3 id="flag4-1000-pts"><a href="#flag4-1000-pts" class="headerlink" title="flag4(1000 pts)"></a>flag4(1000 pts)</h3><p>题目：</p>
<p>SM4加密解密代码.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmssl.sm4 <span class="keyword">import</span> CryptSM4, SM4_ENCRYPT, SM4_DECRYPT</span><br><span class="line"></span><br><span class="line">MULTIPLIER = <span class="number">6364136223846793005</span></span><br><span class="line">ADDEND = <span class="number">1</span></span><br><span class="line">MASK = <span class="number">0xffffffffffffffff</span></span><br><span class="line">ITERATIONS = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从文件中读取seed</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_seed</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        seed = <span class="built_in">int</span>(file.read().strip(), <span class="number">16</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;seed:&quot;</span>, <span class="built_in">hex</span>(seed))</span><br><span class="line">    <span class="keyword">return</span> seed</span><br><span class="line"></span><br><span class="line">global_seed = read_seed(<span class="string">&#x27;seed.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genRandom</span>():</span><br><span class="line">    <span class="keyword">global</span> global_seed</span><br><span class="line">    <span class="comment"># print(&quot;global_seed&quot;, hex(global_seed))</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ITERATIONS):</span><br><span class="line">        global_seed = (global_seed * MULTIPLIER + ADDEND) &amp; MASK</span><br><span class="line">    <span class="keyword">return</span> (global_seed &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16进制字符串转bytes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HexStringToBytes</span>(<span class="params">hex_str</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(hex_str)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bytes转16进制字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">BytesToHexString</span>(<span class="params">byte_seq</span>):</span><br><span class="line">    <span class="keyword">return</span> byte_seq.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genSM4KeyOrIV</span>():</span><br><span class="line">    <span class="keyword">return</span> HexStringToBytes(<span class="string">&#x27;&#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;genRandom():08x&#125;</span>&#x27;</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM4Encrypt</span>(<span class="params">data_bytes, key_bytes, iv_bytes</span>):</span><br><span class="line">    sm4 = CryptSM4()</span><br><span class="line">    sm4.set_key(key_bytes, SM4_ENCRYPT)</span><br><span class="line">    <span class="keyword">return</span> sm4.crypt_cbc(iv_bytes, data_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM4Decrypt</span>(<span class="params">cipher_bytes, key_bytes, iv_bytes</span>):</span><br><span class="line">    sm4 = CryptSM4()</span><br><span class="line">    sm4.set_key(key_bytes, SM4_DECRYPT)</span><br><span class="line">    <span class="keyword">return</span> sm4.crypt_cbc(iv_bytes, cipher_bytes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;############ SM4 Cryptographic Services Start... ###################&quot;</span>)</span><br><span class="line"></span><br><span class="line">iv_bytes = genSM4KeyOrIV()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;iv hex:&quot;</span>, BytesToHexString(iv_bytes))</span><br><span class="line"></span><br><span class="line">key_bytes = genSM4KeyOrIV()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;key hex:&quot;</span>, BytesToHexString(key_bytes))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从test.pcapng读取数据并加密</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;test.pcapng&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">    plain1_bytes = f1.read()</span><br><span class="line">    cipher1_bytes = SM4Encrypt(plain1_bytes,key_bytes,iv_bytes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写密文数据到cipherText.dat</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;cipherText.dat&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f2:</span><br><span class="line">    f2.write(cipher1_bytes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从cipherText.dat读密文数据</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;cipherText.dat&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f3:</span><br><span class="line">    cipher2_bytes = f3.read()</span><br><span class="line">    plain2_bytes = SM4Decrypt(cipher2_bytes,key_bytes,iv_bytes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密密文并将明文写入到plainText.pcapng(含flag4)</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;plainText.pcapng&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f4:</span><br><span class="line">    f4.write(plain2_bytes)</span><br></pre></td></tr></table></figure>
<p>总经理协同签名流量包加密使用的iv.txt：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">90fc5cf2e2f47488a257fd51e0ae615b</span><br></pre></td></tr></table></figure>
<p>终于是一个python加密了，倍感亲切。题目主要流程是：</p>
<ul>
<li>读取seed.txt文件得到初始seed</li>
<li>用genSM4KeyOrIV函数连续生成16字节的iv和key</li>
<li>读取一个流量包文件，并用iv、key对流量包文件进行SM4加密</li>
<li>给出密文文件以及iv，要求还原流量包</li>
</ul>
<p>有古怪的地方只可能在genSM4KeyOrIV函数里，查看一下发现其是连续调用四次genRandom函数并拼接而成，而genRandom函数是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">genRandom</span>():</span><br><span class="line">    <span class="keyword">global</span> global_seed</span><br><span class="line">    <span class="comment"># print(&quot;global_seed&quot;, hex(global_seed))</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ITERATIONS):</span><br><span class="line">        global_seed = (global_seed * MULTIPLIER + ADDEND) &amp; MASK</span><br><span class="line">    <span class="keyword">return</span> (global_seed &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffffffff</span></span><br></pre></td></tr></table></figure>
<p>可以看出这是一个LCG过程，其会返回seed迭代一千次之后的高32位。</p>
<p>我们知道IV，也就是我们知道连续四次迭代一千次之后的seed高位，这就变成了一个简单的HNP问题。由于LCG迭代过程可以写为如下矩阵乘法：</p>
<script type="math/tex; mode=display">
\left(\begin{matrix}
a&b\\
0&1
\end{matrix}\right)
\left(\begin{matrix}
x_i\\1
\end{matrix}\right)
=
\left(\begin{matrix}
x_{i+1}\\1
\end{matrix}\right)</script><p>所以一千次迭代也就是：</p>
<script type="math/tex; mode=display">
\left(\begin{matrix}
a&b\\
0&1
\end{matrix}\right)^{1000}
\left(\begin{matrix}
x_0\\1
\end{matrix}\right)
=
\left(\begin{matrix}
x_{1000}\\1
\end{matrix}\right)</script><p>对于题目来说是已知高32位，那么以IV的第一个分组和第二个分组为例，式子就可以写成：</p>
<script type="math/tex; mode=display">
\left(\begin{matrix}
a&b\\
0&1
\end{matrix}\right)^{1000}
\left(\begin{matrix}
2^{32}x_{1h} + x_{1l}\\1
\end{matrix}\right)
=
\left(\begin{matrix}
2^{32}x_{2h} + x_{2l}\\1
\end{matrix}\right)</script><p>所以对IV所有连续的两组用第一行对应的线性等式，就可以把问题转化成规约低32位的HNP问题了，得到所有低位之后就可以向后迭代得到key，从而恢复流量包。</p>
<p>exp：</p>
<p>get xl：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">c = <span class="string">&quot;90fc5cf2e2f47488a257fd51e0ae615b&quot;</span></span><br><span class="line"></span><br><span class="line">MULTIPLIER = <span class="number">6364136223846793005</span></span><br><span class="line">ADDEND = <span class="number">1</span></span><br><span class="line">MASK = <span class="number">0xffffffffffffffff</span> + <span class="number">1</span></span><br><span class="line">ITERATIONS = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">t1,t2,t3,t4 = c[:<span class="number">8</span>],c[<span class="number">8</span>:<span class="number">16</span>],c[<span class="number">16</span>:<span class="number">24</span>],c[<span class="number">24</span>:<span class="number">32</span>]</span><br><span class="line">res = [t1,t2,t3,t4]</span><br><span class="line">t = [<span class="built_in">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> res]</span><br><span class="line"></span><br><span class="line"><span class="comment">################################################## </span></span><br><span class="line">M = Matrix(Zmod(MASK),[</span><br><span class="line">    [MULTIPLIER,<span class="number">1</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">])</span><br><span class="line">Mn = M^ITERATIONS</span><br><span class="line">a,b = Mn[<span class="number">0</span>]</span><br><span class="line">a,b = <span class="built_in">int</span>(a),<span class="built_in">int</span>(b)</span><br><span class="line"></span><br><span class="line">nums = <span class="number">4</span></span><br><span class="line">L = Matrix(ZZ,<span class="number">2</span>*nums,<span class="number">2</span>*nums)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nums+<span class="number">1</span>):</span><br><span class="line">    L[i,i] = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nums-<span class="number">1</span>):</span><br><span class="line">    L[i,nums+i+<span class="number">1</span>] = a</span><br><span class="line">    L[i+<span class="number">1</span>,nums+i+<span class="number">1</span>] = -<span class="number">1</span></span><br><span class="line">    c = a*<span class="number">2</span>^<span class="number">32</span>*t[i] - <span class="number">2</span>^<span class="number">32</span>*t[i+<span class="number">1</span>] + b</span><br><span class="line">    L[nums,nums+i+<span class="number">1</span>] = c</span><br><span class="line">L[nums,nums] = <span class="number">2</span>^<span class="number">32</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nums-<span class="number">1</span>):</span><br><span class="line">    L[-i-<span class="number">1</span>,-i-<span class="number">1</span>] = MASK</span><br><span class="line">L[:,-(nums-<span class="number">1</span>):] *= MASK</span><br><span class="line"></span><br><span class="line">res = L.LLL()[<span class="number">0</span>][:<span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<p>decrypt：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmssl.sm4 <span class="keyword">import</span> CryptSM4, SM4_ENCRYPT, SM4_DECRYPT</span><br><span class="line"></span><br><span class="line">MULTIPLIER = <span class="number">6364136223846793005</span></span><br><span class="line">ADDEND = <span class="number">1</span></span><br><span class="line">MASK = <span class="number">0xffffffffffffffff</span></span><br><span class="line">ITERATIONS = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">global_seed = <span class="number">0</span> <span class="comment"># TODO</span></span><br><span class="line">iv_high = <span class="number">0xe0ae615b</span></span><br><span class="line">iv_low = <span class="number">187714221</span></span><br><span class="line">iv_last = (iv_high &lt;&lt; <span class="number">32</span>) + iv_low</span><br><span class="line">global_seed = iv_last</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genRandom</span>():</span><br><span class="line">    <span class="keyword">global</span> global_seed</span><br><span class="line">    <span class="comment"># print(&quot;global_seed&quot;, hex(global_seed))</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ITERATIONS):</span><br><span class="line">        global_seed = (global_seed * MULTIPLIER + ADDEND) &amp; MASK</span><br><span class="line">    <span class="keyword">return</span> (global_seed &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16进制字符串转bytes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HexStringToBytes</span>(<span class="params">hex_str</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(hex_str)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bytes转16进制字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">BytesToHexString</span>(<span class="params">byte_seq</span>):</span><br><span class="line">    <span class="keyword">return</span> byte_seq.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genSM4KeyOrIV</span>():</span><br><span class="line">    <span class="keyword">return</span> HexStringToBytes(<span class="string">&#x27;&#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;genRandom():08x&#125;</span>&#x27;</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM4Encrypt</span>(<span class="params">data_bytes, key_bytes, iv_bytes</span>):</span><br><span class="line">    sm4 = CryptSM4()</span><br><span class="line">    sm4.set_key(key_bytes, SM4_ENCRYPT)</span><br><span class="line">    <span class="keyword">return</span> sm4.crypt_cbc(iv_bytes, data_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM4Decrypt</span>(<span class="params">cipher_bytes, key_bytes, iv_bytes</span>):</span><br><span class="line">    sm4 = CryptSM4()</span><br><span class="line">    sm4.set_key(key_bytes, SM4_DECRYPT)</span><br><span class="line">    <span class="keyword">return</span> sm4.crypt_cbc(iv_bytes, cipher_bytes)</span><br><span class="line"></span><br><span class="line">iv_bytes = HexStringToBytes(<span class="string">&quot;90fc5cf2e2f47488a257fd51e0ae615b&quot;</span>)</span><br><span class="line">key_bytes = genSM4KeyOrIV()</span><br><span class="line"><span class="built_in">print</span>(key_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;总经理协同签名流量包（加密后的文件）.dat&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    cipher_bytes = fp.read()</span><br><span class="line">    plain_bytes = SM4Decrypt(cipher_bytes, key_bytes, iv_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;plainText.pcapng&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    fp.write(plain_bytes)</span><br></pre></td></tr></table></figure>
<p>然后就可以在流量包里找到flag4。</p>
<p><br></p>
<p><br></p>
<h3 id="最终挑战"><a href="#最终挑战" class="headerlink" title="最终挑战 *"></a>最终挑战 *</h3><p>在比赛还是不到半分钟的时候，我们队才惊险地交上flag4，完全没有时间看最终挑战了，因此只能赛后复现一下。</p>
<p>flag4的流量包跟踪TCP流，可以看到里面有以下内容：</p>
<p><img src="/post/6452f9a0/image-20240906162944644.png" alt="image-20240906162944644"></p>
<p>除了flag4外，剩下的数据很显然是和flag2的协同签名有关的，而相比于flag2来说，这里多给了一个client_sign字段的值，再回头看看.js文件可以发现这是clientSign2函数的返回值，其流程为：</p>
<ul>
<li><p>在clientSign1的过程里会生成一个随机数k1，满足：</p>
<script type="math/tex; mode=display">
Q_1 = k_1G = (x,y)</script><script type="math/tex; mode=display">
r_1 = x</script><script type="math/tex; mode=display">
s_1 = k_1^{-1}(e + d_1^{-1}r_1)</script></li>
<li><p>传入未知的用户私钥d1，以及已知的s2、s3、r</p>
</li>
<li><p>计算s：</p>
<script type="math/tex; mode=display">
s = d_1k_1s_2 + d_1s_3 -r</script></li>
</ul>
<p>可以看出s1、s的生成等式其实分别就是关于d1、k1的两个变量的方程，所以就可以解出d1了。而我们的目的是伪造一个签名，解出d1之后走一遍协同签名的流程就好了，自然也就没有难度。</p>
<blockquote>
<p>没有交互部分了，但可以用d1联系的两个点来检验d1的正确性</p>
</blockquote>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">a = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>, <span class="number">16</span>)</span><br><span class="line">b = <span class="built_in">int</span>(<span class="string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>, <span class="number">16</span>)</span><br><span class="line">p = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>, <span class="number">16</span>)</span><br><span class="line">n = <span class="built_in">int</span>(<span class="string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>, <span class="number">16</span>)</span><br><span class="line">x = <span class="built_in">int</span>(<span class="string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>, <span class="number">16</span>)</span><br><span class="line">y = <span class="built_in">int</span>(<span class="string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(Zmod(p),[a,b])</span><br><span class="line">G = E(x,y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################# res</span></span><br><span class="line">q1x = <span class="string">&quot;125fd6eb66351ca49073a6e55be1fa40cfd6662f80452a6bcea3b25bd69b6b26&quot;</span></span><br><span class="line">q1y = <span class="string">&quot;79a9748598cc2886b09fa856b9806b8789b8a719f6a969e2f08da35ea997bc5d&quot;</span></span><br><span class="line">e = <span class="string">&quot;eaf0adee014bd35a12180bbc99292e3acf895203aa97f8dbbb760da04da844f6&quot;</span></span><br><span class="line">r1 = <span class="string">&quot;125fd6eb66351ca49073a6e55be1fa40cfd6662f80452a6bcea3b25bd69b6b26&quot;</span></span><br><span class="line">s1 = <span class="string">&quot;47baaef61c7a3c4c239fc2634ec25a2059d937026c6e0b72df1463fbba5b3a05&quot;</span></span><br><span class="line">p1x = <span class="string">&quot;4c84b1cf8e9255c9385c07c2bf3426a9497d49e2b33c328ab02c4aed8b021bad&quot;</span></span><br><span class="line">p1y = <span class="string">&quot;8a3e40da9d3423f27be30eebb2e4e11999e565be0def197fe1bcf4f6b724b471&quot;</span></span><br><span class="line"></span><br><span class="line">r = <span class="string">&quot;8A6BB033033E79683E81FE36D6394262D451A3DB9D1A0C489D51543D22E67BC4&quot;</span></span><br><span class="line">s2 = <span class="string">&quot;B54A6668F644EC08D925552D45F66E348762B460693E7A68CBB0FDF38327DB45&quot;</span></span><br><span class="line">s3 = <span class="string">&quot;B50FAE013594F79192898FF7FC0A84D931B1EC56EF9174159023ACF1C708180D&quot;</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;cb524f49515c9a7387210ddcdbf1f32aad1c8806f01a362c62a5d6a5466da158&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tt = [e,p1x,p1y,q1x,q1y,r1,s1,r,s2,s3,s]</span><br><span class="line">e,p1x,p1y,q1x,q1y,r1,s1,r,s2,s3,s = [<span class="built_in">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> tt]</span><br><span class="line">P1 = E(p1x,p1y)</span><br><span class="line">Q1 = E(q1x,q1y)</span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################# solve d1</span></span><br><span class="line">PR.&lt;k1,d1&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f1 = (s1*k1 - e)*d1 - r1</span><br><span class="line">f2 = d1*k1*s2 + d1*s3 - r - s</span><br><span class="line">res = f1.sylvester_matrix(f2, k1).det().univariate_polynomial().monic().roots()</span><br><span class="line">d1 = <span class="built_in">int</span>(res[<span class="number">1</span>][<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d1*P1 == G)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>熵密杯总共进行6小时，从上午10点打到下午16点，最终是拿到第九名，得了个二等奖。这次参赛让我认为这个比赛最鲜明的几个特点是：</p>
<ul>
<li>最终求解题目用到的核心思路很简单</li>
<li>主要难度在于审代码、运用工具、编写代码，而不出网会极大幅度的提升这几个步骤的难度</li>
</ul>
<p>不出网带来的不便利是非常非常巨大的：</p>
<ul>
<li>平时对于不熟悉的语言，结合gpt之类的工具可以快速理清楚大意，甚至直接找到一些不合理的洞。但是赛中只能自己一点点慢慢读去找不对劲的地方。</li>
<li>没有提前准备一些工具是很麻烦的，比如初始谜题二的哈希长度扩展攻击，虽然说没有也可以搓一个，但是比起直接准备了工具去做肯定是很不占优；再比如gmssl这个库，要是准备了对好些题都有帮助。</li>
<li>用工具遇到问题没办法及时上网搜，这个问题最突出，以下是好些例子：</li>
<li><ul>
<li>不知道证书格式，只能读一下提前准备好的sm2签名流程，然后base64解码，并连蒙带猜手动按十六进制一点点拆出来点坐标、颁发方之类的字段</li>
<li>不知道怎么用gmssl、openssl去生成一对能够解析的公私钥对，很难想象我们在有这两个工具的情况下怎么都解析不了自己生成的加密私钥证书，最后还是在源码里加东西重新编译才解决的。</li>
</ul>
</li>
<li>一些平时用gpt秒生成的代码只能手写，比如flag1的解密代码以及多进程。</li>
</ul>
<p>我们前面的题目做的还是相当顺利，虽然由于分工的问题，一个血都没有抢到，但是依然保持住了一段时间的前五。然而这个证书题让我们队直接尬住了，从午饭时候差不多就开始，一直到三点半才解决。解决掉之后拿到flag4的源码，匆匆忙忙做的时候还把格造错了，差点没交上flag。</p>
<p>如果熟悉工具使用的话，就算只多剩个二十分钟出来，我都还是挺有信心把最终挑战给完成的——但是事实就是连个半分钟都没给我剩下，还是有一点点可惜吧。</p>
<blockquote>
<p>不过还是比预想的好了很多，因为看昨年的wp觉得Crypto味似乎不是很浓，并且必须做完一道才能开新题，所以担心太偏misc或者web了自己会做不太动，实际体验下来感觉也还好，虽然Crypto味确实也不算很浓就是了XD</p>
</blockquote>
<p><br></p>
<p><br></p>
<h2 id="游记"><a href="#游记" class="headerlink" title="游记"></a>游记</h2><p>线下赛的机会很难得，而且这次9.2就出发来银川了，9.6才离开，玩了算比较久，所以当然也要写篇游记才行。</p>
<h3 id="9-2"><a href="#9-2" class="headerlink" title="9.2"></a>9.2</h3><p>由于主办方只报销火车的二等座的票钱，否则都需要补差价，所以我和学长学弟一合计——既然包差旅，就最好一分钱都不自己出吧！就这样我们往返都选了高铁票。不过上海到银川实在有点远，所以也意味着我们要花接近24h的时间在赶路上了：</p>
<p><img src="/post/6452f9a0/a2baae1dbad9c793f325597bc62f6ddd.jpg" alt="img"></p>
<p><img src="/post/6452f9a0/fbdd13f0b84d64ab230b65c3b3d12580.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">铁辟鼓</center>

<p>9.2号早上九点从学校出发去虹桥坐高铁，上高铁之前空白在呼叫去打BlackHat，所以本来是想在车上睡一睡的，但现在就只能开电脑研究下那个剩下来的题目了。</p>
<p>然而上了高铁找到座位发现是第一排，而且是那种小桌板都没对齐的第一排，压根就没有地方放电脑：</p>
<p><img src="/post/6452f9a0/image-20240906221715709.png" alt="image-20240906221715709"></p>
<p>但打还是得打啊，问了问似乎也在做这题的rec，他让我上notion先同步一下进度，但是因为不好开电脑，就只能手机下个notion看题目了。</p>
<p>再问一问rec发现他也在火车上，只是在赶回南京XD。我们两个就在那里拿着个手机没纸没笔地硬看题目，能开电脑做的似乎就只有一个想要LLL 2049x2049矩阵的越南老哥，我和rec提一个思路否定一个思路，也没啥新进展。</p>
<p>比赛18：00结束，rec下午还要开会，我本来就没有新思路，就算有思路也开不了电脑写，所以到结束的时候我们也没搞定这题，有点难受。赛后空白上discord看了看其他老哥的思路，告诉我们这是一篇paper题，那我们两个拿手机的确实没啥办法了。</p>
<p>晚上九点四十多准时下车，一出列车门，马上就感觉到一点点凉意，到酒店办入住的时候发现自己单出来了，而且很巧地和sh1kaku的一个队友分到了一间。</p>
<blockquote>
<p>可能也不能算很巧，因为都在上海(⌒ω⌒)</p>
</blockquote>
<p>酒店虽然也不能说多好，但是比起前些天高校密码挑战赛安排的实在是好了很多倍，让我不得不夸赞。美中不足的地方是空调似乎完全没效果，但是银川这几天的天气本身并不热，所以影响也不大。</p>
<p>到酒店后大家都想休息了，也就各自点外卖吃，没有出门去逛。睡前按照惯例还是和高中同学来了几局无限火力，玩着玩着突然下大雨了，明天一整天只有报道一件事，所以我们三个还想出门逛逛景点之类的，希望这场雨不要影响到我们的出行。</p>
<p><br></p>
<h3 id="9-3"><a href="#9-3" class="headerlink" title="9.3"></a>9.3</h3><p>这个酒店早餐开放时间又早又短，7：00-8：30，对于最近晚睡晚起惯了的我简直是种折磨。本身早饭也没啥胃口，所以没有去尝当地的特色羊杂碎，就喝了碗粥、吃了几瓣苹果之后就没吃了。</p>
<blockquote>
<p>后来Zima尝了下酒店的羊杂碎，说是有点膻，我完全吃不下有膻味的羊肉，幸好没尝</p>
</blockquote>
<p>然后我们去了距离酒店最近的一个知名景点——镇北堡西部影城。其实宁夏在我小学的时候和一大群小学同学一起来玩过一次，沙坡头、沙湖、镇北堡这些出名一点的都来过了，这次算是故地重游。</p>
<p>昨晚下的雨应该早就停了，但是多少还是影响了道路状况，对于这个黄沙漫过的土地来说多了很多需要绕着走的泥泞。一路上有很多电影介绍+剧照，但是我在观影方面实在太小资历了，确实没看过几部，所以也就认得出大话西游的一些场景，剩下的就只有拍拍拍了：</p>
<p><img src="/post/6452f9a0/e30d63b57974059d2e4dbbc01080ea8c.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">实在不知道怎么不背光拍</center>

<p><img src="/post/6452f9a0/a24cbbade1997a5118f4145480f52f44.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">被剑抵喉咙那里</center>

<p><img src="/post/6452f9a0/2b9b84515fdabece93d5fab2ef46e897-1725634979776.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">唐僧受刑台</center>

<p><img src="/post/6452f9a0/e90398f9e18ee521f83babd3fd748ac5.jpg" alt="img"></p>
<p><img src="/post/6452f9a0/519b699be3f243dffa48619ae57b876e.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">大宋弹弓和大宋沙包</center>

<p><img src="/post/6452f9a0/c36118133cc65bc19853af34f64e876c.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">很多骆驼</center>

<p><img src="/post/6452f9a0/1554e9f73d54e9b1dd358e59efab202e-1725635079503.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">应该是人造的白骨</center>

<p><img src="/post/6452f9a0/8dd4f367ba15a45703eb2a87c53fe30e.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">见过最穷的许愿池，加起来有十块钱不XD</center>

<p>然后中午一点左右我们差不多逛完了影视城，然后一起张罗着去酒店旁边一个大广场尝一尝当地特色，到了广场之后我们选了一家之前从来没见过的叫“冰煮羊”的东西吃。</p>
<p>锅里肉块混着冰一起端上来，然后店长拿着4L的农夫山泉往里咕咕倒，倒的差不多了就盖上锅开煮，视觉效果确实很神奇：</p>
<p><img src="/post/6452f9a0/df15f79aa2e0f45d0da0945723d31fd6.jpg" alt="img"></p>
<p><img src="/post/6452f9a0/0f95989624687f52424fd829ac2cd38c.jpg" alt="img"></p>
<p><img src="/post/6452f9a0/db2a5567863700299734daffa714a893.jpg" alt="img"></p>
<p>吃着也确实不错，肉块的口感很奇妙，奇妙到我不知道怎么形容，可能就是和冰一起煮的原因。</p>
<p>吃完之后和Cain一起去上网，我们选了一家离酒店比较近的网吧，去网吧的一路上四面八方都是宁夏大学的校区，里面的小登们正在军训，看着他们军训有一种说不清的感觉，这种感觉让我回想起我高中军训的那段日子，短短七天的回忆比大学半个月的军训回忆却要多很多：</p>
<p><img src="/post/6452f9a0/67ff89742b93a0769e4fc2be6f516384.jpg" alt="img"></p>
<p>三点接近四点的时候，我和Cain到了网吧，网吧是新开的，充30送100，由于晚上还要和NK的师傅们聚餐，所以六点多差不多就要走，所以感觉充30妥妥够了，然后就开始上网，我把号借给了他，自己上了个同学的号：</p>
<p><img src="/post/6452f9a0/2ad7bbfcf0d5d5119812141b1cfb8682.jpg" alt="img"></p>
<p>六点多一点的时候，我和Cain正在玩最后一把无限火力，他小鱼人我奥拉夫。我们把对面杀穿之后去对面泉水前面开始爽钢，对面打Cain压根不掉血，打我没我吸得多。然而，然而，打着打着他的机子突然就没网费，直接下机了。</p>
<p>这么一把爽局怎么能不玩完！所以Cain马上跑去前台续网费。我这边应该还剩一点，所以就继续打，然而过了可能两分钟，在Cain还没充完网费回来的时候，我的网费也没了，当场下机。</p>
<p>Cain续完费火速回来重连，但是连上来过后战场已经从他们的泉水转移到我们的泉水了，虽然打还是打不死他，但是耐不住对面格温小丑直接开偷啊，很快这把就输掉了——新充的网费都还没怎么花呢。细算了一下，充30送100，结果两个小时出头这网费就花干净了，这网费至少得50一个小时吧，有点小坑。</p>
<p><img src="/post/6452f9a0/7f4b5021fa35673a075f4a2f612e18d1.jpg" alt="img"></p>
<p>然后我们就润了，我不会骑电瓶，我们就一个自行车一个电瓶车去火车站晃悠了一圈之后，去一个烩肉餐厅和来熵密杯的NK的师傅们聚餐（此处偷Cain的图）：</p>
<p><img src="/post/6452f9a0/784fbe3a12b5250f27b2029e530f47da.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">都是特色菜，奈何饭量真的不大，吃不太下</center>

<p><img src="/post/6452f9a0/5c3007d103847a1f3b44987ba30deef4.jpg" alt="img"></p>
<center style="font-size:16px;color:#C0C0C0">合照</center>

<p>由于本身现实里不太会说话，所以吃饭的时候就听师傅们聊，听到了不少趣事，甚至还有一些猛料XD。最后还上了一盘手抓羊肉，但是我真的一块都干不下了，遗憾离场。</p>
<p>吃完饭后我们走路回酒店，路上给缺水的sh1kaku他们几个捎了些饮料和水（我今早上把酒店里送的两瓶水全部拿走了(* Ŏ∀Ŏ)），也见到了我的室友。明天就要比赛了，回酒店后和学长学弟一起准备了点明天可能用的脚本、资料和工具，发现确实也不太好急急忙忙的准备出个什么名堂，所以就休息了。</p>
<p><br></p>
<h3 id="9-4"><a href="#9-4" class="headerlink" title="9.4"></a>9.4</h3><p>一早起来发现外面在下雨，出门就感觉到温度也突然变得有点低，对于没带外套的我有点难顶，幸好会场不远，稍微冻几步路就到了。</p>
<p>比赛完全断网，并且要收手机，我们三个也都在紧张比赛，所以没什么特别好记录的，就放一张赛前的现场图吧：</p>
<p><img src="/post/6452f9a0/19630656b752181f5fdb409716505c7f.jpg" alt="img"></p>
<p>下午四点比赛结束，回酒店休息了会儿后和Zima两个人出来吃了个饭，吃的是大盘鸡，我们就点了个中份也超大一盘：</p>
<p><img src="/post/6452f9a0/7aea2ba94b58422550873e7707a57b00.jpg" alt="img"></p>
<p>最后也没吃完，去逛就在旁边的怀远夜市。Zima还能买点羊肉串吃，然而我真的什么都吃不下，只喝了一杯Zima请我的宁夏特色热饮，叫做“牛奶鸡蛋醪糟”，味道对于我来说过于甜了。</p>
<p>七点出头正在逛街的时候发个通知来说拿了二等奖，要七点半赶去宁大一个教学楼彩排颁奖仪式。但是通知这么晚，想也知道大多数队伍都不会太准时，问了问Lvsun他们队去没去，果然是还没去XD。所以我和Zima还是逛完了夜市之后慢慢走着去参加彩排。彩排其实也就是提前熟悉下明天颁奖时侯坐的位置、上的顺序而已，也很快就结束了，我和Zima就回了酒店。</p>
<p>回了酒店想洗漱一下开始无限火力，结果还没坐定Cain就叫我和Zima一起去K歌，听Zima说这里的KTV都是烧烤+KTV一起开的，感觉应该会很新奇就拉着Zima一起去了，到地方发现确实很新奇，可惜真的吃不下：</p>
<p><img src="/post/6452f9a0/af5ae90c009514359a231e01cf4ac720.jpg" alt="img"></p>
<blockquote>
<p>气氛真的很好，开始觉得不太好意思，结果听着听着就想唱歌，就唱了几首歌</p>
</blockquote>
<p><br></p>
<h3 id="9-5"><a href="#9-5" class="headerlink" title="9.5"></a>9.5</h3><p>今天上午就是平平无奇的颁奖仪式：</p>
<p><img src="/post/6452f9a0/9e5e38b1d5d1bc43f7af44ce7b99259e.jpg" alt="img"></p>
<p><img src="/post/6452f9a0/fb286c68275730e5c6b3e82a0ff8963c.jpg" alt="img"></p>
<p><img src="/post/6452f9a0/430461feb6fc2a2f71d282c30940827b.jpg" alt="img"></p>
<p>9：45颁奖仪式就结束了，之后一直到十二点都基本上是一些讲座，好多队早早就跑路了（比如yolbby和Cain），我们队还是一直待到特等奖分享完解题思路才走：</p>
<p><img src="/post/6452f9a0/2c1ba1e940f518ada9115ad4b8ec2f8e.jpg" alt="img"></p>
<p>然后和队友去吃了Zima推荐的一家吴忠麻辣烫，感觉麻酱味有些重，而且有一点甜，不是很适合我：</p>
<p><img src="/post/6452f9a0/38fa428b6cd68e11b27c6695fc7691b1.jpg" alt="img"></p>
<p>下午本来说去沙湖，但是天一直在下雨，外面很冷，我又没带外套，加上沙湖五点就关门，所以作罢，在酒店打无限火力。sh1kaku他们下午走，打到四五点钟的时候告别了他们。</p>
<p>晚饭本来是叫了Zima、yolbby一起吃，结果yolbby要带学弟一起去逛一逛鼓楼，Zima更牛皮，下午直接跑出去和学妹看电影+吃饭，所以晚上随便吃了点之后我就继续无限火力。</p>
<p>第二天早上7：40就发车，所以还要早点休息才好。</p>
<p><br></p>
<h3 id="9-6"><a href="#9-6" class="headerlink" title="9.6"></a>9.6</h3><p>今天踏上归程，不知不觉就正好翘掉了一周的课，幸好大四没啥课。</p>
<p><br></p>
<p><br></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>糖醋小鸡块
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tangcuxiaojikuai.xyz/post/6452f9a0.html" title="2024-熵密杯-wp-crypto">https://tangcuxiaojikuai.xyz/post/6452f9a0.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sacreative/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SACREATIVE</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/eb2541c3.html" rel="prev" title="2024-SEKAICTF-wp-crypto">
      <i class="fa fa-chevron-left"></i> 2024-SEKAICTF-wp-crypto
    </a></div>
      <div class="post-nav-item">
    <a href="/post/9b3c95d4.html" rel="next" title="最近更新">
      最近更新 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%98"><span class="nav-number">1.</span> <span class="nav-text">第一部分：初始谜题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%98%E4%B8%80-300-pts"><span class="nav-number">1.1.</span> <span class="nav-text">初始谜题一(300 pts)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%98%E4%BA%8C-300-pts"><span class="nav-number">1.2.</span> <span class="nav-text">初始谜题二(300 pts)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%98%E4%B8%89-300-pts"><span class="nav-number">1.3.</span> <span class="nav-text">初始谜题三(300 pts)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E5%A4%A7%E5%9E%8B%E5%AF%86%E7%A0%81%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.</span> <span class="nav-text">第二部分：大型密码系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#flag1-600-pts"><span class="nav-number">2.1.</span> <span class="nav-text">flag1(600 pts)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flag2-900-pts"><span class="nav-number">2.2.</span> <span class="nav-text">flag2(900 pts)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flag3-500-pts"><span class="nav-number">2.3.</span> <span class="nav-text">flag3(500 pts)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flag4-1000-pts"><span class="nav-number">2.4.</span> <span class="nav-text">flag4(1000 pts)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E6%8C%91%E6%88%98"><span class="nav-number">2.5.</span> <span class="nav-text">最终挑战 *</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B8%E8%AE%B0"><span class="nav-number">4.</span> <span class="nav-text">游记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2"><span class="nav-number">4.1.</span> <span class="nav-text">9.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3"><span class="nav-number">4.2.</span> <span class="nav-text">9.3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4"><span class="nav-number">4.3.</span> <span class="nav-text">9.4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-5"><span class="nav-number">4.4.</span> <span class="nav-text">9.5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-6"><span class="nav-number">4.5.</span> <span class="nav-text">9.6</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="糖醋小鸡块"
      src="/images/image.png">
  <p class="site-author-name" itemprop="name">糖醋小鸡块</p>
  <div class="site-description" itemprop="description">"追风赶月莫停留，平芜尽处是春山"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/1142381085@qq.com" title="E-Mail → 1142381085@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6394335993" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6394335993" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">糖醋小鸡块</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'UPEMA7DyYbIIEyOW72ohgytU-gzGzoHsz',
      appKey     : 'M7rXAfeP3JOslroay2n0Jv2R',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
<!-- 引入jQuery -->
<script type="text/javascript" src="//libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<!-- 雪花特效2 -->
<script type="text/javascript" src="/js/snow2.js"></script>
