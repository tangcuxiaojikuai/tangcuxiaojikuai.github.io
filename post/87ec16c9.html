<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_small.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="RnN18ZogmZl_dLVpxZ6y8kjKL73Mu9VLVEkw9d3qrq0" />
  <meta name="msvalidate.01" content="DC3050AD55F30DDF75AAB78517714910" />
  <meta name="baidu-site-verification" content="codeva-PPofu3dNxe" />

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-loading-bar.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tangcuxiaojikuai.xyz","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="*代表赛中未解出的题目，包含全四道赛题的复现。">
<meta property="og:type" content="article">
<meta property="og:title" content="2023-DASCTF-CBCTF-wp-crypto">
<meta property="og:url" content="https://tangcuxiaojikuai.xyz/post/87ec16c9.html">
<meta property="og:site_name" content="糖醋小鸡块的blog">
<meta property="og:description" content="*代表赛中未解出的题目，包含全四道赛题的复现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/87ec16c9/image-20231023200836792.png">
<meta property="og:image" content="https://tangcuxiaojikuai.xyz/post/87ec16c9/image-20231023200412149.png">
<meta property="article:published_time" content="2023-10-22T02:50:36.000Z">
<meta property="article:modified_time" content="2023-10-24T09:06:48.000Z">
<meta property="article:author" content="糖醋小鸡块">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tangcuxiaojikuai.xyz/post/87ec16c9/image-20231023200836792.png">

<link rel="canonical" href="https://tangcuxiaojikuai.xyz/post/87ec16c9.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>2023-DASCTF-CBCTF-wp-crypto | 糖醋小鸡块的blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">糖醋小鸡块的blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tangcuxiaojikuai.xyz/post/87ec16c9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/image.png">
      <meta itemprop="name" content="糖醋小鸡块">
      <meta itemprop="description" content=""追风赶月莫停留，平芜尽处是春山"">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="糖醋小鸡块的blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2023-DASCTF-CBCTF-wp-crypto
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-22 10:50:36" itemprop="dateCreated datePublished" datetime="2023-10-22T10:50:36+08:00">2023-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-24 17:06:48" itemprop="dateModified" datetime="2023-10-24T17:06:48+08:00">2023-10-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/wp-crypto/" itemprop="url" rel="index"><span itemprop="name">wp-crypto</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/87ec16c9.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/87ec16c9.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>*代表赛中未解出的题目，包含全四道赛题的复现。</p>
<span id="more"></span>
<h3 id="EzRSA"><a href="#EzRSA" class="headerlink" title="EzRSA"></a>EzRSA</h3><p>题目描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">来做简单的RSA啦</span><br></pre></td></tr></table></figure>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">padding</span>(<span class="params">f</span>):</span><br><span class="line">    random_chars = <span class="built_in">bytes</span>([random.randint(<span class="number">0</span>, <span class="number">255</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)])</span><br><span class="line">    f = f + random_chars</span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guess_p</span>(<span class="params">p</span>):</span><br><span class="line">    e = <span class="number">65537</span></span><br><span class="line">    </span><br><span class="line">    P = p</span><br><span class="line">    n1 = getPrime(<span class="number">512</span>)*getPrime(<span class="number">512</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;enc.txt&#x27;</span>, <span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">while</span> jacobi(<span class="number">2</span>,n1) == <span class="number">1</span>:</span><br><span class="line">            n1 = getPrime(<span class="number">512</span>)*getPrime(<span class="number">512</span>)</span><br><span class="line">        <span class="keyword">while</span> P:</span><br><span class="line">            pad = random.randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">2023</span>)**<span class="number">2</span> </span><br><span class="line">            message = pad &lt;&lt; <span class="number">1</span> + P % <span class="number">2</span></span><br><span class="line">            cipher = <span class="built_in">pow</span>(message, e, n1)</span><br><span class="line">            f.write(<span class="built_in">str</span>(cipher)+<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">            P //= <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;n1 = &quot;</span>+ <span class="built_in">str</span>(n1) )    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guess_q</span>(<span class="params">q</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">q, n</span>):</span><br><span class="line">        e = random.randint(<span class="number">1000</span>,<span class="number">2000</span>)</span><br><span class="line">        noise = random.randint(<span class="number">0</span>, n - <span class="number">1</span>)</span><br><span class="line">        c = <span class="built_in">pow</span>(q+noise,e,n)</span><br><span class="line">        <span class="keyword">return</span> e, noise,c </span><br><span class="line">    </span><br><span class="line">    n2 = getPrime(<span class="number">512</span>)*getPrime(<span class="number">512</span>)</span><br><span class="line">    e1, noise1, c1 = encrypt(q, n2)</span><br><span class="line">    e2, noise2, c2 = encrypt(q, n2)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;n2 = &quot;</span>+ <span class="built_in">str</span>(n2) ) </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;(e1, noise1, c1) =&#x27;</span>, (e1,noise1,c1))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;(e2, noise2, c2) =&#x27;</span>, (e2,noise2,c2))</span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">n = p*q</span><br><span class="line">guess_p(p)</span><br><span class="line">guess_q(q)</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">flag = padding(flag)</span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">c = <span class="built_in">pow</span>(m,e,n)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;c = &quot;</span> + <span class="built_in">str</span>(c))</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">n1 = 65634094430927080732256164808833233563732628654160389042977689628512527168256899310662239009610512772020503283842588142453533499954947692968978190310627721338357432052800695091789711809256924541784954080619073213358228083200846540676931341013554634493581962527475555869292091755676130810562421465063412235309</span></span><br><span class="line"><span class="string">n2 = 103670293685965841863872863719573676572683187403862749665555450164387906552249974071743238931253290278574192713467491802940810851806104430306195931179902098180199167945649526235613636163362672777298968943319216325949503045377100235181706964846408396946496139224344270391027205106691880999410424150216806861393</span></span><br><span class="line"><span class="string">(e1, noise1, c1) = (1743, 44560588075773853612820227436439937514195680734214431948441190347878274184937952381785302837541202705212687700521129385632776241537669208088777729355349833215443048466316517110778502508209433792603420158786772339233397583637570006255153020675167597396958251208681121668808253767520416175569161674463861719776, 65643009354198075182587766550521107063140340983433852821580802983736094225036497335607400197479623208915379722646955329855681601551282788854644359967909570360251550766970054185510197999091645907461580987639650262519866292285164258262387411847857812391136042309550813795587776534035784065962779853621152905983)</span></span><br><span class="line"><span class="string">(e2, noise2, c2) = (1325, 35282006599813744140721262875292395887558561517759721467291789696459426702600397172655624765281531167221787036009507833425145071265739486735993631460189629709591456017092661028839951392247601628468621576100035700437892164435424035004463142959219067199451575338270613300215815894328788753564798153516122567683, 50327632090778183759544755226710110702046850880299488259739672542025916422119065179822210884622225945376465802069464782311211031263046593145733701591371950349735709553105217501410716570601397725812709771348772095131473415552527749452347866778401205442409443726952960806789526845194216490544108773715759733714)</span></span><br><span class="line"><span class="string">c = 124349762993424531697403299350944207725577290992189948388824124986066269514204313888980321088629462472088631052329128042837153718129149149661961926557818023704330462282009415874674794190206220980118413541269327644472633791532767765585035518183177197863522573410860341245613331398610013697803459403446614221369</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>本题分为两部分，先要用guess_p求出p、然后用guess_q求出q，之后就可以正常RSA解密得到flag。</p>
<p>其中，q的求解相对容易一点，由guess_q知道：</p>
<script type="math/tex; mode=display">
(q+noise1)^{e1} \equiv c1 \quad(mod\;n2)</script><script type="math/tex; mode=display">
(q+noise2)^{e2} \equiv c2 \quad(mod\;n2)</script><p>将q看作未知数，写作多项式如下：</p>
<script type="math/tex; mode=display">
(x+noise1)^{e1} \equiv c1 \quad(mod\;n2)</script><script type="math/tex; mode=display">
(x+noise2)^{e2} \equiv c2 \quad(mod\;n2)</script><p>那么显然q是两个多项式的公共根，因此两个多项式有公因式(x-q)，求解gcd即可得到(x-q)，进而得到q。</p>
<p>然后就是p的求解。这里用到了雅可比符号，因此需要先了解一下雅可比符号的一些相关概念：</p>
<p><img src="/post/87ec16c9/image-20231023200836792.png" alt="image-20231023200836792"></p>
<p>而其中勒让德符号(a,pi)的作用是判断a是否是模pi下的二次剩余，若勒让德符号值为1则是二次剩余，为-1则是二次非剩余。</p>
<p>而在这个题目中，还需要知道雅可比符号的一个性质：</p>
<ul>
<li>完全积性：</li>
</ul>
<script type="math/tex; mode=display">
(\frac{ab}{p}) = (\frac{a}{p})(\frac{b}{p})</script><p>那么再回头看这个题，首先它保证了：</p>
<script type="math/tex; mode=display">
(\frac{2}{n}) \neq 1</script><p>也就是说值为-1，而由雅可比符号的性质知道：</p>
<script type="math/tex; mode=display">
(\frac{2}{n}) = (\frac{2}{p})(\frac{2}{q}) = -1</script><p>也就是说，2不能同为p、q的二次剩余或二次非剩余，而必须是其中一个的二次剩余，是另一个的二次非剩余。不过本题后续其实没有用到这一点。</p>
<p>再看guess_p中RSA的加密过程(此处要注意优先级，先计算的是加法运算，然后才是移位运算)：</p>
<script type="math/tex; mode=display">
message = pad^2<<(1+ P_{lastbit})</script><script type="math/tex; mode=display">
cipher = message^e \quad(mod\;n1)</script><p>而由雅可比符号的完全积性，我们知道：</p>
<script type="math/tex; mode=display">
(\frac{cipher}{n1}) = (\frac{message}{n1})^e</script><p>而e是一个奇数，因此无论是-1还是1都会维持原值，也就有：</p>
<script type="math/tex; mode=display">
(\frac{cipher}{n1}) = (\frac{message}{n1})^e = (\frac{message}{n1})</script><p>也就是说，我们计算密文的雅可比符号，其实就能得到明文的雅可比符号，这也就是说明RSA语义不安全的其中一点。那么我们有了明文的雅可比符号后，如何得到P的取值呢？</p>
<p>试想，如果P当前位为0，那么就有：</p>
<script type="math/tex; mode=display">
message = pad^2<<1 =2*pad^2</script><script type="math/tex; mode=display">
(\frac{message}{n1}) = (\frac{2*pad^2}{n1}) = (\frac{2}{n1})(\frac{pad^2}{n1}) = -1*(\frac{pad^2}{p1})(\frac{pad^2}{q1})</script><p>显然，pad^2肯定既是p1的二次剩余，也是q1的二次剩余，因此当P的该位为0时，计算出的雅可比符号值为-1</p>
<p>而当P当前位为1时，有如下式：</p>
<script type="math/tex; mode=display">
message = pad^2<<2 =4*pad^2</script><script type="math/tex; mode=display">
(\frac{message}{n1}) = (\frac{4*pad^2}{n1})  = (\frac{4*pad^2}{p1})(\frac{4*pad^2}{q1})=(\frac{4}{p1})(\frac{4}{q1})(\frac{pad^2}{p1})(\frac{pad^2}{q1})</script><p>显然全部都是二次剩余，因此该部分一定是1。所以我们可以把这个作为判断依据来还原P的每一个比特位，还原p、q后就可以解密RSA了。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gcd</span>(<span class="params">g1, g2</span>):</span><br><span class="line">    <span class="keyword">while</span> g2:</span><br><span class="line">        g1, g2 = g2, g1 % g2</span><br><span class="line">    <span class="keyword">return</span> g1.monic()</span><br><span class="line"></span><br><span class="line">n1 = <span class="number">65634094430927080732256164808833233563732628654160389042977689628512527168256899310662239009610512772020503283842588142453533499954947692968978190310627721338357432052800695091789711809256924541784954080619073213358228083200846540676931341013554634493581962527475555869292091755676130810562421465063412235309</span></span><br><span class="line">n2 = <span class="number">103670293685965841863872863719573676572683187403862749665555450164387906552249974071743238931253290278574192713467491802940810851806104430306195931179902098180199167945649526235613636163362672777298968943319216325949503045377100235181706964846408396946496139224344270391027205106691880999410424150216806861393</span></span><br><span class="line">(e1, noise1, c1) = (<span class="number">1743</span>, <span class="number">44560588075773853612820227436439937514195680734214431948441190347878274184937952381785302837541202705212687700521129385632776241537669208088777729355349833215443048466316517110778502508209433792603420158786772339233397583637570006255153020675167597396958251208681121668808253767520416175569161674463861719776</span>, <span class="number">65643009354198075182587766550521107063140340983433852821580802983736094225036497335607400197479623208915379722646955329855681601551282788854644359967909570360251550766970054185510197999091645907461580987639650262519866292285164258262387411847857812391136042309550813795587776534035784065962779853621152905983</span>)</span><br><span class="line">(e2, noise2, c2) = (<span class="number">1325</span>, <span class="number">35282006599813744140721262875292395887558561517759721467291789696459426702600397172655624765281531167221787036009507833425145071265739486735993631460189629709591456017092661028839951392247601628468621576100035700437892164435424035004463142959219067199451575338270613300215815894328788753564798153516122567683</span>, <span class="number">50327632090778183759544755226710110702046850880299488259739672542025916422119065179822210884622225945376465802069464782311211031263046593145733701591371950349735709553105217501410716570601397725812709771348772095131473415552527749452347866778401205442409443726952960806789526845194216490544108773715759733714</span>)</span><br><span class="line">c = <span class="number">124349762993424531697403299350944207725577290992189948388824124986066269514204313888980321088629462472088631052329128042837153718129149149661961926557818023704330462282009415874674794190206220980118413541269327644472633791532767765585035518183177197863522573410860341245613331398610013697803459403446614221369</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#getq</span></span><br><span class="line">PR.&lt;x&gt;=PolynomialRing(Zmod(n2))</span><br><span class="line">g1 = (x+noise1)^e1-c1</span><br><span class="line">g2 = (x+noise2)^e2-c2</span><br><span class="line">q = <span class="built_in">int</span>(-gcd(g1, g2)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;E:\题\CBCTF 2023\crypto\CB_rsa\enc.txt&quot;</span>,<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    c1 = f.read().split(<span class="string">&quot;n&quot;</span>)</span><br><span class="line">tt = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c1)-<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span>(jacobi(<span class="built_in">int</span>(c1[i]),n1) == -<span class="number">1</span>):</span><br><span class="line">        tt += <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tt += <span class="string">&quot;1&quot;</span></span><br><span class="line">p = <span class="built_in">int</span>(tt[::-<span class="number">1</span>],<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">phi = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">d = inverse(<span class="number">65537</span>,phi)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(<span class="built_in">pow</span>(c,d,p*q))))</span><br><span class="line"></span><br><span class="line"><span class="comment">#DASCTF&#123;W05-y03r_m2st1r-j2c0b1_2nd_p01yn0mi2l!&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="CB-backpack"><a href="#CB-backpack" class="headerlink" title="CB backpack"></a>CB backpack</h3><p>题目描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cryptography Based on 8-balanced-backpack</span><br></pre></td></tr></table></figure>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> shuffle</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_e</span>():</span><br><span class="line">    e = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        ee = [<span class="number">0</span>]*<span class="number">3</span>+[<span class="number">1</span>]*<span class="number">3</span></span><br><span class="line">        shuffle(ee)</span><br><span class="line">        e += ee</span><br><span class="line">    <span class="keyword">return</span> e</span><br><span class="line">    </span><br><span class="line">e = gen_e()</span><br><span class="line">nbit = <span class="built_in">len</span>(e)</span><br><span class="line">flag = <span class="string">&#x27;DASCTF&#123;&#x27;</span>+sha256(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> e]).encode()).hexdigest()+<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">a = [randint(<span class="number">1</span>,<span class="number">2</span>^nbit) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nbit)]</span><br><span class="line"></span><br><span class="line">re = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nbit):</span><br><span class="line">    re += e[i]*a[i]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(re)</span><br></pre></td></tr></table></figure>
<p>相较于普通的01背包密码，这一题的背包有一个特别之处，即每六个比特位之和为3。</p>
<p>开始觉得影响好像不大，但是直接上普通背包的LLL会发现规约不出全为0、1的最短向量，因此肯定需要用上这个特别之处来构造格。</p>
<p>先看看普通的背包密码的格是怎么样的：</p>
<script type="math/tex; mode=display">
\left(
 \begin{matrix}
   1 &   &   &   &   &a_{1}\\
     & 1 &   &   &   &a_{2} \\
     &   &...&   &   & ...\\
     &   &   & 1 &   & a_{47} \\
     &   &   &   & 1 & a_{48} \\
     &   &   &   &   &-c  \\
  \end{matrix}
  \right)</script><p>这是因为，这个格具有如下线性关系：</p>
<script type="math/tex; mode=display">
(b_1,b_1,...b_{47},b_{48},1)*
\left(
 \begin{matrix}
   1 &   &   &   &   &a_{1}\\
     & 1 &   &   &   &a_{2} \\
     &   &...&   &   & ...\\
     &   &   & 1 &   & a_{47} \\
     &   &   &   & 1 & a_{48} \\
     &   &   &   &   &-c  \\
  \end{matrix}
  \right)
  =
  (b_1,b_1,...b_{47},b_{48},0)</script><p>而由于有每六个的和为3，所以可以尝试扩充八列格，如下：</p>
<script type="math/tex; mode=display">
\left(
 \begin{matrix}
   1 &   &   &   &   &a_{1} & 1 &   &   \\
     & 1 &   &   &   &a_{2} & 1 &   &   \\
     &   &...&   &   &...   &   &...&   \\
     &   &   & 1 &   &a_{47}&   &   & 1  \\
     &   &   &   & 1 &a_{48}&   &   & 1 \\
     &   &   &   &   &-c    &-3 &   &-3  \\
  \end{matrix}
  \right)</script><p>右边新增的八列，每一列对应位置有6个1，然后最后一行为-3。这样构造格的依据是下列线性关系：</p>
<script type="math/tex; mode=display">
(b_1,b_1,...b_{47},b_{48},1)*
\left(
 \begin{matrix}
   1 &   &   &   &   &a_{1} & 1 &   &   \\
     & 1 &   &   &   &a_{2} & 1 &   &   \\
     &   &...&   &   &...   &   &...&   \\
     &   &   & 1 &   &a_{47}&   &   & 1  \\
     &   &   &   & 1 &a_{48}&   &   & 1 \\
     &   &   &   &   &-c    &-3 &   &-3  \\
  \end{matrix}
  \right)
  = (b_1,b_1,...b_{47},b_{48},0,0,0,0,0,0,0,0,0)</script><p>其中，后九列可以乘上K倍系数来确保规约得到0。但是这样构造格，规约出来的仍然没有满足条件的01向量。然后又改变思路，构造下面的格：</p>
<script type="math/tex; mode=display">
\left(
 \begin{matrix}
   1 &   &   &   &   &a_{1} & 1 \\
     & 1 &   &   &   &a_{2} & 1 \\
     &   &...&   &   &...   & 1   \\
     &   &   & 1 &   &a_{47}& 1\\
     &   &   &   & 1 &a_{48}& 1   \\
     &   &   &   &   &-c    &-24  \\
  \end{matrix}
  \right)</script><p>其线性关系如下：</p>
<script type="math/tex; mode=display">
(b_1,b_1,...b_{47},b_{48},1)*
\left(
 \begin{matrix}
   1 &   &   &   &   &a_{1} & 1 \\
     & 1 &   &   &   &a_{2} & 1 \\
     &   &...&   &   &...   & 1   \\
     &   &   & 1 &   &a_{47}& 1\\
     &   &   &   & 1 &a_{48}& 1   \\
     &   &   &   &   &-c    &-24  \\
  \end{matrix}
  \right)
  =
  (b_1,b_1,...b_{47},b_{48},0,0)</script><p>仍然是将最后两列扩充K倍，保证规约出0，这样用LLL之后可以找到对应01向量。</p>
<p>不过应该依然是运气好，碰上非预期解，因为前一个格出不来，没想通为什么这个格能出来。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> shuffle</span><br><span class="line"></span><br><span class="line">b = [<span class="number">65651991706497</span>, <span class="number">247831871690373</span>, <span class="number">120247087605020</span>, <span class="number">236854536567393</span>, <span class="number">38795708921144</span>, <span class="number">256334857906663</span>, <span class="number">120089773523233</span>, <span class="number">165349388120302</span>, <span class="number">123968326805899</span>, <span class="number">79638234559694</span>, <span class="number">259559389823590</span>, <span class="number">256776519514651</span>, <span class="number">107733244474073</span>, <span class="number">216508566448440</span>, <span class="number">39327578905012</span>, <span class="number">118682486932022</span>, <span class="number">263357223061004</span>, <span class="number">132872609024098</span>, <span class="number">44605761726563</span>, <span class="number">24908360451602</span>, <span class="number">237906955893793</span>, <span class="number">204469770496199</span>, <span class="number">7055254513808</span>, <span class="number">221802659519968</span>, <span class="number">169686619990988</span>, <span class="number">23128789035141</span>, <span class="number">208847144870760</span>, <span class="number">272339624469135</span>, <span class="number">269511404473473</span>, <span class="number">112830627321371</span>, <span class="number">73203551744776</span>, <span class="number">42843503010671</span>, <span class="number">118193938825623</span>, <span class="number">49625220390324</span>, <span class="number">230439888723036</span>, <span class="number">241486656550572</span>, <span class="number">107149406378865</span>, <span class="number">233503862264755</span>, <span class="number">269502011971514</span>, <span class="number">181805192674559</span>, <span class="number">152612003195556</span>, <span class="number">184127512098087</span>, <span class="number">165959151027513</span>, <span class="number">188723045133473</span>, <span class="number">241615906682300</span>, <span class="number">216101484550038</span>, <span class="number">81190147709444</span>, <span class="number">124498742419309</span>]</span><br><span class="line">c = <span class="number">4051501228761632</span></span><br><span class="line"></span><br><span class="line">n = <span class="built_in">len</span>(b)</span><br><span class="line">L = Matrix(ZZ, n+<span class="number">1</span>, n+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">K = <span class="number">2</span>**<span class="number">20</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    L[i,i] = <span class="number">1</span></span><br><span class="line">    L[i,-<span class="number">2</span>] = b[i]*K</span><br><span class="line">L[-<span class="number">1</span>,-<span class="number">2</span>] = -c*K</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>):</span><br><span class="line">    L[i,-<span class="number">1</span>] = <span class="number">1</span>*K</span><br><span class="line">L[-<span class="number">1</span>,-<span class="number">1</span>] = -<span class="number">24</span>*K</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(L)</span></span><br><span class="line">res = L.LLL()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    error = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">        <span class="keyword">if</span>(j != <span class="number">1</span> <span class="keyword">and</span> j != <span class="number">0</span>):</span><br><span class="line">            error = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(error == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span>(error == <span class="number">0</span>):</span><br><span class="line">        e = i[:-<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;DASCTF&#123;&#x27;</span>+sha256(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> e]).encode()).hexdigest()+<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DASCTF&#123;22a53e95a21f1000ac5dcc618f67586c412e1072f5bb1fee0ee5ce3d1794e3f3&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="CB-curve"><a href="#CB-curve" class="headerlink" title="*CB curve"></a>*CB curve</h3><p>题目描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cryptography Based on curve</span><br></pre></td></tr></table></figure>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag,order</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CB_curve</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.p = <span class="number">1141741939958844590498346884870015122543626602665954681008204697160652371664923</span></span><br><span class="line">        self.a = <span class="number">727131475903635498678013730344448225340496007388151739960305539398192321065043</span></span><br><span class="line">        self.b = <span class="number">840714623434321649308065401328602364673881568379142278640950034404861312007307</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, P, Q</span>):</span><br><span class="line">        <span class="keyword">if</span> P == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> Q</span><br><span class="line">        (x1, y1) = P</span><br><span class="line">        (x2, y2) = Q</span><br><span class="line">        x3 =  (x1+x2)*(<span class="number">1</span>+self.a*y1*y2)*inverse((<span class="number">1</span>+self.b*x1*x2)*(<span class="number">1</span>-self.a*y1*y2),self.p)% self.p</span><br><span class="line">        y3 =  (y1+y2)*(<span class="number">1</span>+self.b*x1*x2)*inverse((<span class="number">1</span>-self.b*x1*x2)*(<span class="number">1</span>+self.a*y1*y2),self.p)% self.p</span><br><span class="line">        <span class="keyword">return</span> (x3, y3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">self, x, P</span>):</span><br><span class="line">        Q = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> x &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> x &amp; <span class="number">1</span>:</span><br><span class="line">                Q = self.add(Q, P)</span><br><span class="line">            P = self.add(P, P)</span><br><span class="line">            x = x &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> Q</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">negG</span>(<span class="params">self,G</span>):</span><br><span class="line">        <span class="keyword">return</span> self.mul(order-<span class="number">1</span>,G)</span><br><span class="line"></span><br><span class="line">ecc = CB_curve()</span><br><span class="line">G = (<span class="number">586066762126624229327260483658353973556531595840920560414263113786807168248797</span>, <span class="number">66727759687879628160487324122999265926655929132333860726404158613654375336028</span>)</span><br><span class="line">P = (ecc.mul(bytes_to_long(flag),G)[<span class="number">0</span>],randint(<span class="number">1</span>,ecc.p))</span><br><span class="line">Q = (<span class="number">460843895959181097343292934009653542386784127282375019764638432240505304648101</span>, <span class="number">739422832583403823403837831802136107593509589942947902014204968923412689379907</span>)</span><br><span class="line"></span><br><span class="line">e = randint(<span class="number">1</span>,p)</span><br><span class="line">pl = [ecc.add(P,ecc.mul(<span class="number">10</span>-i,ecc.negG(Q)))[<span class="number">0</span>] + e <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">ph = [ecc.add(P,ecc.mul(<span class="number">10</span>-i,Q))[<span class="number">0</span>] + e <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(pl)</span><br><span class="line"><span class="built_in">print</span>(ph)</span><br></pre></td></tr></table></figure>
<p>梳理一下加密流程：</p>
<ul>
<li>定义了一条曲线ecc，并给定其上的点加法与倍乘法</li>
<li>给出两点G、Q</li>
<li>对于G，将flag转为大整数后，求出G的flag倍点并取其横坐标作为P点的横坐标，并另生成一个随机数作为P点的纵坐标</li>
<li>对于Q，生成一个随机数e，然后进行10次如下运算(其中，[0]代表取横坐标，negG是取逆元点)：</li>
</ul>
<script type="math/tex; mode=display">
pl_i = (P + (10-i)*negG(Q))[0] + e</script><script type="math/tex; mode=display">
ph_i = (P + (10-i)*Q)[0] + e</script><p>那么大致思路就是：</p>
<ul>
<li>先通过pl、ph求出点P的坐标</li>
<li>通过曲线映射求解DLP，得到flag</li>
</ul>
<p>接下来进入具体题目分析。</p>
<h4 id="negG"><a href="#negG" class="headerlink" title="negG"></a>negG</h4><p>要求出P点的坐标就要利用pli与phi，但是利用pli之前，首先要知道negG(Q)的具体坐标是多少。由题目中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">negG</span>(<span class="params">self,G</span>):</span><br><span class="line">    <span class="keyword">return</span> self.mul(order-<span class="number">1</span>,G)</span><br></pre></td></tr></table></figure>
<p>可以看出，negG(Q)操作其实就是在取Q的该曲线上的逆元，但是我们没有order，也没有有效的计算order的方法，因此只能用题目已知信息推算Q逆元的坐标形式。</p>
<p>首先要确认曲线的单位元O，由于普通ECC的单位元是无穷远点，不好计算，所以我们先测试O=(0，0)，看他是不是单位元。测试方法就是看对于曲线上任意一点X，是否有O+X=X。</p>
<p>而我们有该曲线的加法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x3 =  (x1+x2)*(<span class="number">1</span>+self.a*y1*y2)*inverse((<span class="number">1</span>+self.b*x1*x2)*(<span class="number">1</span>-self.a*y1*y2),self.p)% self.p</span><br><span class="line">y3 =  (y1+y2)*(<span class="number">1</span>+self.b*x1*x2)*inverse((<span class="number">1</span>-self.b*x1*x2)*(<span class="number">1</span>+self.a*y1*y2),self.p)% self.p</span><br></pre></td></tr></table></figure>
<p>把数学表达式写的直观一点(以下均在模p下进行)：</p>
<script type="math/tex; mode=display">
x_3 = \frac{(x_1+x_2)(1+ay_1y_2)}{(1+bx_1x_2)(1-ay_1y_2)}</script><script type="math/tex; mode=display">
y_3 = \frac{(y_1+y_2)(1+bx_1x_2)}{(1-bx_1x_2)(1+ay_1y_2)}</script><p>很显然对曲线上任意一点X，O=(0，0)满足O+X=X，因此(0，0)是该曲线的单位元。这一点也可以用题目给定的add函数测试。</p>
<p>那么有了单位元后，由于negG(Q)是Q的逆元，所以有：</p>
<script type="math/tex; mode=display">
negG(Q) + Q = O</script><p>那么设negG(Q)=(x1,y1)，代入点加法就有：</p>
<script type="math/tex; mode=display">
0 = \frac{(x_1+x_Q)(1+ay_1y_Q)}{(1+bx_1x_Q)(1-ay_1y_Q)}</script><script type="math/tex; mode=display">
0 = \frac{(y_1+y_Q)(1+bx_1x_Q)}{(1-bx_1x_Q)(1+ay_1y_Q)}</script><p>这个时候就可以看出来其实Q和negG(Q)的坐标关系其实就是模p下互为相反数，因此我们就有了negG(Q)的坐标了。可能有的师傅看到这里会觉得这很显然，但其实对于认识一个曲线，这些分析步骤其实并不显然，而且很重要。</p>
<h4 id="groebner求P点坐标"><a href="#groebner求P点坐标" class="headerlink" title="groebner求P点坐标"></a>groebner求P点坐标</h4><p>那么现在有了negG(Q)的坐标，我们就可以着手利用pl和ph了。仍然把他们先写成直观的数学表达式如下：</p>
<script type="math/tex; mode=display">
pl_i = \frac{(x_P-x_i)(1-ay_Py_i)}{(1-bx_Px_i)(1+ay_Py_i)} + e</script><script type="math/tex; mode=display">
ph_i = \frac{(x_P+x_i)(1+ay_Py_i)}{(1+bx_Px_i)(1-ay_Py_i)} + e</script><p>其中，(xi,yi)是当次Q的(10-i)倍点的坐标。现在有了十组pli、phi，而这些方程组只有三个未知数xP、yP、e，因此朴素的想法是直接groebner基求出三个未知数就有P点的坐标。但是实际上这样是求不出的，我觉得可能是以下两个原因：</p>
<ul>
<li>yP并不是P点在该曲线上的纵坐标，而是一个随机数，因此直接用曲线加法会产生一些错误</li>
<li>多项式形式过于复杂，直接groebner难以求解</li>
</ul>
<p>赛后看别的师傅wp，才发现只要采用一个小技巧，这两个问题就可以同时解决。这个技巧就是发现平方差公式可以利用在消元中，如下：</p>
<script type="math/tex; mode=display">
pl_i - e = \frac{(x_P-x_i)(1-ay_Py_i)}{(1-bx_Px_i)(1+ay_Py_i)}</script><script type="math/tex; mode=display">
ph_i - e = \frac{(x_P+x_i)(1+ay_Py_i)}{(1+bx_Px_i)(1-ay_Py_i)}</script><p>上下两式相乘可以得到：</p>
<script type="math/tex; mode=display">
(pl_i - e)(ph_i - e) = \frac{(x_P-x_i)(1-ay_Py_i)}{(1-bx_Px_i)(1+ay_Py_i)} \frac{(x_P+x_i)(1+ay_Py_i)}{(1+bx_Px_i)(1-ay_Py_i)}</script><p>就可以消掉yP，并得到：</p>
<script type="math/tex; mode=display">
(pl_i - e)(ph_i - e) = \frac{xP^2-x_i^2}{1-b^2x_P^2x_i^2}</script><p>而这样用groebner基就可以求出xP和e了，当然求出来的xP有两种取值。</p>
<h4 id="mapping"><a href="#mapping" class="headerlink" title="mapping"></a>mapping</h4><p>这也是赛后看别的师傅wp(<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ZimaBlue/articles/17780216.html">DASCTF-CBCTF 2023 - ZimaB1ue - 博客园 (cnblogs.com)</a>)才看到的，赛中没找到这是huff曲线(其实赛后自己找也没找到)。而huff曲线可以利用如下映射mapping到普通椭圆曲线上(也就是常见的Weiestrass Curve)：</p>
<p><img src="/post/87ec16c9/image-20231023200412149.png" alt="image-20231023200412149"></p>
<p>那么就先用huff曲线方程求出P点坐标，然后将P点映射到对应椭圆曲线上。</p>
<p>然后由于映射是一一对应，因此曲线阶不会变，所以我们可以直接用order函数求出映射后的曲线阶，发现其除了一个因子外都光滑，因此之后就是pohlig_Hellman求一个DLP就能得到flag。</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CB_curve</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.p = <span class="number">1141741939958844590498346884870015122543626602665954681008204697160652371664923</span></span><br><span class="line">        self.a = <span class="number">727131475903635498678013730344448225340496007388151739960305539398192321065043</span></span><br><span class="line">        self.b = <span class="number">840714623434321649308065401328602364673881568379142278640950034404861312007307</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, P, Q</span>):</span><br><span class="line">        <span class="keyword">if</span> P == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> Q</span><br><span class="line">        (x1, y1) = P</span><br><span class="line">        (x2, y2) = Q</span><br><span class="line">        x3 =  (x1+x2)*(<span class="number">1</span>+self.a*y1*y2)*inverse((<span class="number">1</span>+self.b*x1*x2)*(<span class="number">1</span>-self.a*y1*y2),self.p)% self.p</span><br><span class="line">        y3 =  (y1+y2)*(<span class="number">1</span>+self.b*x1*x2)*inverse((<span class="number">1</span>-self.b*x1*x2)*(<span class="number">1</span>+self.a*y1*y2),self.p)% self.p</span><br><span class="line">        <span class="keyword">return</span> (x3, y3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">self, x, P</span>):</span><br><span class="line">        Q = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> x &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> x &amp; <span class="number">1</span>:</span><br><span class="line">                Q = self.add(Q, P)</span><br><span class="line">            P = self.add(P, P)</span><br><span class="line">            x = x &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> Q</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">negG</span>(<span class="params">self,G</span>):</span><br><span class="line">        <span class="keyword">return</span> self.mul(order-<span class="number">1</span>,G)</span><br><span class="line"></span><br><span class="line">ecc = CB_curve()</span><br><span class="line">G = (<span class="number">586066762126624229327260483658353973556531595840920560414263113786807168248797</span>, <span class="number">66727759687879628160487324122999265926655929132333860726404158613654375336028</span>)</span><br><span class="line">Q = (<span class="number">460843895959181097343292934009653542386784127282375019764638432240505304648101</span>, <span class="number">739422832583403823403837831802136107593509589942947902014204968923412689379907</span>)</span><br><span class="line">pl = [<span class="number">908996880816674413953945844149350915331956247471480600840221415119794882139724</span>, <span class="number">971918808384910355828135603762747020183688585728289421786279444571287619529246</span>, <span class="number">1285550352531583269956802123237391199017403081800977678246201935580429758051904</span>, <span class="number">1551774945769448705387900437472951015954157193946719575845523359198154668857591</span>, <span class="number">676185408751480221545400062950292727848016906516506232986883519673765317932582</span>, <span class="number">1250300209784131850574858927023046353058343552115735540789593580037130054384362</span>, <span class="number">1298409778422699298367007023890818793557023853717180295526932023194697263501748</span>, <span class="number">1332552452292482549702793642987623159617988974910321945878093492007278710993114</span>, <span class="number">1030239404875082841481045525469865919289388171602293245905162820968158543176773</span>, <span class="number">1154148024180033719999293176590867264297899817449945744942661351655533433871621</span>]</span><br><span class="line">ph = [<span class="number">584297112520340495757457954416165393828472756298945167299482077258411155766756</span>, <span class="number">886432149227960827335266910774569034430464592640209168563805700117347063152246</span>, <span class="number">613528590036968449893421430816319461615130635882647544978722093413694101540550</span>, <span class="number">576162106332135829961234799085370038425761945928004579456101802617485243023987</span>, <span class="number">627570890346195626159365118862437334953500165050236216404858019114288681512171</span>, <span class="number">1015503424232985454098149884321288932492551183126601131968495641510550575005042</span>, <span class="number">1532737675157046782602115678180407262847166210963507805526455422934164759886583</span>, <span class="number">1540047002602145805476906585925538790245968214992837106009502002588479779602195</span>, <span class="number">505097517314409449404205152068185149808364887623922221197462411159844816865696</span>, <span class="number">873498218680784138428154510303205366133389839886911286745954821800632158315951</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#get coordinate_P</span></span><br><span class="line">PR.&lt;xp,e&gt; = PolynomialRing(Zmod(ecc.p))</span><br><span class="line">F = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    f = (pl[i]-e)*(ph[i]-e)*(<span class="number">1</span>-ecc.b^<span class="number">2</span>*xp^<span class="number">2</span>*(ecc.mul(<span class="number">10</span>-i,Q)[<span class="number">0</span>]^<span class="number">2</span>)) - (xp^<span class="number">2</span>-(ecc.mul(<span class="number">10</span>-i,Q)[<span class="number">0</span>]^<span class="number">2</span>))</span><br><span class="line">    F.append(f)</span><br><span class="line">res = Ideal(F).groebner_basis()</span><br><span class="line"><span class="comment">#print(res)</span></span><br><span class="line"><span class="comment">#[xp^2 + 219493165434454878473973957507132663767650700404392831423708684433961924200902, e + 716700711017198421972376297958894204723153539777056104579499803899129208364755]</span></span><br><span class="line"></span><br><span class="line">xp_2 = -<span class="number">219493165434454878473973957507132663767650700404392831423708684433961924200902</span></span><br><span class="line">F = Zmod(ecc.p)</span><br><span class="line">xp_2 = F(xp_2)</span><br><span class="line">xp = xp_2.nth_root(<span class="number">2</span>,<span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">points = []</span><br><span class="line">PR.&lt;yp&gt; = PolynomialRing(Zmod(ecc.p))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> xp:</span><br><span class="line">    f = x*(ecc.a*yp^<span class="number">2</span>-<span class="number">1</span>) - yp*(ecc.b*x^<span class="number">2</span>-<span class="number">1</span>)</span><br><span class="line">    res = f.roots()</span><br><span class="line">    points.append((<span class="built_in">int</span>(x),<span class="built_in">int</span>(res[<span class="number">0</span>][<span class="number">0</span>])))</span><br><span class="line">    points.append((<span class="built_in">int</span>(x),<span class="built_in">int</span>(res[<span class="number">1</span>][<span class="number">0</span>])))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mapping and pohlig_hellman</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mapping</span>(<span class="params">point</span>):</span><br><span class="line">    x = point[<span class="number">0</span>]</span><br><span class="line">    y = point[<span class="number">1</span>]</span><br><span class="line">    Ex = (ecc.b*x-ecc.a*y) * inverse(y-x,ecc.p) % ecc.p</span><br><span class="line">    Ey = (ecc.b-ecc.a) * inverse(y-x,ecc.p) % ecc.p</span><br><span class="line">    <span class="keyword">return</span> (Ex,Ey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pohlig_hellman</span>(<span class="params">q,g,primes,order</span>):</span><br><span class="line">    logs=[]</span><br><span class="line">    <span class="keyword">for</span> fac <span class="keyword">in</span> primes:</span><br><span class="line">        t=<span class="built_in">int</span>(order)//<span class="built_in">int</span>(fac)</span><br><span class="line">        log=discrete_log(t*q,t*g,operation=<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        logs+=[log]</span><br><span class="line">    m = crt(logs,primes)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># DLP</span></span><br><span class="line">E = EllipticCurve(GF(ecc.p),[<span class="number">0</span>,ecc.a+ecc.b,<span class="number">0</span>,ecc.a*ecc.b,<span class="number">0</span>])</span><br><span class="line"><span class="comment">#print(E.order())</span></span><br><span class="line">order = <span class="number">1141741939958844590498346884870015122544171009688372185479632675211885925945760</span></span><br><span class="line">order_factors = [<span class="number">3</span>,<span class="number">5</span>,<span class="number">37</span>,<span class="number">271</span>,<span class="number">4297</span>,<span class="number">6983</span>,<span class="number">9679</span>,<span class="number">52631</span>,<span class="number">139571</span>,<span class="number">84666937</span>,<span class="number">558977989</span>]</span><br><span class="line">EG = E(mapping(G))</span><br><span class="line"><span class="keyword">for</span> point <span class="keyword">in</span> points:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        EP = E(mapping(point))</span><br><span class="line">        m = pohlig_hellman(EP,EG,order_factors,order)</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#DASCTF&#123;goodathuff&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><br></p>
<h3 id="CB-cipher"><a href="#CB-cipher" class="headerlink" title="*CB cipher"></a>*CB cipher</h3><p>题目描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cryptography Based on cipher</span><br></pre></td></tr></table></figure>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> pylfsr <span class="keyword">import</span> LFSR</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> state1,state2,state3,flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="string">b&#x27;DASCTF&#x27;</span> <span class="keyword">in</span> flag</span><br><span class="line"></span><br><span class="line">fpoly1 = [<span class="number">14</span>,<span class="number">13</span>,<span class="number">6</span>,<span class="number">2</span>]</span><br><span class="line">fpoly2 = [<span class="number">20</span>,<span class="number">15</span>,<span class="number">12</span>,<span class="number">9</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>]</span><br><span class="line">fpoly3 = [<span class="number">13</span>,<span class="number">12</span>,<span class="number">11</span>,<span class="number">9</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">iv</span>():</span><br><span class="line">    a,b,c = L1.<span class="built_in">next</span>(),L2.<span class="built_in">next</span>(),L3.<span class="built_in">next</span>()</span><br><span class="line">    <span class="keyword">return</span> (a &amp; b) ^ (b &amp; c) ^ c</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CB_cipher</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        key = [<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(randint(<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)]) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line">        self.key = [[<span class="built_in">int</span>(j) <span class="keyword">for</span> j <span class="keyword">in</span> i] <span class="keyword">for</span> i <span class="keyword">in</span> key]</span><br><span class="line">        </span><br><span class="line">        self.sbox = [<span class="number">0x6</span>, <span class="number">0x4</span>, <span class="number">0xc</span>, <span class="number">0x5</span>,</span><br><span class="line">                     <span class="number">0x0</span>, <span class="number">0x7</span>, <span class="number">0x2</span>, <span class="number">0xe</span>,</span><br><span class="line">                     <span class="number">0x1</span>, <span class="number">0xf</span>, <span class="number">0x3</span>, <span class="number">0xd</span>,</span><br><span class="line">                     <span class="number">0x8</span>, <span class="number">0xa</span>, <span class="number">0x9</span>, <span class="number">0xb</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">s_trans</span>(<span class="params">self,pt</span>):</span><br><span class="line">        pt = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">        pt = [self.sbox[<span class="built_in">int</span>(i,<span class="number">16</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">hex</span>(<span class="built_in">int</span>(pt,<span class="number">2</span>))[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">        ct = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">bin</span>(i)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]</span><br><span class="line">        <span class="keyword">return</span> ct</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self,pltxt</span>):</span><br><span class="line">        key_add = <span class="keyword">lambda</span> x,key : [x[i]^key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        bit_move = <span class="keyword">lambda</span> x : [x[(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        </span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pltxt]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            ct = key_add(ct,self.key[i%<span class="number">2</span>])</span><br><span class="line">            ct = self.s_trans(ct)</span><br><span class="line">            <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">2</span>:</span><br><span class="line">                ct = bit_move(ct)</span><br><span class="line">        </span><br><span class="line">        ct = key_add(ct,self.key[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]) </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bt_to_bin</span>(<span class="params">self,msg</span>):</span><br><span class="line">        msg = msg <span class="keyword">if</span> (<span class="built_in">len</span>(msg)+<span class="number">1</span>)%<span class="number">2</span> <span class="keyword">else</span> msg+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bin</span>(bytes_to_long(msg))[<span class="number">2</span>:].rjust(<span class="number">8</span>*<span class="built_in">len</span>(msg),<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">txt_encrypt</span>(<span class="params">self,msg</span>):</span><br><span class="line">        time = (<span class="built_in">len</span>(msg)+<span class="number">1</span>)//<span class="number">2</span></span><br><span class="line">        pltxt = [self.bt_to_bin(msg)[i*<span class="number">16</span>:i*<span class="number">16</span>+<span class="number">16</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(time)]</span><br><span class="line">        <span class="comment">#print(pltxt)</span></span><br><span class="line">        output = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(time):</span><br><span class="line">            now_re = self.encrypt(pltxt[i])</span><br><span class="line">            <span class="keyword">if</span> output != []:</span><br><span class="line">                now_re = <span class="built_in">bin</span>(<span class="built_in">int</span>(now_re,<span class="number">2</span>) ^ <span class="built_in">int</span>(output[-<span class="number">1</span>],<span class="number">2</span>))[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">            output.append(now_re)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(output),<span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">L1 = LFSR(fpoly = fpoly1, initstate = state1)</span><br><span class="line">L2 = LFSR(fpoly = fpoly2, initstate = state2)</span><br><span class="line">L3 = LFSR(fpoly = fpoly3, initstate = state3)</span><br><span class="line"></span><br><span class="line">iv_txt = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)*<span class="number">8</span>):</span><br><span class="line">    iv_txt += <span class="built_in">str</span>(iv())</span><br><span class="line">    </span><br><span class="line">a = CB_cipher()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(iv_txt[:<span class="number">320</span>])</span><br><span class="line"><span class="built_in">print</span>(a.txt_encrypt(<span class="string">b&#x27;Welcome to our CBCTF! I hope you can have a nice day here. Come with me.&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(bytes_to_long(a.txt_encrypt(flag))^<span class="built_in">int</span>(iv_txt,<span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#10101010100110100000111111011110111101010010011000011011001010010010111000100101011111010001110110110111000010100001010111110110000011110100110011011110001100100011101101110001000100111100001111100111010100010000001101001001000011110001100110101100101000101001110011101100001100100000011101011110100110110110000110010101</span></span><br><span class="line"><span class="comment">#b&#x27;\x10\x07t9\x88\x95\x8b&amp;\xb2\x8fp\xe7\xce\\k&#123;\xbb\xe5\xa7\xb8\x92\xbe\xd1\n\x84.\xe1\xe0\xab\x08\x97\x92\x1a\xbd\xdf\x80R\xbe\xe2\x84\xe17\x14\x8a\x07\x03\x87)\xb2\xa6W:\xda\x04Y\xa5\xca\x16o1\x93\x9d\x90.\xcdS\xd6\xcbK\xf4\xd8G&#x27;</span></span><br><span class="line"><span class="comment">#b&quot;\xec\x16&lt;[D;F6\xb6\xcc\x7f\x80jL1\xb1@\x84iF[\xfcW\xbbbp\xdc\x0fI,%\x15\x1a\xbe\x86hT\r\xf0\x8a\xa91\x9aF\xe3\x84n\xeb\xe9\xa3,T\xec\x8f\xdbb\xc1\xd7\xe7&amp;&#x27;u\xe9A\xe9\x03\xe1\x89\x04\x8f\xa77\x8a\xd7\x97x\xccl\x1e\xc6\xea%\xb1/P\x98\x8e\x9bS\xca\xf5kR\x98H\xc6d\x15&quot;</span></span><br></pre></td></tr></table></figure>
<p>分析一下题目流程：</p>
<ul>
<li>题目给出了三个LFSR，并结合三个LFSR的每一比特输出生成了iv_txt，并给出了iv_txt的前320位</li>
<li>题目自定义了一个CB_cipher类，并生成一个对象a，对一段已知明文进行了加密，并给出密文</li>
<li>将flag也用对象a加密后，与完整的iv_txt异或，并给出密文</li>
</ul>
<h4 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h4><p>首先，三个LFSR这部分有点类似于前段时间柏鹭杯的Stream。</p>
<p><a href="https://tangcuxiaojikuai.xyz/post/812dabe5.html#more">2023-网信柏鹭杯-wp-crypto | 糖醋小鸡块的blog (tangcuxiaojikuai.xyz)</a></p>
<p>只是这道题里采用了pylfsr实现，把特征多项式换成等价的移位操作就仍然可以用z3解出三个state，从而还原出完整iv_txt，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;10101010100110100000111111011110111101010010011000011011001010010010111000100101011111010001110110110111000010100001010111110110000011110100110011011110001100100011101101110001000100111100001111100111010100010000001101001001000011110001100110101100101000101001110011101100001100100000011101011110100110110110000110010101&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part1 get_init_state</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lfsr1</span>(<span class="params">R</span>):</span><br><span class="line">    <span class="keyword">return</span> ((R &gt;&gt; <span class="number">13</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">12</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">5</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">1</span>) &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lfsr2</span>(<span class="params">R</span>):</span><br><span class="line">    <span class="keyword">return</span> ((R &gt;&gt; <span class="number">19</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">14</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">11</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">6</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">3</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">2</span>) &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lfsr3</span>(<span class="params">R</span>):</span><br><span class="line">    <span class="keyword">return</span> ((R &gt;&gt; <span class="number">12</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">11</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">10</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">6</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">5</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">2</span>) &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z3_sol</span>():</span><br><span class="line">    R1 = BitVec(<span class="string">&#x27;R1&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">    R2 = BitVec(<span class="string">&#x27;R2&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">    R3 = BitVec(<span class="string">&#x27;R3&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">    sol = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">320</span>):</span><br><span class="line">        sol.add(((lfsr1(R1) &amp; lfsr2(R2))^(lfsr2(R2) &amp; lfsr3(R3))^lfsr3(R3)) == <span class="built_in">int</span>(c[i]))</span><br><span class="line">        R1 = R1 &lt;&lt; <span class="number">1</span> ^ lfsr1(R1)</span><br><span class="line">        R2 = R2 &lt;&lt; <span class="number">1</span> ^ lfsr2(R2)</span><br><span class="line">        R3 = R3 &lt;&lt; <span class="number">1</span> ^ lfsr3(R3)</span><br><span class="line">    <span class="keyword">if</span>(sol.check() == sat):</span><br><span class="line">        <span class="built_in">print</span>(sol.model())</span><br><span class="line"></span><br><span class="line">z3_sol()</span><br></pre></td></tr></table></figure>
<p>得到三个初始state：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[R2 = <span class="number">68217</span>, R3 = <span class="number">3230</span>, R1 = <span class="number">6464</span>]</span><br></pre></td></tr></table></figure>
<p>可以验证该种子产生的iv_txt前320位与给定的相等：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#part2 check_init_state</span></span><br><span class="line">R2 = <span class="number">68217</span>;R3 = <span class="number">3230</span>;R1 = <span class="number">6464</span></span><br><span class="line">iv_txt = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">98</span>*<span class="number">8</span>):</span><br><span class="line">    iv_txt += <span class="built_in">str</span>((lfsr1(R1)&amp;lfsr2(R2)) ^ (lfsr2(R2)&amp;lfsr3(R3)) ^ lfsr3(R3))</span><br><span class="line">    R1 = (R1 &lt;&lt; <span class="number">1</span>) ^ lfsr1(R1)</span><br><span class="line">    R2 = (R2 &lt;&lt; <span class="number">1</span>) ^ lfsr2(R2)</span><br><span class="line">    R3 = (R3 &lt;&lt; <span class="number">1</span>) ^ lfsr3(R3)</span><br><span class="line"><span class="built_in">print</span>(iv_txt[:<span class="number">320</span>] == c)</span><br></pre></td></tr></table></figure>
<p>然后我们就可以去除iv_txt对flag的密文异或的影响。</p>
<p>接下来的问题就是：如何由一组已知的明密文对，解密flag对应的密文？这就需要分析加密的具体过程了。不过大致浏览一下可以发现几个比较重要的性质：</p>
<ul>
<li>把明文每两个字节分为一组，对于相同的两个字节，encrypt的结果是一样的</li>
<li>txt_encrypt其实只是对每个明文分组encrypt的结果做了一个类似CBC的操作，也就是当前组的最终密文，由该组encrypt的加密结果与前一组的最终密文异或得到</li>
</ul>
<p>可以发现，性质二其实提供了一个逆操作，我们只需要知道前一组的最终密文，与当前分组的最终密文异或，就能得到当前分组的encrypt结果。比如对于题目中给定的已知的一组明文c1，可以用以下操作恢复其encrypt结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c1 = <span class="string">b&#x27;\x10\x07t9\x88\x95\x8b&amp;\xb2\x8fp\xe7\xce\\k&#123;\xbb\xe5\xa7\xb8\x92\xbe\xd1\n\x84.\xe1\xe0\xab\x08\x97\x92\x1a\xbd\xdf\x80R\xbe\xe2\x84\xe17\x14\x8a\x07\x03\x87)\xb2\xa6W:\xda\x04Y\xa5\xca\x16o1\x93\x9d\x90.\xcdS\xd6\xcbK\xf4\xd8G&#x27;</span></span><br><span class="line">plain = <span class="string">b&#x27;Welcome to our CBCTF! I hope you can have a nice day here. Come with me.&#x27;</span></span><br><span class="line"></span><br><span class="line">final_c1 = <span class="string">b&quot;\x10\x07&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="built_in">len</span>(c1),<span class="number">2</span>):</span><br><span class="line">    tt1 = bytes_to_long(c1[i:i+<span class="number">2</span>])</span><br><span class="line">    tt2 = bytes_to_long(c1[i-<span class="number">2</span>:i])</span><br><span class="line">    final_c1 += long_to_bytes(tt1^tt2,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(final_c1)</span><br></pre></td></tr></table></figure>
<p>得到的结果如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&quot;\x10\x07d&gt;\xfc\xac\x03\xb39\xa9\xc2h\xbe\xbb\xa5&#x27;\xd0\x9e\x1c]5\x06C\xb4U$e\xceJ\xe8&lt;\x9a\x8d/\xc5=\x8d&gt;\xb0:\x03\xb3\xf5\xbd\x13\x89\x80*5\x8f\xe5\x9c\x8d&gt;\x83\xa1\x93\xb3\xa5&#x27;\xfc\xac\x03\xb3]&#125;\x1b\x98\x9d?\x93\xb3&quot;</span></span><br></pre></td></tr></table></figure>
<p>得到了原始的encrypt的结果，其用处是什么呢？这个时候就需要用到刚才提到的性质一：把明文每两个字节分为一组，对于相同的两个字节，encrypt的结果是一样的。</p>
<p>而由于两次加密用的是同一个对象a，因此密钥key不变，所以同样的两字节密文肯定会得到同样的两字节密文。而我们现在相当于有了36组2字节的明密文对应关系，也许可以根据这些关系恢复一部分flag串，然后用猜单词之类的方式猜测flag的完整串？</p>
<p>那么如法炮制，先把c2的CBC加密去掉：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">c2 = <span class="string">b&quot;\xec\x16&lt;[D;F6\xb6\xcc\x7f\x80jL1\xb1@\x84iF[\xfcW\xbbbp\xdc\x0fI,%\x15\x1a\xbe\x86hT\r\xf0\x8a\xa91\x9aF\xe3\x84n\xeb\xe9\xa3,T\xec\x8f\xdbb\xc1\xd7\xe7&amp;&#x27;u\xe9A\xe9\x03\xe1\x89\x04\x8f\xa77\x8a\xd7\x97x\xccl\x1e\xc6\xea%\xb1/P\x98\x8e\x9bS\xca\xf5kR\x98H\xc6d\x15&quot;</span></span><br><span class="line">c2 = long_to_bytes(bytes_to_long(c2)^<span class="built_in">int</span>(iv_txt,<span class="number">2</span>))</span><br><span class="line">final_c2 = <span class="string">b&quot;F\x8c&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="built_in">len</span>(c2),<span class="number">2</span>):</span><br><span class="line">    tt1 = bytes_to_long(c2[i:i+<span class="number">2</span>])</span><br><span class="line">    tt2 = bytes_to_long(c2[i-<span class="number">2</span>:i])</span><br><span class="line">    final_c2 += long_to_bytes(tt1^tt2,<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(final_c2)</span><br></pre></td></tr></table></figure>
<p>得到的结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;F\x8cu\t\x82\x98\xec\x02\xc5\xf6\x9at\xdf\xdb\xf9\x01k\x8f\xf8\xbc\xd7\xf9$\xf5\xc1YZg\x99s\xcf\x82\x0f\xe52=\xbe\xf9\x9b\x89+\xdf\x8dYr\xac\x06\xf3W\x8e\x81\x82\x00L\xf0%\xd7*Ea\xb6=\xd4(\x1f\x17Gck2\xde\xc1r8\xcdSY\x8a\xd63\xfa\x1a&#123;yNO\xe5\xe7%\x98\xc7\x84\xff\x9cr\r\xf3!&#x27;</span></span><br></pre></td></tr></table></figure>
<p>然后由于题目保证了”DASCTF”在flag串中，然后由已知明密文对可以分析出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;TF&quot;</span> --&gt; <span class="string">&quot;\x1c]&quot;</span></span><br></pre></td></tr></table></figure>
<p>但是很可惜在密文串中没有发现这组加密结果，这说明”DASCTF”应该是按如下分组加密的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;xD&quot;</span>,<span class="string">&quot;AS&quot;</span>,<span class="string">&quot;CT&quot;</span>,<span class="string">&quot;Fx&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后就期望可以找到别的已有的密文对，结果<strong>一组都没有找到</strong>，尝试彻底失败！</p>
<p>那么通过这种方式肯定是不行的，还是要结合提示”中间相遇”去分析具体加密流程才能找出密钥，从而进行解密。</p>
<h4 id="正确思路"><a href="#正确思路" class="headerlink" title="正确思路"></a>正确思路</h4><p>在研究了wp以及与出题师傅交流后，基本理清了这道题的思路，接下来我会尝试把wp的思路阐述的更清楚一点。</p>
<h5 id="iv"><a href="#iv" class="headerlink" title="iv"></a>iv</h5><p>首先就是纠正一下尝试中对于iv求解的一点小错误。这里的错误主要是由于题目iv的生成方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iv_txt = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)*<span class="number">8</span>):</span><br><span class="line">    iv_txt += <span class="built_in">str</span>(iv())</span><br></pre></td></tr></table></figure>
<p>可以看到，他生成了flag长度乘8个比特，也就是flag长度个字节。而由于题目中给定的flag最终密文是98字节，所以很容易就会像我一样直接认为iv也是98个字节的长度。但其实并不一定，因为flag在txt_encrypt中可能会进行填充，因此flag的初始长度<strong>既可能是98字节，也可能是97字节！</strong></p>
<p>而在上面我的尝试中，我生成了98字节的iv并消除类似CBC的影响后，竟然一组明文都找不到(包括”TF”这种很大概率存在的明文对)，因此很可能iv其实是97个字节。我们生成97字节的iv后重新求解，就可以重新得到c2的两两一组的纯encrypt加密结果如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;F\x8cJ\xe8&lt;\x9a\xfa\xe3\xff\xcf\xc5\x1f-\x06L_\x8d/\x93\x13L_Oo\x87?,\x9b\x8d/&lt;\x9a\x84\x9b\xd2x9\t8\xb8W\xc9W\xc9W\xc9\xe3\xe4\x1b\x98\x03\xb3\xb5\x1b\xa0*\xd2x\xb9\x92P%\xa0.\x1c]]\xc5\x0c\x88\x97\xc5T\xbf\xc5\x7f\xa7\x16L\xaem\xed\xa2*\x92\x18&amp;89\xa9o\xc0\x82\xabu6\x7f\x0c&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这个时候可以发现里面就存在包括”\x1c]”在内的一些密文对了，并且拓展一下也可以知道诸如”DA”、”SC”之类明文对应的密文，不过这已经不重要了，因为还有非常多对密文对没有出现在已知明密文对中，所以这个方法无法完全求解。</p>
<p>不过至少这说明iv长度为97应该才是正解。</p>
<h5 id="中间相遇"><a href="#中间相遇" class="headerlink" title="中间相遇"></a>中间相遇</h5><p>然后接下来是对中间相遇步骤的分析，这才是本题的重头戏。</p>
<p>首先由之前的分析我们可以知道，我们完全可以把每两个字节都当作独立的明文进行处理。因此现在我们只需要关注encrypt函数的加密流程了。而encrypt函数一共加密五轮，再贴一下其加密流程如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self,pltxt</span>):</span><br><span class="line">    key_add = <span class="keyword">lambda</span> x,key : [x[i]^key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">    bit_move = <span class="keyword">lambda</span> x : [x[(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">    </span><br><span class="line">    ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pltxt]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        ct = key_add(ct,self.key[i%<span class="number">2</span>])</span><br><span class="line">        ct = self.s_trans(ct)</span><br><span class="line">        <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">2</span>:</span><br><span class="line">            ct = bit_move(ct)</span><br><span class="line">    </span><br><span class="line">    ct = key_add(ct,self.key[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]) </span><br></pre></td></tr></table></figure>
<p>其中，s_trans函数如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">s_trans</span>(<span class="params">self,pt</span>):</span><br><span class="line">    pt = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">    pt = [self.sbox[<span class="built_in">int</span>(i,<span class="number">16</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">hex</span>(<span class="built_in">int</span>(pt,<span class="number">2</span>))[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">    ct = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">bin</span>(i)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">    ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]</span><br><span class="line">    <span class="keyword">return</span> ct</span><br></pre></td></tr></table></figure>
<p>它实现的功能是：把输入的长度为16的01列表，转化为4个十六进制数，并使用sbox对这4个十六进制数分别进行代换，代换完毕后，将其重新转为长度为16的01列表并返回。</p>
<p>然后还有一个bit_move函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bit_move = <span class="keyword">lambda</span> x : [x[(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br></pre></td></tr></table></figure>
<p>它实现的功能是一个比特置换，我们打印一下其置换结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>([i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)])</span><br><span class="line"><span class="built_in">print</span>([(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)])</span><br><span class="line"></span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>]</span><br><span class="line">[<span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">13</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">15</span>]</span><br></pre></td></tr></table></figure>
<p>这也就是说，进行bit_move操作后，位置为0的比特换到位置0，位置为4的比特换到位置1，位置为8的比特换到位置2，以此类推。其实这两个函数也就是一个代换置换网络每一轮的代换与置换操作。</p>
<p>那么我们可以发现encrypt函数几个不安全的地方：</p>
<ul>
<li>加密轮数只有5轮，轮数比较少</li>
<li>只有1、3、5轮进行了bit_move，2、4轮没有进行</li>
<li>bit_move函数中，有4个比特位并没有进行置换，分别是：0，5，10，15</li>
</ul>
<p>那么接下来我们尝试进行中间相遇攻击，那么首先假设我们通过爆破操作，可以拥有正确的密钥K[0]的全16个比特以及密钥K[1]的前4个比特，然后对已知的明文加密三轮。我们把已知的两字节明文分成每4bit一组，这样符合每一轮的代换置换过程，然后对前三轮依次进行分析：</p>
<ul>
<li><p>第一轮：由于我们拥有完全正确的K[0]，因此我们可以获得完全正确的第一轮加密结果。</p>
</li>
<li><p>第二轮：由于我们只拥有K[1]的前四个比特，而第二轮只进行了S盒代换没有进行bit_move，因此我们能获得完全正确的第二轮加密得到的前4bit</p>
</li>
<li>第三轮：仍然由于拥有K[0]的全16个bit，因此自然拥有完全正确的K[0]前4bit，所以在第三轮bit_move之前，得到的前4bit加密结果仍然是完全正确的。然后就需要进行bit_move，而正如刚才分析得到的一样，由于bit_move中第0比特位并没有进行置换，所以三轮加密完全结束后，我们可以得到完全正确的第0比特。</li>
</ul>
<p>也就是说，我们爆破密钥K[0]的全16个比特以及密钥K[1]的前4个比特，其中正确的那一组就可以得到36组已知明文的三轮加密的第0比特，所以我们可以依据此建立中间相遇攻击的字典。</p>
<p>同理，对于解密操作，我们爆破正确的密钥K[1]的全16个比特以及密钥K[0]的前4个比特，就可以得到完全正确的三轮解密得到的前四个bit，但是我们只需要第0比特来进行中间相遇攻击。</p>
<p>而这个步骤还可以简化，就是wp说的那样分为内层和外层，外层爆破两个密钥的前4bit，内层使用两个密钥的后12bit去中间相遇。这样就可以每次建立一个较小字典进行中间相遇攻击，而不需要先花较长时间把完整的很大的加密字典完全建立好，然后再通过解密操作反查字典进行中间相遇。</p>
<p>现在我们有已知的36组明密文，那么如果中间相遇攻击发现了一组密钥对36个碰撞比特都满足，那么就很大概率是正确的密钥了。有了正确密钥后写个解密逆操作就可以得到flag。</p>
<p>exp(偷了点懒，完整的CB_cipher类就直接用wp的了)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;10101010100110100000111111011110111101010010011000011011001010010010111000100101011111010001110110110111000010100001010111110110000011110100110011011110001100100011101101110001000100111100001111100111010100010000001101001001000011110001100110101100101000101001110011101100001100100000011101011110100110110110000110010101&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part1 get_init_state</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lfsr1</span>(<span class="params">R</span>):</span><br><span class="line">    <span class="keyword">return</span> ((R &gt;&gt; <span class="number">13</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">12</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">5</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">1</span>) &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lfsr2</span>(<span class="params">R</span>):</span><br><span class="line">    <span class="keyword">return</span> ((R &gt;&gt; <span class="number">19</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">14</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">11</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">6</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">3</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">2</span>) &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lfsr3</span>(<span class="params">R</span>):</span><br><span class="line">    <span class="keyword">return</span> ((R &gt;&gt; <span class="number">12</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">11</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">10</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">6</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">5</span>) &amp; <span class="number">1</span>) ^ ((R &gt;&gt; <span class="number">2</span>) &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">z3_sol</span>():</span><br><span class="line">    R1 = BitVec(<span class="string">&#x27;R1&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">    R2 = BitVec(<span class="string">&#x27;R2&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">    R3 = BitVec(<span class="string">&#x27;R3&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">    sol = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">320</span>):</span><br><span class="line">        sol.add(((lfsr1(R1) &amp; lfsr2(R2))^(lfsr2(R2) &amp; lfsr3(R3))^lfsr3(R3)) == <span class="built_in">int</span>(c[i]))</span><br><span class="line">        R1 = R1 &lt;&lt; <span class="number">1</span> ^ lfsr1(R1)</span><br><span class="line">        R2 = R2 &lt;&lt; <span class="number">1</span> ^ lfsr2(R2)</span><br><span class="line">        R3 = R3 &lt;&lt; <span class="number">1</span> ^ lfsr3(R3)</span><br><span class="line">    <span class="keyword">if</span>(sol.check() == sat):</span><br><span class="line">        <span class="built_in">print</span>(sol.model())</span><br><span class="line"><span class="comment">#z3_sol()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part2 check_init_state</span></span><br><span class="line">R2 = <span class="number">68217</span>;R3 = <span class="number">3230</span>;R1 = <span class="number">6464</span></span><br><span class="line">iv_txt = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">97</span>*<span class="number">8</span>):</span><br><span class="line">    iv_txt += <span class="built_in">str</span>((lfsr1(R1)&amp;lfsr2(R2)) ^ (lfsr2(R2)&amp;lfsr3(R3)) ^ lfsr3(R3))</span><br><span class="line">    R1 = (R1 &lt;&lt; <span class="number">1</span>) ^ lfsr1(R1)</span><br><span class="line">    R2 = (R2 &lt;&lt; <span class="number">1</span>) ^ lfsr2(R2)</span><br><span class="line">    R3 = (R3 &lt;&lt; <span class="number">1</span>) ^ lfsr3(R3)</span><br><span class="line"><span class="comment">#print(iv_txt[:320] == c)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part3 get_cipher</span></span><br><span class="line">c1 = <span class="string">b&#x27;\x10\x07t9\x88\x95\x8b&amp;\xb2\x8fp\xe7\xce\\k&#123;\xbb\xe5\xa7\xb8\x92\xbe\xd1\n\x84.\xe1\xe0\xab\x08\x97\x92\x1a\xbd\xdf\x80R\xbe\xe2\x84\xe17\x14\x8a\x07\x03\x87)\xb2\xa6W:\xda\x04Y\xa5\xca\x16o1\x93\x9d\x90.\xcdS\xd6\xcbK\xf4\xd8G&#x27;</span></span><br><span class="line">plain = <span class="string">b&#x27;Welcome to our CBCTF! I hope you can have a nice day here. Come with me.&#x27;</span></span><br><span class="line">final_c1 = <span class="string">b&quot;\x10\x07&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="built_in">len</span>(c1),<span class="number">2</span>):</span><br><span class="line">    tt1 = bytes_to_long(c1[i:i+<span class="number">2</span>])</span><br><span class="line">    tt2 = bytes_to_long(c1[i-<span class="number">2</span>:i])</span><br><span class="line">    final_c1 += long_to_bytes(tt1^tt2,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">c2 = <span class="string">b&quot;\xec\x16&lt;[D;F6\xb6\xcc\x7f\x80jL1\xb1@\x84iF[\xfcW\xbbbp\xdc\x0fI,%\x15\x1a\xbe\x86hT\r\xf0\x8a\xa91\x9aF\xe3\x84n\xeb\xe9\xa3,T\xec\x8f\xdbb\xc1\xd7\xe7&amp;&#x27;u\xe9A\xe9\x03\xe1\x89\x04\x8f\xa77\x8a\xd7\x97x\xccl\x1e\xc6\xea%\xb1/P\x98\x8e\x9bS\xca\xf5kR\x98H\xc6d\x15&quot;</span></span><br><span class="line">c2 = long_to_bytes(bytes_to_long(c2)^<span class="built_in">int</span>(iv_txt,<span class="number">2</span>))</span><br><span class="line">final_c2 = <span class="string">b&quot;F\x8c&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="built_in">len</span>(c2),<span class="number">2</span>):</span><br><span class="line">    tt1 = bytes_to_long(c2[i:i+<span class="number">2</span>])</span><br><span class="line">    tt2 = bytes_to_long(c2[i-<span class="number">2</span>:i])</span><br><span class="line">    final_c2 += long_to_bytes(tt1^tt2,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#part4 Meet-in-the-Middle attack</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CB_cipher</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):      </span><br><span class="line">        self.sbox = [<span class="number">0x6</span>, <span class="number">0x4</span>, <span class="number">0xc</span>, <span class="number">0x5</span>,</span><br><span class="line">                     <span class="number">0x0</span>, <span class="number">0x7</span>, <span class="number">0x2</span>, <span class="number">0xe</span>,</span><br><span class="line">                     <span class="number">0x1</span>, <span class="number">0xf</span>, <span class="number">0x3</span>, <span class="number">0xd</span>,</span><br><span class="line">                     <span class="number">0x8</span>, <span class="number">0xa</span>, <span class="number">0x9</span>, <span class="number">0xb</span>]</span><br><span class="line">        self.inv_sbox = [<span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x6</span>, <span class="number">0xa</span>, </span><br><span class="line">                         <span class="number">0x1</span>, <span class="number">0x3</span>, <span class="number">0x0</span>, <span class="number">0x5</span>, </span><br><span class="line">                         <span class="number">0xc</span>, <span class="number">0xe</span>, <span class="number">0xd</span>, <span class="number">0xf</span>, </span><br><span class="line">                         <span class="number">0x2</span>, <span class="number">0xb</span>, <span class="number">0x7</span>, <span class="number">0x9</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">s_trans</span>(<span class="params">self,pt</span>):</span><br><span class="line">        pt = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">        pt = [self.sbox[<span class="built_in">int</span>(i,<span class="number">16</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">hex</span>(<span class="built_in">int</span>(pt,<span class="number">2</span>))[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">        ct = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">bin</span>(i)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]</span><br><span class="line">        <span class="keyword">return</span> ct</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv_s_trans</span>(<span class="params">self,pt</span>):</span><br><span class="line">        pt = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">        pt = [self.inv_sbox[<span class="built_in">int</span>(i,<span class="number">16</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">hex</span>(<span class="built_in">int</span>(pt,<span class="number">2</span>))[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">        ct = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">bin</span>(i)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> pt])</span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]</span><br><span class="line">        <span class="keyword">return</span> ct</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">e1</span>(<span class="params">self,pltxt,k0,k1_4</span>):</span><br><span class="line">        key_add = <span class="keyword">lambda</span> x,key : [x[i]^key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        bit_move = <span class="keyword">lambda</span> x : [x[(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        </span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pltxt]</span><br><span class="line">        ct = key_add(ct,k0)</span><br><span class="line">        ct = self.s_trans(ct)</span><br><span class="line">        ct = bit_move(ct)</span><br><span class="line">        ct = key_add(ct[:<span class="number">4</span>],k1_4)</span><br><span class="line">        ct = self.sbox[<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]),<span class="number">2</span>)]</span><br><span class="line">        ct = key_add([<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bin</span>(ct)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)],k0[:<span class="number">4</span>])</span><br><span class="line">        ct = self.sbox[<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]),<span class="number">2</span>)]</span><br><span class="line">        ct = ct&gt;&gt;<span class="number">3</span></span><br><span class="line">        <span class="keyword">return</span> ct</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">d1</span>(<span class="params">self,pltxt,k1,k0_4</span>):</span><br><span class="line">        <span class="comment">#print(self)</span></span><br><span class="line">        key_add = <span class="keyword">lambda</span> x,key : [x[i]^key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        bit_move = <span class="keyword">lambda</span> x : [x[(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        </span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pltxt]</span><br><span class="line">        ct = key_add(ct,k1)</span><br><span class="line">        ct = bit_move(ct)</span><br><span class="line">        ct = self.inv_s_trans(ct)</span><br><span class="line">        ct = key_add(ct[:<span class="number">4</span>],k0_4)</span><br><span class="line">        ct = self.inv_sbox[<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]),<span class="number">2</span>)]</span><br><span class="line">        ct = key_add([<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bin</span>(ct)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)],k1[:<span class="number">4</span>])</span><br><span class="line">        <span class="keyword">return</span> ct[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bt_to_bin</span>(<span class="params">self,msg</span>):</span><br><span class="line">        msg = msg <span class="keyword">if</span> (<span class="built_in">len</span>(msg)+<span class="number">1</span>)%<span class="number">2</span> <span class="keyword">else</span> msg+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bin</span>(bytes_to_long(msg))[<span class="number">2</span>:].rjust(<span class="number">8</span>*<span class="built_in">len</span>(msg),<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self,pltxt,key</span>):</span><br><span class="line">        key_add = <span class="keyword">lambda</span> x,key : [x[i]^key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        bit_move = <span class="keyword">lambda</span> x : [x[(i//<span class="number">4</span>)+(i%<span class="number">4</span>)*<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">        </span><br><span class="line">        ct = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> pltxt]</span><br><span class="line">        <span class="comment">#print(ct,key)</span></span><br><span class="line">        ct = key_add(ct,key[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">2</span>:</span><br><span class="line">                ct = bit_move(ct)</span><br><span class="line">            ct = self.inv_s_trans(ct)</span><br><span class="line">            ct = key_add(ct,key[i%<span class="number">2</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ct]) </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">txt_decrypt</span>(<span class="params">self,msg,key</span>):</span><br><span class="line">        output = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(msg)):</span><br><span class="line">            now_re = self.decrypt(msg[i],key)</span><br><span class="line">            output.append(now_re)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(output),<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m1 = [<span class="built_in">bin</span>(bytes_to_long(plain[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>]))[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>)]</span><br><span class="line">c1 = [<span class="built_in">bin</span>(bytes_to_long(final_c1[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>]))[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>)]</span><br><span class="line">c2 = [<span class="built_in">bin</span>(bytes_to_long(final_c2[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>]))[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">49</span>)]</span><br><span class="line">a = CB_cipher()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">2</span>**<span class="number">8</span>):</span><br><span class="line">    dic_encbit = &#123;&#125;</span><br><span class="line">    k0_4 = [<span class="built_in">int</span>(k) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">bin</span>(i&amp;<span class="number">0xffff0000</span>)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">    k1_4 = [<span class="built_in">int</span>(k) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">bin</span>(i&amp;<span class="number">0x0000ffff</span>)[<span class="number">2</span>:].rjust(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">12</span>):</span><br><span class="line">        k0_12 = [<span class="built_in">int</span>(k) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">bin</span>(j)[<span class="number">2</span>:].rjust(<span class="number">12</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">        k0 = k0_4+k0_12</span><br><span class="line">        enc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">            enc += <span class="built_in">str</span>(a.e1(m1[i],k0,k1_4))</span><br><span class="line">        enc = <span class="built_in">int</span>(enc,<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span>(enc <span class="keyword">in</span> dic_encbit.keys()):</span><br><span class="line">            dic_encbit[enc].append(k0)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dic_encbit[enc] = [k0]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">12</span>):</span><br><span class="line">        k1_12 = [<span class="built_in">int</span>(k) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">bin</span>(j)[<span class="number">2</span>:].rjust(<span class="number">12</span>,<span class="string">&#x27;0&#x27;</span>)]</span><br><span class="line">        k1 = k1_4+k1_12</span><br><span class="line">        dec = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">            dec += <span class="built_in">str</span>(a.d1(c1[i],k1,k0_4))</span><br><span class="line">        dec = <span class="built_in">int</span>(dec,<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span>(dec <span class="keyword">in</span> dic_encbit.keys()):</span><br><span class="line">            <span class="keyword">for</span> k0 <span class="keyword">in</span> dic_encbit[dec]:</span><br><span class="line">                message = a.txt_decrypt(c2,[k0,k1])</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">b&quot;DASCTF&quot;</span> <span class="keyword">in</span> message):</span><br><span class="line">                    <span class="built_in">print</span>(message)</span><br><span class="line">                    exit()</span><br></pre></td></tr></table></figure>
<p>解得：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;n\xa3 you break the cipher!!how could it be??????? the flag is:DASCTF&#123;God_on_syM@etric_cRypto9raPhy&#125;\x00&#x27;</span></span><br></pre></td></tr></table></figure>
<p>其实前两个字节还有点小错误，正确flag中是”oh”，不过这个小bug暂时就不d了。</p>
<p>这样利用中间相遇攻击，复杂度就由爆破完整密钥的2^32降低到了2*2^20，因此最多约半小时就能爆破出结果。而且运气比较好，其实一分多钟就有正确结果。</p>
<h5 id="一些补充"><a href="#一些补充" class="headerlink" title="一些补充"></a>一些补充</h5><p>在复现完成后，出题师傅对我的一些说法进行了更细致的补充。就比如，其实再回头看我们刚才讲的encrypt函数不安全的第三点：</p>
<ul>
<li>bit_move函数中，有4个比特位并没有进行置换，分别是：0，5，10，15</li>
</ul>
<p>其实这一点对安全性影响并不大，因为即使进行了置换，依然是可以中间相遇攻击的，步骤并没有什么大变化。这是因为，第三轮如何置换并不重要，我们需要的其实只是<strong>加密三轮和解密三轮后得到的位置相同的碰撞比特</strong>。这也就是说，我们其实也不一定非要在外层爆破K[0]，K[1]的前四比特，其实任选两组，只要能得到满足要求的碰撞比特，都是可以建立字典的。</p>
<p>通过这题收获到了很多，也非常感谢出题师傅对我思路上的帮助。</p>
<p><br></p>
<p><br></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>糖醋小鸡块
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tangcuxiaojikuai.xyz/post/87ec16c9.html" title="2023-DASCTF-CBCTF-wp-crypto">https://tangcuxiaojikuai.xyz/post/87ec16c9.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sacreative/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SACREATIVE</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/6a2afd81.html" rel="prev" title="2023-0xGame-week3-wp-crypto">
      <i class="fa fa-chevron-left"></i> 2023-0xGame-week3-wp-crypto
    </a></div>
      <div class="post-nav-item">
    <a href="/post/85e9cf6b.html" rel="next" title="2023-"科来杯"第十届山东省大学生网络安全技能大赛-wp-crypto">
      2023-"科来杯"第十届山东省大学生网络安全技能大赛-wp-crypto <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#EzRSA"><span class="nav-number">1.</span> <span class="nav-text">EzRSA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CB-backpack"><span class="nav-number">2.</span> <span class="nav-text">CB backpack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CB-curve"><span class="nav-number">3.</span> <span class="nav-text">*CB curve</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#negG"><span class="nav-number">3.1.</span> <span class="nav-text">negG</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#groebner%E6%B1%82P%E7%82%B9%E5%9D%90%E6%A0%87"><span class="nav-number">3.2.</span> <span class="nav-text">groebner求P点坐标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mapping"><span class="nav-number">3.3.</span> <span class="nav-text">mapping</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CB-cipher"><span class="nav-number">4.</span> <span class="nav-text">*CB cipher</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%9D%E8%AF%95"><span class="nav-number">4.1.</span> <span class="nav-text">尝试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E6%80%9D%E8%B7%AF"><span class="nav-number">4.2.</span> <span class="nav-text">正确思路</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#iv"><span class="nav-number">4.2.1.</span> <span class="nav-text">iv</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E7%9B%B8%E9%81%87"><span class="nav-number">4.2.2.</span> <span class="nav-text">中间相遇</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E8%A1%A5%E5%85%85"><span class="nav-number">4.2.3.</span> <span class="nav-text">一些补充</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="糖醋小鸡块"
      src="/images/image.png">
  <p class="site-author-name" itemprop="name">糖醋小鸡块</p>
  <div class="site-description" itemprop="description">"追风赶月莫停留，平芜尽处是春山"</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/1142381085@qq.com" title="E-Mail → 1142381085@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6394335993" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6394335993" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">糖醋小鸡块</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>
  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'UPEMA7DyYbIIEyOW72ohgytU-gzGzoHsz',
      appKey     : 'M7rXAfeP3JOslroay2n0Jv2R',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
<!-- 引入jQuery -->
<script type="text/javascript" src="//libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<!-- 雪花特效2 -->
<script type="text/javascript" src="/js/snow2.js"></script>
